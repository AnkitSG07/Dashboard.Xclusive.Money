{% extends "layout.html" %}

{% block title %}Groups Management - DhanBot{% endblock %}

{% block styles %}
<!-- Your layout.html should already be loading Bootstrap CSS. -->
<!-- These links are here as a fallback, but can be removed if your layout handles them. -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="mb-4">
        <h2 class="fw-bold">Groups Management</h2>
        <p class="text-muted">Organize and manage your account groups for efficient trading operations.</p>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="mb-4"></div>

    <!-- Create Group -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="bi bi-plus-circle-fill me-2"></i>Create New Group</h5>
        </div>
        <div class="card-body">
            <form id="createGroupForm">
                <div class="input-group">
                    <input type="text" class="form-control" id="groupName" placeholder="Enter a unique name for the new group" required>
                    <button class="btn btn-primary" type="submit"><i class="bi bi-plus-lg"></i> Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Groups Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="bi bi-list-ul me-2"></i>Current Account Groups</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="groupsTable">
                    <thead>
                        <tr>
                            <th class="ps-4">Group Name</th>
                            <th>Members</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-center p-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Management Actions Row -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-person-plus-fill me-2"></i>Add Account to Group</h5></div>
                <div class="card-body">
                    <form id="addMemberForm">
                        <div class="mb-3">
                            <label for="addGroupSelect" class="form-label">Select Group</label>
                            <select class="form-select" id="addGroupSelect" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="accountSelect" class="form-label">Select Account</label>
                            <select class="form-select" id="accountSelect" required></select>
                        </div>
                        <button type="submit" class="btn btn-info w-100"><i class="bi bi-person-plus"></i> Add to Group</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-person-dash-fill me-2"></i>Remove Account from Group</h5></div>
                <div class="card-body">
                    <form id="removeMemberForm">
                        <div class="mb-3">
                            <label for="removeGroupSelect" class="form-label">Select Group</label>
                            <select class="form-select" id="removeGroupSelect" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="removeAccountSelect" class="form-label">Select Member to Remove</label>
                            <select class="form-select" id="removeAccountSelect" required></select>
                        </div>
                        <button type="submit" class="btn btn-warning w-100"><i class="bi bi-person-dash"></i> Remove from Group</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Other Actions -->
    <div class="row g-4 mt-4">
        <div class="col-lg-6">
             <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-pencil-square me-2"></i>Rename Group</h5></div>
                <div class="card-body">
                    <form id="renameGroupForm">
                        <div class="mb-3">
                            <label for="renameGroupSelect" class="form-label">Select Group</label>
                            <select class="form-select" id="renameGroupSelect" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="newGroupName" class="form-label">New Name</label>
                            <input type="text" class="form-control" id="newGroupName" placeholder="Enter the new name" required>
                        </div>
                        <button type="submit" class="btn btn-secondary w-100"><i class="bi bi-pencil"></i> Rename</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-trash-fill me-2"></i>Delete Group</h5></div>
                <div class="card-body">
                    <form id="deleteGroupForm">
                         <div class="mb-3">
                            <label for="deleteGroupSelect" class="form-label">Select Group</label>
                            <select class="form-select" id="deleteGroupSelect" required></select>
                        </div>
                        <p class="text-muted small">This action is permanent and cannot be undone.</p>
                        <button type="submit" class="btn btn-danger w-100"><i class="bi bi-trash"></i> Delete Group</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Place Order Card -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-send-fill me-2"></i>Place Group Order</h5></div>
                <div class="card-body">
                    <form id="groupOrderForm" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="orderGroupSelect" class="form-label">Group</label>
                            <select class="form-select" id="orderGroupSelect" required></select>
                        </div>
                        <div class="col-md-3">
                            <label for="orderSymbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="orderSymbol" list="symbolList" placeholder="e.g., NIFTY" required>
                            <datalist id="symbolList"></datalist>
                        </div>
                        <div class="col-md-2">
                            <label for="orderAction" class="form-label">Action</label>
                            <select class="form-select" id="orderAction">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label for="orderQty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="orderQty" placeholder="Qty" min="1" required>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success w-100" type="submit">Send Order</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Your layout.html should already be loading Bootstrap JS. -->
<!-- This link is here as a fallback, but can be removed if your layout handles it. -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let groupsCache = [];

    // --- Utility Functions ---
    async function fetchJson(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'An unknown error occurred.');
            }
            return response.json();
        } catch (error) {
            showAlert(`API Error: ${error.message}`, 'danger');
            throw error;
        }
    }
    
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const icons = { success: 'check-circle-fill', danger: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.role = 'alert';
        alert.innerHTML = `
            <i class="bi bi-${icons[type]} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
    }

    // --- UI Update Functions ---
    function renderGroupsTable() {
        const tbody = document.querySelector('#groupsTable tbody');
        tbody.innerHTML = '';
        if (groupsCache.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center p-5"><div><h3>No Groups Yet</h3><p class="text-muted">Use the form above to create your first group.</p></div></td></tr>`;
            return;
        }

        groupsCache.forEach(g => {
            const tr = document.createElement('tr');
            const membersHtml = (g.members && g.members.length > 0)
                ? g.members.map(m => `<span class="badge bg-secondary me-1">${m}</span>`).join('')
                : '<span class="text-muted">No members</span>';
            
            tr.innerHTML = `
                <td class="ps-4"><strong>${g.name}</strong></td>
                <td>${membersHtml}</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-outline-primary" onclick="window.pageFuncs.editGroup('${g.name}')">Edit</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function populateSelects(selectIds, options, placeholder) {
        selectIds.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            
            const currentVal = select.value;
            select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            select.innerHTML += options;
            
            if (select.querySelector(`option[value="${currentVal}"]`)) {
                select.value = currentVal;
            }
        });
    }

    // --- Data Loading ---
    async function loadGroups() {
        try {
            const groups = await fetchJson('/api/groups');
            groupsCache = groups || [];
            renderGroupsTable();
            const groupOpts = groupsCache.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
            populateSelects(['addGroupSelect', 'removeGroupSelect', 'renameGroupSelect', 'deleteGroupSelect', 'orderGroupSelect'], groupOpts, 'Select a group...');
            updateRemoveAccountOptions();
        } catch (error) {
            console.error("Failed to load groups:", error);
        }
    }

    async function loadAccounts() {
        try {
            const data = await fetchJson('/api/accounts');
            const accounts = data.accounts || [];
            const accOpts = accounts.map(a => `<option value="${a.client_id}">${a.client_id}</option>`).join('');
            populateSelects(['accountSelect'], accOpts, 'Select an account...');
        } catch (error) {
            console.error("Failed to load accounts:", error);
        }
    }

    const BROKER_DISPLAY_KEYS = ['dhan', 'aliceblue', 'angelone', 'iifl', 'kotak', 'upstox'];

    async function loadSymbols() {
        try {
            const symbols = await fetchJson('/api/symbols');
            const symbolList = document.getElementById('symbolList');
            symbolList.innerHTML = '';

            (symbols || []).forEach(symbolEntry => {
                const option = document.createElement('option');
                option.value = symbolEntry.symbol || '';

                const preferredId = symbolEntry.dhan || symbolEntry.symbol || '';
                const brokerTokens = BROKER_DISPLAY_KEYS
                    .filter(key => symbolEntry[key])
                    .map(key => `${key}: ${symbolEntry[key]}`);

                const label = brokerTokens.length
                    ? `${preferredId} â€” ${brokerTokens.join(', ')}`
                    : preferredId;

                option.label = label;
                option.textContent = preferredId;
                option.title = brokerTokens.length ? brokerTokens.join(' | ') : label;

                symbolList.appendChild(option);
            });
        } catch(error) {
            console.error("Failed to load symbols:", error);
        }
    }
    
    function updateRemoveAccountOptions() {
        const groupName = document.getElementById('removeGroupSelect').value;
        const group = groupsCache.find(g => g.name === groupName);
        const members = group ? group.members : [];
        const memberOpts = members.map(m => `<option value="${m}">${m}</option>`).join('');
        populateSelects(['removeAccountSelect'], memberOpts, 'Select a member...');
    }

    // --- Event Handlers ---
    document.getElementById('createGroupForm').addEventListener('submit', async e => {
        e.preventDefault();
        const name = document.getElementById('groupName').value.trim();
        if (!name) { showAlert('Group name cannot be empty.', 'warning'); return; }
        
        try {
            await fetchJson('/api/create-group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            showAlert(`Group "${name}" created successfully!`, 'success');
            document.getElementById('createGroupForm').reset();
            loadGroups();
        } catch (error) { /* showAlert is called in fetchJson */ }
    });

    document.getElementById('addMemberForm').addEventListener('submit', async e => {
        e.preventDefault();
        const group = document.getElementById('addGroupSelect').value;
        const client_id = document.getElementById('accountSelect').value;
        if (!group || !client_id) { showAlert('Please select both a group and an account.', 'warning'); return; }
        
        try {
            const resp = await fetchJson(`/api/groups/${encodeURIComponent(group)}/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_id })
            });
            showAlert(resp.message || 'Account added successfully!', 'success');
            loadGroups();
        } catch (error) { /* showAlert is called in fetchJson */ }
    });
    
    document.getElementById('removeGroupSelect').addEventListener('change', updateRemoveAccountOptions);

    document.getElementById('removeMemberForm').addEventListener('submit', async e => {
        e.preventDefault();
        const group = document.getElementById('removeGroupSelect').value;
        const client_id = document.getElementById('removeAccountSelect').value;
        if (!group || !client_id) { showAlert('Please select a group and a member to remove.', 'warning'); return; }
        
        try {
            const resp = await fetchJson(`/api/groups/${encodeURIComponent(group)}/remove`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_id })
            });
            showAlert(resp.message || 'Account removed successfully!', 'success');
            loadGroups();
        } catch (error) { /* showAlert is called in fetchJson */ }
    });
    
    document.getElementById('renameGroupForm').addEventListener('submit', async e => {
        e.preventDefault();
        const oldName = document.getElementById('renameGroupSelect').value;
        const newName = document.getElementById('newGroupName').value.trim();
        if (!oldName || !newName) { showAlert('Please select a group and provide a new name.', 'warning'); return; }
        
        try {
            const resp = await fetchJson(`/api/groups/${encodeURIComponent(oldName)}/rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_name: newName })
            });
            showAlert(resp.message || 'Group renamed successfully!', 'success');
            document.getElementById('renameGroupForm').reset();
            loadGroups();
        } catch (error) { /* showAlert is called in fetchJson */ }
    });

    document.getElementById('deleteGroupForm').addEventListener('submit', async e => {
        e.preventDefault();
        const name = document.getElementById('deleteGroupSelect').value;
        if (!name) { showAlert('Please select a group to delete.', 'warning'); return; }
        if (!confirm(`Are you sure you want to delete the group "${name}"? This action cannot be undone.`)) return;
        
        try {
            const resp = await fetchJson(`/api/groups/${encodeURIComponent(name)}`, { method: 'DELETE' });
            showAlert(resp.message || 'Group deleted successfully!', 'success');
            loadGroups();
        } catch (error) { /* showAlert is called in fetchJson */ }
    });

    document.getElementById('groupOrderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const group_name = document.getElementById('orderGroupSelect').value;
        const symbol = document.getElementById('orderSymbol').value.trim();
        const action = document.getElementById('orderAction').value;
        const quantity = document.getElementById('orderQty').value;

        if(!group_name || !symbol || !quantity) { showAlert('Please fill all order details.', 'warning'); return; }
        if(isNaN(quantity) || parseInt(quantity) <= 0) { showAlert('Quantity must be a positive number.', 'warning'); return; }

        try {
            const data = await fetchJson('/api/group-order', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({group_name, symbol, action, quantity: parseInt(quantity)})
            });
            showAlert('Order placed successfully: ' + JSON.stringify(data, null, 2), 'success');
            document.getElementById('groupOrderForm').reset();
        } catch (error) { /* showAlert is called in fetchJson */ }
    });

    // --- Initial Load ---
    loadGroups();
    loadAccounts();
    loadSymbols();
    
    // Make functions globally accessible for inline onclick
    window.pageFuncs = {
        editGroup: (groupName) => {
            document.getElementById('renameGroupSelect').value = groupName;
            document.getElementById('newGroupName').value = groupName;
            document.getElementById('newGroupName').focus();
        }
    };
});
</script>
{% endblock %}
