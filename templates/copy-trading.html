{% extends "layout.html" %}
{% block title %}Copy Trading - DhanBot{% endblock %}

{% block content %}
<div class="section-box hero-section mb-4 p-4 rounded shadow-sm bg-white">
  <h3 class="mb-2 text-primary"><i class="bi bi-people-fill me-2"></i> Copy Trading Setup</h3>
  <p class="mb-0 text-muted">Manage your trading accounts for copy trading. Use the <a href="/Add-Account" class="text-decoration-none fw-semibold">Account Configuration</a> page to add new accounts. Below, you can assign roles, link/unlink accounts, and control the copying process.</p>
</div>

<div class="section-box mb-4 p-4 rounded shadow-sm bg-white">
  <h5 class="mb-3 text-info"><i class="bi bi-question-circle me-2"></i> Unassigned Accounts</h5>
  <p class="text-muted">Accounts added but not yet assigned a role (Master or Child). Assign their role below to get started.</p>
  <div class="table-responsive">
    <table class="table table-hover table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Broker</th>
          <th>Client ID</th>
          <th class="d-none d-md-table-cell">Username</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="unassigned-table-body">
        </tbody>
    </table>
  </div>
  <div id="unassigned-empty-state" class="text-center p-3 text-muted" style="display: none;">
    No unassigned accounts. All accounts have a role.
  </div>
</div>

<div class="section-box mb-4 p-4 rounded shadow-sm bg-white">
  <h5 class="mb-3 text-success"><i class="bi bi-person-badge-fill me-2"></i> Master Accounts</h5>
  <p class="text-muted">Accounts selected to replicate their trades across linked child accounts.</p>
  <div class="table-responsive">
    <table class="table table-hover table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Broker</th>
          <th>Client ID</th>
          <th class="d-none d-md-table-cell">Username</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="master-table-body">
        </tbody>
    </table>
  </div>
  <div id="master-empty-state" class="text-center p-3 text-muted" style="display: none;">
    No master accounts configured.
  </div>
</div>

<div class="section-box mb-4 p-4 rounded shadow-sm bg-white">
  <h5 class="mb-3 text-primary"><i class="bi bi-people-fill me-2"></i> Child Accounts</h5>
  <p class="text-muted">Accounts where all trades from their assigned Master will be copied.</p>
  <div class="table-responsive">
    <table class="table table-hover table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Broker</th>
          <th class="d-none d-sm-table-cell">Master ID</th>
          <th>Client ID</th>
          <th class="d-none d-md-table-cell">Username</th>
          <th>Status</th>
          <th>Copy Status</th>
          <th>Multiplier</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="children-table-body">
        </tbody>
    </table>
  </div>
  <div id="children-empty-state" class="text-center p-3 text-muted" style="display: none;">
    No child accounts configured.
  </div>
</div>

<div class="section-box mb-4 p-4 rounded shadow-sm bg-white">
  <h5 class="mb-3 text-secondary"><i class="bi bi-card-checklist me-2"></i> Master Orders</h5>
  <p class="text-muted">Manage or cancel trades initiated by Master accounts and copied to children.</p>
  <div class="sticky-toolbar bg-light p-3 border-bottom rounded-top d-flex flex-wrap gap-2 align-items-center" style="position: sticky; top: 0; z-index: 10;">
    <button class="btn btn-danger btn-sm" id="cancelSelectedOrdersBtn"><i class="bi bi-x-circle me-1"></i> Cancel Selected</button>
    <button class="btn btn-warning btn-sm" id="squareOffSelectedOrdersBtn"><i class="bi bi-box-arrow-in-up-right me-1"></i> Square Off Selected</button>
    <div class="form-check ms-auto">
      <input class="form-check-input" type="checkbox" id="toggleAllMasterOrdersCheckbox" onchange="window.toggleAllMasterOrders(this.checked)">
      <label class="form-check-label" for="toggleAllMasterOrdersCheckbox">Select All</label>
    </div>
  </div>
  <div class="table-responsive mt-3">
    <table class="table table-hover table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="master-orders-select-all" onchange="window.toggleAllMasterOrders(this.checked)"></th>
          <th>Order ID</th>
          <th>Symbol</th>
          <th>Status</th>
          <th>Children</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="master-orders-body">
        </tbody>
    </table>
  </div>
  <div id="master-orders-empty-state" class="text-center p-3 text-muted" style="display: none;">
    No master orders found.
  </div>
</div>

<div class="modal fade" id="childMappingModal" tabindex="-1" aria-labelledby="childMappingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="childMappingModalLabel">Child Orders</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-striped align-middle">
            <thead>
              <tr>
                <th>Child Client ID</th>
                <th>Order ID</th>
                <th>Status</th>
                <th>Broker</th>
              </tr>
            </thead>
            <tbody id="child-mapping-body">
              </tbody>
          </table>
        </div>
        <div id="child-mapping-empty-state" class="text-center p-3 text-muted" style="display: none;">
          No child orders found for this master order.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="changeMasterModal" tabindex="-1" aria-labelledby="changeMasterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="changeMasterModalLabel">Change Master for Child Account</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="changeChildId" />
        <div class="mb-3">
          <label for="newMasterDropdown" class="form-label">Select New Master:</label>
          <select id="newMasterDropdown" class="form-select"></select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitChangeMasterBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="dynamicModal" tabindex="-1" aria-labelledby="dynamicModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="dynamicModalLabel">Action Required</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="dynamicModalBody">
        </div>
      <div class="modal-footer" id="dynamicModalFooter">
        </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
window.pageScripts = window.pageScripts || {};
window.pageScripts["copy-trading"] = function () {
  // Centralized data store (consider using a state management library for larger apps)
  let allAccountsData = {
    unassigned: [],
    masters: [],
    children: []
  };
  let exitedChildren = {}; // Tracks explicitly exited children

  // Utility function for showing temporary messages (can be replaced by a toast system)
  function showMessage(message, type = 'info') {
    alert(message); // For simplicity, keep using alert. Replace with toast notifications in production.
  }

  // Generic fetch wrapper with error handling
  async function fetchData(url, options = {}) {
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.error(`API call to ${url} failed:`, error);
      showMessage(`Error: ${error.message}`, 'danger');
      throw error; // Re-throw to allow specific error handling at call site
    }
  }

  // ============ MODAL HELPERS ============

  // Manages a generic dynamic modal
  const dynamicModalElement = document.getElementById('dynamicModal');
  const dynamicModal = new bootstrap.Modal(dynamicModalElement);
  const dynamicModalLabel = document.getElementById('dynamicModalLabel');
  const dynamicModalBody = document.getElementById('dynamicModalBody');
  const dynamicModalFooter = document.getElementById('dynamicModalFooter');

  function openDynamicModal(title, bodyHtml, footerButtonsHtml) {
      dynamicModalLabel.textContent = title;
      dynamicModalBody.innerHTML = bodyHtml;
      dynamicModalFooter.innerHTML = footerButtonsHtml;
      dynamicModal.show();
  }

  function closeDynamicModal() {
      dynamicModal.hide();
  }

  window.openChangeMaster = async function(childId) {
    try {
      document.getElementById("changeChildId").value = childId;
      const data = await fetchData("/api/accounts");
      const masters = data.masters || [];
      const dropdown = document.getElementById("newMasterDropdown");
      dropdown.innerHTML = masters.map(m => `<option value="${m.client_id}">${m.username || m.client_id}</option>`).join("");
      new bootstrap.Modal(document.getElementById("changeMasterModal")).show();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  document.getElementById("submitChangeMasterBtn").onclick = async function() {
    const child_id = document.getElementById("changeChildId").value;
    const new_master_id = document.getElementById("newMasterDropdown").value;
    try {
      const data = await fetchData("/api/change-master", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ child_id, new_master_id })
      });
      showMessage(data.message);
      loadAccounts(); // Reload all accounts
      bootstrap.Modal.getInstance(document.getElementById("changeMasterModal")).hide();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.viewChildMappings = async function(masterOrderId) {
    try {
      const data = await fetchData(`/api/child-orders?master_order_id=${masterOrderId}`);
      const tbody = document.getElementById("child-mapping-body");
      tbody.innerHTML = "";
      if (data && data.length > 0) {
        data.forEach(row => {
          tbody.innerHTML += `
            <tr>
              <td>${row.child_client_id}</td>
              <td>${row.child_order_id}</td>
              <td>${row.status}</td>
              <td>${row.child_broker}</td>
            </tr>`;
        });
        document.getElementById("child-mapping-empty-state").style.display = 'none';
      } else {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center">No child orders found.</td></tr>`;
        document.getElementById("child-mapping-empty-state").style.display = 'block';
      }
      new bootstrap.Modal(document.getElementById("childMappingModal")).show();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  // ============ MAIN TABLE LOADERS ============

  window.openSetAsChild = async function(clientId) {
    try {
      const data = await fetchData("/api/accounts");
      const masters = data.masters || [];
      if (masters.length === 0) {
        showMessage("No master accounts available to link as a child. Please set up a master account first.", "warning");
        return;
      }
      const selectHtml = `
        <div class="mb-3">
          <label for="setChildMasterSelect" class="form-label">Select Master Account</label>
          <select class="form-select" id="setChildMasterSelect">
            ${masters.map(m => `<option value="${m.client_id}">${m.username || m.client_id}</option>`).join("")}
          </select>
        </div>
      `;
      const footerButtons = `
        <button class="btn btn-secondary" onclick="closeDynamicModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmSetAsChildBtn">Confirm</button>
      `;

      openDynamicModal("Assign as Child", selectHtml, footerButtons);

      document.getElementById("confirmSetAsChildBtn").onclick = async function() {
        const linked_master_id = document.getElementById("setChildMasterSelect").value;
        try {
          const result = await fetchData("/api/set-child", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ client_id: clientId, linked_master_id })
          });
          showMessage(result.message || "Assigned as child.");
          closeDynamicModal();
          loadAccounts();
        } catch (error) {
          // Error handled by fetchData
        }
      };
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.loadAccounts = async function() {
    try {
      const data = await fetchData("/api/accounts");
      allAccountsData.masters = (data.masters || []).map(m => ({ ...m, role: "master" }));
      allAccountsData.unassigned = (data.accounts || []).filter(acc => !acc.role);

      // Flatten children and link to master
      allAccountsData.children = [];
      for (const master of allAccountsData.masters) {
        if (master.children && Array.isArray(master.children)) {
          for (const child of master.children) {
            allAccountsData.children.push({ ...child, linked_master_id: master.client_id });
          }
        }
      }

      renderUnassignedAccounts();
      renderMasterAccounts();
      renderChildAccounts();
      loadMasterOrders(); // Also reload master orders
    } catch (err) {
      console.error("Failed to load accounts:", err);
      // Removed retry logic as it can lead to infinite loops.
      // A more robust solution involves proper UI feedback and user-initiated retries.
      showMessage("Failed to load accounts. Please try refreshing the page.", 'danger');
    }
  };

  function renderUnassignedAccounts() {
    const tbody = document.getElementById("unassigned-table-body");
    tbody.innerHTML = "";
    if (allAccountsData.unassigned.length === 0) {
      document.getElementById("unassigned-empty-state").style.display = 'block';
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No unassigned accounts.</td></tr>`;
    } else {
      document.getElementById("unassigned-empty-state").style.display = 'none';
      allAccountsData.unassigned.forEach(acc => {
        tbody.innerHTML += `
          <tr>
            <td><i class="bi bi-bank me-1"></i> ${acc.broker}</td>
            <td>${acc.client_id}</td>
            <td class="d-none d-md-table-cell">${acc.username || "-"}</td>
            <td><span class="badge bg-secondary">Not Assigned</span></td>
            <td>
              <button class="btn btn-sm btn-primary me-1" onclick="window.setAsMaster('${acc.client_id}')">Set as Master</button>
              <button class="btn btn-sm btn-info" onclick="window.openSetAsChild('${acc.client_id}')">Set as Child</button>
            </td>
          </tr>
        `;
      });
    }
  }

  function renderMasterAccounts() {
    const tbody = document.getElementById("master-table-body");
    tbody.innerHTML = "";
    if (allAccountsData.masters.length === 0) {
      document.getElementById("master-empty-state").style.display = 'block';
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No master accounts configured.</td></tr>`;
    } else {
      document.getElementById("master-empty-state").style.display = 'none';
      allAccountsData.masters.forEach(master => {
        tbody.innerHTML += `
          <tr>
            <td><i class="bi bi-bank me-1"></i> ${master.broker}</td>
            <td>${master.client_id}</td>
            <td class="d-none d-md-table-cell">${master.username || "-"}</td>
            <td><span class="badge bg-success">${master.status || "Connected"}</span></td>
            <td>
              <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.removeMaster('${master.client_id}')">Remove Master</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.startAllChildren('${master.client_id}')">Turn On All Child Copying</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.stopAllChildren('${master.client_id}')">Turn Off All Child Copying</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.exitAllChildren('${master.client_id}')">Exit All Child Positions</a></li>
                </ul>
              </div>
            </td>
          </tr>
          <tr class="master-details-row">
            <td colspan="5" class="p-0">
              <ul class="nav nav-tabs master-tab-links px-3">
                <li class="nav-item">
                  <a class="nav-link active" id="tab-children-${master.client_id}" data-bs-toggle="tab" href="#master-children-${master.client_id}" role="tab" aria-controls="master-children-${master.client_id}" aria-selected="true" onclick="window.showMasterTab('${master.client_id}', 'children')">View Children</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="tab-positions-${master.client_id}" data-bs-toggle="tab" href="#master-positions-${master.client_id}" role="tab" aria-controls="master-positions-${master.client_id}" aria-selected="false" onclick="window.showMasterTab('${master.client_id}', 'positions')">Positions</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="tab-orders-${master.client_id}" data-bs-toggle="tab" href="#master-orders-book-${master.client_id}" role="tab" aria-controls="master-orders-book-${master.client_id}" aria-selected="false" onclick="window.showMasterTab('${master.client_id}', 'orders')">Order Book</a>
                </li>
              </ul>
              <div class="tab-content p-3 bg-light rounded-bottom">
                <div class="tab-pane fade show active" id="master-children-${master.client_id}" role="tabpanel">
                  <h6>Linked Child Accounts</h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered table-striped mb-0 align-middle">
                      <thead>
                        <tr>
                          <th>Client ID</th>
                          <th class="d-none d-md-table-cell">Username</th>
                          <th>Status</th>
                          <th>Copy Status</th>
                          <th>Multiplier</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="child-rows-${master.client_id}">
                        </tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="master-positions-${master.client_id}" role="tabpanel">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered table-striped mb-0 align-middle">
                      <thead>
                        <tr>
                          <th>Symbol</th>
                          <th>Type</th>
                          <th>Buy Qty</th>
                          <th>Sell Qty</th>
                          <th>Net Qty</th>
                          <th>Avg Buy Price</th>
                          <th>Avg Sell Price</th>
                          <th>LTP</th>
                          <th>P/L</th>
                        </tr>
                      </thead>
                      <tbody id="positions-body-${master.client_id}"></tbody>
                    </table>
                    <div id="positions-empty-${master.client_id}" class="text-center p-2 text-muted" style="display:none;">No positions for this master account.</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="master-orders-book-${master.client_id}" role="tabpanel">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered table-striped mb-0 align-middle">
                      <thead>
                        <tr>
                          <th>Order ID</th>
                          <th>Side</th>
                          <th>Status</th>
                          <th>Symbol</th>
                          <th>Product Type</th>
                          <th>Placed Qty</th>
                          <th>Filled Qty</th>
                          <th>Avg Price</th>
                          <th>Order Time</th>
                          <th>Remarks</th>
                        </tr>
                      </thead>
                      <tbody id="orders-body-${master.client_id}"></tbody>
                    </table>
                    <div id="orders-empty-${master.client_id}" class="text-center p-2 text-muted" style="display:none;">No recent orders for this master account.</div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        `;
      });
      // Initial load for master children tabs
      allAccountsData.masters.forEach(master => {
          renderMasterChildrenTable(master.client_id);
          // showMasterTab(master.client_id, 'children'); // Keep the children tab active by default
      });
    }
  }

  function renderMasterChildrenTable(masterId) {
      const master = allAccountsData.masters.find(m => m.client_id === masterId);
      const kids = (master?.children || []);
      const tbody = document.getElementById(`child-rows-${masterId}`);
      if (!tbody) return; // Ensure the tbody element exists

      if (kids.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No child accounts linked to this master.</td></tr>`;
      } else {
          tbody.innerHTML = kids.map(child => `
              <tr>
                <td>${child.client_id}</td>
                <td class="d-none d-md-table-cell">${child.username || "-"}</td>
                <td><span class="badge bg-success">${child.status || "Connected"}</span></td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="form-check form-switch m-0">
                      <input type="checkbox" class="form-check-input" ${child.copy_status === 'On' ? 'checked' : ''}
                        onchange="window.toggleCopyTrade('${child.client_id}', '${masterId}', this.checked)">
                    </div>
                    <span class="badge ${child.copy_status === 'On' ? 'bg-success' : 'bg-secondary'}">${child.copy_status || '-'}</span>
                  </div>
                </td>
                <td>${child.multiplier || 1}</td>
                <td>
                  <button class="btn btn-sm btn-danger" onclick="window.removeChild('${child.client_id}')">Remove</button>
                </td>
              </tr>
          `).join('');
      }
  }

  function renderChildAccounts() {
    const tbody = document.getElementById("children-table-body");
    tbody.innerHTML = "";
    if (allAccountsData.children.length === 0) {
      document.getElementById("children-empty-state").style.display = 'block';
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No child accounts configured.</td></tr>`;
    } else {
      document.getElementById("children-empty-state").style.display = 'none';
      allAccountsData.children.forEach(child => {
        const master = allAccountsData.masters.find(m => m.client_id === child.linked_master_id) || {};
        const exited = exitedChildren[child.client_id];
        tbody.innerHTML += `
          <tr>
            <td><i class="bi bi-bank me-1"></i> ${child.broker}</td>
            <td class="d-none d-sm-table-cell">${master.client_id || "-"}</td>
            <td>${child.client_id}</td>
            <td class="d-none d-md-table-cell">${child.username || "-"}</td>
            <td><span class="badge bg-success">${child.status || "Connected"}</span></td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="form-check form-switch m-0">
                  <input type="checkbox" class="form-check-input" ${child.copy_status === 'On' ? 'checked' : ''}
                    onchange="window.toggleCopyTrade('${child.client_id}', '${master.client_id}', this.checked)">
                </div>
                <span class="badge ${child.copy_status === 'On' ? 'bg-success' : 'bg-secondary'}">${child.copy_status || "-"}</span>
              </div>
            </td>
            <td>
              <div class="input-group input-group-sm">
                <input type="number" min="0.1" step="0.1" class="form-control" id="mult-${child.client_id}" value="${child.multiplier || 1}">
                <button class="btn btn-sm btn-outline-primary" onclick="window.updateMultiplier('${child.client_id}')">Save</button>
              </div>
            </td>
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.startCopying('${child.client_id}', '${master.client_id}')">Start Copying</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.stopCopying('${child.client_id}', '${master.client_id}')">Stop Copying</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.squareOffPosition('${master.client_id}', '${child.client_id}')">Square Off Specific Symbol</a></li>
                    <li><a class="dropdown-item ${exited ? 'disabled' : ''}" href="javascript:void(0)" ${exited ? '' : `onclick="window.exitAllPositions('${child.client_id}')"`}>${exited ? 'Exited All Positions' : 'Exit All Positions'}</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.removeChild('${child.client_id}')">Remove Child</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.openChangeMaster('${child.client_id}')">Change Master</a></li>
                </ul>
              </div>
            </td>
          </tr>
        `;
      });
    }
  }

  // ============ MASTER TAB CONTENT LOADERS (Positions, Orders) ============

  window.showMasterTab = async function(clientId, tabName) {
    // Hide all tab content rows for this master first
    const tabPanes = document.querySelectorAll(`#master-positions-${clientId}, #master-orders-book-${clientId}, #master-children-${clientId}`);
    tabPanes.forEach(pane => pane.classList.remove('show', 'active'));

    // Activate the selected tab
    const selectedTabPane = document.getElementById(`master-${tabName === 'orders' ? 'orders-book' : tabName}-${clientId}`);
    if (selectedTabPane) {
        selectedTabPane.classList.add('show', 'active');
    }

    // Load data for the selected tab if not already loaded or if it's positions/orders
    if (tabName === 'positions') {
      await loadMasterPositions(clientId);
    } else if (tabName === 'orders') {
      await loadMasterOrderBook(clientId);
    } else if (tabName === 'children') {
        // Children table is rendered with initial loadAccounts, just ensure it's shown
        renderMasterChildrenTable(clientId);
    }
  };

  async function loadMasterOrderBook(clientId) {
    const tbody = document.getElementById(`orders-body-${clientId}`);
    const emptyState = document.getElementById(`orders-empty-${clientId}`);
    tbody.innerHTML = `<tr><td colspan="10" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Loading orders...</td></tr>`;
    emptyState.style.display = 'none';

    try {
      const data = await fetchData(`/api/order-book/${clientId}`);
      tbody.innerHTML = "";
      if (Array.isArray(data) && data.length > 0) {
        data.forEach(order => {
          tbody.innerHTML += `
            <tr>
              <td>${order.order_id || '-'}</td>
              <td>${order.side || '-'}</td>
              <td>${order.status || '-'}</td>
              <td>${order.symbol || '-'}</td>
              <td>${order.product_type || '-'}</td>
              <td>${order.placed_qty || '-'}</td>
              <td>${order.filled_qty || '-'}</td>
              <td>${order.avg_price || '-'}</td>
              <td>${order.order_time ? new Date(order.order_time).toLocaleString() : '-'}</td>
              <td>${order.remarks || '-'}</td>
            </tr>
          `;
        });
      } else {
        emptyState.style.display = 'block';
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">No recent orders found.</td></tr>`;
      }
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Failed to load order book.</td></tr>`;
      emptyState.style.display = 'none';
    }
  }

  async function loadMasterPositions(clientId) {
    const tbody = document.getElementById(`positions-body-${clientId}`);
    const emptyState = document.getElementById(`positions-empty-${clientId}`);
    tbody.innerHTML = `<tr><td colspan="9" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Loading positions...</td></tr>`;
    emptyState.style.display = 'none';

    try {
      const positions = await fetchData(`/api/portfolio/${clientId}`);
      tbody.innerHTML = "";
      if (Array.isArray(positions) && positions.length > 0) {
        positions.forEach(pos => {
          const buyQty = pos.buyQty || pos.buy_quantity || 0;
          const sellQty = pos.sellQty || pos.sell_quantity || 0;
          const netQty = pos.netQty || pos.net_quantity || 0;
          const type = netQty >= 0 ? "BUY" : "SELL";
          tbody.innerHTML += `
            <tr>
              <td>${pos.tradingSymbol || pos.symbol || '-'}</td>
              <td><span class="badge ${type === 'BUY' ? 'bg-success' : 'bg-danger'}">${type}</span></td>
              <td>${buyQty}</td>
              <td>${sellQty}</td>
              <td>${netQty}</td>
              <td>${pos.buyAvg || pos.buy_avg_price || '-'}</td>
              <td>${pos.sellAvg || pos.sell_avg_price || '-'}</td>
              <td>${pos.ltp || pos.last_price || '-'}</td>
              <td>${pos.profitAndLoss || pos.pnl || '-'}</td>
            </tr>
          `;
        });
      } else {
        emptyState.style.display = 'block';
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No positions for this master account.</td></tr>`;
      }
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Failed to load positions.</td></tr>`;
      emptyState.style.display = 'none';
    }
  }

  // --- Master Orders Table ---
  window.loadMasterOrders = async function() {
    try {
      const data = await fetchData('/api/master-orders');
      const tbody = document.getElementById("master-orders-body");
      tbody.innerHTML = "";
      if (Array.isArray(data) && data.length > 0) {
        document.getElementById("master-orders-empty-state").style.display = 'none';
        data.forEach(order => {
          tbody.innerHTML += `
            <tr>
              <td><input type="checkbox" class="form-check-input master-order-checkbox" value="${order.master_order_id}"></td>
              <td>${order.master_order_id}</td>
              <td>${order.symbol}</td>
              <td><span class="badge bg-primary">${order.status}</span></td>
              <td>${order.total_children}</td>
              <td><button class="btn btn-sm btn-info" onclick="window.viewChildMappings('${order.master_order_id}')"><i class="bi bi-eye-fill"></i> View Children</button></td>
            </tr>`;
        });
      } else {
        document.getElementById("master-orders-empty-state").style.display = 'block';
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No master orders found.</td></tr>`;
      }
      // Reset select all checkbox
      document.getElementById("toggleAllMasterOrdersCheckbox").checked = false;
    } catch (error) {
      // Error handled by fetchData
      document.getElementById("master-orders-body").innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load master orders.</td></tr>`;
      document.getElementById("master-orders-empty-state").style.display = 'none';
    }
  };

  window.toggleAllMasterOrders = function(isChecked) {
    document.querySelectorAll(".master-order-checkbox").forEach(cb => cb.checked = isChecked);
    document.getElementById("master-orders-select-all").checked = isChecked;
  };

  // --- Cancel/Square Off Actions ---
  document.getElementById("cancelSelectedOrdersBtn").onclick = async function() {
    const selected = [...document.querySelectorAll(".master-order-checkbox:checked")].map(cb => cb.value);
    if (selected.length === 0) return showMessage("No orders selected to cancel.", 'warning');

    if (!confirm(`Are you sure you want to cancel ${selected.length} selected order(s)?`)) return;

    for (const id of selected) {
        await fetchData("/api/cancel-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ master_order_id: id })
        });
    }
    showMessage("Selected orders cancelled successfully.");
    loadMasterOrders();
  };

  document.getElementById("squareOffSelectedOrdersBtn").onclick = async function() {
    const selected = [...document.querySelectorAll(".master-order-checkbox:checked")].map(cb => cb.value);
    if (selected.length === 0) return showMessage("No orders selected to square off.", 'warning');

    if (!confirm(`Are you sure you want to square off ${selected.length} selected order(s)? This will attempt to exit positions in all linked children.`)) return;

    for (const id of selected) {
        await fetchData("/api/master-squareoff", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ master_order_id: id })
        });
    }
    showMessage("Selected master orders squared off. Check child accounts for position updates.");
    loadMasterOrders();
    loadAccounts(); // Reload accounts to update child positions
  };

  // --- Master/Child Linking and Copying ---
  window.setAsMaster = async function(clientId) {
    if (!confirm(`Are you sure you want to set ${clientId} as a Master account?`)) return;
    try {
      const data = await fetchData("/api/set-master", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: clientId })
      });
      showMessage(data.message);
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.removeMaster = async function(clientId) {
    if (!confirm(`WARNING: Removing master account ${clientId} will also unlink all its child accounts. Are you sure?`)) return;
    try {
      const data = await fetchData("/api/remove-master", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: clientId })
      });
      showMessage(data.message);
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.startCopying = async function(childId, masterId) {
    try {
      const data = await fetchData("/api/start-copy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: childId, master_id: masterId })
      });
      showMessage(data.message);
      loadAccounts(); // Reload to update UI status
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.stopCopying = async function(childId, masterId) {
    try {
      const data = await fetchData("/api/stop-copy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: childId, master_id: masterId })
      });
      showMessage(data.message);
      loadAccounts(); // Reload to update UI status
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.toggleCopyTrade = function(childId, masterId, isOn) {
    if (isOn) {
      window.startCopying(childId, masterId);
    } else {
      window.stopCopying(childId, masterId);
    }
  };

  window.startAllChildren = async function(masterId) {
    if (!confirm(`Are you sure you want to turn ON copy trading for ALL children linked to Master ${masterId}?`)) return;
    try {
      const data = await fetchData('/api/start-copy-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ master_id: masterId })
      });
      showMessage(data.message);
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.stopAllChildren = async function(masterId) {
    if (!confirm(`Are you sure you want to turn OFF copy trading for ALL children linked to Master ${masterId}?`)) return;
    try {
      const data = await fetchData('/api/stop-copy-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ master_id: masterId })
      });
      showMessage(data.message);
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.removeChild = async function(childId) {
    if (!confirm(`Are you sure you want to remove child account ${childId}? This will stop all copy trading for this account.`)) return;
    try {
      const data = await fetchData("/api/remove-child", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: childId })
      });
      showMessage(data.message);
      // Remove from exitedChildren if it was marked
      delete exitedChildren[childId];
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.squareOffPosition = async function(masterId, childId) {
    try {
      const positions = await fetchData(`/api/portfolio/${childId}`);
      const activePositions = (positions || []).filter(pos => (pos.netQty || pos.net_quantity) !== 0);
      const symbols = activePositions.map(pos => pos.tradingSymbol || pos.symbol);

      if (symbols.length === 0) {
        showMessage(`No active positions found for child ${childId}.`, 'info');
        return;
      }

      const symbolOptions = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
      const bodyHtml = `
        <p>Select a symbol to square off for child account <strong>${childId}</strong>:</p>
        <div class="mb-3">
          <label for="squareOffSymbol" class="form-label">Symbol:</label>
          <select id="squareOffSymbol" class="form-select">${symbolOptions}</select>
        </div>
      `;
      const footerButtons = `
        <button class="btn btn-secondary" onclick="closeDynamicModal()">Cancel</button>
        <button class="btn btn-danger" id="confirmSquareOffBtn">Confirm Square Off</button>
      `;

      openDynamicModal("Square Off Position", bodyHtml, footerButtons);

      document.getElementById("confirmSquareOffBtn").onclick = async function() {
        const symbol = document.getElementById("squareOffSymbol").value;
        if (!confirm(`Are you sure you want to square off ${symbol} for child ${childId}?`)) {
          closeDynamicModal();
          return;
        }

        // Add a simple loading spinner directly to the modal for this action
        dynamicModalBody.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Processing square off for ${symbol}...</p></div>`;
        dynamicModalFooter.innerHTML = ''; // Hide buttons during processing

        try {
          const data = await fetchData("/api/square-off", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              client_id: childId,
              symbol: symbol,
              is_master: false // This seems to imply the API handles master/child square-off differently
            })
          });
          showMessage(data.message + (data.details ? "\nDetails:\n" + data.details.join("\n") : ''));
          closeDynamicModal();
          loadAccounts(); // Reload to update positions
        } catch (error) {
          // Error handled by fetchData
          closeDynamicModal();
          loadAccounts(); // Still reload to reflect any changes
        }
      };
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.exitAllPositions = async function(childId) {
    if (exitedChildren[childId]) {
      showMessage("Child positions already exited for this session.", 'info');
      return;
    }
    if (!confirm(`Are you sure you want to exit ALL open positions for child account ${childId}?`)) return;

    try {
      const data = await fetchData('/api/exit-child-positions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ child_id: childId })
      });
      showMessage(data.message);
      if (Array.isArray(data.results) && data.results.some(r => r.status === 'SUCCESS')) {
        exitedChildren[childId] = true; // Mark as exited for the current session
      }
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.exitAllChildren = async function(masterId) {
    const childrenToExit = allAccountsData.children
      .filter(c => c.linked_master_id === masterId && !exitedChildren[c.client_id])
      .map(c => c.client_id);

    if (childrenToExit.length === 0) {
      showMessage('All linked children for this master are already exited or have no positions to exit.', 'info');
      return;
    }

    if (!confirm(`Are you sure you want to attempt to exit ALL open positions for the ${childrenToExit.length} linked child account(s) of Master ${masterId}?`)) return;

    try {
      const data = await fetchData('/api/exit-all-children', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ master_id: masterId, child_ids: childrenToExit })
      });
      showMessage(data.message);
      if (Array.isArray(data.exited_children)) {
        data.exited_children.forEach(id => { exitedChildren[id] = true; });
      }
      loadAccounts();
    } catch (error) {
      // Error handled by fetchData
    }
  };

  window.updateMultiplier = async function(clientId) {
    const inputElement = document.getElementById(`mult-${clientId}`);
    const newMultiplier = parseFloat(inputElement.value);

    if (isNaN(newMultiplier) || newMultiplier < 0.1) {
      showMessage("Please enter a valid multiplier (minimum 0.1).", 'warning');
      inputElement.value = inputElement.defaultValue; // Reset to previous valid value
      return;
    }
    if (!confirm(`Confirm update multiplier for ${clientId} to ${newMultiplier}?`)) {
        inputElement.value = inputElement.defaultValue; // Reset if cancelled
        return;
    }

    try {
      const data = await fetchData("/api/update-multiplier", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id: clientId, multiplier: newMultiplier })
      });
      showMessage(data.message || "Multiplier updated successfully.");
      // No need to reload all accounts, just update the default value for the input
      inputElement.defaultValue = newMultiplier;
      // If you need to re-render the child row for any other reason:
      // loadAccounts();
    } catch (error) {
      inputElement.value = inputElement.defaultValue; // Reset on error
      // Error handled by fetchData
    }
  };

  // --- INIT ON LOAD ---
  // Ensure DOM is fully loaded before trying to attach listeners or load data
  document.addEventListener('DOMContentLoaded', () => {
    loadAccounts();
  });
};

// Ensure this script is executed when the page is loaded, typically by
// calling `window.pageScripts["copy-trading"]()` in your main layout script
// after all page-specific scripts are loaded.
</script>
{% endblock %}
