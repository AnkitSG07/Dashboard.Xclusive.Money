{% extends "layout.html" %}
{% block title %}Copy Trading - DhanBot{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <h3 class="mb-0 text-primary">
                        <i class="bi bi-people-fill me-2"></i> Copy Trading Setup
                    </h3>
                    <a href="/Add-Account" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-2"></i> Configure New Account
                    </a>
                </div>
                <div class="card-footer bg-light border-0 text-muted">
                    Manage your trading accounts for copy trading. Use the Account Configuration page to add new accounts. Below, you can assign roles, link/unlink accounts, and control the copying process.
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i> Unassigned Accounts</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Accounts added but not yet assigned a role (Master or Child). Assign their role below to get started.</p>
                    <div id="unassigned-accounts-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                        </div>
                    <div id="unassigned-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-check-circle-fill fs-3 text-success mb-2"></i>
                        <p class="mb-0">No unassigned accounts. All accounts have a role.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i> Master Accounts</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Accounts selected to replicate their trades across linked child accounts.</p>
                    <div id="master-accounts-accordion" class="accordion">
                        </div>
                    <div id="master-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                        <p class="mb-0">No master accounts configured.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i> Child Accounts</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Accounts where all trades from their assigned Master will be copied.</p>
                    <div id="children-accounts-accordion" class="accordion">
                        </div>
                    <div id="children-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                        <p class="mb-0">No child accounts configured.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-card-checklist me-2"></i> Master Orders</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Manage or cancel trades initiated by Master accounts and copied to children.</p>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-danger btn-sm" id="cancelSelectedOrdersBtn"><i class="bi bi-x-circle me-1"></i> Cancel Selected</button>
                        <button class="btn btn-warning btn-sm" id="squareOffSelectedOrdersBtn"><i class="bi bi-box-arrow-in-up-right me-1"></i> Square Off Selected</button>
                        <div class="form-check form-check-inline ms-auto">
                            <input class="form-check-input" type="checkbox" id="toggleAllMasterOrdersCheckbox" onchange="window.toggleAllMasterOrders(this.checked)">
                            <label class="form-check-label" for="toggleAllMasterOrdersCheckbox">Select All</label>
                        </div>
                    </div>
                    <div id="master-orders-list" class="list-group">
                        </div>
                    <div id="master-orders-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                        <p class="mb-0">No master orders found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="childMappingModal" tabindex="-1" aria-labelledby="childMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="childMappingModalLabel">Child Orders for Master Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="child-mapping-list" class="list-group">
                    </div>
                <div id="child-mapping-empty-state" class="text-center p-3 text-muted" style="display: none;">
                    No child orders found for this master order.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="changeMasterModal" tabindex="-1" aria-labelledby="changeMasterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="changeMasterModalLabel">Change Master for Child Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="changeChildId" />
                <div class="mb-3">
                    <label for="newMasterDropdown" class="form-label">Select New Master:</label>
                    <select id="newMasterDropdown" class="form-select"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitChangeMasterBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
window.pageScripts = window.pageScripts || {};

window.pageScripts["copy-trading"] = function () {
  const brokerIcons = {{ broker_icons|tojson }};
  window.brokerIcons = brokerIcons;
  // Centralized data store (matches copy-trading (7).html structure for window properties)
  window.masterAccounts = [];
  window.childAccounts = [];
  window.exitedChildren = window.exitedChildren || {};

  function brokerIconHTML(broker) {
    const name = broker ? broker.charAt(0).toUpperCase() + broker.slice(1) : '';
    const url = brokerIcons[broker] || '/static/images/logo.png';
    return `<img src="${url}" class="rounded-circle" style="width:24px;height:24px;object-fit:contain;" alt="${name} logo">`;
  }

  // Utility for showing messages (kept alert to match original behavior)
  function showMessage(message, type = 'info') {
    alert(message);
  }

  // Generate a status badge with optional tooltip for error messages
  function statusBadge(status, errors, broker) {
    const st = (status || '').toLowerCase();
    const errList = Array.isArray(errors)
      ? errors.map(e => String(e))
      : errors
        ? [String(errors)]
        : [];
    const hasErr = errList.length > 0;
    const normalized = errList.map(e => e.toLowerCase());

    if (broker === 'dhan') {
      const showErr = normalized.some(e => e.includes('short margin') || e.includes('market closed'));
      if (!showErr) {
        return '<span class="badge bg-success">Connected</span>';
      }
    }

    if (hasErr) {
      const tip = errList.join('\n');
      const sanitized = tip.replace(/\"/g, '&quot;');
      return `<span class="badge bg-danger me-1">Error</span><i class="bi bi-info-circle" title="${sanitized}"></i>`;
    }

    if (st && st !== 'connected') {
      if (broker === 'dhan') {
        return '<span class="badge bg-success">Connected</span>';
      }
      if (st === 'pending') return '<span class="badge bg-warning text-dark">Pending</span>';
      return `<span class="badge bg-warning text-dark">${status}</span>`;
    }

    return '<span class="badge bg-success">Connected</span>';
  }

  function childHasError(acc) {
    const st = (acc.status || '').toLowerCase();
    const errList = Array.isArray(acc.errors || acc.last_error)
      ? (acc.errors || acc.last_error).map(e => String(e))
      : acc.errors || acc.last_error
        ? [String(acc.errors || acc.last_error)]
        : [];
    const normalized = errList.map(e => e.toLowerCase());

    if (acc.broker === 'dhan') {
      const showErr = normalized.some(e => e.includes('short margin') || e.includes('market closed'));
      return showErr ? true : false;
    }

    if (errList.length > 0) return true;
    if (st === 'failed') return true;
    if (st && st !== 'connected' && st !== 'pending') return true;
    return false;
  }

  // ============ Helper Modal Functions (Using Bootstrap API where applicable) ============

  window.openChangeMaster = function(childId) {
    document.getElementById("changeChildId").value = childId;
    fetch("/api/accounts")
      .then(res => res.json())
      .then(data => {
        const masters = data.masters || [];
        const dropdown = document.getElementById("newMasterDropdown");
        dropdown.innerHTML = masters.map(m => `<option value="${m.client_id}">${m.username || m.client_id}</option>`).join("");
        new bootstrap.Modal(document.getElementById("changeMasterModal")).show();
      })
      .catch(err => {
        console.error("Error fetching accounts for change master:", err);
        showMessage("Failed to load master accounts for selection.", 'danger');
      });
  };

  document.getElementById("submitChangeMasterBtn").onclick = function() {
    const child_id = document.getElementById("changeChildId").value;
    const new_master_id = document.getElementById("newMasterDropdown").value;
    fetch("/api/change-master", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ child_id, new_master_id })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
      bootstrap.Modal.getInstance(document.getElementById("changeMasterModal")).hide();
    })
    .catch(err => {
      console.error("Error changing master:", err);
      showMessage("Failed to change master account.", 'danger');
    });
  };

  window.viewChildMappings = function(masterOrderId) {
    fetch(`/api/child-orders?master_order_id=${masterOrderId}`)
      .then(res => res.json())
      .then(data => {
        const listGroup = document.getElementById("child-mapping-list");
        const emptyState = document.getElementById("child-mapping-empty-state");
        listGroup.innerHTML = "";
        if (data && data.length > 0) {
          data.forEach(row => {
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                  <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1">${row.child_client_id} <span class="badge bg-secondary ms-2">${row.status}</span></h6>
                      <small>${brokerIconHTML(row.child_broker)}</small>
                  </div>
                  <p class="mb-1 text-muted">Order ID: ${row.child_order_id}</p>
              </div>`;
          });
          emptyState.style.display = 'none';
        } else {
          listGroup.innerHTML = ``; // Clear list if no data
          emptyState.style.display = 'block';
        }
        new bootstrap.Modal(document.getElementById("childMappingModal")).show();
      })
      .catch(err => {
        console.error("Error viewing child mappings:", err);
        showMessage("Failed to load child orders.", 'danger');
      });
  };

  // ============ MAIN CONTENT LOADERS ============

  // Show modal to select master for setting as child (original manual modal creation retained)
  window.openSetAsChild = function(clientId) {
    fetch("/api/accounts")
      .then(res => res.json())
      .then(data => {
        const masters = data.masters || [];
        if (masters.length === 0) {
          showMessage("No master accounts available to link as a child. Please set up a master account first.", "warning");
          return;
        }

        let selectHtml = `
          <div class="mb-3">
            <label for="setChildMasterSelect" class="form-label">Select Master Account</label>
            <select class="form-select" id="setChildMasterSelect">
              ${masters.map(m => `<option value="${m.client_id}">${m.username || m.client_id}</option>`).join("")}
            </select>
          </div>
        `;
        // Use Bootstrap modal directly instead of manually creating divs
        const modalElement = document.getElementById('manualSetChildModal') || (() => {
            const div = document.createElement('div');
            div.id = 'manualSetChildModal';
            div.classList.add('modal', 'fade');
            div.setAttribute('tabindex', '-1');
            div.setAttribute('aria-hidden', 'true');
            div.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">Assign as Child</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmSetAsChildBtn">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            return div;
        })();

        modalElement.querySelector('.modal-body').innerHTML = selectHtml;
        const setChildModal = new bootstrap.Modal(modalElement);
        setChildModal.show();
  
        document.getElementById("confirmSetAsChildBtn").onclick = function() {
          const linked_master_id = document.getElementById("setChildMasterSelect").value;
          fetch("/api/set-child", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ client_id: clientId, linked_master_id })
          })
          .then(res => res.json())
          .then(data => {
            showMessage(data.message || "Assigned as child.");
            window.loadAccounts();
          })
          .catch(err => {
            console.error("Error setting child:", err);
            showMessage("Failed to assign as child.", 'danger');
          })
          .finally(() => {
            setChildModal.hide();
          });
        };
      })
      .catch(err => {
        console.error("Error fetching accounts for set as child:", err);
        showMessage("Failed to load accounts for child assignment.", 'danger');
      });
  };

  window.loadAccounts = function() {
    fetch("/api/accounts")
      .then(res => res.json())
      .then(data => {
        // 1. Masters
        const masters = (data.masters || []).map(m => ({
          ...m,
          role: "master"
        }));
        window.masterAccounts = masters; // Store globally for other functions

        // 2. Children (flattened, with .linked_master_id if possible)
        let children = [];
        for (const master of masters) {
          if (master.children && Array.isArray(master.children)) {
            master.children = master.children.map(child => {
              if (childHasError(child)) {
                child.copy_status = 'Off';
              }
              children.push({
                ...child,
                linked_master_id: master.client_id
              });
              return child;
            });
          }
        }
        window.childAccounts = children; // Store globally

        // --- Master Accounts Display ---
        const masterAccordion = document.getElementById("master-accounts-accordion");
        masterAccordion.innerHTML = "";
        if (masters.length === 0) {
            document.getElementById("master-empty-state").style.display = 'block';
        } else {
            document.getElementById("master-empty-state").style.display = 'none';
            masters.forEach((master, index) => {
              const accordionItem = `
                <div class="accordion-item shadow-sm mb-3 rounded">
                  <h2 class="accordion-header" id="headingMaster${master.client_id}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMaster${master.client_id}" aria-expanded="false" aria-controls="collapseMaster${master.client_id}">
                      <div class="d-flex align-items-center w-100 pe-3">
                        ${brokerIconHTML(master.broker)}
                        <span class="ms-2 fw-semibold">${master.client_id}</span>
                        <span class="text-muted ms-3 d-none d-md-inline-block">${master.username || "-"}</span>
                        <div class="ms-auto">${statusBadge(master.status, master.errors || master.last_error, master.broker)}</div>
                      </div>
                    </button>
                  </h2>
                  <div id="collapseMaster${master.client_id}" class="accordion-collapse collapse" aria-labelledby="headingMaster${master.client_id}" data-bs-parent="#master-accounts-accordion">
                    <div class="accordion-body p-3">
                      <div class="d-flex flex-wrap gap-2 mb-3">
                          <button class="btn btn-sm btn-outline-danger" onclick="window.removeMaster('${master.client_id}')">Remove Master</button>
                          <div class="vr"></div>
                          <button class="btn btn-sm btn-outline-success" onclick="window.startAllChildren('${master.client_id}')">Turn On All Child Copying</button>
                          <button class="btn btn-sm btn-outline-warning text-dark" onclick="window.stopAllChildren('${master.client_id}')">Turn Off All Child Copying</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="window.exitAllChildren('${master.client_id}')">Exit All Child Positions</button>
                      </div>
                      <ul class="nav nav-tabs master-tab-links mb-3" id="tabs-${master.client_id}" role="tablist">
                          <li class="nav-item" role="presentation">
                              <button class="nav-link active" id="tab-children-${master.client_id}-tab" data-bs-toggle="tab" data-bs-target="#master-children-${master.client_id}" type="button" role="tab" aria-controls="master-children-${master.client_id}" aria-selected="true" onclick="window.showMasterTab('${master.client_id}', 'children')">View Children</button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link" id="tab-positions-${master.client_id}-tab" data-bs-toggle="tab" data-bs-target="#master-positions-${master.client_id}" type="button" role="tab" aria-controls="master-positions-${master.client_id}" aria-selected="false" onclick="window.showMasterTab('${master.client_id}', 'positions')">Positions</button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link" id="tab-holdings-${master.client_id}-tab" data-bs-toggle="tab" data-bs-target="#master-holdings-${master.client_id}" type="button" role="tab" aria-controls="master-holdings-${master.client_id}" aria-selected="false" onclick="window.showMasterTab('${master.client_id}', 'holdings')">Holdings</button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link" id="tab-orders-${master.client_id}-tab" data-bs-toggle="tab" data-bs-target="#master-orders-book-${master.client_id}" type="button" role="tab" aria-controls="master-orders-book-${master.client.id}" aria-selected="false" onclick="window.showMasterTab('${master.client_id}', 'orders')">Order Book</button>
                          </li>
                      </ul>
                      <div class="tab-content">
                          <div class="tab-pane fade show active" id="master-children-${master.client_id}" role="tabpanel" aria-labelledby="tab-children-${master.client_id}-tab">
                              <h6>Linked Child Accounts</h6>
                              <div id="child-rows-${master.client_id}" class="list-group">
                                  </div>
                              <div id="child-rows-empty-${master.client_id}" class="text-center p-3 text-muted" style="display:none;">No child accounts linked to this master.</div>
                          </div>
                          <div class="tab-pane fade" id="master-positions-${master.client_id}" role="tabpanel" aria-labelledby="tab-positions-${master.client_id}-tab">
                            <div id="positions-body-${master.client_id}" class="list-group"></div>
                            <div id="positions-empty-${master.client_id}" class="text-center p-2 text-muted" style="display:none;">No positions for this master account.</div>
                          </div>
                          <div class="tab-pane fade" id="master-holdings-${master.client_id}" role="tabpanel" aria-labelledby="tab-holdings-${master.client_id}-tab">
                            <div id="holdings-body-${master.client_id}" class="list-group"></div>
                            <div id="holdings-empty-${master.client_id}" class="text-center p-2 text-muted" style="display:none;">No holdings for this master account.</div>
                          </div>
                          <div class="tab-pane fade" id="master-orders-book-${master.client_id}" role="tabpanel" aria-labelledby="tab-orders-${master.client_id}-tab">
                            <div id="orders-body-${master.client_id}" class="list-group"></div>
                            <div id="orders-empty-${master.client_id}" class="text-center p-2 text-muted" style="display:none;">No recent orders for this master account.</div>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
              masterAccordion.innerHTML += accordionItem;
            });
            // Manually trigger initial tab content load for the first tab (children) for all masters
            masters.forEach(master => {
                window.showMasterTab(master.client_id, 'children');
            });
        }

        // --- Children Accounts Display ---
        const childrenAccordion = document.getElementById("children-accounts-accordion");
        childrenAccordion.innerHTML = "";
        if (children.length === 0) {
            document.getElementById("children-empty-state").style.display = 'block';
        } else {
            document.getElementById("children-empty-state").style.display = 'none';
            children.forEach((child, index) => {
              const master = masters.find(m => m.client_id === child.linked_master_id) || {};
              const exited = window.exitedChildren[child.client_id];
              const disableCopy = childHasError(child) ? 'disabled' : '';
              const copyStatus = childHasError(child) ? 'Off' : child.copy_status;
              const accordionItem = `
                <div class="accordion-item shadow-sm mb-3 rounded">
                  <h2 class="accordion-header" id="headingChild${child.client_id}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChild${child.client_id}" aria-expanded="false" aria-controls="collapseChild${child.client_id}">
                      <div class="d-flex align-items-center w-100 pe-3">
                        ${brokerIconHTML(child.broker)}
                        <span class="ms-2 fw-semibold">${child.client_id}</span>
                        <span class="text-muted ms-3 d-none d-md-inline-block">Master: ${master.client_id || "-"}</span>
                        <div class="ms-auto me-3">${statusBadge(child.status, child.errors || child.last_error, child.broker)}</div>
                        <div class="form-check form-switch m-0 me-3">
                            <input type="checkbox" class="form-check-input" ${copyStatus === 'On' ? 'checked' : ''} ${disableCopy}
                              ${disableCopy ? '' : `onchange=\"window.toggleCopyTrade('${child.client_id}', '${master.client_id}', this.checked)\"` }>
                            <label class="form-check-label badge ${copyStatus === 'On' ? 'bg-success' : 'bg-secondary'}">${copyStatus || "-"}</label>
                        </div>
                        <div class="input-group input-group-sm w-auto d-inline-flex me-3">
                          <input type="number" min="0.1" step="0.1" class="form-control form-control-sm" id="mult-${child.client_id}" value="${child.multiplier || 1}" style="width: 60px;">
                          <button class="btn btn-sm btn-outline-primary" onclick="window.updateMultiplier('${child.client_id}')">Save</button>
                        </div>
                      </div>
                    </button>
                  </h2>
                  <div id="collapseChild${child.client_id}" class="accordion-collapse collapse" aria-labelledby="headingChild${child.client_id}" data-bs-parent="#children-accounts-accordion">
                    <div class="accordion-body p-3">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-sm btn-outline-success ${disableCopy ? 'disabled' : ''}" ${disableCopy ? '' : `onclick=\"window.startCopying('${child.client_id}', '${master.client_id}')\"`}>Start Copying</button>
                            <button class="btn btn-sm btn-outline-warning text-dark ${disableCopy ? 'disabled' : ''}" ${disableCopy ? '' : `onclick=\"window.stopCopying('${child.client_id}', '${master.client_id}')\"`}>Stop Copying</button>
                            <div class="vr"></div>
                            <button class="btn btn-sm btn-outline-info" onclick="window.squareOffPosition('${master.client_id}', '${child.client_id}')">Square Off Specific Symbol</button>
                            <button class="btn btn-sm btn-outline-secondary ${exited ? 'disabled' : ''}" ${exited ? '' : `onclick=\"window.exitAllPositions('${child.client_id}')\"`}>${exited ? 'Exited All Positions' : 'Exit All Positions'}</button>
                            <div class="vr"></div>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.removeChild('${child.client_id}')">Remove Child</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.openChangeMaster('${child.client_id}')">Change Master</button>
                        </div>
                        <ul class="nav nav-tabs child-tab-links mb-3" id="child-tabs-${child.client_id}" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tab-child-orders-${child.client_id}-tab" data-bs-toggle="tab" data-bs-target="#child-orders-${child.client_id}" type="button" role="tab" aria-controls="child-orders-${child.client_id}" aria-selected="true" onclick="window.showChildTab('${child.client_id}', 'orders')">Order Book</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-child-positions-${child.client_id}-tab" data-bs-toggle="tab" data-bs-target="#child-positions-${child.client_id}" type="button" role="tab" aria-controls="child-positions-${child.client_id}" aria-selected="false" onclick="window.showChildTab('${child.client_id}', 'positions')">Positions</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-child-holdings-${child.client_id}-tab" data-bs-toggle="tab" data-bs-target="#child-holdings-${child.client_id}" type="button" role="tab" aria-controls="child-holdings-${child.client.id}" aria-selected="false" onclick="window.showChildTab('${child.client_id}', 'holdings')">Holdings</button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="child-orders-${child.client_id}" role="tabpanel" aria-labelledby="tab-child-orders-${child.client_id}-tab">
                                <div id="child-orders-body-${child.client_id}" class="list-group"></div>
                                <div id="child-orders-empty-${child.client_id}" class="text-center p-2 text-muted" style="display:none;">No recent orders for this child account.</div>
                            </div>
                            <div class="tab-pane fade" id="child-positions-${child.client_id}" role="tabpanel" aria-labelledby="tab-child-positions-${child.client_id}-tab">
                                <div id="child-positions-body-${child.client_id}" class="list-group"></div>
                                <div id="child-positions-empty-${child.client_id}" class="text-center p-2 text-muted" style="display:none;">No positions for this child account.</div>
                            </div>
                            <div class="tab-pane fade" id="child-holdings-${child.client_id}" role="tabpanel" aria-labelledby="tab-child-holdings-${child.client_id}-tab">
                                <div id="child-holdings-body-${child.client_id}" class="list-group"></div>
                                <div id="child-holdings-empty-${child.client_id}" class="text-center p-2 text-muted" style="display:none;">No holdings for this child account.</div>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
              `;
              childrenAccordion.innerHTML += accordionItem;
            });
            // Initial load for child tabs
            children.forEach(child => {
                window.showChildTab(child.client_id, 'orders');
            });
        }

        // --- Unassigned Accounts Display ---
        const unassignedList = document.getElementById("unassigned-accounts-list");
        unassignedList.innerHTML = "";
        const unassignedAccounts = (data.accounts || []).filter(acc => !acc.role);
        if (unassignedAccounts.length === 0) {
            document.getElementById("unassigned-empty-state").style.display = 'block';
        } else {
            document.getElementById("unassigned-empty-state").style.display = 'none';
            unassignedAccounts.forEach(acc => {
              unassignedList.innerHTML += `
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex align-items-center mb-2">
                                ${brokerIconHTML(acc.broker)}
                                <h6 class="card-title mb-0 ms-2">${acc.client_id}</h6>
                            </div>
                            <p class="card-text text-muted mb-auto">Username: ${acc.username || "-"}</p>
                            <span class="badge bg-secondary mb-3 align-self-start">Not Assigned</span>
                            <div class="d-flex gap-2 mt-auto">
                                <button class="btn btn-sm btn-primary flex-grow-1" onclick="window.setAsMaster('${acc.client_id}')">Set as Master</button>
                                <button class="btn btn-sm btn-info flex-grow-1" onclick="window.openSetAsChild('${acc.client_id}')">Set as Child</button>
                            </div>
                        </div>
                    </div>
                </div>
              `;
            });
        }
      })
      .then(() => {
        if (typeof enableDropdowns === 'function') enableDropdowns(); // Re-enable dropdowns if needed (Bootstrap 5 handles this automatically with data-bs-toggle)
      })
      .catch(err => {
        console.error("Failed to load accounts:", err);
        showMessage("Failed to load accounts. Please check your API connection.", 'danger');
      });
  };

  function renderMasterChildrenList(masterId) {
      const master = window.masterAccounts.find(m => m.client_id === masterId);
      const kids = (master?.children || []);
      const listGroup = document.getElementById(`child-rows-${masterId}`);
      const emptyState = document.getElementById(`child-rows-empty-${masterId}`);
      if (!listGroup || !emptyState) return;

      if (kids.length === 0) {
          listGroup.innerHTML = ``;
          emptyState.style.display = 'block';
      } else {
          emptyState.style.display = 'none';
          listGroup.innerHTML = kids.map(child => {
              const copyStatus = childHasError(child) ? 'Off' : child.copy_status;
              const disableCopy = childHasError(child) ? 'disabled' : '';
              return `
              <div class="list-group-item list-group-item-action py-3 d-flex align-items-center">
                ${brokerIconHTML(child.broker)}
                <span class="ms-2 me-auto fw-semibold">${child.client_id}</span>
                <span class="text-muted d-none d-md-inline-block me-3">${child.username || "-"}</span>
                <div class="me-3">${statusBadge(child.status, child.errors || child.last_error, child.broker)}</div>
                <div class="form-check form-switch m-0 me-3">
                  <input type="checkbox" class="form-check-input" ${copyStatus === 'On' ? 'checked' : ''} ${disableCopy}
                    ${disableCopy ? '' : `onchange=\"window.toggleCopyTrade('${child.client_id}', '${masterId}', this.checked)\"` }>
                  <label class="form-check-label badge ${copyStatus === 'On' ? 'bg-success' : 'bg-secondary'}">${copyStatus || '-'}</label>
                </div>
                <span class="me-3">Mult: ${child.multiplier || 1}</span>
                <button class="btn btn-sm btn-danger" onclick="window.removeChild('${child.client_id}')">Remove</button>
              </div>
          `}).join('');
      }
  }


  window.showMasterTab = function(clientId, tabName) {
    const tabLinks = document.querySelectorAll(`#tabs-${clientId} .nav-link`);
    const tabPanes = document.querySelectorAll(`#master-children-${clientId}, #master-positions-${clientId}, #master-holdings-${clientId}, #master-orders-book-${clientId}`);
    const activeTabLink = document.getElementById(`tab-${tabName}-${clientId}-tab`); // Correct ID for tab button
    const selectedTabPane = document.getElementById(`master-${tabName === 'orders' ? 'orders-book' : tabName}-${clientId}`);
    
    // Deactivate all
    tabLinks.forEach(link => link.classList.remove('active'));
    tabPanes.forEach(pane => pane.classList.remove('show', 'active'));

    // Activate selected tab and pane
    if (activeTabLink) activeTabLink.classList.add('active');
    if (selectedTabPane) {
      selectedTabPane.classList.add('show', 'active');
      if (tabName === 'positions') {
        loadMasterPositions(clientId);
      } else if (tabName === 'orders') {
        loadMasterOrderBook(clientId);
      } else if (tabName === 'holdings') {
        loadMasterHoldings(clientId);
      } else if (tabName === 'children') {
        renderMasterChildrenList(clientId); // Re-render in case child data changed
      }
    }
  };


  function loadMasterOrderBook(clientId) {
    const listGroup = document.getElementById(`orders-body-${clientId}`);
    const emptyState = document.getElementById(`orders-empty-${clientId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading orders...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/order-book/${clientId}`)
      .then(res => res.json())
      .then(data => {
        listGroup.innerHTML = "";
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(order => {
            const status = String(order.status || '').toUpperCase();
            const statusClass = status === 'TRADED' ? 'bg-success' : status === 'REJECTED' ? 'bg-danger' : 'bg-primary';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${order.symbol || '-'} <span class="badge ${statusClass} ms-2">${status}</span></h6>
                  <small class="text-muted">${order.order_time ? new Date(order.order_time).toLocaleString() : '-'}</small>
                </div>
                <p class="mb-1">Order ID: ${order.order_id || '-'} | Side: ${order.side || '-'} | Qty: ${order.placed_qty || '-'} / ${order.filled_qty || '-'} | Avg Price: ${order.avg_price || '-'}</p>
                <small class="text-muted">Product Type: ${order.product_type || '-'} | Remarks: ${order.remarks || '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error("Order book fetch failed:", err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load order book.</div>`;
        emptyState.style.display = 'none';
        showMessage("Failed to load order book.", 'danger');
      });
  }

  function loadMasterPositions(clientId) {
    const listGroup = document.getElementById(`positions-body-${clientId}`);
    const emptyState = document.getElementById(`positions-empty-${clientId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading positions...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/portfolio/${clientId}`)
      .then(res => res.json())
      .then(positions => {
        listGroup.innerHTML = "";
        if (Array.isArray(positions) && positions.length > 0) {
          positions.forEach(pos => {
            const buyQty = pos.buyQty || pos.buy_quantity || 0;
            const sellQty = pos.sellQty || pos.sell_quantity || 0;
            const netQty = pos.netQty || pos.net_quantity || 0;
            const type = netQty >= 0 ? "BUY" : "SELL";
            const typeClass = type === 'BUY' ? 'bg-success' : 'bg-danger';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${pos.tradingSymbol || pos.symbol || '-'} <span class="badge ${typeClass} ms-2">${type}</span></h6>
                  <small class="text-muted">P/L: ${pos.profitAndLoss || pos.pnl || '-'}</small>
                </div>
                <p class="mb-1">Net Qty: ${netQty} | Buy Qty: ${buyQty} | Sell Qty: ${sellQty}</p>
                <small class="text-muted">Avg Buy Price: ${pos.buyAvg || pos.buy_avg_price || '-'} | Avg Sell Price: ${pos.sellAvg || pos.sell_avg_price || '-'} | LTP: ${pos.ltp || pos.last_price || '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error("Positions fetch failed:", err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load positions.</div>`;
        emptyState.style.display = 'none';
        showMessage("Failed to load positions.", 'danger');
    });
  }

  function loadMasterHoldings(clientId) {
    const listGroup = document.getElementById(`holdings-body-${clientId}`);
    const emptyState = document.getElementById(`holdings-empty-${clientId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading holdings...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/holdings/${clientId}`)
      .then(res => res.json())
      .then(holdings => {
        listGroup.innerHTML = "";
        if (Array.isArray(holdings) && holdings.length > 0) {
          holdings.forEach(h => {
            const getVal = (obj, keys) => {
              for (const k of keys) {
                for (const key in obj) {
                  if (key.toLowerCase() === k.toLowerCase()) return obj[key];
                }
              }
              return undefined;
            };
            const qty = getVal(h, [
              'quantity', 'qty', 'holdqty', 'holdingsquantity', 't1_quantity',
              'dp_qty', 'totalqty', 'availableqty', 'dpqty', 't1qty', 'collateralqty'
            ]) || 0;
            const avg = getVal(h, [
              'buyavg', 'buy_avg_price', 'average_price', 'avg_price', 'purchaseprice', 'avgcostprice'
            ]);
            const ltp = getVal(h, ['ltp','last_price','last_traded_price']);
            let pnl = getVal(h, [
              'profitandloss',
              'pnl',
              'unrealizedprofit',
              'unrealisedprofit'
            ]);
            if (pnl === undefined && ltp !== undefined && avg !== undefined) {
              const qtyNum = parseFloat(qty) || 0;
              const ltpNum = parseFloat(ltp);
              const avgNum = parseFloat(avg);
              if (!isNaN(ltpNum) && !isNaN(avgNum)) {
                pnl = ((ltpNum - avgNum) * qtyNum).toFixed(2);
              }
            }
            const sym = getVal(h, ['tradingSymbol','tradingsymbol','symbol','tsym']) || '-';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${sym}</h6>
                  <small class="text-muted">P/L: ${pnl !== undefined ? pnl : '-'}</small>
                </div>
                <p class="mb-1">Qty: ${qty} | Avg Price: ${avg !== undefined ? avg : '-'}</p>
                <small class="text-muted">LTP: ${ltp !== undefined ? ltp : '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error("Holdings fetch failed:", err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load holdings.</div>`;
        emptyState.style.display = 'none';
        showMessage("Failed to load holdings for child account.", 'danger');
    });
  }

  // --- Child Tabs ---
  window.showChildTab = function(childId, tabName) {
    const tabLinks = document.querySelectorAll(`#child-tabs-${childId} .nav-link`);
    const tabPanes = document.querySelectorAll(`#child-orders-${childId}, #child-positions-${childId}, #child-holdings-${childId}`);
    const activeTabLink = document.getElementById(`tab-child-${tabName}-${childId}-tab`); // Correct ID for tab button
    const selectedTabPane = document.getElementById(`child-${tabName}-${childId}`);
    
    // Deactivate all
    tabLinks.forEach(link => link.classList.remove('active'));
    tabPanes.forEach(pane => pane.classList.remove('show', 'active'));

    // Activate selected tab and pane
    if (activeTabLink) activeTabLink.classList.add('active');
    if (selectedTabPane) {
      selectedTabPane.classList.add('show', 'active');
      if (tabName === 'positions') {
        loadChildPositions(childId);
      } else if (tabName === 'orders') {
        loadChildOrderBook(childId);
      } else if (tabName === 'holdings') {
        loadChildHoldings(childId);
      }
    }
  };

  function loadChildOrderBook(childId) {
    const listGroup = document.getElementById(`child-orders-body-${childId}`);
    const emptyState = document.getElementById(`child-orders-empty-${childId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading orders...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/order-book/${childId}`)
      .then(res => res.json())
      .then(data => {
        listGroup.innerHTML = "";
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(order => {
            const status = String(order.status || '').toUpperCase();
            const statusClass = status === 'TRADED' ? 'bg-success' : status === 'REJECTED' ? 'bg-danger' : 'bg-primary';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${order.symbol || '-'} <span class="badge ${statusClass} ms-2">${status}</span></h6>
                  <small class="text-muted">${order.order_time ? new Date(order.order_time).toLocaleString() : '-'}</small>
                </div>
                <p class="mb-1">Order ID: ${order.order_id || '-'} | Side: ${order.side || '-'} | Qty: ${order.placed_qty || '-'} / ${order.filled_qty || '-'} | Avg Price: ${order.avg_price || '-'}</p>
                <small class="text-muted">Product Type: ${order.product_type || '-'} | Remarks: ${order.remarks || '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error('Child order book fetch failed:', err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load order book.</div>`;
        emptyState.style.display = 'none';
        showMessage('Failed to load order book.', 'danger');
      });
  }

  function loadChildPositions(childId) {
    const listGroup = document.getElementById(`child-positions-body-${childId}`);
    const emptyState = document.getElementById(`child-positions-empty-${childId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading positions...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/portfolio/${childId}`)
      .then(res => res.json())
      .then(positions => {
        listGroup.innerHTML = "";
        if (Array.isArray(positions) && positions.length > 0) {
          positions.forEach(pos => {
            const buyQty = pos.buyQty || pos.buy_quantity || 0;
            const sellQty = pos.sellQty || pos.sell_quantity || 0;
            const netQty = pos.netQty || pos.net_quantity || 0;
            const type = netQty >= 0 ? 'BUY' : 'SELL';
            const typeClass = type === 'BUY' ? 'bg-success' : 'bg-danger';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${pos.tradingSymbol || pos.symbol || '-'} <span class="badge ${typeClass} ms-2">${type}</span></h6>
                  <small class="text-muted">P/L: ${pos.profitAndLoss || pos.pnl || '-'}</small>
                </div>
                <p class="mb-1">Net Qty: ${netQty} | Buy Qty: ${buyQty} | Sell Qty: ${sellQty}</p>
                <small class="text-muted">Avg Buy Price: ${pos.buyAvg || pos.buy_avg_price || '-'} | Avg Sell Price: ${pos.sellAvg || pos.sell_avg_price || '-'} | LTP: ${pos.ltp || pos.last_price || '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error('Child positions fetch failed:', err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load positions.</div>`;
        emptyState.style.display = 'none';
        showMessage('Failed to load positions.', 'danger');
      });
  }

  function loadChildHoldings(childId) {
    const listGroup = document.getElementById(`child-holdings-body-${childId}`);
    const emptyState = document.getElementById(`child-holdings-empty-${childId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading holdings...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/holdings/${childId}`)
      .then(res => res.json())
      .then(holdings => {
        listGroup.innerHTML = "";
        if (Array.isArray(holdings) && holdings.length > 0) {
          holdings.forEach(h => {
            const getVal = (obj, keys) => {
              for (const k of keys) {
                for (const key in obj) {
                  if (key.toLowerCase() === k.toLowerCase()) return obj[key];
                }
              }
              return undefined;
            };
            const qty = getVal(h, [
              'quantity', 'qty', 'holdqty', 'holdingsquantity', 't1_quantity',
              'dp_qty', 'totalqty', 'availableqty', 'dpqty', 't1qty', 'collateralqty'
            ]) || 0;
            const avg = getVal(h, [
              'buyavg', 'buy_avg_price', 'average_price', 'avg_price', 'purchaseprice', 'avgcostprice'
            ]);
            const ltp = getVal(h, ['ltp','last_price','last_traded_price']);
            const pnl = getVal(h, ['profitandloss','pnl','unrealizedprofit','unrealisedprofit']);
            const sym = getVal(h, ['tradingSymbol','tradingsymbol','symbol','tsym']) || '-';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${sym}</h6>
                  <small class="text-muted">P/L: ${pnl !== undefined ? pnl : '-'}</small>
                </div>
                <p class="mb-1">Qty: ${qty} | Avg Price: ${avg !== undefined ? avg : '-'}</p>
                <small class="text-muted">LTP: ${ltp !== undefined ? ltp : '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error('Child holdings fetch failed:', err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load holdings.</div>`;
        emptyState.style.display = 'none';
        showMessage('Failed to load holdings for child account.', 'danger');
      });
  }

  // --- Master Orders Display ---
  window.loadMasterOrders = function() {
    fetch('/api/master-orders')
      .then(res => res.json())
      .then(data => {
        const listGroup = document.getElementById("master-orders-list");
        const emptyState = document.getElementById("master-orders-empty-state");
        listGroup.innerHTML = "";
        if (Array.isArray(data) && data.length > 0) {
          emptyState.style.display = 'none';
          data.forEach(order => {
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input master-order-checkbox" value="${order.master_order_id}" id="masterOrderCheck${order.master_order_id}">
                    <label class="form-check-label fw-semibold" for="masterOrderCheck${order.master_order_id}">${order.symbol}</label>
                  </div>
                  <span class="badge bg-primary">${order.status}</span>
                </div>
                <p class="mb-1 text-muted">Order ID: ${order.master_order_id} | Children: ${order.total_children}</p>
                <button class="btn btn-sm btn-info mt-2" onclick="window.viewChildMappings('${order.master_order_id}')"><i class="bi bi-eye-fill"></i> View Children</button>
              </div>`;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
        // Reset select all checkbox
        document.getElementById("toggleAllMasterOrdersCheckbox").checked = false;
      })
      .then(() => {
        // No longer need enableDropdowns as Bootstrap handles this
      })
      .catch(err => {
        console.error("Error loading master orders:", err);
        document.getElementById("master-orders-list").innerHTML = `<div class="p-3 text-center text-danger">Failed to load master orders.</div>`;
        document.getElementById("master-orders-empty-state").style.display = 'none';
        showMessage("Failed to load master orders.", 'danger');
      });
  };

  window.toggleAllMasterOrders = function(isChecked) {
    document.querySelectorAll(".master-order-checkbox").forEach(cb => cb.checked = isChecked);
    // No longer a separate "master-orders-select-all" element in new design, only one toggle
    // document.getElementById("master-orders-select-all").checked = isChecked;
    // document.getElementById("toggleAllMasterOrdersCheckbox").checked = isChecked; // This is the source of truth
  };

  // --- Cancel/Square Off Actions ---
  document.getElementById("cancelSelectedOrdersBtn").onclick = function() {
    const selected = [...document.querySelectorAll(".master-order-checkbox:checked")].map(cb => cb.value);
    if (selected.length === 0) return showMessage("No orders selected to cancel.", 'warning');

    if (!confirm(`Are you sure you want to cancel ${selected.length} selected order(s)?`)) return;

    // Use Promise.all to handle multiple fetches and then reload once
    Promise.all(selected.map(id => 
      fetch("/api/cancel-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ master_order_id: id })
      })
      .then(res => res.json())
      .then(data => {
        showMessage(data.message); // Show message for each operation or collect messages
        return data;
      })
      .catch(err => {
        console.error(`Error cancelling order ${id}:`, err);
        showMessage(`Failed to cancel order ${id}.`, 'danger');
        return { error: true, message: `Failed to cancel order ${id}.` };
      })
    ))
    .then(() => {
      window.loadMasterOrders(); // Reload orders after all operations
      window.loadAccounts(); // Also reload accounts as status might change
    });
  };

  document.getElementById("squareOffSelectedOrdersBtn").onclick = function() {
    const selected = [...document.querySelectorAll(".master-order-checkbox:checked")].map(cb => cb.value);
    if (selected.length === 0) return showMessage("No orders selected to square off.", 'warning');

    if (!confirm(`Are you sure you want to square off ${selected.length} selected order(s)? This will attempt to exit positions in all linked children.`)) return;

    // Use Promise.all to handle multiple fetches and then reload once
    Promise.all(selected.map(id => 
      fetch("/api/master-squareoff", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ master_order_id: id })
      })
      .then(res => res.json())
      .then(data => {
        showMessage(data.message);
        return data;
      })
      .catch(err => {
        console.error(`Error squaring off order ${id}:`, err);
        showMessage(`Failed to square off order ${id}.`, 'danger');
        return { error: true, message: `Failed to square off order ${id}.` };
      })
    ))
    .then(() => {
      window.loadMasterOrders();
      window.loadAccounts(); // Reload accounts to update child positions
    });
  };

  // --- Master/Child Linking and Copying ---
  window.setAsMaster = function(clientId) {
    if (!confirm(`Are you sure you want to set ${clientId} as a Master account?`)) return;
    fetch("/api/set-master", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error setting as master:", err);
      showMessage("Failed to set as master.", 'danger');
    });
  };

  window.removeMaster = function(clientId) {
    if (!confirm(`WARNING: Removing master account ${clientId} will also unlink all its child accounts. Are you sure?`)) return;
    fetch("/api/remove-master", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error removing master:", err);
      showMessage("Failed to remove master.", 'danger');
    });
  };

  window.startCopying = function(childId, masterId) {
    fetch("/api/start-copy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: childId, master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts(); // Reload to update UI status
    })
    .catch(err => {
      console.error("Error starting copy:", err);
      showMessage("Failed to start copying.", 'danger');
    });
  };

  window.stopCopying = function(childId, masterId) {
    fetch("/api/stop-copy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: childId, master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts(); // Reload to update UI status
    })
    .catch(err => {
      console.error("Error stopping copy:", err);
      showMessage("Failed to stop copying.", 'danger');
    });
  };

  window.toggleCopyTrade = function(childId, masterId, isOn) {
    if (isOn) {
      window.startCopying(childId, masterId);
    } else {
      window.stopCopying(childId, masterId);
    }
  };

  window.startAllChildren = function(masterId) {
    if (!confirm(`Are you sure you want to turn ON copy trading for ALL children linked to Master ${masterId}?`)) return;
    fetch('/api/start-copy-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error starting all children:", err);
      showMessage("Failed to start copying for all children.", 'danger');
    });
  };

  window.stopAllChildren = function(masterId) {
    if (!confirm(`Are you sure you want to turn OFF copy trading for ALL children linked to Master ${masterId}?`)) return;
    fetch('/api/stop-copy-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error stopping all children:", err);
      showMessage("Failed to stop copying for all children.", 'danger');
    });
  };

  window.removeChild = function(clientId) {
    if (!confirm(`Are you sure you want to remove child account ${clientId}? This will stop all copy trading for this account.`)) return;
    fetch("/api/remove-child", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      delete window.exitedChildren[clientId]; // Remove from exitedChildren if it was marked
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error removing child:", err);
      showMessage("Failed to remove child.", 'danger');
    });
  };

  window.squareOffPosition = function(masterId, childId) {
    fetch("/api/portfolio/" + childId)
      .then(res => res.json())
      .then(data => {
        const positions = data || [];
        const activePositions = positions.filter(pos => (pos.netQty || pos.net_quantity) !== 0);
        const symbols = activePositions.map(pos => pos.tradingSymbol || pos.symbol);

        if (symbols.length === 0) {
          showMessage(`No active positions found for child ${childId}.`, 'info');
          return;
        }

        // Use Bootstrap modal directly instead of manually creating divs
        const modalElement = document.getElementById('squareOffSymbolModal') || (() => {
            const div = document.createElement('div');
            div.id = 'squareOffSymbolModal';
            div.classList.add('modal', 'fade');
            div.setAttribute('tabindex', '-1');
            div.setAttribute('aria-hidden', 'true');
            div.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">Square Off Position</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Select a symbol to square off for child account <strong>${childId}</strong>:</p>
                            <div class="mb-3">
                                <label for="squareOffSymbol" class="form-label">Symbol:</label>
                                <select id="squareOffSymbol" class="form-select"></select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmSquareOffBtn">Confirm Square Off</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            return div;
        })();

        const symbolOptions = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
        modalElement.querySelector('#squareOffSymbol').innerHTML = symbolOptions;
        const squareOffModal = new bootstrap.Modal(modalElement);
        squareOffModal.show();

        document.getElementById("confirmSquareOffBtn").onclick = function() {
          const symbol = document.getElementById("squareOffSymbol").value;
          if (!confirm(`Are you sure you want to square off ${symbol} for child ${childId}?`)) {
            squareOffModal.hide();
            return;
          }

          // Show spinner within the modal or as a global overlay
          const spinnerOverlay = document.createElement('div');
          spinnerOverlay.classList.add('modal-backdrop', 'fade', 'show', 'd-flex', 'align-items-center', 'justify-content-center', 'position-fixed', 'top-0', 'start-0', 'w-100', 'h-100');
          spinnerOverlay.style.zIndex = 1050; // Ensure it's above other modals
          spinnerOverlay.innerHTML = `
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="text-light ms-2">Processing...</p>
          `;
          document.body.appendChild(spinnerOverlay);

          fetch("/api/square-off", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              client_id: childId,
              symbol: symbol,
              is_master: false
            })
          })
          .then(res => res.json())
          .then(data => {
            showMessage(data.message + (data.details ? "\nDetails:\n" + data.details.join("\n") : ''));
            window.loadAccounts();
          })
          .catch(err => {
            console.error("Error squaring off position:", err);
            showMessage("Failed to square off positions.", 'danger');
          })
          .finally(() => {
            document.body.removeChild(spinnerOverlay);
            squareOffModal.hide();
          });
        };
      })
      .catch(err => {
        console.error("Failed to load portfolio for square off:", err);
        showMessage("Failed to load holdings for child account.", 'danger');
      });
  };


  window.exitAllPositions = function(childId) {
    if (window.exitedChildren[childId]) {
      showMessage("Child positions already exited for this session.", 'info');
      return;
    }
    if (!confirm(`Are you sure you want to exit ALL open positions for child account ${childId}?`)) return;

    fetch('/api/exit-child-positions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ child_id: childId })
    })
    .then(res => res.json())
    .then(data => {
      const err = data.failed_count && data.failed_count > 0;
      showMessage(data.message, err ? 'danger' : 'success');
      if (data.exited) {
        window.exitedChildren[childId] = true;
      }
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error exiting all positions:", err);
      showMessage("Failed to exit all positions.", 'danger');
    });
  };

  window.exitAllChildren = function(masterId) {
    const toExit = (window.childAccounts || [])
      .filter(c => c.linked_master_id === masterId && !window.exitedChildren[c.client_id])
      .map(c => c.client_id);
    if (toExit.length === 0) {
      showMessage('All linked children for this master are already exited or have no positions to exit.', 'info');
      return;
    }
    if (!confirm(`Are you sure you want to attempt to exit ALL open positions for the ${toExit.length} linked child account(s) of Master ${masterId}?`)) return;

    fetch('/api/exit-all-children', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_id: masterId, child_ids: toExit })
    })
    .then(res => res.json())
    .then(data => {
      const failed = Array.isArray(data.failed_children) && data.failed_children.length > 0;
      showMessage(data.message, failed ? 'danger' : 'success');
      if (Array.isArray(data.exited_children)) {
        data.exited_children.forEach(id => { window.exitedChildren[id] = true; });
      }
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error exiting all children positions:", err);
      showMessage("Failed to exit all children positions.", 'danger');
    });
  };

  window.updateMultiplier = function(clientId) {
    const inputElement = document.getElementById(`mult-${clientId}`);
    const newMultiplier = parseFloat(inputElement.value);

    if (isNaN(newMultiplier) || newMultiplier < 0.1) {
      showMessage("Please enter a valid multiplier (minimum 0.1).", 'warning');
      inputElement.value = inputElement.defaultValue; // Reset to previous valid value
      return;
    }
    if (!confirm(`Confirm update multiplier for ${clientId} to ${newMultiplier}?`)) {
        inputElement.value = inputElement.defaultValue; // Reset if cancelled
        return;
    }

    fetch("/api/update-multiplier", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId, multiplier: newMultiplier })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message || "Multiplier updated successfully.");
      // No need to reload all accounts, just update the default value for the input
      // And the multiplier shown in the master's children list
      window.loadAccounts(); // Reload to update master's children list and child's own section
    })
    .catch(err => {
      console.error("Error updating multiplier:", err);
      showMessage("Failed to update multiplier.", 'danger');
      inputElement.value = inputElement.defaultValue; // Reset on error
    });
  };

  // --- INIT ON LOAD ---
  // These calls will now fetch and populate the sections
  window.loadAccounts();
  window.loadMasterOrders();
};

// This ensures the main page script function runs even if this script is loaded
// after the DOM has already finished loading (e.g. when navigating via SPA).
function initCopyTradingPage() {
  if (window.pageScripts && typeof window.pageScripts["copy-trading"] === 'function') {
    window.pageScripts["copy-trading"]();
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCopyTradingPage);
} else {
  initCopyTradingPage();
}
</script>
{% endblock %}
