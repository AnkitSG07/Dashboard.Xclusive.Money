{% extends "layout.html" %}
{% block title %}Copy Trading - DhanBot{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    :root {
      --bs-primary: #007bff; /* A standard primary blue */
      --bs-secondary: #6c757d;
      --bs-success: #28a745;
      --bs-info: #17a2b8;
      --bs-warning: #ffc107;
      --bs-danger: #dc3545;
      --bs-light: #f8f9fa;
      --bs-dark: #343a40;

      --bs-body-bg: #f4f7f6; /* Light gray background for the whole page */
      --bs-body-color: #333; /* Darker text for readability */

      /* Customizing shadows for a softer look */
      --bs-box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
      --bs-box-shadow-sm: 0 .125rem .25rem rgba(0,0,0,.06);
      --bs-box-shadow-lg: 0 .5rem 1rem rgba(0,0,0,.15);
      --bs-box-shadow-inset: inset 0 1px 2px rgba(0,0,0,.075);

      /* Rounded corners */
      --bs-border-radius: .5rem; /* Slightly more rounded */
      --bs-border-radius-sm: .3rem;
      --bs-border-radius-lg: .75rem;
    }

    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
    }

    .card {
      border-radius: var(--bs-border-radius-lg); /* More pronounced rounded corners for cards */
      box-shadow: var(--bs-box-shadow);
      transition: all 0.3s ease; /* Smooth transition for hover effects */
    }

    .card:hover {
      box-shadow: var(--bs-box-shadow-lg); /* Lift effect on hover */
      transform: translateY(-2px);
    }

    .card-header {
      border-top-left-radius: var(--bs-border-radius-lg);
      border-top-right-radius: var(--bs-border-radius-lg);
      font-weight: 600;
      border-bottom: none; /* Remove default header border */
    }

    .hero-section {
      background: linear-gradient(45deg, var(--bs-primary), #0d6efd); /* Gradient background for hero */
      color: white;
      padding: 2.5rem !important;
      border-radius: var(--bs-border-radius-lg) !important;
      box-shadow: var(--bs-box-shadow-lg) !important;
    }

    .hero-section h3, .hero-section p {
        color: white !important; /* Ensure text is white on gradient */
    }

    .hero-section a {
        color: rgba(255, 255, 255, 0.8) !important;
        text-decoration: underline !important;
    }
    .hero-section a:hover {
        color: white !important;
    }

    .btn {
      border-radius: var(--bs-border-radius-sm);
    }

    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-outline-success,
    .btn-outline-warning,
    .btn-outline-info,
    .btn-outline-danger,
    .btn-outline-dark {
        transition: all 0.2s ease; /* Smooth hover for outline buttons */
    }

    .accordion-item {
      border: none; /* Remove default accordion borders */
      border-radius: var(--bs-border-radius);
      box-shadow: var(--bs-box-shadow-sm);
      margin-bottom: 1rem; /* Space between accordion items */
      overflow: hidden; /* Ensure rounded corners clip content */
    }

    .accordion-button {
      background-color: white;
      border-radius: var(--bs-border-radius);
      transition: background-color 0.2s ease;
      font-weight: 500;
      padding: 1rem 1.25rem; /* Adjust padding */
    }

    .accordion-button:not(.collapsed) {
      background-color: var(--bs-light); /* Slightly different background for expanded */
      color: var(--bs-primary);
      box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.125);
    }

    .accordion-body {
      background-color: #fcfdff; /* Lighter background for accordion content */
      border-top: 1px solid rgba(0,0,0,.05); /* Subtle separator */
    }

    .list-group-item {
      border-radius: var(--bs-border-radius-sm);
      margin-bottom: .5rem; /* Space between list items */
      border: 1px solid rgba(0,0,0,.05);
      background-color: white;
      transition: all 0.2s ease;
    }

    .list-group-item:hover {
        background-color: var(--bs-light);
        box-shadow: var(--bs-box-shadow-sm);
    }

    .badge {
      font-weight: 600;
      padding: .4em .7em;
      border-radius: .25rem;
    }

    .form-check-input:checked {
      background-color: var(--bs-primary);
      border-color: var(--bs-primary);
    }

    /* Adjust modal header background for consistent theme */
    .modal-header.bg-primary,
    .modal-header.bg-info {
        background-color: var(--bs-primary) !important;
    }

    /* Specific adjustments for input groups in tables */
    .input-group-sm .form-control, .input-group-sm .btn {
        height: calc(1.5em + .5rem + 2px); /* Bootstrap's height for sm inputs */
    }

    /* Specific styling for the custom backdrop used in modals for spinner/symbol select */
    .modal-backdrop.d-flex {
        background-color: rgba(0, 0, 0, 0.65); /* Darker backdrop for loading */
        backdrop-filter: blur(3px); /* Optional blur effect */
    }

    /* --- FIXES FOR MOBILE VIEW & MULTIPLIER --- */

    /* Multiplier input and button on the same line and responsive */
    .multiplier-control {
        display: inline-flex; /* Prevent block-level expansion */
        align-items: center;
        gap: .5rem; /* Space between input and button */
        flex-wrap: nowrap; /* Keep them on one line */
        width: auto; /* Allow content to dictate width */
        flex-shrink: 0; /* Avoid shrinking that can cause wrapping */
    }

    .multiplier-control .form-control {
        max-width: 80px; /* Limit width of multiplier input */
        text-align: center;
    }

    /* Ensure list-group-item content flows well on small screens */
    .list-group-item .d-flex {
        flex-wrap: wrap; /* Allow content inside list items to wrap */
    }

    .list-group-item .d-flex > * {
        margin-bottom: .25rem; /* Small space for wrapped items */
    }

    .list-group-item .d-flex > *:last-child {
        margin-bottom: 0;
    }

    /* Adjust spacing and font size for details within list items on smaller screens */
    .list-group-item p,
    .list-group-item small {
        font-size: 0.875rem; /* Slightly smaller text */
        line-height: 1.3;
    }

    @media (max-width: 767.98px) { /* Small devices (landscape phones, less than 768px) */
        /* Updated: Use flex-nowrap to keep elements on one line, and adjust spacing. */
        .accordion-button .d-flex.w-100.pe-3 {
            flex-wrap: nowrap; /* Prevent wrapping to keep controls on one line */
            justify-content: flex-start; /* Align content to the start */
            text-align: left;
            overflow-x: auto; /* Add horizontal scroll if necessary */
        }
        .accordion-button .d-flex.w-100.pe-3 > * {
            flex-shrink: 0; /* Prevent elements from shrinking */
            margin-bottom: 0;
        }
        .accordion-button .d-flex.w-100.pe-3 .ms-auto {
            margin-left: auto !important;
            margin-right: 0 !important;
        }

        .accordion-button .d-none.d-md-inline-block {
            display: block !important; /* Show username on mobile */
            font-size: 0.85rem;
        }

        /* Remove the width 100% rule for multiplier control on mobile */
        .accordion-button .multiplier-control {
            width: auto;
        }

        .accordion-body .d-flex.flex-wrap.gap-2.mb-3 {
            justify-content: center;
        }

        .accordion-body .d-flex.flex-wrap.gap-2.mb-3 .btn {
            flex-grow: 1; /* Make buttons expand on mobile */
            max-width: 48%; /* Allow two buttons per row */
        }

        .nav-tabs .nav-item {
            flex-grow: 1; /* Make tabs equally wide */
            text-align: center;
        }
        .nav-tabs .nav-link {
            padding: .75rem .5rem; /* Smaller padding for tabs */
            font-size: 0.875rem;
        }

        /* Adjust list-group items for better mobile readability */
        .list-group-item p,
        .list-group-item small {
            word-break: break-word; /* Break long words */
        }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card hero-section">
                <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-md-between">
                    <div class="mb-3 mb-md-0">
                        <h3 class="mb-2"><i class="bi bi-people-fill me-2"></i> Copy Trading Setup</h3>
                        <p class="mb-0">Manage your trading accounts for copy trading. Use the <a href="/Add-Account" class="text-decoration-none fw-semibold">Account Configuration</a> page to add new accounts. Below, you can assign roles, link/unlink accounts, and control the copying process.</p>
                    </div>
                    <a href="/Add-Account" class="btn btn-light text-primary btn-lg mt-3 mt-md-0 shadow-sm">
                        <i class="bi bi-plus-circle me-2"></i> Configure New Account
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i> Unassigned Accounts</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Accounts added but not yet assigned a role (Master or Child). Assign their role below to get started.</p>
                    <div id="unassigned-accounts-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                        </div>
                    <div id="unassigned-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-check-circle-fill fs-3 text-success mb-2"></i>
                        <p class="mb-0">No unassigned accounts. All accounts have a role.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i> Master Accounts</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Accounts selected to replicate their trades across linked child accounts.</p>
                    <div id="master-accounts-accordion" class="accordion">
                        </div>
                    <div id="master-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                        <p class="mb-0">No master accounts configured.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i> Child Accounts</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Accounts where all trades from their assigned Master will be copied.</p>
                    <div id="children-accounts-accordion" class="accordion">
                        </div>
                    <div id="children-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                        <p class="mb-0">No child accounts configured.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-card-checklist me-2"></i> Master Orders</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Manage or cancel trades initiated by Master accounts and copied to children.</p>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-danger btn-sm" id="cancelSelectedOrdersBtn"><i class="bi bi-x-circle me-1"></i> Cancel Selected</button>
                        <button class="btn btn-warning btn-sm" id="squareOffSelectedOrdersBtn"><i class="bi bi-box-arrow-in-up-right me-1"></i> Square Off Selected</button>
                        <div class="form-check form-check-inline ms-auto">
                            <input class="form-check-input" type="checkbox" id="toggleAllMasterOrdersCheckbox" onchange="window.toggleAllMasterOrders(this.checked)">
                            <label class="form-check-label" for="toggleAllMasterOrdersCheckbox">Select All</label>
                        </div>
                    </div>
                    <div id="master-orders-list" class="list-group">
                        </div>
                    <div id="master-orders-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                        <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                        <p class="mb-0">No master orders found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="childMappingModal" tabindex="-1" aria-labelledby="childMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="childMappingModalLabel">Child Orders for Master Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="child-mapping-list" class="list-group">
                    </div>
                <div id="child-mapping-empty-state" class="text-center p-3 text-muted" style="display: none;">
                    No child orders found for this master order.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="changeMasterModal" tabindex="-1" aria-labelledby="changeMasterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="changeMasterModalLabel">Change Master for Child Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="changeChildId" />
                <div class="mb-3">
                    <label for="newMasterDropdown" class="form-label">Select New Master:</label>
                    <select id="newMasterDropdown" class="form-select"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitChangeMasterBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
window.pageScripts = window.pageScripts || {};

window.pageScripts["copy-trading"] = function () {
  const brokerIcons = {{ broker_icons|tojson }};
  window.brokerIcons = brokerIcons;
  // Centralized data store (matches copy-trading (7).html structure for window properties)
  window.masterAccounts = [];
  window.childAccounts = [];
  window.exitedChildren = window.exitedChildren || {};
  // Order book caches to support incremental loading
  window.masterOrderBooks = {};
  window.masterOrderIndex = {};
  window.childOrderBooks = {};
  window.childOrderIndex = {};
  const ORDER_PAGE_SIZE = 20;

  function orderItemHtml(order) {
    const status = String(order.status || '').toUpperCase();
    const statusClass = status === 'TRADED' ? 'bg-success'
                     : status === 'REJECTED' ? 'bg-danger'
                     : 'bg-primary';
    return `
      <div class="list-group-item list-group-item-action py-3">
        <div class="d-flex w-100 justify-content-between flex-wrap">
          <h6 class="mb-1">${order.symbol || '-'} <span class="badge ${statusClass} ms-2">${status}</span></h6>
          <small class="text-muted mt-1 mt-md-0">${order.order_time ? new Date(order.order_time).toLocaleString() : '-'}</small>
        </div>
        <p class="mb-1">Order ID: ${order.order_id || '-'} | Side: ${order.side || '-'} | Qty: ${order.placed_qty || '-'} / ${order.filled_qty || '-'} | Type: ${order.order_type || order.type || '-'} | Avg Price: ${order.avg_price || '-'}</p>
        <small class="text-muted">Product Type: ${order.product_type || '-'} | Remarks: ${order.remarks || '-'}</small>
      </div>
    `;
  }
  
  function brokerIconHTML(broker) {
    const name = broker ? broker.charAt(0).toUpperCase() + broker.slice(1) : '';
    const url = brokerIcons[broker] || '/static/images/logo.png';
    return `<img src="${url}" class="rounded-circle" style="width:24px;height:24px;object-fit:contain;" alt="${name} logo">`;
  }

  // Utility for showing messages (kept alert to match original behavior)
  function showMessage(message, type = 'info') {
    alert(message);
  }

  // Generate a status badge with optional tooltip for error messages
  function statusBadge(status, errors, broker) {
    const st = (status || '').toLowerCase();
    const errList = Array.isArray(errors)
      ? errors.map(e => String(e))
      : errors
        ? [String(errors)]
        : [];
    const hasErr = errList.length > 0;
    const normalized = errList.map(e => e.toLowerCase());

    if (broker === 'dhan') {
      const showErr = normalized.some(e => e.includes('short margin') || e.includes('market closed'));
      if (!showErr) {
        return '<span class="badge bg-success">LIVE</span>';
      }
    }
    if (broker === 'zerodha') {
      const ignoreErr = normalized.some(e =>
        e.includes('failed to fetch orders') &&
        e.includes('"status":"success"') &&
        e.includes('profile')
      );
      if (ignoreErr) {
        return '<span class="badge bg-success">LIVE</span>';
      }
    }
    
    if (hasErr) {
      const tip = errList.join('\n');
      const sanitized = tip.replace(/\"/g, '&quot;');
      return `<span class="badge bg-danger me-1">Error</span><i class="bi bi-info-circle" title="${sanitized}"></i>`;
    }

    if (st && !['live', 'connected'].includes(st)) {
      if (broker === 'dhan') {
        return '<span class="badge bg-success">LIVE</span>';
      }
      if (st === 'pending') return '<span class="badge bg-warning text-dark">Pending</span>';
      return `<span class="badge bg-warning text-dark">${status}</span>`;
    }
    if (st === 'connected') {
      return '<span class="badge bg-success">Connected</span>';
    }
    
    return '<span class="badge bg-success">LIVE</span>';
  }

  function childHasError(acc) {
    const st = (acc.status || '').toLowerCase();
    const errList = Array.isArray(acc.errors || acc.last_error)
      ? (acc.errors || acc.last_error).map(e => String(e))
      : acc.errors || acc.last_error
        ? [String(acc.errors || acc.last_error)]
        : [];
    const normalized = errList.map(e => e.toLowerCase());

    if (acc.broker === 'dhan') {
      const showErr = normalized.some(e => e.includes('short margin') || e.includes('market closed'));
      return showErr ? true : false;
    }
    if (acc.broker === 'zerodha') {
      const ignoreErr = normalized.some(e =>
        e.includes('failed to fetch orders') &&
        e.includes('"status":"success"') &&
        e.includes('profile')
      );
      if (ignoreErr) return false;
    }
    
    if (errList.length > 0) return true;
    if (st === 'failed') return true;
    if (st && !['live', 'connected', 'pending'].includes(st)) return true;
    return false;
  }

  // ============ Helper Modal Functions (Using Bootstrap API where applicable) ============

  window.openChangeMaster = function(childId) {
    document.getElementById("changeChildId").value = childId;
    fetch("/api/accounts")
      .then(res => res.json())
      .then(data => {
        const masters = data.masters || [];
        const dropdown = document.getElementById("newMasterDropdown");
        dropdown.innerHTML = masters.map(m => `<option value="${m.client_id || ''}">${m.username || m.client_id || 'N/A'}</option>`).join(""); // Added checks
        new bootstrap.Modal(document.getElementById("changeMasterModal")).show();
      })
      .catch(err => {
        console.error("Error fetching accounts for change master:", err);
        showMessage("Failed to load master accounts for selection.", 'danger');
      });
  };

  document.getElementById("submitChangeMasterBtn").onclick = function() {
    const child_id = document.getElementById("changeChildId").value;
    const new_master_id = document.getElementById("newMasterDropdown").value;
    fetch("/api/change-master", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ child_id, new_master_id })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
      bootstrap.Modal.getInstance(document.getElementById("changeMasterModal")).hide();
    })
    .catch(err => {
      console.error("Error changing master:", err);
      showMessage("Failed to change master account.", 'danger');
    });
  };

  window.viewChildMappings = function(masterOrderId) {
    fetch(`/api/child-orders?master_order_id=${masterOrderId}`)
      .then(res => res.json())
      .then(data => {
        const listGroup = document.getElementById("child-mapping-list");
        const emptyState = document.getElementById("child-mapping-empty-state");
        listGroup.innerHTML = "";
        if (data && data.length > 0) {
          data.forEach(row => {
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                  <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1">${row.child_client_id || 'N/A'} <span class="badge bg-secondary ms-2">${row.status || 'N/A'}</span></h6>
                      <small>${brokerIconHTML(row.child_broker)}</small>
                  </div>
                  <p class="mb-1 text-muted">Order ID: ${row.child_order_id || 'N/A'}</p>
              </div>`;
          });
          emptyState.style.display = 'none';
        } else {
          listGroup.innerHTML = ``; // Clear list if no data
          emptyState.style.display = 'block';
        }
        new bootstrap.Modal(document.getElementById("childMappingModal")).show();
      })
      .catch(err => {
        console.error("Error viewing child mappings:", err);
        showMessage("Failed to load child orders.", 'danger');
      });
  };

  // ============ MAIN CONTENT LOADERS ============

  // Show modal to select master for setting as child (original manual modal creation retained)
  window.openSetAsChild = function(clientId) {
    fetch("/api/accounts")
      .then(res => res.json())
      .then(data => {
        const masters = data.masters || [];
        if (masters.length === 0) {
          showMessage("No master accounts available to link as a child. Please set up a master account first.", "warning");
          return;
        }

        let selectHtml = `
          <div class="mb-3">
            <label for="setChildMasterSelect" class="form-label">Select Master Account</label>
            <select class="form-select" id="setChildMasterSelect">
              ${masters.map(m => `<option value="${m.client_id || ''}">${m.username || m.client_id || 'N/A'}</option>`).join("")}
            </select>
          </div>
          <div class="mb-3">
            <div class="form-check d-flex align-items-center gap-1">
              <input class="form-check-input" type="radio" name="copyOption" id="copyOptMultiplier" value="multiplier" checked>
              <label class="form-check-label" for="copyOptMultiplier">Multiplier</label>
              <span data-bs-toggle="tooltip" title="Child order quantity = Master order quantity × Multiplier.">
                <i class="bi bi-info-circle"></i>
              </span>
            </div>
            <div id="multiplierContainer" class="mt-2">
              <input type="number" class="form-control" id="newChildMultiplier" value="1" min="0.1" step="0.1">
            </div>
            <div class="form-check mt-3 d-flex align-items-center gap-1">
              <input class="form-check-input" type="radio" name="copyOption" id="copyOptValue" value="value">
              <label class="form-check-label" for="copyOptValue">Value Amount (₹)</label>
              <span data-bs-toggle="tooltip" title="Trade size = Balance ÷ Price. Balance reduces after each trade.">
                <i class="bi bi-info-circle"></i>
              </span>
            </div>
            <div id="valueContainer" class="mt-2" style="display:none;">
              <input type="number" class="form-control" id="newChildValueLimit" placeholder="Amount in rupees" min="1" step="0.01">
            </div>
          </div>
        `;
        // Use Bootstrap modal directly instead of manually creating divs
        const modalElement = document.getElementById('manualSetChildModal') || (() => {
            const div = document.createElement('div');
            div.id = 'manualSetChildModal';
            div.classList.add('modal', 'fade');
            div.setAttribute('tabindex', '-1');
            div.setAttribute('aria-hidden', 'true');
            div.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">Assign as Child</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmSetAsChildBtn">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            return div;
        })();

        modalElement.querySelector('.modal-body').innerHTML = selectHtml;
        const tooltipList = modalElement.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipList.forEach(el => new bootstrap.Tooltip(el));
        const optMultiplier = modalElement.querySelector('#copyOptMultiplier');
        const optValue = modalElement.querySelector('#copyOptValue');
        const multiplierContainer = modalElement.querySelector('#multiplierContainer');
        const valueContainer = modalElement.querySelector('#valueContainer');

        const toggleInputs = () => {
          if (optValue.checked) {
            multiplierContainer.style.display = 'none';
            valueContainer.style.display = 'block';
          } else {
            multiplierContainer.style.display = 'block';
            valueContainer.style.display = 'none';
          }
        };
        optMultiplier.addEventListener('change', toggleInputs);
        optValue.addEventListener('change', toggleInputs);
        toggleInputs();

        const setChildModal = new bootstrap.Modal(modalElement);
        setChildModal.show();
  
        document.getElementById("confirmSetAsChildBtn").onclick = function() {
          const linked_master_id = document.getElementById("setChildMasterSelect").value;
          const selected = modalElement.querySelector('input[name="copyOption"]:checked').value;
          let multiplier = 1;
          let value_limit = null;
          if (selected === 'value') {
            const raw = document.getElementById("newChildValueLimit").value;
            value_limit = raw ? parseFloat(raw) : null;
          } else {
            multiplier = parseFloat(document.getElementById("newChildMultiplier").value || "1");
          }
          fetch("/api/set-child", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ client_id: clientId, linked_master_id, multiplier, value_limit })
          })
          .then(res => res.json())
          .then(data => {
            showMessage(data.message || "Assigned as child.");
            window.loadAccounts();
          })
          .catch(err => {
            console.error("Error setting child:", err);
            showMessage("Failed to assign as child.", 'danger');
          })
          .finally(() => {
            setChildModal.hide();
          });
        };
      })
      .catch(err => {
        console.error("Error fetching accounts for set as child:", err);
        showMessage("Failed to load accounts for child assignment.", 'danger');
      });
  };

  window.loadAccounts = function() {
    let errorHandled = false;
    fetch("/api/accounts")
      .then(async response => {
        if (!response.ok) {
          errorHandled = true;
          let message = "";
          try {
            const errData = await response.json();
            message = errData.message || JSON.stringify(errData);
          } catch (_) {
            message = response.statusText;
          }
          const alertMsg = `Error ${response.status}: ${message}`;
          console.error(alertMsg);
          showMessage(alertMsg, 'danger');
          const fallbackMsg = response.status === 401
            ? "You appear to be logged out. Please log in to view your accounts."
            : "The server returned an error while loading accounts.";
          ["master-accounts-accordion", "children-accounts-accordion", "unassigned-accounts-list"].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.innerHTML = `<div class="text-center p-4 text-muted">${fallbackMsg}</div>`;
            }
          });
          throw new Error(alertMsg);
        }
        return response.json();
      })
      .then(data => {
        // 1. Masters
        // Ensure data.masters is an array before mapping
        const masters = (Array.isArray(data.masters) ? data.masters : []).map(m => ({
          ...m,
          // Use nullish coalescing for safer access, ensuring client_id is present
          client_id: m.client_id || (m.client && m.client.id ? m.client.id : undefined), // Defensive check for m.client.id
          username: m.username || (m.client && m.client.username ? m.client.username : undefined), // Defensive check for m.client.username
          role: "master"
        })).filter(m => m.client_id); // Filter out masters without a valid client_id
        window.masterAccounts = masters; // Store globally for other functions

        // 2. Children (flattened, with .linked_master_id if possible)
        let children = [];
        for (const master of masters) {
          if (master.children && Array.isArray(master.children)) {
            master.children = master.children.map(child => {
              if (childHasError(child)) {
                child.copy_status = 'Off';
              }
              children.push({
                ...child,
                linked_master_id: master.client_id // Master's client_id should be defined here
              });
              return child;
            });
          }
        }
        window.childAccounts = children; // Store globally

        // --- Master Accounts Display ---
        const masterAccordion = document.getElementById("master-accounts-accordion");
        masterAccordion.innerHTML = "";
        if (masters.length === 0) {
            document.getElementById("master-empty-state").style.display = 'block';
        } else {
            document.getElementById("master-empty-state").style.display = 'none';
            masters.forEach((master, index) => {
              // Safely access master properties for rendering
              const masterClientId = master.client_id || 'N/A';
              const masterUsername = master.username || "-";

              const accordionItem = `
                <div class="accordion-item shadow-sm mb-3 rounded">
                  <h2 class="accordion-header" id="headingMaster${masterClientId}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMaster${masterClientId}" aria-expanded="false" aria-controls="collapseMaster${masterClientId}">
                      <div class="d-flex align-items-center w-100 pe-3">
                        ${brokerIconHTML(master.broker)}
                        <span class="ms-2 fw-semibold">${masterClientId}</span>
                        <span class="text-muted ms-3 d-none d-md-inline-block">${masterUsername}</span>
                        <div class="ms-auto">${statusBadge(master.status, master.errors || master.last_error, master.broker)}</div>
                      </div>
                    </button>
                  </h2>
                  <div id="collapseMaster${masterClientId}" class="accordion-collapse collapse" aria-labelledby="headingMaster${masterClientId}" data-bs-parent="#master-accounts-accordion">
                    <div class="accordion-body p-3">
                      <div class="d-flex flex-wrap gap-2 mb-3">
                          <button class="btn btn-sm btn-outline-danger" onclick="window.removeMaster('${masterClientId}')">Remove Master</button>
                          <div class="vr"></div>
                          <button class="btn btn-sm btn-outline-success" onclick="window.startAllChildren('${masterClientId}')">Turn On All Child Copying</button>
                          <button class="btn btn-sm btn-outline-warning text-dark" onclick="window.stopAllChildren('${masterClientId}')">Turn Off All Child Copying</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="window.exitAllChildren('${masterClientId}')">Exit All Child Positions</button>
                      </div>
                      <ul class="nav nav-tabs master-tab-links mb-3" id="tabs-${masterClientId}" role="tablist">
                          <li class="nav-item" role="presentation">
                              <button class="nav-link active" id="tab-children-${masterClientId}-tab" data-bs-toggle="tab" data-bs-target="#master-children-${masterClientId}" type="button" role="tab" aria-controls="master-children-${masterClientId}" aria-selected="true" onclick="window.showMasterTab('${masterClientId}', 'children')">View Children</button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link" id="tab-positions-${masterClientId}-tab" data-bs-toggle="tab" data-bs-target="#master-positions-${masterClientId}" type="button" role="tab" aria-controls="master-positions-${masterClientId}" aria-selected="false" onclick="window.showMasterTab('${masterClientId}', 'positions')">Positions</button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link" id="tab-holdings-${masterClientId}-tab" data-bs-toggle="tab" data-bs-target="#master-holdings-${masterClientId}" type="button" role="tab" aria-controls="master-holdings-${masterClientId}" aria-selected="false" onclick="window.showMasterTab('${masterClientId}', 'holdings')">Holdings</button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link" id="tab-orders-${masterClientId}-tab" data-bs-toggle="tab" data-bs-target="#master-orders-book-${masterClientId}" type="button" role="tab" aria-controls="master-orders-book-${masterClientId}" aria-selected="false" onclick="window.showMasterTab('${masterClientId}', 'orders')">Order Book</button>
                          </li>
                      </ul>
                      <div class="tab-content">
                          <div class="tab-pane fade show active" id="master-children-${masterClientId}" role="tabpanel" aria-labelledby="tab-children-${masterClientId}-tab">
                              <h6>Linked Child Accounts</h6>
                              <div id="child-rows-${masterClientId}" class="list-group">
                                  </div>
                              <div id="child-rows-empty-${masterClientId}" class="text-center p-3 text-muted" style="display:none;">No child accounts linked to this master.</div>
                          </div>
                          <div class="tab-pane fade" id="master-positions-${masterClientId}" role="tabpanel" aria-labelledby="tab-positions-${masterClientId}-tab">
                            <div id="positions-body-${masterClientId}" class="list-group"></div>
                            <div id="positions-empty-${masterClientId}" class="text-center p-2 text-muted" style="display:none;">No positions for this master account.</div>
                          </div>
                          <div class="tab-pane fade" id="master-holdings-${masterClientId}" role="tabpanel" aria-labelledby="tab-holdings-${masterClientId}-tab">
                            <div id="holdings-body-${masterClientId}" class="list-group"></div>
                            <div id="holdings-empty-${masterClientId}" class="text-center p-2 text-muted" style="display:none;">No holdings for this master account.</div>
                          </div>
                          <div class="tab-pane fade" id="master-orders-book-${masterClientId}" role="tabpanel" aria-labelledby="tab-orders-${masterClientId}-tab">
                            <div id="orders-body-${masterClientId}" class="list-group"></div>
                            <div id="orders-empty-${masterClientId}" class="text-center p-2 text-muted" style="display:none;">No recent orders for this master account.</div>
                            <div class="text-center mt-2">
                              <button class="btn btn-sm btn-outline-primary" id="orders-load-more-${masterClientId}" style="display:none;">Load More</button>
                            </div>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
              masterAccordion.innerHTML += accordionItem;
            });
            // Manually trigger initial tab content load for the first tab (children) for all masters
            masters.forEach(master => {
                window.showMasterTab(master.client_id || 'N/A', 'children'); // Pass potentially 'N/A' but the method expects it
            });
        }

        // --- Children Accounts Display ---
        const childrenAccordion = document.getElementById("children-accounts-accordion");
        childrenAccordion.innerHTML = "";
        if (children.length === 0) {
            document.getElementById("children-empty-state").style.display = 'block';
        } else {
            document.getElementById("children-empty-state").style.display = 'none';
            children.forEach((child, index) => {
              const master = masters.find(m => m.client_id === child.linked_master_id) || {};
              const exited = window.exitedChildren[child.client_id];
              const disableCopy = childHasError(child) ? 'disabled' : '';
              const copyStatus = childHasError(child) ? 'Off' : child.copy_status;
              const childClientId = child.client_id || 'N/A';
              const childUsername = child.username || "-";
              const linkedMasterId = master.client_id || "-";
              const linkedMasterUsername = master.username || "-";
              const childMultiplier = child.multiplier || 1;
              const valueLimit = child.copy_value_limit;
              const remainingValue = valueLimit != null ? (valueLimit - (child.copied_value || 0)) : null;
              
              const accordionItem = `
                <div class="accordion-item shadow-sm mb-3 rounded">
                  <h2 class="accordion-header" id="headingChild${childClientId}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChild${childClientId}" aria-expanded="false" aria-controls="collapseChild${childClientId}">
                      <div class="d-flex align-items-center flex-wrap w-100 pe-3">
                        ${brokerIconHTML(child.broker)}
                        <span class="ms-2 fw-semibold">${childUsername} (${childClientId})</span>
                        <span class="text-muted ms-3 d-block d-md-inline-block">Master: ${linkedMasterUsername} (${linkedMasterId})</span>
                        <div class="ms-auto me-3 mt-2 mt-md-0">${statusBadge(child.status, child.errors || child.last_error, child.broker)}</div>
                        <div class="form-check form-switch m-0 me-3 mt-2 mt-md-0">
                            <input type="checkbox" class="form-check-input" ${copyStatus === 'On' ? 'checked' : ''} ${disableCopy}
                              ${disableCopy ? '' : `onchange=\"window.toggleCopyTrade('${childClientId}', '${linkedMasterId}', this.checked)\"` }>
                            <label class="form-check-label badge ${copyStatus === 'On' ? 'bg-success' : 'bg-secondary'}">${copyStatus || "-"}</label>
                        </div>
                        <div class="multiplier-control me-3">
                          <input type="number" min="0.1" step="0.1"
                                 class="form-control form-control-sm"
                                 id="mult-${child.client_id}"
                                 value="${child.multiplier || 1}" style="width: 60px;">
                          <button class="btn btn-sm btn-outline-primary"
                                  onclick="window.updateMultiplier('${child.client_id}')">Save</button>
                          <span data-bs-toggle="tooltip" title="Set how much larger or smaller you want copied trades to be for this account. For example, 2 means double the trade size, 0.5 means half. Trades copied to this account will use: Master trade size × Multiplier.">
                            <i class="bi bi-info-circle"></i>
                          </span>
                        </div>
                        ${remainingValue != null ? `<span class="badge bg-secondary me-3">Balance ₹${remainingValue.toFixed(2)}</span>` : ''}
                      </div>
                    </button>
                  </h2>
                  <div id="collapseChild${childClientId}" class="accordion-collapse collapse" aria-labelledby="headingChild${childClientId}" data-bs-parent="#children-accounts-accordion">
                    <div class="accordion-body p-3">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-sm btn-outline-success ${disableCopy ? 'disabled' : ''}" ${disableCopy ? '' : `onclick=\"window.startCopying('${childClientId}', '${linkedMasterId}')\"`}>Start Copying</button>
                            <button class="btn btn-sm btn-outline-warning text-dark ${disableCopy ? 'disabled' : ''}" ${disableCopy ? '' : `onclick=\"window.stopCopying('${childClientId}', '${linkedMasterId}')\"`}>Stop Copying</button>
                            <div class="vr d-none d-md-block"></div>
                            <button class="btn btn-sm btn-outline-info" onclick="window.squareOffPosition('${linkedMasterId}', '${childClientId}')">Square Off Specific Symbol</button>
                            <button class="btn btn-sm btn-outline-secondary ${exited ? 'disabled' : ''}" ${exited ? '' : `onclick=\"window.exitAllPositions('${childClientId}')\"`}>${exited ? 'Exited All Positions' : 'Exit All Positions'}</button>
                            <div class="vr d-none d-md-block"></div>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.removeChild('${childClientId}')">Remove Child</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.openChangeMaster('${childClientId}')">Change Master</button>
                        </div>
                        <ul class="nav nav-tabs child-tab-links mb-3" id="child-tabs-${childClientId}" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tab-child-orders-${childClientId}-tab" data-bs-toggle="tab" data-bs-target="#child-orders-${childClientId}" type="button" role="tab" aria-controls="child-orders-${childClientId}" aria-selected="true" onclick="window.showChildTab('${childClientId}', 'orders')">Order Book</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-child-positions-${childClientId}-tab" data-bs-toggle="tab" data-bs-target="#child-positions-${childClientId}" type="button" role="tab" aria-controls="child-positions-${childClientId}" aria-selected="false" onclick="window.showChildTab('${childClientId}', 'positions')">Positions</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-child-holdings-${childClientId}-tab" data-bs-toggle="tab" data-bs-target="#child-holdings-${childClientId}" type="button" role="tab" aria-controls="child-holdings-${childClientId}" aria-selected="false" onclick="window.showChildTab('${childClientId}', 'holdings')">Holdings</button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="child-orders-${childClientId}" role="tabpanel" aria-labelledby="tab-child-orders-${childClientId}-tab">
                                <div id="child-orders-body-${childClientId}" class="list-group"></div>
                                <div id="child-orders-empty-${childClientId}" class="text-center p-2 text-muted" style="display:none;">No recent orders for this child account.</div>
                                <div class="text-center mt-2">
                                  <button class="btn btn-sm btn-outline-primary" id="child-orders-load-more-${childClientId}" style="display:none;">Load More</button>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="child-positions-${childClientId}" role="tabpanel" aria-labelledby="tab-child-positions-${childClientId}-tab">
                                <div id="child-positions-body-${childClientId}" class="list-group"></div>
                                <div id="child-positions-empty-${childClientId}" class="text-center p-2 text-muted" style="display:none;">No positions for this child account.</div>
                            </div>
                            <div class="tab-pane fade" id="child-holdings-${childClientId}" role="tabpanel" aria-labelledby="tab-child-holdings-${childClientId}-tab">
                                <div id="child-holdings-body-${childClientId}" class="list-group"></div>
                                <div id="child-holdings-empty-${childClientId}" class="text-center p-2 text-muted" style="display:none;">No holdings for this child account.</div>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
              `;
              childrenAccordion.innerHTML += accordionItem;
            });
            // Initial load for child tabs
            children.forEach(child => {
                window.showChildTab(child.client_id || 'N/A', 'orders');
            });
        }

        // --- Unassigned Accounts Display ---
        const unassignedList = document.getElementById("unassigned-accounts-list");
        unassignedList.innerHTML = "";
        // Ensure data.accounts is an array before filtering
        const unassignedAccounts = (Array.isArray(data.accounts) ? data.accounts : []).filter(acc => !acc.role);
        if (unassignedAccounts.length === 0) {
            document.getElementById("unassigned-empty-state").style.display = 'block';
        } else {
            document.getElementById("unassigned-empty-state").style.display = 'none';
            unassignedAccounts.forEach(acc => {
              const accClientId = acc.client_id || 'N/A';
              const accUsername = acc.username || "-";

              unassignedList.innerHTML += `
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex align-items-center mb-2">
                                ${brokerIconHTML(acc.broker)}
                                <h6 class="card-title mb-0 ms-2">${accClientId}</h6>
                            </div>
                            <p class="card-text text-muted mb-auto">Username: ${accUsername}</p>
                            <span class="badge bg-secondary mb-3 align-self-start">Not Assigned</span>
                            <div class="d-flex gap-2 mt-auto">
                                <button class="btn btn-sm btn-primary flex-grow-1" onclick="window.setAsMaster('${accClientId}')">Set as Master</button>
                                <button class="btn btn-sm btn-info flex-grow-1" onclick="window.openSetAsChild('${accClientId}')">Set as Child</button>
                            </div>
                        </div>
                    </div>
                </div>
              `;
            });
        }
      })
      .then(() => {
        // No longer need enableDropdowns as Bootstrap handles this
      })
      .catch(err => {
        console.error("Failed to load accounts:", err);
        if (!errorHandled) {
          showMessage(`Failed to load accounts: ${err.message}`, 'danger');
          const fallbackMsg = "The server returned an error while loading accounts.";
          ["master-accounts-accordion", "children-accounts-accordion", "unassigned-accounts-list"].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.innerHTML = `<div class="text-center p-4 text-muted">${fallbackMsg}</div>`;
            }
          });
        }
      });
  };

  function renderMasterChildrenList(masterId) {
      const master = window.masterAccounts.find(m => m.client_id === masterId);
      const kids = (master?.children || []);
      const listGroup = document.getElementById(`child-rows-${masterId}`);
      const emptyState = document.getElementById(`child-rows-empty-${masterId}`);
      if (!listGroup || !emptyState) return;

      if (kids.length === 0) {
          listGroup.innerHTML = ``;
          emptyState.style.display = 'block';
      } else {
          emptyState.style.display = 'none';
          listGroup.innerHTML = kids.map(child => {
              const copyStatus = childHasError(child) ? 'Off' : child.copy_status;
              const disableCopy = childHasError(child) ? 'disabled' : '';
              const childClientId = child.client_id || 'N/A';
              const childUsername = child.username || "-";
              const multiplier = child.multiplier || 1;
              const valueLimit = child.copy_value_limit;
              const remainingValue = valueLimit != null ? (valueLimit - (child.copied_value || 0)) : null;

                return `
              <div class="list-group-item list-group-item-action py-3 d-flex align-items-center flex-wrap">
                ${brokerIconHTML(child.broker)}
                <span class="ms-2 me-auto fw-semibold">${childUsername} (${childClientId})</span>
                <div class="me-3 mt-2 mt-md-0">${statusBadge(child.status, child.errors || child.last_error, child.broker)}</div>
                <div class="form-check form-switch m-0 me-3 mt-2 mt-md-0">
                  <input type="checkbox" class="form-check-input" ${copyStatus === 'On' ? 'checked' : ''} ${disableCopy}
                    ${disableCopy ? '' : `onchange=\"window.toggleCopyTrade('${childClientId}', '${masterId}', this.checked)\"` }>
                  <label class="form-check-label badge ${copyStatus === 'On' ? 'bg-success' : 'bg-secondary'}">${copyStatus || '-'}</label>
                </div>
                <span class="me-3 mt-2 mt-md-0">Mult: ${multiplier}</span>
                ${remainingValue != null ? `<span class="me-3 mt-2 mt-md-0">Balance: ₹${remainingValue.toFixed(2)}</span>` : ''}
                <button class="btn btn-sm btn-danger mt-2 mt-md-0" onclick="window.removeChild('${childClientId}')">Remove</button>
              </div>
          `}).join('');
      }
  }


  window.showMasterTab = function(clientId, tabName) {
    const tabLinks = document.querySelectorAll(`#tabs-${clientId} .nav-link`);
    const tabPanes = document.querySelectorAll(`#master-children-${clientId}, #master-positions-${clientId}, #master-holdings-${clientId}, #master-orders-book-${clientId}`);
    const activeTabLink = document.getElementById(`tab-${tabName}-${clientId}-tab`); // Correct ID for tab button
    const selectedTabPane = document.getElementById(`master-${tabName === 'orders' ? 'orders-book' : tabName}-${clientId}`);
    
    // Deactivate all
    tabLinks.forEach(link => link.classList.remove('active'));
    tabPanes.forEach(pane => pane.classList.remove('show', 'active'));

    // Activate selected tab and pane
    if (activeTabLink) activeTabLink.classList.add('active');
    if (selectedTabPane) {
      selectedTabPane.classList.add('show', 'active');
      if (tabName === 'positions') {
        loadMasterPositions(clientId);
      } else if (tabName === 'orders') {
        loadMasterOrderBook(clientId);
      } else if (tabName === 'holdings') {
        loadMasterHoldings(clientId);
      } else if (tabName === 'children') {
        renderMasterChildrenList(clientId); // Re-render in case child data changed
      }
    }
  };

  function appendMasterOrders(clientId) {
    const orders = window.masterOrderBooks[clientId] || [];
    const listGroup = document.getElementById(`orders-body-${clientId}`);
    const loadMoreButton = document.getElementById(`orders-load-more-${clientId}`);
    let idx = window.masterOrderIndex[clientId] || 0;
    const end = Math.min(idx + ORDER_PAGE_SIZE, orders.length);
    for (let i = idx; i < end; i++) {
      listGroup.innerHTML += orderItemHtml(orders[i]);
    }
    window.masterOrderIndex[clientId] = end;
    if (end >= orders.length && loadMoreButton) {
      loadMoreButton.style.display = 'none';
    }
  }
  
  function loadMasterOrderBook(clientId) {
    const listGroup = document.getElementById(`orders-body-${clientId}`);
    const emptyState = document.getElementById(`orders-empty-${clientId}`);
    const loadMoreButton = document.getElementById(`orders-load-more-${clientId}`);  
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading orders...</div>`;
    emptyState.style.display = 'none';
    if (loadMoreButton) loadMoreButton.style.display = 'none';
    
    fetch(`/api/order-book/${clientId}`)
      .then(res => res.json())
      .then(data => {
        listGroup.innerHTML = "";
        const orders = Array.isArray(data) ? data : [];
        if (orders.length > 0) {
          window.masterOrderBooks[clientId] = orders;
          window.masterOrderIndex[clientId] = 0;
          appendMasterOrders(clientId);
          if (orders.length > ORDER_PAGE_SIZE && loadMoreButton) {
            loadMoreButton.style.display = 'inline-block';
            loadMoreButton.onclick = () => appendMasterOrders(clientId);
          }
        } else {
          emptyState.style.display = 'block';
        }
      })
      .catch(err => {
        console.error("Order book fetch failed:", err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load order book.</div>`;
        emptyState.style.display = 'none';
        if (loadMoreButton) loadMoreButton.style.display = 'none';
        showMessage("Failed to load order book.", 'danger');
      });
  }

  function loadMasterPositions(clientId) {
    const listGroup = document.getElementById(`positions-body-${clientId}`);
    const emptyState = document.getElementById(`positions-empty-${clientId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading positions...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/portfolio/${clientId}`)
      .then(res => res.json())
      .then(positions => {
        listGroup.innerHTML = "";
        if (Array.isArray(positions) && positions.length > 0) {
          positions.forEach(pos => {
            const buyQty = pos.buyQty || pos.buy_quantity || 0;
            const sellQty = pos.sellQty || pos.sell_quantity || 0;
          const netQty = pos.netQty || pos.net_quantity || 0;
          let type = 'CLOSED';
          if (netQty > 0) {
            type = 'BUY';
          } else if (netQty < 0) {
            type = 'SELL';
          }
          const typeClass = type === 'BUY' ? 'bg-success'
                             : type === 'SELL' ? 'bg-danger'
                             : 'bg-secondary';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between flex-wrap">
                  <h6 class="mb-1">${pos.tradingSymbol || pos.symbol || '-'} <span class="badge ${typeClass} ms-2">${type}</span></h6>
                  <small class="text-muted mt-1 mt-md-0">P/L: ${pos.profitAndLoss ?? pos.pnl ?? '-'}</small>
                </div>
                <p class="mb-1">Net Qty: ${netQty} | Buy Qty: ${buyQty} | Sell Qty: ${sellQty}</p>
                  <small class="text-muted">Avg Buy Price: ${pos.buyAvg ?? pos.buy_avg_price ?? '-'} | Avg Sell Price: ${pos.sellAvg ?? pos.sell_avg_price ?? '-'} | LTP: ${pos.ltp ?? pos.last_price ?? '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error("Positions fetch failed:", err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load positions.</div>`;
        emptyState.style.display = 'none';
        showMessage("Failed to load positions.", 'danger');
    });
  }

  function loadMasterHoldings(clientId) {
    const listGroup = document.getElementById(`holdings-body-${clientId}`);
    const emptyState = document.getElementById(`holdings-empty-${clientId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading holdings...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/holdings/${clientId}`)
      .then(res => res.json())
      .then(holdings => {
        listGroup.innerHTML = "";
        if (Array.isArray(holdings) && holdings.length > 0) {
          holdings.forEach(h => {
            const getVal = (obj, keys) => {
              for (const k of keys) {
                for (const key in obj) {
                  if (key.toLowerCase() === k.toLowerCase()) return obj[key];
                }
              }
              return undefined;
            };
            const qty = getVal(h, [
              'quantity', 'qty', 'holdqty', 'holdingsquantity', 't1_quantity',
              'dp_qty', 'totalqty', 'availableqty', 'dpqty', 't1qty', 'collateralqty'
            ]) || 0;
            const avg = getVal(h, [
              'buyavg', 'buy_avg_price', 'average_price', 'avg_price', 'purchaseprice', 'avgcostprice'
            ]);
            const ltp = getVal(h, ['ltp','last_price','last_traded_price']);
            let pnl = getVal(h, [
              'profitandloss',
              'pnl',
              'unrealizedprofit',
              'unrealisedprofit'
            ]);
            if (pnl === undefined && ltp !== undefined && avg !== undefined) {
              const qtyNum = parseFloat(qty) || 0;
              const ltpNum = parseFloat(ltp);
              const avgNum = parseFloat(avg);
              if (!isNaN(ltpNum) && !isNaN(avgNum)) {
                pnl = ((ltpNum - avgNum) * qtyNum).toFixed(2);
              }
            }
            const sym = getVal(h, ['tradingSymbol','tradingsymbol','symbol','tsym']) || '-';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between flex-wrap">
                  <h6 class="mb-1">${sym}</h6>
                  <small class="text-muted mt-1 mt-md-0">P/L: ${pnl !== undefined ? pnl : '-'}</small>
                </div>
                <p class="mb-1">Qty: ${qty} | Avg Price: ${avg !== undefined ? avg : '-'}</p>
                <small class="text-muted">LTP: ${ltp !== undefined ? ltp : '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error("Holdings fetch failed:", err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load holdings.</div>`;
        emptyState.style.display = 'none';
        showMessage("Failed to load holdings for child account.", 'danger');
    });
  }

  // --- Child Tabs ---
  window.showChildTab = function(childId, tabName) {
    const tabLinks = document.querySelectorAll(`#child-tabs-${childId} .nav-link`);
    const tabPanes = document.querySelectorAll(`#child-orders-${childId}, #child-positions-${childId}, #child-holdings-${childId}`);
    const activeTabLink = document.getElementById(`tab-child-${tabName}-${childId}-tab`); // Correct ID for tab button
    const selectedTabPane = document.getElementById(`child-${tabName}-${childId}`);
    
    // Deactivate all
    tabLinks.forEach(link => link.classList.remove('active'));
    tabPanes.forEach(pane => pane.classList.remove('show', 'active'));

    // Activate selected tab and pane
    if (activeTabLink) activeTabLink.classList.add('active');
    if (selectedTabPane) {
      selectedTabPane.classList.add('show', 'active');
      if (tabName === 'positions') {
        loadChildPositions(childId);
      } else if (tabName === 'orders') {
        loadChildOrderBook(childId);
      } else if (tabName === 'holdings') {
        loadChildHoldings(childId);
      }
    }
  };

  function appendChildOrders(childId) {
    const orders = window.childOrderBooks[childId] || [];
    const listGroup = document.getElementById(`child-orders-body-${childId}`);
    const loadMoreButton = document.getElementById(`child-orders-load-more-${childId}`);
    let idx = window.childOrderIndex[childId] || 0;
    const end = Math.min(idx + ORDER_PAGE_SIZE, orders.length);
    for (let i = idx; i < end; i++) {
      listGroup.innerHTML += orderItemHtml(orders[i]);
    }
    window.childOrderIndex[childId] = end;
    if (end >= orders.length && loadMoreButton) {
      loadMoreButton.style.display = 'none';
    }
  }

  function loadChildOrderBook(childId) {
    const listGroup = document.getElementById(`child-orders-body-${childId}`);
    const emptyState = document.getElementById(`child-orders-empty-${childId}`);
    const loadMoreButton = document.getElementById(`child-orders-load-more-${childId}`);
    if (!listGroup || !emptyState || !loadMoreBtn) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading orders...</div>`;
    emptyState.style.display = 'none';
    loadMoreBtn.style.display = 'none';
    if (loadMoreButton) loadMoreButton.style.display = 'none';
    
    fetch(`/api/order-book/${childId}`)
      .then(res => res.json())
      .then(data => {
        listGroup.innerHTML = "";
        const orders = Array.isArray(data) ? data : [];
        if (orders.length > 0) {
          window.childOrderBooks[childId] = orders;
          window.childOrderIndex[childId] = 0;
          appendChildOrders(childId);
          if (orders.length > ORDER_PAGE_SIZE && loadMoreButton) {
            loadMoreButton.style.display = 'inline-block';
            loadMoreButton.onclick = () => appendChildOrders(childId);
          }
        } else {
          emptyState.style.display = 'block';
        }
      })
      .catch(err => {
        console.error('Child order book fetch failed:', err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load order book.</div>`;
        emptyState.style.display = 'none';
        if (loadMoreButton) loadMoreButton.style.display = 'none';  
        showMessage('Failed to load order book.', 'danger');
      });
  }

  function loadChildPositions(childId) {
    const listGroup = document.getElementById(`child-positions-body-${childId}`);
    const emptyState = document.getElementById(`child-positions-empty-${childId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading positions...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/portfolio/${childId}`)
      .then(res => res.json())
      .then(positions => {
        listGroup.innerHTML = "";
        if (Array.isArray(positions) && positions.length > 0) {
          positions.forEach(pos => {
            const buyQty = pos.buyQty || pos.buy_quantity || 0;
            const sellQty = pos.sellQty || pos.sell_quantity || 0;
          const netQty = pos.netQty || pos.net_quantity || 0;
          let type = 'CLOSED';
          if (netQty > 0) {
            type = 'BUY';
          } else if (netQty < 0) {
            type = 'SELL';
          }
          const typeClass = type === 'BUY' ? 'bg-success'
                             : type === 'SELL' ? 'bg-danger'
                             : 'bg-secondary';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between flex-wrap">
                  <h6 class="mb-1">${pos.tradingSymbol || pos.symbol || '-'} <span class="badge ${typeClass} ms-2">${type}</span></h6>
                  <small class="text-muted mt-1 mt-md-0">P/L: ${pos.profitAndLoss ?? pos.pnl ?? '-'}</small>
                </div>
                <p class="mb-1">Net Qty: ${netQty} | Buy Qty: ${buyQty} | Sell Qty: ${sellQty}</p>
                  <small class="text-muted">Avg Buy Price: ${pos.buyAvg ?? pos.buy_avg_price ?? '-'} | Avg Sell Price: ${pos.sellAvg ?? pos.sell_avg_price ?? '-'} | LTP: ${pos.ltp ?? pos.last_price ?? '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error('Child positions fetch failed:', err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load positions.</div>`;
        emptyState.style.display = 'none';
        showMessage('Failed to load positions.', 'danger');
      });
  }

  function loadChildHoldings(childId) {
    const listGroup = document.getElementById(`child-holdings-body-${childId}`);
    const emptyState = document.getElementById(`child-holdings-empty-${childId}`);
    if (!listGroup || !emptyState) return;

    listGroup.innerHTML = `<div class="p-3 text-center text-primary"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading holdings...</div>`;
    emptyState.style.display = 'none';

    fetch(`/api/holdings/${childId}`)
      .then(res => res.json())
      .then(holdings => {
        listGroup.innerHTML = "";
        if (Array.isArray(holdings) && holdings.length > 0) {
          holdings.forEach(h => {
            const getVal = (obj, keys) => {
              for (const k of keys) {
                for (const key in obj) {
                  if (key.toLowerCase() === k.toLowerCase()) return obj[key];
                }
              }
              return undefined;
            };
            const qty = getVal(h, [
              'quantity', 'qty', 'holdqty', 'holdingsquantity', 't1_quantity',
              'dp_qty', 'totalqty', 'availableqty', 'dpqty', 't1qty', 'collateralqty'
            ]) || 0;
            const avg = getVal(h, [
              'buyavg', 'buy_avg_price', 'average_price', 'avg_price', 'purchaseprice', 'avgcostprice'
            ]);
            const ltp = getVal(h, ['ltp','last_price','last_traded_price']);
            const pnl = getVal(h, ['profitandloss','pnl','unrealizedprofit','unrealisedprofit']);
            const sym = getVal(h, ['tradingSymbol','tradingsymbol','symbol','tsym']) || '-';
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between flex-wrap">
                  <h6 class="mb-1">${sym}</h6>
                  <small class="text-muted mt-1 mt-md-0">P/L: ${pnl !== undefined ? pnl : '-'}</small>
                </div>
                <p class="mb-1">Qty: ${qty} | Avg Price: ${avg !== undefined ? avg : '-'}</p>
                <small class="text-muted">LTP: ${ltp !== undefined ? ltp : '-'}</small>
              </div>
            `;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
      })
      .catch(err => {
        console.error('Child holdings fetch failed:', err);
        listGroup.innerHTML = `<div class="p-3 text-center text-danger">Failed to load holdings.</div>`;
        emptyState.style.display = 'none';
        showMessage('Failed to load holdings for child account.', 'danger');
      });
  }

  // --- Master Orders Display ---
  window.loadMasterOrders = function() {
    fetch('/api/master-orders')
      .then(res => res.json())
      .then(data => {
        const listGroup = document.getElementById("master-orders-list");
        const emptyState = document.getElementById("master-orders-empty-state");
        listGroup.innerHTML = "";
        if (Array.isArray(data) && data.length > 0) {
          emptyState.style.display = 'none';
          data.forEach(order => {
            listGroup.innerHTML += `
              <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between align-items-center flex-wrap">
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input master-order-checkbox" value="${order.master_order_id || ''}" id="masterOrderCheck${order.master_order_id || ''}">
                    <label class="form-check-label fw-semibold" for="masterOrderCheck${order.master_order_id || ''}">${order.symbol || '-'}</label>
                  </div>
                  <span class="badge bg-primary mt-1 mt-md-0">${order.status || '-'}</span>
                </div>
                <p class="mb-1 text-muted">Order ID: ${order.master_order_id || 'N/A'} | Children: ${order.total_children || 0}</p>
                <button class="btn btn-sm btn-info mt-2" onclick="window.viewChildMappings('${order.master_order_id || ''}')"><i class="bi bi-eye-fill"></i> View Children</button>
              </div>`;
          });
        } else {
          emptyState.style.display = 'block';
          listGroup.innerHTML = ``; // Clear list if no data
        }
        // Reset select all checkbox
        document.getElementById("toggleAllMasterOrdersCheckbox").checked = false;
      })
      .then(() => {
        // No longer need enableDropdowns as Bootstrap handles this
      })
      .catch(err => {
        console.error("Error loading master orders:", err);
        document.getElementById("master-orders-list").innerHTML = `<div class="p-3 text-center text-danger">Failed to load master orders.</div>`;
        document.getElementById("master-orders-empty-state").style.display = 'none';
        showMessage("Failed to load master orders.", 'danger');
      });
  };

  window.toggleAllMasterOrders = function(isChecked) {
    document.querySelectorAll(".master-order-checkbox").forEach(cb => cb.checked = isChecked);
    // No longer a separate "master-orders-select-all" element in new design, only one toggle
    // document.getElementById("master-orders-select-all").checked = isChecked;
    // document.getElementById("toggleAllMasterOrdersCheckbox").checked = isChecked; // This is the source of truth
  };

  // --- Cancel/Square Off Actions ---
  document.getElementById("cancelSelectedOrdersBtn").onclick = function() {
    const selected = [...document.querySelectorAll(".master-order-checkbox:checked")].map(cb => cb.value);
    if (selected.length === 0) return showMessage("No orders selected to cancel.", 'warning');

    if (!confirm(`Are you sure you want to cancel ${selected.length} selected order(s)?`)) return;

    // Use Promise.all to handle multiple fetches and then reload once
    Promise.all(selected.map(id => 
      fetch("/api/cancel-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ master_order_id: id })
      })
      .then(res => res.json())
      .then(data => {
        showMessage(data.message); // Show message for each operation or collect messages
        return data;
      })
      .catch(err => {
        console.error(`Error cancelling order ${id}:`, err);
        showMessage(`Failed to cancel order ${id}.`, 'danger');
        return { error: true, message: `Failed to cancel order ${id}.` };
      })
    ))
    .then(() => {
      window.loadMasterOrders(); // Reload orders after all operations
      window.loadAccounts(); // Also reload accounts as status might change
    });
  };

  document.getElementById("squareOffSelectedOrdersBtn").onclick = function() {
    const selected = [...document.querySelectorAll(".master-order-checkbox:checked")].map(cb => cb.value);
    if (selected.length === 0) return showMessage("No orders selected to square off.", 'warning');

    if (!confirm(`Are you sure you want to square off ${selected.length} selected order(s)? This will attempt to exit positions in all linked children.`)) return;

    // Use Promise.all to handle multiple fetches and then reload once
    Promise.all(selected.map(id => 
      fetch("/api/master-squareoff", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ master_order_id: id })
      })
      .then(res => res.json())
      .then(data => {
        showMessage(data.message);
        return data;
      })
      .catch(err => {
        console.error(`Error squaring off order ${id}:`, err);
        showMessage(`Failed to square off order ${id}.`, 'danger');
        return { error: true, message: `Failed to square off order ${id}.` };
      })
    ))
    .then(() => {
      window.loadMasterOrders();
      window.loadAccounts(); // Reload accounts to update child positions
    });
  };

  // --- Master/Child Linking and Copying ---
  window.setAsMaster = function(clientId) {
    if (!confirm(`Are you sure you want to set ${clientId} as a Master account?`)) return;
    fetch("/api/set-master", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error setting as master:", err);
      showMessage("Failed to set as master.", 'danger');
    });
  };

  window.removeMaster = function(clientId) {
    if (!confirm(`WARNING: Removing master account ${clientId} will also unlink all its child accounts. Are you sure?`)) return;
    fetch("/api/remove-master", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error removing master:", err);
      showMessage("Failed to remove master.", 'danger');
    });
  };

  window.startCopying = function(childId, masterId) {
    fetch("/api/start-copy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: childId, master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts(); // Reload to update UI status
    })
    .catch(err => {
      console.error("Error starting copy:", err);
      showMessage("Failed to start copying.", 'danger');
    });
  };

  window.stopCopying = function(childId, masterId) {
    fetch("/api/stop-copy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: childId, master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts(); // Reload to update UI status
    })
    .catch(err => {
      console.error("Error stopping copy:", err);
      showMessage("Failed to stop copying.", 'danger');
    });
  };

  window.toggleCopyTrade = function(childId, masterId, isOn) {
    if (isOn) {
      window.startCopying(childId, masterId);
    } else {
      window.stopCopying(childId, masterId);
    }
  };

  window.startAllChildren = function(masterId) {
    if (!confirm(`Are you sure you want to turn ON copy trading for ALL children linked to Master ${masterId}?`)) return;
    fetch('/api/start-copy-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error starting all children:", err);
      showMessage("Failed to start copying for all children.", 'danger');
    });
  };

  window.stopAllChildren = function(masterId) {
    if (!confirm(`Are you sure you want to turn OFF copy trading for ALL children linked to Master ${masterId}?`)) return;
    fetch('/api/stop-copy-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_id: masterId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error stopping all children:", err);
      showMessage("Failed to stop copying for all children.", 'danger');
    });
  };

  window.removeChild = function(clientId) {
    if (!confirm(`Are you sure you want to remove child account ${clientId}? This will stop all copy trading for this account.`)) return;
    fetch("/api/remove-child", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      delete window.exitedChildren[clientId]; // Remove from exitedChildren if it was marked
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error removing child:", err);
      showMessage("Failed to remove child.", 'danger');
    });
  };

  window.squareOffPosition = function(masterId, childId) {
    fetch("/api/portfolio/" + childId)
      .then(res => res.json())
      .then(data => {
        const positions = data || [];
        const activePositions = positions.filter(pos => (pos.netQty || pos.net_quantity) !== 0);
        const symbols = activePositions.map(pos => pos.tradingSymbol || pos.symbol);

        if (symbols.length === 0) {
          showMessage(`No active positions found for child ${childId}.`, 'info');
          return;
        }

        // Use Bootstrap modal directly instead of manually creating divs
        const modalElement = document.getElementById('squareOffSymbolModal') || (() => {
            const div = document.createElement('div');
            div.id = 'squareOffSymbolModal';
            div.classList.add('modal', 'fade');
            div.setAttribute('tabindex', '-1');
            div.setAttribute('aria-hidden', 'true');
            div.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">Square Off Position</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Select a symbol to square off for child account <strong>${childId}</strong>:</p>
                            <div class="mb-3">
                                <label for="squareOffSymbol" class="form-label">Symbol:</label>
                                <select id="squareOffSymbol" class="form-select"></select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmSquareOffBtn">Confirm Square Off</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            return div;
        })();

        const symbolOptions = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
        modalElement.querySelector('#squareOffSymbol').innerHTML = symbolOptions;
        const squareOffModal = new bootstrap.Modal(modalElement);
        squareOffModal.show();

        document.getElementById("confirmSquareOffBtn").onclick = function() {
          const symbol = document.getElementById("squareOffSymbol").value;
          if (!confirm(`Are you sure you want to square off ${symbol} for child ${childId}?`)) {
            squareOffModal.hide();
            return;
          }

          // Show spinner within the modal or as a global overlay
          const spinnerOverlay = document.createElement('div');
          spinnerOverlay.classList.add('modal-backdrop', 'fade', 'show', 'd-flex', 'align-items-center', 'justify-content-center', 'position-fixed', 'top-0', 'start-0', 'w-100', 'h-100');
          spinnerOverlay.style.zIndex = 1050; // Ensure it's above other modals
          spinnerOverlay.innerHTML = `
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="text-light ms-2">Processing...</p>
          `;
          document.body.appendChild(spinnerOverlay);

          fetch("/api/square-off", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              client_id: childId,
              symbol: symbol,
              is_master: false
            })
          })
          .then(res => res.json())
          .then(data => {
            showMessage(data.message + (data.details ? "\nDetails:\n" + data.details.join("\n") : ''));
            window.loadAccounts();
          })
          .catch(err => {
            console.error("Error squaring off position:", err);
            showMessage("Failed to square off positions.", 'danger');
          })
          .finally(() => {
            document.body.removeChild(spinnerOverlay);
            squareOffModal.hide();
          });
        };
      })
      .catch(err => {
        console.error("Failed to load portfolio for square off:", err);
        showMessage("Failed to load holdings for child account.", 'danger');
      });
  };


  window.exitAllPositions = function(childId) {
    if (window.exitedChildren[childId]) {
      showMessage("Child positions already exited for this session.", 'info');
      return;
    }
    if (!confirm(`Are you sure you want to exit ALL open positions for child account ${childId}?`)) return;

    fetch('/api/exit-child-positions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ child_id: childId })
    })
    .then(res => res.json())
    .then(data => {
      const err = data.failed_count && data.failed_count > 0;
      showMessage(data.message, err ? 'danger' : 'success');
      if (data.exited) {
        window.exitedChildren[childId] = true;
      }
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error exiting all positions:", err);
      showMessage("Failed to exit all positions.", 'danger');
    });
  };

  window.exitAllChildren = function(masterId) {
    const toExit = (window.childAccounts || [])
      .filter(c => String(c.linked_master_id) === String(masterId) && !window.exitedChildren[c.client_id])
      .map(c => c.client_id);
    if (toExit.length === 0) {
      showMessage('All linked children for this master are already exited or have no positions to exit.', 'info');
      return;
    }
    if (!confirm(`Are you sure you want to attempt to exit ALL open positions for the ${toExit.length} linked child account(s) of Master ${masterId}?`)) return;

    fetch('/api/exit-all-children', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_id: masterId, child_ids: toExit })
    })
    .then(res => res.json())
    .then(data => {
      const failed = Array.isArray(data.failed_children) && data.failed_children.length > 0;
      showMessage(data.message, failed ? 'danger' : 'success');
      if (Array.isArray(data.exited_children)) {
        data.exited_children.forEach(id => { window.exitedChildren[id] = true; });
      }
      window.loadAccounts();
    })
    .catch(err => {
      console.error("Error exiting all children positions:", err);
      showMessage("Failed to exit all children positions.", 'danger');
    });
  };

  window.updateMultiplier = function(clientId) {
    const inputElement = document.getElementById(`mult-${clientId}`);
    const newMultiplier = parseFloat(inputElement.value);

    if (isNaN(newMultiplier) || newMultiplier < 0.1) {
      showMessage("Please enter a valid multiplier (minimum 0.1).", 'warning');
      inputElement.value = inputElement.defaultValue; // Reset to previous valid value
      return;
    }
    if (!confirm(`Confirm update multiplier for ${clientId} to ${newMultiplier}?`)) {
        inputElement.value = inputElement.defaultValue; // Reset if cancelled
        return;
    }

    fetch("/api/update-multiplier", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client_id: clientId, multiplier: newMultiplier })
    })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message || "Multiplier updated successfully.");
      // No need to reload all accounts, just update the default value for the input
      // And the multiplier shown in the master's children list
      window.loadAccounts(); // Reload to update master's children list and child's own section
    })
    .catch(err => {
      console.error("Error updating multiplier:", err);
      showMessage("Failed to update multiplier.", 'danger');
      inputElement.value = inputElement.defaultValue; // Reset on error
    });
  };

  // --- INIT ON LOAD ---
  // These calls will now fetch and populate the sections
  window.loadAccounts();
  window.loadMasterOrders();
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  [...tooltipTriggerList].forEach(el => new bootstrap.Tooltip(el));
};

// This ensures the main page script function runs even if this script is loaded
// after the DOM has already finished loading (e.g. when navigating via SPA).
function initCopyTradingPage() {
  if (window.pageScripts && typeof window.pageScripts["copy-trading"] === 'function') {
    window.pageScripts["copy-trading"]();
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCopyTradingPage);
} else {
  initCopyTradingPage();
}
</script>
{% endblock %}
