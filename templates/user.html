{% extends "layout.html" %}

{% block title %}User - Profile Management{% endblock %}

{% block styles %}
<style>
  .user-page {
    min-height: 100vh;
    background-color: hsl(0 0% 100%);
    padding: 96px 16px 32px;
  }

  .user-container {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .user-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .user-header h1 {
    font-size: 30px;
    font-weight: 700;
    color: hsl(240 10% 3.9%);
  }

  .user-breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: hsl(240 3.8% 46.1%);
  }

  .user-breadcrumb span {
    color: hsl(240 10% 3.9%);
  }

  .user-tabs {
    background-color: transparent;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .tab-buttons {
    display: flex;
    gap: 4px;
    background-color: hsl(240 4.8% 95.9%);
    padding: 4px;
    border-radius: 8px;
  }

  .tab-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px 16px;
    background: transparent;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: hsl(240 5.9% 10%);
    transition: background 0.2s ease, box-shadow 0.2s ease;
  }

  .tab-button.active {
    background-color: hsl(0 0% 100%);
    color: hsl(240 10% 3.9%);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  .general-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 32px;
  }

  .avatar-card,
  .form-card,
  .security-card {
    background-color: hsl(0 0% 100%);
    border: 1px solid hsl(240 5.9% 90%);
    border-radius: 8px;
    padding: 24px;
  }

  .avatar-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .avatar-circle {
    width: 192px;
    height: 192px;
    border-radius: 50%;
    background-color: hsl(240 4.8% 95.9%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 600;
    color: hsl(240 10% 3.9%);
    overflow: hidden;
  }

  .avatar-circle img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-username {
    font-size: 18px;
    font-weight: 500;
    color: hsl(240 3.8% 46.1%);
  }

  .avatar-upload {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 999px;
    border: 1px solid hsl(240 5.9% 10%);
    background-color: transparent;
    color: hsl(240 5.9% 10%);
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .avatar-upload:hover {
    background-color: hsl(240 5.9% 10%);
    color: hsl(0 0% 98%);
  }

  .avatar-upload input[type="file"] {
    display: none;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-field label {
    font-size: 14px;
    font-weight: 500;
    color: hsl(240 10% 3.9%);
  }

  .form-field input,
  .form-field select {
    height: 40px;
    width: 100%;
    border-radius: 6px;
    border: 1px solid hsl(240 5.9% 90%);
    background-color: hsl(0 0% 100%);
    padding: 8px 12px;
    font-size: 14px;
    color: hsl(240 10% 3.9%);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 24px;
  }

  .primary-btn {
    height: 44px;
    padding: 0 32px;
    background-color: hsl(240 5.9% 10%);
    color: hsl(0 0% 98%);
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
  }

  .security-grid {
    max-width: 448px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .security-field {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .security-field label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 600;
    color: hsl(240 10% 3.9%);
  }

  .security-helper {
    font-size: 14px;
    color: hsl(240 3.8% 46.1%);
  }

  @media (min-width: 992px) {
    .general-grid {
      grid-template-columns: 1fr 2fr;
    }

    .form-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 768px) and (max-width: 991.98px) {
    .form-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="user-page">
  <div class="user-container">
    <div class="user-header">
      <h1>User</h1>
      <div class="user-breadcrumb">
        <span>Management</span>
        <span>&bull;</span>
        <span>User</span>
      </div>
    </div>

    {% if message %}
      <div class="alert alert-info mb-0">{{ message }}</div>
    {% endif %}

    <div class="user-tabs">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="general">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect width="20" height="14" x="2" y="5" rx="2"></rect>
            <path d="M2 10h20"></path>
          </svg>
          <span>General</span>
        </button>
        <button class="tab-button" data-tab="security">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="m15 6.5-1 2.5 3 3 2-5.5"></path>
            <path d="m12.4 3.8 1.7 4.3c.2.5.4.9.8 1.3l2.9 2.9c.4.4.8.6 1.3.8l4.3 1.7c.3.1.6.5.6 1 0 .4-.2.8-.6 1l-4.3 1.7c-.5.2-.9.4-1.3.8L15 21.2c-.4.4-.6.8-.8 1.3l-1.7 4.3c-.1.3-.5.6-1 .6-.4 0-.8-.2-1-.6l-1.7-4.3c-.2-.5-.4-.9-.8-1.3L5.1 18.3c-.4-.4-.8-.6-1.3-.8L-.5 15.8c-.3-.1-.6-.5-.6-1 0-.4.2-.8.6-1l4.3-1.7c.5-.2.9-.4 1.3-.8l2.9-2.9c.4-.4.6-.8.8-1.3l1.7-4.3c.1-.3.5-.6 1-.6.4 0 .8.2 1 .6z"></path>
          </svg>
          <span>Security</span>
        </button>
      </div>

      <div class="tab-panel active" id="general">
        <form method="post" enctype="multipart/form-data" class="general-form">
          <input type="hidden" name="action" value="save_profile">
          <div class="general-grid">
            <div class="avatar-card">
              <div class="avatar-circle" id="avatarCircle">
                {% if user.profile_image %}
                  <img src="{{ user.profile_image }}" alt="Profile avatar" id="profileAvatar">
                {% else %}
                {% set first_initial = (user.first_name[0] if user.first_name else '') %}
                {% set last_initial = (user.last_name[0] if user.last_name else '') %}
                {% set initials = (first_initial ~ last_initial) | upper %}
                <span id="avatarInitials">{{ initials if initials else 'U' }}</span>
                <img src="" alt="Profile avatar" id="profileAvatar" class="d-none">
              {% endif %}
            </div>
            <p class="avatar-username">{{ user.username or user.email }}</p>
            <label class="avatar-upload">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 16v-8"></path>
                <path d="m9 11 3-3 3 3"></path>
                <path d="M20 21H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h4l2-3h4l2 3h4a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z"></path>
              </svg>
              <span>Upload Photo</span>
              <input type="file" id="profileImageInput" name="profile_image" accept="image/*">
            </label>
            </div>
            <div class="form-card">
              <div class="form-grid">
                <div class="form-field">
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="first_name" value="{{ user.first_name or '' }}" required>
                </div>
                <div class="form-field">
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="last_name" value="{{ user.last_name or '' }}" required>
                </div>
                <div class="form-field">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" value="{{ user.email or '' }}" readonly>
                </div>
                <div class="form-field">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" name="phone" value="{{ user.phone or '' }}" placeholder="Enter phone number">
                </div>
                <div class="form-field">
                  <label for="address1">Address Line 1</label>
                  <input type="text" id="address1" name="address1" value="{{ user.address1 or '' }}" placeholder="Street address">
                </div>
                <div class="form-field">
                  <label for="address2">Address Line 2</label>
                  <input type="text" id="address2" name="address2" value="{{ user.address2 or '' }}" placeholder="Apartment, suite, etc.">
                </div>
                <div class="form-field">
                  <label for="state">State</label>
                  <select id="state" name="state">
                    <option value="" {% if not user.state %}selected{% endif %}>Select State</option>
                    <option value="Andhra Pradesh" {% if user.state == 'Andhra Pradesh' %}selected{% endif %}>Andhra Pradesh</option>
                    <option value="Delhi" {% if user.state == 'Delhi' %}selected{% endif %}>Delhi</option>
                    <option value="Karnataka" {% if user.state == 'Karnataka' %}selected{% endif %}>Karnataka</option>
                    <option value="Maharashtra" {% if user.state == 'Maharashtra' %}selected{% endif %}>Maharashtra</option>
                    <option value="Tamil Nadu" {% if user.state == 'Tamil Nadu' %}selected{% endif %}>Tamil Nadu</option>
                    <option value="Telangana" {% if user.state == 'Telangana' %}selected{% endif %}>Telangana</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="zipCode">Zip/Code</label>
                  <input type="text" id="zipCode" name="zip_code" value="{{ user.zip_code or '' }}" placeholder="Postal code">
                </div>
                <div class="form-field">
                  <label for="gstin">GSTN (Optional)</label>
                  <input type="text" id="gstin" name="gstin" value="{{ user.gstin or '' }}" placeholder="Enter GSTIN">
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="primary-btn">Save Changes</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="tab-panel" id="security">
        <div class="security-card">
          <form method="post">
            <input type="hidden" name="action" value="change_password">
            <div class="security-grid">
              <div class="security-field">
                <label for="currentPassword">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"></path>
                  </svg>
                  Current Password
                </label>
                <input type="password" id="currentPassword" name="current_password" required>
              </div>
              <div class="security-field">
                <label for="newPassword">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  New Password
                </label>
                <input type="password" id="newPassword" name="new_password" required>
              </div>
              <div class="security-field">
                <label for="confirmPassword">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  Confirm New Password
                </label>
                <input type="password" id="confirmPassword" name="confirm_password" required>
              </div>
              <p class="security-helper">Password must be minimum 6+</p>
              <div class="form-actions">
                <button type="submit" class="primary-btn">Update Password</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const imageInput = document.getElementById('profileImageInput');
    const profileAvatar = document.getElementById('profileAvatar');
    const avatarInitials = document.getElementById('avatarInitials');

    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const target = button.getAttribute('data-tab');

        tabButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
        tabPanels.forEach((panel) => panel.classList.toggle('active', panel.id === target));
      });
    });

    if (imageInput) {
      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          if (profileAvatar) {
            profileAvatar.src = e.target.result;
            profileAvatar.classList.remove('d-none');
          }
          if (avatarInitials) {
            avatarInitials.classList.add('d-none');
          }
        };
        reader.readAsDataURL(file);
      });
    }
  });
</script>
{% endblock %}
