{% extends "layout.html" %}

{% block title %}Alert to Trade - DhanBot{% endblock %}

{% block styles %}
<style>




  .strategies-page-root {
    background: #f5f5f5;
    margin: -1.2rem -1.1rem 0;
    padding: 40px 0;
  }

  .strategies-page {
    max-width: 1400px;
    margin: 12px;
    padding: 0 40px 40px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .strategies-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
  }

  .strategies-header h1 {
    font-size: 36px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 8px;
  }

  .strategies-header p {
    color: #6b7280;
    font-size: 16px;
  }

  .strategy-btn-new {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    padding: 12px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
  }

  .strategy-filters {
    display: flex;
    gap: 16px;
    margin-bottom: 32px;
  }

  .strategy-search-box {
    position: relative;
    flex: 1;
  }

  .strategy-search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
  }

  .strategy-search-box input,
  .strategy-filters select {
    width: 100%;
    padding: 12px 12px 12px 44px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 15px;
    background: #fff;
  }

  .strategy-filters select {
    padding: 12px 36px 12px 16px;
    background: #fff url('data:image/svg+xml;charset=UTF-8,%3csvg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg"%3e%3cpath d="M1 1l6 6 6-6" stroke="%239CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/%3e%3c/svg%3e') no-repeat right 12px center;
    cursor: pointer;
    appearance: none;
  }

  .strategy-cards-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .strategy-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 24px;
  }

  .strategy-card-header {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }

  .strategy-avatar {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 20px;
    font-weight: 700;
    color: #6b7280;
  }

  .strategy-card-info {
    flex: 1;
    min-width: 0;
  }

  .strategy-card-title-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 4px;
  }

  .strategy-card-title {
    font-size: 17px;
    font-weight: 600;
    color: #1a1a1a;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .strategy-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    color: #fff;
  }

  .strategy-badge.is-active {
    background: #10b981;
  }

  .strategy-badge.is-inactive {
    background: #6b7280;
  }

  .strategy-card-type {
    color: #6b7280;
    font-size: 14px;
  }

  .strategy-card-desc {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 16px;
  }

  .strategy-card-section {
    margin-bottom: 12px;
  }

  .strategy-card-label {
    color: #9ca3af;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 4px;
    text-transform: uppercase;
  }

  .strategy-card-value {
    color: #1a1a1a;
    font-size: 14px;
    font-weight: 500;
  }

  .strategy-webhook-section {
    margin-bottom: 20px;
  }

  .strategy-webhook-box {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #f9fafb;
    padding: 8px 11px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }

  .strategy-webhook-url {
    flex: 1;
    font-size: 12px;
    color: #6b7280;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: monospace;
  }

  .strategy-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px;
    display: flex;
    align-items: center;
  }

  .strategy-btn-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 8px;
  }

  .strategy-btn {
    border: none;
    padding: 10px 8px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .strategy-btn-status[data-status="active"] {
    background: #f97316;
    color: #fff;
  }

  .strategy-btn-status[data-status="inactive"] {
    background: #10b981;
    color: #fff;
  }

  .strategy-btn-clone {
    background: #f3f4f6;
    color: #1a1a1a;
  }

  .strategy-btn-payload {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
  }

  .strategy-btn-logs,
  .strategy-btn-edit {
    background: #fff;
    color: #1a1a1a;
    border: 1px solid #e5e7eb;
  }

  .strategy-btn-delete {
    background: #ef4444;
    color: #fff;
    border: none;
  }

  .strategy-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    padding: 40px;
    overflow-y: auto;
  }

  .strategy-modal {
    max-width: 600px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    padding: 32px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .strategy-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .strategy-modal-title {
    font-size: 24px;
    font-weight: 700;
    color: #1a1a1a;
  }

  .strategy-close-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 28px;
    color: #6b7280;
    line-height: 1;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .strategy-form-group {
    margin-bottom: 20px;
  }

  .strategy-form-label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
  }

  .strategy-form-input,
  .strategy-form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
  }

  .strategy-form-select {
    cursor: pointer;
  }

  .strategy-form-actions {
    display: flex;
    gap: 10px;
    padding-top: 12px;
  }

  .strategy-btn-save {
    flex: 1;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    padding: 11px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .strategy-btn-cancel {
    flex: 1;
    background: #fff;
    color: #1a1a1a;
    border: 1px solid #e5e7eb;
    padding: 11px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .strategy-payload-section {
    margin-bottom: 32px;
  }

  .strategy-payload-section:last-child {
    margin-bottom: 0;
  }

  .strategy-payload-label {
    font-size: 14px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 12px;
  }

  .strategy-payload-box {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    position: relative;
  }

  .strategy-payload-code {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #1a1a1a;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.6;
  }

  .strategy-copy-icon-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .strategy-copy-icon-btn:hover {
    background: #f3f4f6;
  }

  @media (max-width: 1024px) {
    .strategy-cards-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .strategies-page-root {
      margin: -1.5rem -1rem 0;
      padding: 24px 0;
    }

    .strategies-page {
      padding: 0 20px 20px;
    }

    .strategies-header {
      flex-direction: column;
      gap: 16px;
    }

    .strategies-header h1 {
      font-size: 28px;
    }

    .strategy-btn-new {
      width: 100%;
    }

    .strategy-filters {
      flex-direction: column;
    }

    .strategy-filters select {
      width: 100%;
    }

    .strategy-search-box input,
    .strategy-filters select {
      padding-left: 44px;
    }

    .strategy-cards-grid {
      grid-template-columns: 1fr;
    }

    .strategy-btn-row {
      grid-template-columns: repeat(2, 1fr);
    }

    .strategy-btn-row:last-of-type {
      grid-template-columns: repeat(3, 1fr);
    }
  }
/* ===== FINAL MOBILE FIX for strategy cards ===== */
@media (max-width: 768px) {

  /* page side padding less so card doesn't look cut */
  .strategies-page-root {
    margin: -1.5rem -0.5rem 0 !important;
    padding: 20px 0 20px !important;
  }
  .strategies-page {
    padding: 0 14px 18px !important;
  }

  /* card should never be wider than screen */
  .strategy-card {
    max-width: 100% !important;
    width: 100% !important;
    padding: 16px 14px 14px !important;
    box-sizing: border-box !important;
  }

  /* webhook box must wrap */
  .strategy-webhook-box {
    display: flex !important;
    flex-wrap: wrap !important;
    align-items: flex-start !important;
    gap: 6px !important;
  }

  /* URL goes on its own line */
  .strategy-webhook-url {
    width: 100% !important;
    white-space: normal !important;   /* allow wrap */
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }

  /* icon buttons stay right but on next line */
  .strategy-webhook-box .strategy-icon-btn {
    margin-left: 0 !important;
  }

  /* buttons grid -> 2 per row */
  .strategy-btn-row {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 8px !important;
  }

  /* make purple Payload full width like in screenshot */
  .strategy-btn-payload {
    grid-column: 1 / -1 !important;
  }

  /* logs & edit stay tidy */
  .strategy-btn-logs,
  .strategy-btn-edit {
    width: 100% !important;
  }
}

/* super small phones */
@media (max-width: 420px) {
  .strategy-btn-row {
    grid-template-columns: 1fr !important;
  }
  
}
/* ===== HARD OVERRIDE: make strategy cards smaller on desktop ===== */

/* container narrower */
.strategies-page-root {
  padding: 28px 0 28px !important;
}
.strategies-page {
  max-width: 1180px !important;
  padding: 0 20px 28px !important;
}

/* grid tighter */
.strategy-cards-grid {
  gap: 16px !important;
}

/* card itself */
.strategy-cards-grid .strategy-card,
.strategy-card {
  padding: 14px 14px 12px !important;   /* was 24 */
  border-radius: 14px !important;
}

/* header */
.strategy-card .strategy-card-header {
  gap: 10px !important;
  margin-bottom: 10px !important;
}

/* avatar small */
.strategy-card .strategy-avatar {
  width: 44px !important;
  height: 44px !important;
  border-radius: 14px !important;
  font-size: 16px !important;
}

/* title smaller */
.strategy-card .strategy-card-title {
  font-size: 15px !important;
  white-space: normal !important;
  line-height: 1.25 !important;
}

/* desc + webhook tighter */
.strategy-card .strategy-card-desc {
  margin-bottom: 10px !important;
}
.strategy-card .strategy-webhook-section {
  margin-bottom: 10px !important;
}
.strategy-card .strategy-webhook-box {
  padding: 5px 8px !important;
}
.strategy-card .strategy-webhook-url {
  font-size: 11.5px !important;
}

/* buttons shorter */
.strategy-card .strategy-btn-row {
  gap: 6px !important;
}
.strategy-card .strategy-btn {
  padding: 7px 6px !important;
  font-size: 12.5px !important;
  border-radius: 8px !important;
}

  .strategies-page-root {
    padding: 28px 0 28px !important;
  }
  .strategies-page {
    max-width: 1180px !important;
    padding: 0 20px 28px !important;
  }
  .strategy-cards-grid {
    gap: 16px !important;
  }
  .strategy-card {
    padding: 14px 14px 12px !important;
    border-radius: 14px !important;
  }
  .strategy-card-header {
    gap: 10px !important;
    margin-bottom: 10px !important;
  }
  .strategy-avatar {
    width: 44px !important;
    height: 44px !important;
    border-radius: 14px !important;
    font-size: 16px !important;
  }
  .strategy-card-title {
    font-size: 15px !important;
    white-space: normal !important;
    line-height: 1.25 !important;
  }
  .strategy-webhook-section {
    margin-bottom: 10px !important;
  }
  .strategy-webhook-box {
    padding: 5px 8px !important;
  }
  .strategy-webhook-url {
    font-size: 11.5px !important;
  }
  .strategy-btn-row {
    gap: 6px !important;
  }
  .strategy-btn {
    padding: 7px 6px !important;
    font-size: 12.5px !important;
    border-radius: 8px !important;
  }

  .strategy-logs-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 140;
  }

  .strategy-logs-overlay.is-visible {
    display: flex;
    animation: strategyLogsFadeIn 0.2s ease-out;
  }

  .strategy-logs-dialog {
    position: relative;
    width: 90%;
    max-width: 768px;
    max-height: 85vh;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    animation: strategyLogsSlideIn 0.2s ease-out;
  }

  body.dark .strategy-logs-dialog,
  body.dark-mode .strategy-logs-dialog {
    background: #0f172a;
    border-color: #1e293b;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.6);
  }

  .strategy-logs-header {
    padding: 24px 24px 20px;
    border-bottom: 1px solid #e2e8f0;
  }

  body.dark .strategy-logs-header,
  body.dark-mode .strategy-logs-header {
    border-bottom-color: #1e293b;
  }

  .strategy-logs-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 4px;
    color: #0f172a;
  }

  body.dark .strategy-logs-title,
  body.dark-mode .strategy-logs-title {
    color: #e2e8f0;
  }

  .strategy-logs-subtitle {
    font-size: 0.875rem;
    color: #64748b;
  }

  body.dark .strategy-logs-subtitle,
  body.dark-mode .strategy-logs-subtitle {
    color: #cbd5f5;
  }

  .strategy-logs-body {
    padding: 24px;
    overflow-y: auto;
    max-height: 100%;
  }

  .strategy-logs-body::-webkit-scrollbar {
    width: 8px;
  }

  .strategy-logs-body::-webkit-scrollbar-track {
    background: #e2e8f0;
    border-radius: 4px;
  }

  body.dark .strategy-logs-body::-webkit-scrollbar-track,
  body.dark-mode .strategy-logs-body::-webkit-scrollbar-track {
    background: #1e293b;
  }

  .strategy-logs-body::-webkit-scrollbar-thumb {
    background: #94a3b8;
    border-radius: 4px;
  }

  body.dark .strategy-logs-body::-webkit-scrollbar-thumb,
  body.dark-mode .strategy-logs-body::-webkit-scrollbar-thumb {
    background: #475569;
  }

  .strategy-logs-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .strategy-log-item {
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 16px;
    transition: background-color 0.2s ease;
  }

  .strategy-log-item:hover {
    background: rgba(226, 232, 240, 0.5);
  }

  body.dark .strategy-log-item,
  body.dark-mode .strategy-log-item {
    border-color: #1e293b;
  }

  body.dark .strategy-log-item:hover,
  body.dark-mode .strategy-log-item:hover {
    background: rgba(30, 41, 59, 0.5);
  }

  .strategy-log-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-wrap: wrap;
  }

  .strategy-log-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 10px;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .strategy-log-badge-success {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .strategy-log-badge-error {
    background: rgba(248, 113, 113, 0.15);
    color: #ef4444;
    border: 1px solid rgba(248, 113, 113, 0.3);
  }

  .strategy-log-badge-warning {
    background: rgba(251, 191, 36, 0.15);
    color: #f59e0b;
    border: 1px solid rgba(251, 191, 36, 0.3);
  }

  .strategy-log-badge-info {
    background: rgba(226, 232, 240, 1);
    color: #0f172a;
    border: 1px solid rgba(226, 232, 240, 1);
  }

  body.dark .strategy-log-badge-info,
  body.dark-mode .strategy-log-badge-info {
    background: rgba(30, 41, 59, 1);
    color: #e2e8f0;
    border-color: rgba(30, 41, 59, 1);
  }

  .strategy-log-timestamp {
    font-size: 0.75rem;
    color: #64748b;
  }

  body.dark .strategy-log-timestamp,
  body.dark-mode .strategy-log-timestamp {
    color: #cbd5f5;
  }

  .strategy-log-message {
    margin-top: 8px;
    font-size: 0.875rem;
    color: #0f172a;
    line-height: 1.5;
  }

  body.dark .strategy-log-message,
  body.dark-mode .strategy-log-message {
    color: #e2e8f0;
  }

  .strategy-logs-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .strategy-logs-close:hover {
    background: #e2e8f0;
    color: #0f172a;
  }

  body.dark .strategy-logs-close,
  body.dark-mode .strategy-logs-close {
    color: #cbd5f5;
  }

  body.dark .strategy-logs-close:hover,
  body.dark-mode .strategy-logs-close:hover {
    background: #1e293b;
    color: #f8fafc;
  }

  .strategy-logs-loading,
  .strategy-logs-empty {
    font-size: 0.875rem;
    color: #64748b;
    text-align: center;
    padding: 16px 0;
  }

  body.dark .strategy-logs-loading,
  body.dark-mode .strategy-logs-loading,
  body.dark .strategy-logs-empty,
  body.dark-mode .strategy-logs-empty {
    color: #cbd5f5;
  }

  @keyframes strategyLogsFadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes strategyLogsSlideIn {
    from {
      transform: translateY(-8px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    .strategy-logs-dialog {
      width: 95%;
      max-height: 90vh;
    }

    .strategy-logs-title {
      font-size: 1.25rem;
    }

    .strategy-logs-body {
      padding: 20px;
    }

    .strategy-log-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }

/* Compact + properly sized cards grid fix */
.strategy-cards-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(310px, 5fr)) !important;
  gap: 14px !important;
  justify-content: center !important;
  align-items: start !important;
}

/* Restrict card width to prevent full stretch */
.strategy-card {
  max-width: 360px !important;
  width: 100% !important;
  margin: 0 auto !important;
  padding: 10px 12px 10px !important;
  border-radius: 14px !important;
}

/* Make overall layout tighter */
.strategies-page {
  max-width: 1180px !important;
  padding: 0 20px 28px !important;
  margin-left: 10px;
}

/* Reduce header and button spacing */
.strategy-card-header {
  gap: 10px !important;
  margin-bottom: 10px !important;
}
.strategy-btn-row {
  gap: 6px !important;
}
.strategy-btn {
  padding: 7px 6px !important;
  font-size: 12.5px !important;
  border-radius: 8px !important;
}

/* Avatar and title adjustments */
.strategy-avatar {
  width: 44px !important;
  height: 44px !important;
  font-size: 16px !important;
}
.strategy-card-title {
  font-size: 15px !important;
  white-space: normal !important;
  line-height: 1.25 !important;
}

/* Webhook and label spacing */
.strategy-webhook-section {
  margin-bottom: 10px !important;
}
.strategy-webhook-box {
  padding: 5px 8px !important;
}
.strategy-webhook-url {
  font-size: 11.5px !important;
}
/* Fix button colors based on status - MUST BE LAST */
.strategy-btn-status[data-status="active"] {
  background: #f97316 !important;  /* Orange for Deactivate */
  color: #fff !important;
}

.strategy-btn-status[data-status="inactive"] {
  background: #10b981 !important;  /* Green for Activate */
  color: #fff !important;
}

/* Mobile button layout fix - 2x3 grid */
@media (max-width: 768px) {
  .strategy-btn-row {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 8px !important;
  }
  
  .strategy-btn-payload {
    grid-column: auto !important;
  }
  
  .strategy-btn {
    padding: 10px 6px !important;
    font-size: 12px !important;
  }
}
/* --- SEARCH BAR OVERRIDE --- */
.strategy-filters{
  display: grid !important;
  grid-template-columns: 1fr 260px 260px !important; /* search grows, filters fixed */
  gap: 16px !important;
  align-items: center !important;
}

.strategy-search-box{
  flex: 1 1 auto !important;
  min-width: 380px !important;
}

.strategy-search-icon{
  left: 16px !important;
  width: 20px !important;
  height: 20px !important;
  opacity: .55 !important;
}

.strategy-search-box input{
  height: 44px !important;              /* taller */
  padding: 14px 16px 14px 48px !important; /* room for icon */
  border-radius: 14px !important;       /* pill-ish */
  border: 1px solid #e7e9f2 !important;
  background: #fff !important;
  font-size: 14px !important;
  line-height: 1 !important;
  box-shadow: 0 1px 2px rgba(16,24,40,.06) !important;
  transition: box-shadow .15s ease, border-color .15s ease !important;
}

.strategy-search-box input::placeholder{
  color: #9aa0ab !important;
}

/* match filter height/shape to search box */
.strategy-filters select{
  height: 44px !important;
  border-radius: 14px !important;
  font-size: 14px !important;
  padding: 14px 40px px 16px !important;
  border: 1px solid #e7e9f2 !important;
  background-color: #fff !important;
  background-position: right 14px center !important;
}

/* focus state like the mock */
.strategy-search-box input:focus,
.strategy-filters select:focus{
  outline: none !important;
  border-color: #cfd5e3 !important;
  box-shadow: 0 0 0 3px rgba(99,102,241,.15) !important;
}

/* --- RESPONSIVE --- */
@media (max-width: 960px){
  .strategy-filters{
    grid-template-columns: 1fr !important;
  }
  .strategy-search-box{ min-width: 0 !important; }
}
/* ===== DESKTOP STRATEGY CARD COMPACT OVERRIDE ===== */
@media (min-width: 1025px) {
  .strategy-cards-grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
    gap: 18px !important;
    justify-content: center !important;
    align-items: start !important;
  }

  .strategy-card {
    max-width: 320px !important;
    width: 100% !important;
    margin: 0 auto !important;
    padding: 16px 18px 14px !important;
    border-radius: 12px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    border: 1px solid #e5e7eb !important;
  }

  .strategy-avatar {
    width: 42px !important;
    height: 42px !important;
    font-size: 15px !important;
    border-radius: 10px !important;
  }

  .strategy-card-header {
    gap: 10px !important;
    margin-bottom: 8px !important;
  }

  .strategy-card-title {
    font-size: 15px !important;
    line-height: 1.2 !important;
  }

  .strategy-card-type,
  .strategy-card-desc,
  .strategy-card-value {
    font-size: 13px !important;
    line-height: 1.4 !important;
  }

  .strategy-card-desc {
    margin-bottom: 10px !important;
  }

  .strategy-webhook-box {
    padding: 6px 8px !important;
  }

  .strategy-webhook-url {
    font-size: 11.5px !important;
  }

  .strategy-btn-row {
    gap: 6px !important;
  }

  .strategy-btn {
    padding: 7px 8px !important;
    font-size: 12px !important;
    border-radius: 8px !important;
  }
}

</style>
{% endblock %}

{% block content %}
<div class="strategies-page-root" data-webhook-base="{{ webhook_base }}" data-webhook-token="{{ logged_in_user.webhook_token or '' }}">
  <div class="strategies-page">
    <div class="strategies-header">
      <div>
        <h1>Alert to Trade</h1>
        <p>Manage your trading strategies and alerts</p>
      </div>
      <button type="button" class="strategy-btn-new" id="createStrategyBtn">Create New Alert</button>
    </div>

    <div class="strategy-filters">
      <div class="strategy-search-box">
        <svg class="strategy-search-icon" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" placeholder="Search strategies by name..." aria-label="Search strategies" data-strategy-search>
      </div>
      <select aria-label="Filter strategies by status" data-strategy-filter="status">
        <option value="all">All Statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select aria-label="Filter strategies by account" style="min-width: 200px;" data-strategy-filter="account">
        <option value="">All Accounts</option>
      </select>
    </div>

    <div class="strategy-messages">
      <div class="strategy-message strategy-loading" data-strategy-loading>Loading strategies...</div>
      <div class="strategy-message strategy-error" data-strategy-error hidden></div>
      <div class="strategy-message strategy-empty" data-strategy-empty hidden>No strategies match your filters.</div>
    </div>

    <div class="strategy-cards-grid" id="strategiesContainer" aria-live="polite"></div>
  </div>
</div>

<div id="editForm" class="strategy-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div class="strategy-modal">
    <div class="strategy-modal-header">
      <h2 id="editTitle" class="strategy-modal-title">Edit Strategy</h2>
      <button type="button" class="strategy-close-btn" aria-label="Close edit form" data-close="edit">&times;</button>
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="editStrategyName">Strategy Name</label>
      <input type="text" id="editStrategyName" class="strategy-form-input" placeholder="Enter strategy name">
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="strategyTypeSelect">Type</label>
      <select id="strategyTypeSelect" class="strategy-form-select">
        <option value="Stocks|Systematic">Stocks - Systematic</option>
        <option value="Stocks|Discretionary">Stocks - Discretionary</option>
        <option value="Options|Systematic">Options - Systematic</option>
        <option value="Options|Discretionary">Options - Discretionary</option>
        <option value="Futures|Systematic">Futures - Systematic</option>
      </select>
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="strategyDescription">Description</label>
      <input type="text" id="strategyDescription" class="strategy-form-input" placeholder="Enter description">
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="strategyAccountSelect">Accounts</label>
      <select id="strategyAccountSelect" class="strategy-form-select">
        <option value="">Select account</option>
      </select>
    </div>
    <div class="strategy-form-actions">
      <button type="button" class="strategy-btn-save" id="saveStrategyChanges">Save Changes</button>
      <button type="button" class="strategy-btn-cancel" data-close="edit">Cancel</button>
    </div>
  </div>
</div>

<div id="payloadModal" class="strategy-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="payloadModalTitle">
  <div class="strategy-modal">
    <div class="strategy-modal-header">
      <h2 class="strategy-modal-title" id="payloadModalTitle">Strategy Webhook Details</h2>
      <button type="button" class="strategy-close-btn" aria-label="Close payload details" data-close="payload">&times;</button>
    </div>
    <p class="strategy-payload-subtitle" id="payloadStrategyName"></p>

    <div class="strategy-payload-section">
      <div class="strategy-payload-label">Webhook URL</div>
      <div class="strategy-payload-box">
        <div class="strategy-payload-code" id="webhookUrl">--</div>
        <button type="button" class="strategy-copy-icon-btn" data-copy-target="webhook" aria-label="Copy webhook URL">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a1a1a" stroke-width="2" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="strategy-payload-section">
      <div class="strategy-payload-label">JSON Payload</div>
      <div class="strategy-payload-box">
        <div class="strategy-payload-code" id="payloadCode">--</div>
        <button type="button" class="strategy-copy-icon-btn" data-copy-target="payload" aria-label="Copy JSON payload">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a1a1a" stroke-width="2" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="logsModal" class="strategy-logs-overlay" role="dialog" aria-modal="true" aria-labelledby="logsTitle" style="display: none;">
  <div class="strategy-logs-dialog">
    <button type="button" class="strategy-logs-close" aria-label="Close strategy logs" data-close="logs">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <div class="strategy-logs-header">
      <h2 class="strategy-logs-title" id="logsTitle">Strategy Logs</h2>
      <p class="strategy-logs-subtitle" id="logsSubtitle"></p>
    </div>
    <div class="strategy-logs-body">
      <div id="logsLoading" class="strategy-logs-loading">Loading logs...</div>
      <div id="logsEmpty" class="strategy-logs-empty" style="display: none;">No logs available yet.</div>
      <div id="logsContainer" class="strategy-logs-container"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    function escapeHtml(value) {
      if (value === null || value === undefined) {
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function truncate(text, limit) {
      if (!text) return '';
      const value = String(text);
      if (value.length <= limit) return value;
      return value.slice(0, limit - 1) + 'â€¦';
    }

    function normalizeListField(value) {
      if (value === null || value === undefined) {
        return [];
      }
      if (Array.isArray(value)) {
        return value;
      }
      if (typeof value === 'number') {
        return [value];
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) {
          return [];
        }
        if ((trimmed.startsWith('[') && trimmed.endsWith(']'))) {
          try {
            const parsed = JSON.parse(trimmed);
            if (Array.isArray(parsed)) {
              return parsed;
            }
          } catch (error) {
            // ignore
          }
        }
        return trimmed
          .split(',')
          .map(part => part.trim())
          .filter(Boolean);
      }
      try {
        const parsed = JSON.parse(value);
        if (Array.isArray(parsed)) {
          return parsed;
        }
      } catch (error) {
        // ignore
      }
      return [];
    }

    function copyFallback(text) {
      const tempInput = document.createElement('textarea');
      tempInput.value = text;
      tempInput.style.position = 'fixed';
      tempInput.style.opacity = '0';
      document.body.appendChild(tempInput);
      tempInput.focus();
      tempInput.select();
      try {
        document.execCommand('copy');
        window.alert('Copied to clipboard');
      } catch (error) {
        window.alert('Unable to copy to clipboard');
      }
      document.body.removeChild(tempInput);
    }

    function copyToClipboard(text) {
      if (!text) {
        window.alert('Nothing to copy');
        return;
      }
      if (!navigator.clipboard) {
        copyFallback(text);
        return;
      }
      navigator.clipboard.writeText(text).then(function () {
        window.alert('Copied to clipboard');
      }).catch(function () {
        copyFallback(text);
      });
    }

    function expandBoth(value, bothValues) {
      if (Array.isArray(value)) {
        return value;
      }
      if (value === null || value === undefined) {
        return bothValues[0];
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) {
          return bothValues[0];
        }
        if ((trimmed.startsWith('[') && trimmed.endsWith(']'))) {
          try {
            const parsed = JSON.parse(trimmed);
            if (Array.isArray(parsed)) {
              return parsed;
            }
          } catch (error) {
            // ignore malformed arrays
          }
        }
        if (trimmed.toUpperCase() === 'BOTH') {
          return bothValues.slice();
        }
        return trimmed;
      }
      return value;
    }

    async function fetchJson(url, options = {}) {
      const response = await fetch(url, options);
      const contentType = response.headers.get('Content-Type') || '';
      let data = null;
      if (contentType.includes('application/json')) {
        data = await response.json();
      } else {
        const text = await response.text();
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (error) {
            data = { message: text };
          }
        }
      }
      if (!response.ok) {
        const message = data && (data.error || data.message);
        throw new Error(message || 'Request failed');
      }
      return data;
    }

    class DematStrategiesPage {
      constructor(root) {
        this.root = null;
        this.container = null;
        this.searchInput = null;
        this.statusFilter = null;
        this.accountFilter = null;
        this.createButton = null;
        this.loadingMessage = null;
        this.errorMessage = null;
        this.emptyMessage = null;
        this.editModal = null;
        this.payloadModal = null;
        this.editTitle = null;
        this.nameInput = null;
        this.typeSelect = null;
        this.descriptionInput = null;
        this.accountSelect = null;
        this.saveButton = null;
        this.payloadWebhook = null;
        this.payloadCode = null;
        this.payloadName = null;
        this.logsModal = null;
        this.logsTitle = null;
        this.logsSubtitle = null;
        this.logsContainer = null;
        this.logsLoading = null;
        this.logsEmpty = null;
        this.state = {
          strategies: [],
          accounts: [],
          filters: {
            search: '',
            searchRaw: '',
            status: 'all',
            account: ''
          },
          editing: null
        };
        this.accountIdMap = new Map();
        this.accountClientMap = new Map();
        this.accountVersion = 0;
        this.isSaving = false;
        this.webhookBase = '';
        this.webhookToken = '';
        this.logsRequestId = 0;
        this.currentLogsStrategy = null;
        this.hasLoaded = false;
        this.isReloading = false;
        this.boundEvents = [];
        this.handleSearchInput = () => {
          const value = this.searchInput?.value || '';
          this.state.filters.searchRaw = value;
          this.state.filters.search = value.trim().toLowerCase();
          this.renderStrategies();
        };
        this.handleStatusFilterChange = () => {
          this.state.filters.status = this.statusFilter?.value || 'all';
          this.renderStrategies();
        };
        this.handleAccountFilterChange = () => {
          this.state.filters.account = this.accountFilter?.value || '';
          this.renderStrategies();
        };
        this.handleCreateButtonClick = () => {
          window.location.href = '/create-alerts';
        };
        this.boundContainerClick = (event) => this.handleContainerClick(event);
        this.handleCloseEditButton = () => this.closeEditModal();
        this.handleClosePayloadButton = () => this.closePayloadModal();
        this.handleCloseLogsButton = () => this.closeLogsModal();
        this.handleEditModalClick = (event) => {
          if (event.target === this.editModal) {
            this.closeEditModal();
          }
        };
        this.handlePayloadModalClick = (event) => {
          if (event.target === this.payloadModal) {
            this.closePayloadModal();
            return;
          }
          const copyBtn = event.target.closest('.strategy-copy-icon-btn');
          if (!copyBtn) {
            return;
          }
          const target = copyBtn.dataset.copyTarget;
          if (target === 'webhook') {
            copyToClipboard(this.payloadWebhook?.textContent?.trim() || '');
          } else if (target === 'payload') {
            copyToClipboard(this.payloadCode?.textContent?.trim() || '');
          }
        };
        this.handleLogsModalClick = (event) => {
          if (event.target === this.logsModal) {
            this.closeLogsModal();
          }
        };
        this.handleGlobalKeydown = (event) => {
          if (event.key === 'Escape') {
            this.closeLogsModal();
          }
        };
        this.attach(root);
        this.reload();
      }

      captureDomReferences(root) {
        this.root = root;
        if (!root) {
          return;
        }
        this.container = root.querySelector('#strategiesContainer');
        this.searchInput = root.querySelector('[data-strategy-search]');
        this.statusFilter = root.querySelector('[data-strategy-filter="status"]');
        this.accountFilter = root.querySelector('[data-strategy-filter="account"]');
        this.createButton = root.querySelector('#createStrategyBtn');
        this.loadingMessage = root.querySelector('[data-strategy-loading]');
        this.errorMessage = root.querySelector('[data-strategy-error]');
        this.emptyMessage = root.querySelector('[data-strategy-empty]');
        this.editModal = document.getElementById('editForm');
        this.payloadModal = document.getElementById('payloadModal');
        this.editTitle = document.getElementById('editTitle');
        this.nameInput = document.getElementById('editStrategyName');
        this.typeSelect = document.getElementById('strategyTypeSelect');
        this.descriptionInput = document.getElementById('strategyDescription');
        this.accountSelect = document.getElementById('strategyAccountSelect');
        this.saveButton = document.getElementById('saveStrategyChanges');
        this.payloadWebhook = document.getElementById('webhookUrl');
        this.payloadCode = document.getElementById('payloadCode');
        this.payloadName = document.getElementById('payloadStrategyName');
        this.logsModal = document.getElementById('logsModal');
        this.logsTitle = document.getElementById('logsTitle');
        this.logsSubtitle = document.getElementById('logsSubtitle');
        this.logsContainer = document.getElementById('logsContainer');
        this.logsLoading = document.getElementById('logsLoading');
        this.logsEmpty = document.getElementById('logsEmpty');
        const dataset = root.dataset || {};
        if (dataset.webhookBase !== undefined) {
          this.webhookBase = dataset.webhookBase || '';
        }
        if (dataset.webhookToken !== undefined) {
          this.webhookToken = dataset.webhookToken || '';
        }
        if (!this.webhookBase && this.webhookToken) {
          const origin = window.location.origin.replace(/\/$/, '');
          this.webhookBase = origin + '/webhook/' + this.webhookToken;
        }
      }

      registerEvent(target, eventName, handler) {
        if (!target || !eventName || !handler) {
          return;
        }
        target.addEventListener(eventName, handler);
        this.boundEvents.push({ target, eventName, handler });
      }

      detachEvents() {
        if (!Array.isArray(this.boundEvents) || !this.boundEvents.length) {
          this.boundEvents = [];
          return;
        }
        this.boundEvents.forEach(({ target, eventName, handler }) => {
          try {
            target.removeEventListener(eventName, handler);
          } catch (error) {
            // ignore cleanup errors
          }
        });
        this.boundEvents = [];
      }

      attach(root) {
        if (!root) {
          return;
        }
        this.detachEvents();
        this.captureDomReferences(root);
        this.bindEvents();
      }

      bindEvents() {
        if (!Array.isArray(this.boundEvents)) {
          this.boundEvents = [];
        }
        if (this.searchInput) {
          this.searchInput.value = this.state.filters.searchRaw;
          this.registerEvent(this.searchInput, 'input', this.handleSearchInput);
        }

        if (this.statusFilter) {
          this.statusFilter.value = this.state.filters.status;
          this.registerEvent(this.statusFilter, 'change', this.handleStatusFilterChange);
        }

        if (this.accountFilter) {
          this.accountFilter.value = this.state.filters.account;
          this.registerEvent(this.accountFilter, 'change', this.handleAccountFilterChange);
        }

        if (this.createButton) {
          this.registerEvent(this.createButton, 'click', this.handleCreateButtonClick);
        }

        if (this.container) {
          this.registerEvent(this.container, 'click', this.boundContainerClick);
        }

        document.querySelectorAll('[data-close="edit"]').forEach(btn => {
          this.registerEvent(btn, 'click', this.handleCloseEditButton);
        });

        document.querySelectorAll('[data-close="payload"]').forEach(btn => {
          this.registerEvent(btn, 'click', this.handleClosePayloadButton);
        });

        if (this.editModal) {
          this.registerEvent(this.editModal, 'click', this.handleEditModalClick);
        }

        if (this.payloadModal) {
          this.registerEvent(this.payloadModal, 'click', this.handlePayloadModalClick);
        }

        document.querySelectorAll('[data-close="logs"]').forEach(btn => {
          this.registerEvent(btn, 'click', this.handleCloseLogsButton);
        });

        if (this.logsModal) {
          this.registerEvent(this.logsModal, 'click', this.handleLogsModalClick);
        }

        this.registerEvent(document, 'keydown', this.handleGlobalKeydown);
      }

      async reload() {
        this.isReloading = true;
        this.setLoading(true);
        this.showError();
        try {
          const [accountsPayload, strategiesPayload] = await Promise.all([
            fetchJson('/api/accounts?cache_only=1'),
            fetchJson('/api/strategies')
          ]);
          const masters = Array.isArray(accountsPayload?.masters) ? accountsPayload.masters : [];  
          const accounts = Array.isArray(accountsPayload?.accounts) ? accountsPayload.accounts : [];
          const combined = [];
          const seenIds = new Set();
          [...masters, ...accounts].forEach(acc => {
            if (!acc) {
              return;
            }
            const id = acc.id !== undefined && acc.id !== null ? String(acc.id) : null;
            if (id) {
              if (seenIds.has(id)) {
                return;
              }
              seenIds.add(id);
            }
            combined.push(acc);
          });
          this.state.accounts = combined;
          this.accountIdMap = new Map(combined
            .filter(acc => acc && acc.id !== undefined && acc.id !== null)
            .map(acc => [String(acc.id), acc]));
          this.accountClientMap = new Map(combined
            .filter(acc => acc && acc.client_id)
            .map(acc => [String(acc.client_id), acc]));
          this.accountVersion += 1;
          this.populateAccountFilters();
          const strategies = Array.isArray(strategiesPayload) ? strategiesPayload : [];
          this.state.strategies = strategies;
          this.hasLoaded = true;
          this.renderStrategies();
        } catch (error) {
          console.error('Failed to load strategies', error);
          this.showError(error.message || 'Failed to load strategies.');
          if (this.container) {
            this.container.innerHTML = '';
          }
        } finally {
          this.isReloading = false;
          this.setLoading(false);
        }
      }

      resume() {
        this.showError();
        if (!this.hasLoaded) {
          this.setLoading(true);
          if (!this.isReloading) {
            this.reload();
          }
          return;
        }
        this.populateAccountFilters();
        this.renderStrategies();
      }

      populateAccountFilters() {
        if (this.accountFilter) {
          const current = this.state.filters.account;
          this.accountFilter.innerHTML = '<option value="">All Accounts</option>';
          this.state.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = String(acc.id);
            option.textContent = this.formatAccountLabel(acc);
            this.accountFilter.appendChild(option);
          });
          if (current && this.accountFilter.querySelector(`option[value="${current}"]`)) {
            this.accountFilter.value = current;
          }
        }

        if (this.accountSelect) {
          const current = this.accountSelect.value;
          this.accountSelect.innerHTML = '<option value="">Select account</option>';
          this.state.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = String(acc.id);
            option.textContent = this.formatAccountLabel(acc);
            this.accountSelect.appendChild(option);
          });
          if (current && this.accountSelect.querySelector(`option[value="${current}"]`)) {
            this.accountSelect.value = current;
          }
        }
      }

      formatAccountLabel(account) {
        if (!account) {
          return 'Account';
        }
        const username = account.username || '';
        const clientId = account.client_id || '';
        const broker = account.broker || '';
        const primary = username || clientId || 'Account';
        const extras = [];
        if (clientId && primary !== clientId) {
          extras.push(clientId);
        }
        if (broker) {
          extras.push(broker);
        }
        return extras.length ? `${primary} (${extras.join(') (')})` : primary;
      }

      setLoading(isLoading) {
        if (this.loadingMessage) {
          this.loadingMessage.hidden = !isLoading;
        }
        if (isLoading) {
          this.setEmptyVisible(false);
        }
      }

      showError(message) {
        if (!this.errorMessage) {
          if (message) {
            window.alert(message);
          }
          return;
        }
        if (message) {
          this.errorMessage.textContent = message;
          this.errorMessage.hidden = false;
        } else {
          this.errorMessage.textContent = '';
          this.errorMessage.hidden = true;
        }
      }

      setEmptyVisible(show) {
        if (this.emptyMessage) {
          this.emptyMessage.hidden = !show;
        }
      }

      getFilteredStrategies() {
        const filters = this.state.filters;
        return this.state.strategies.filter(strategy => {
          if (filters.search && !(String(strategy.name || '').toLowerCase().includes(filters.search))) {
            return false;
          }
          if (filters.status === 'active' && !strategy.is_active) {
            return false;
          }
          if (filters.status === 'inactive' && strategy.is_active) {
            return false;
          }
          if (filters.account) {
            const linked = this.getResolvedAccounts(strategy);
            if (!linked.some(item => item.account && String(item.account.id) === filters.account)) {
              return false;
            }
          }
          return true;
        });
      }

      renderStrategies() {
        if (!this.container) {
          return;
        }
        const strategies = this.getFilteredStrategies();
        this.setLoading(false);
        if (!strategies.length) {
          this.container.innerHTML = '';
          this.setEmptyVisible(true);
          return;
        }
        this.setEmptyVisible(false);
        const html = strategies.map(strategy => this.renderStrategyCard(strategy)).join('');
        this.container.innerHTML = html;
      }

      renderStrategyCard(strategy) {
        const name = strategy.name || 'Untitled Strategy';
        const isActive = Boolean(strategy.is_active);
        const badgeClass = isActive ? 'is-active' : 'is-inactive';
        const badgeLabel = isActive ? 'Active' : 'Inactive';
        const toggleLabel = isActive ? 'Deactivate' : 'Activate';
        const accounts = this.getResolvedAccounts(strategy);
        const accountsText = accounts.length ? accounts.map(item => escapeHtml(item.label)).join(', ') : 'No linked accounts';
        const typeLabel = escapeHtml(this.formatStrategyType(strategy));
        const description = strategy.description ? escapeHtml(strategy.description) : 'No description provided for this strategy.';
        const webhookUrl = this.buildWebhookUrl(strategy);
        const webhookDisplay = webhookUrl ? escapeHtml(truncate(webhookUrl, 72)) : 'Webhook URL unavailable';
        const webhookTitle = webhookUrl ? escapeHtml(webhookUrl) : 'Webhook URL unavailable';
        const avatar = escapeHtml((name.trim() || '?').charAt(0).toUpperCase());
        return `
      <article class="strategy-card" data-strategy-id="${strategy.id}">
        <header class="strategy-card-header">
          <div class="strategy-avatar" aria-hidden="true">${avatar || '?'}</div>
          <div class="strategy-card-info">
            <div class="strategy-card-title-row">
              <h3 class="strategy-card-title" title="${escapeHtml(name)}">${escapeHtml(name)}</h3>
              <span class="strategy-badge ${badgeClass}">${badgeLabel}</span>
            </div>
            <p class="strategy-card-type">${typeLabel}</p>
          </div>
        </header>
        <p class="strategy-card-desc">${description}</p>
        <div class="strategy-card-section">
          <p class="strategy-card-label">Accounts</p>
          <p class="strategy-card-value">${accountsText}</p>
        </div>
        <section class="strategy-webhook-section">
          <p class="strategy-card-label">Webhook URL</p>
          <div class="strategy-webhook-box">
            <code class="strategy-webhook-url" title="${webhookTitle}">${webhookDisplay}</code>
            <button type="button" class="strategy-icon-btn" data-action="copy-webhook" data-id="${strategy.id}" aria-label="Copy webhook URL">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" aria-hidden="true">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
            <button type="button" class="strategy-icon-btn" data-action="refresh-webhook" data-id="${strategy.id}" aria-label="Refresh webhook secret">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" aria-hidden="true">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>
            <button type="button" class="strategy-icon-btn" data-action="test-webhook" data-id="${strategy.id}" aria-label="Test webhook">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="#ef4444" aria-hidden="true">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
          </div>
        </section>
        <div class="strategy-btn-row">
          <button type="button" class="strategy-btn strategy-btn-status" data-action="toggle-status" data-id="${strategy.id}" data-status="${isActive ? 'active' : 'inactive'}">${toggleLabel}</button>
          <button type="button" class="strategy-btn strategy-btn-clone" data-action="clone" data-id="${strategy.id}">Clone</button>
          <button type="button" class="strategy-btn strategy-btn-payload" data-action="show-payload" data-id="${strategy.id}">Payload</button>
        </div>
        <div class="strategy-btn-row">
          <button type="button" class="strategy-btn strategy-btn-logs" data-action="view-logs" data-id="${strategy.id}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Logs
          </button>
          <button type="button" class="strategy-btn strategy-btn-edit" data-action="edit" data-id="${strategy.id}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit
          </button>
          <button type="button" class="strategy-btn strategy-btn-delete" data-action="delete" data-id="${strategy.id}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
          </button>
        </div>
      </article>`;
      }

      formatStrategyType(strategy) {
        const asset = strategy.asset_class || 'Unknown';
        const style = strategy.style || '';
        return style ? `${asset} - ${style}` : asset;
      }

      getResolvedAccounts(strategy) {
        const cacheKey = '__resolvedAccounts';
        const versionKey = '__accountsVersion';
        if (strategy[versionKey] === this.accountVersion && Array.isArray(strategy[cacheKey])) {
          return strategy[cacheKey];
        }
        const results = [];
        const seen = new Set();
        const addAccount = (label, account) => {
          const key = account ? `acc-${account.id}` : `label-${label}`;
          if (seen.has(key)) {
            return;
          }
          seen.add(key);
          results.push({ label, account });
        };
        if (strategy.account_id) {
          const account = this.accountIdMap.get(String(strategy.account_id));
          const label = account ? this.formatAccountLabel(account) : `Account #${strategy.account_id}`;
          addAccount(label, account);
        }
        normalizeListField(strategy.master_accounts).forEach(raw => {
          const key = String(raw);
          const account = this.accountIdMap.get(key) || this.accountClientMap.get(key);
          if (account) {
            addAccount(this.formatAccountLabel(account), account);
          } else if (key) {
            addAccount(key, null);
          }
        });
        strategy[cacheKey] = results;
        strategy[versionKey] = this.accountVersion;
        return results;
      }

      buildWebhookUrl(strategy) {        const base = this.webhookBase;
        if (!base) {
          return '';
        }
        const origin = window.location.origin.replace(/\/$/, '');
        const trimmedBase = base.startsWith('http') ? base : `${origin}/${base.replace(/^\//, '')}`;
        if (!strategy?.webhook_secret) {
          return trimmedBase;
        }
        const separator = trimmedBase.includes('?') ? '&' : '?';
        return `${trimmedBase}${separator}secret=${encodeURIComponent(strategy.webhook_secret)}`;
      }

      getPayloadStorageKey(id) {
        return `strategyPayload_${id}`;
      }

      getStoredPayload(id) {
        if (!id && id !== 0) {
          return null;
        }
        try {
          const raw = window.localStorage.getItem(this.getPayloadStorageKey(id));
          if (!raw) {
            return null;
          }
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        } catch (error) {
          console.warn('Failed to parse stored payload', error);
        }
        return null;
      }

      savePayload(id, payload) {
        if (!id && id !== 0) {
          return;
        }
        try {
          window.localStorage.setItem(this.getPayloadStorageKey(id), JSON.stringify(payload));
        } catch (error) {
          console.warn('Failed to persist payload preview', error);
        }
      }

      buildPayloadFromStrategy(strategy) {
        if (!strategy) {
          return {};
        }
        const payload = {
          exchange: expandBoth(strategy.exchange || 'NSE', ['NSE', 'BSE']),
          transactionType: expandBoth(strategy.transaction_type || 'BUY', ['BUY', 'SELL']),
          orderType: strategy.order_type || 'limit',
          orderValidity: strategy.order_validity || 'day',
          productType: strategy.product_type || 'intraday',
          masterAccounts: normalizeListField(strategy.master_accounts).map(value => String(value))
        };
        if (strategy.order_qty) {
          const qty = Number(strategy.order_qty);
          if (!Number.isNaN(qty)) {
            payload.orderQty = qty;
          }
        }
        if (strategy.order_value) {
          const orderValue = Number(strategy.order_value);
          if (!Number.isNaN(orderValue)) {
            payload.orderValue = orderValue;
          }
        }
        if (strategy.allowed_tickers === '__WATCHLIST_DYNAMIC__') {
          payload.tradingSymbols = ["{{ticker}}"];
        } else if (strategy.allowed_tickers) {
          payload.tradingSymbols = normalizeListField(strategy.allowed_tickers);
        } else {
          payload.tradingSymbols = [];
        }
        return payload;
      }

      buildPayload(strategy) {
        const stored = this.getStoredPayload(strategy?.id);
        if (stored) {
          return stored;
        }
        return this.buildPayloadFromStrategy(strategy);
      }

      openPayloadModal(strategy) {
        if (!this.payloadModal) {
          return;
        }
        if (this.payloadName) {
          this.payloadName.textContent = strategy.name || `Strategy #${strategy.id}`;
        }
        if (this.payloadWebhook) {
          const webhook = this.buildWebhookUrl(strategy);
          this.payloadWebhook.textContent = webhook || 'Webhook URL unavailable';
        }
        if (this.payloadCode) {
          const payload = this.buildPayload(strategy);
          this.payloadCode.textContent = JSON.stringify(payload, null, 2);
          this.savePayload(strategy.id, payload);
        }
        this.payloadModal.style.display = 'block';
      }

      closePayloadModal() {
        if (this.payloadModal) {
          this.payloadModal.style.display = 'none';
        }
      }

      formatLogTimestamp(value) {
        if (!value) {
          return '';
        }
        try {
          const date = new Date(value);
          if (!Number.isNaN(date.getTime())) {
            return date.toLocaleString();
          }
        } catch (error) {
          // ignore
        }
        return String(value);
      }

      formatLogLevel(level) {
        const normalized = String(level || 'INFO').trim();
        return normalized ? normalized.toUpperCase() : 'INFO';
      }

      getLogBadgeClass(level) {
        const normalized = String(level || '').toLowerCase();
        if (normalized === 'success' || normalized === 'ok') {
          return 'strategy-log-badge-success';
        }
        if (normalized === 'error' || normalized === 'fail' || normalized === 'failure' || normalized === 'critical') {
          return 'strategy-log-badge-error';
        }
        if (normalized === 'warning' || normalized === 'warn') {
          return 'strategy-log-badge-warning';
        }
        return 'strategy-log-badge-info';
      }

      renderLogs(logs) {
        if (!this.logsContainer) {
          return;
        }
        const items = logs.map(log => {
          const badgeClass = this.getLogBadgeClass(log?.level);
          const levelLabel = escapeHtml(this.formatLogLevel(log?.level));
          const timestamp = escapeHtml(this.formatLogTimestamp(log?.timestamp));
          const message = escapeHtml(log?.message || '');
          const displayedMessage = message || 'â€”';
          return `
            <div class="strategy-log-item">
              <div class="strategy-log-header">
                <span class="strategy-log-badge ${badgeClass}">${levelLabel}</span>
                <span class="strategy-log-timestamp">${timestamp}</span>
              </div>
              <p class="strategy-log-message">${displayedMessage}</p>
            </div>
          `;
        }).join('');
        this.logsContainer.innerHTML = items;
        this.logsContainer.scrollTop = 0;
      }

      openLogsModal(strategy) {
        if (!strategy) {
          return;
        }

        this.currentLogsStrategy = strategy;
        this.logsRequestId += 1;
        const requestId = this.logsRequestId;
        this.logsModal.style.display = 'flex';
        this.logsModal.classList.add('is-visible');
        if (this.logsTitle) {
          this.logsTitle.textContent = 'Strategy Logs';
        }
        if (this.logsSubtitle) {
          this.logsSubtitle.textContent = strategy.name || `Strategy #${strategy.id}`;
        }
        if (this.logsContainer) {
          this.logsContainer.innerHTML = '';
        }
        if (this.logsLoading) {
          this.logsLoading.style.display = 'block';
        }
        if (this.logsEmpty) {
          this.logsEmpty.style.display = 'none';
          this.logsEmpty.textContent = 'No logs available yet.';
        }

        fetchJson(`/api/strategies/${strategy.id}/logs`).then(logs => {
          if (requestId !== this.logsRequestId) {
            return;
          }
          if (Array.isArray(logs) && logs.length) {
            this.renderLogs(logs);
            if (this.logsEmpty) {
              this.logsEmpty.style.display = 'none';
            }
          } else {
            if (this.logsContainer) {
              this.logsContainer.innerHTML = '';
            }
            if (this.logsEmpty) {
              this.logsEmpty.textContent = 'No logs available yet.';
              this.logsEmpty.style.display = 'block';
            }
          }
        }).catch(error => {
          if (requestId !== this.logsRequestId) {
            return;
          }
          console.error('Failed to load strategy logs', error);
          if (this.logsContainer) {
            this.logsContainer.innerHTML = '';
          }
          if (this.logsEmpty) {
            this.logsEmpty.textContent = error.message || 'Failed to load strategy logs.';
            this.logsEmpty.style.display = 'block';
          }
        }).finally(() => {
          if (requestId !== this.logsRequestId) {
            return;
          }
          if (this.logsLoading) {
            this.logsLoading.style.display = 'none';
          }
        });
      }

      closeLogsModal() {
        this.logsRequestId += 1;
        if (this.logsModal) {
          this.logsModal.classList.remove('is-visible');
          this.logsModal.style.display = 'none';
        }
        if (this.logsLoading) {
          this.logsLoading.style.display = 'none';
        }
        if (this.logsEmpty) {
          this.logsEmpty.style.display = 'none';
        }
        this.currentLogsStrategy = null;
      }

      openEditModal(strategy) {
        const url = strategy && strategy.id ? `/create-alerts?strategy_id=${encodeURIComponent(strategy.id)}` : '/create-alerts';
        window.location.href = url;
      }

      ensureTypeOption(value) {
        if (!this.typeSelect || !value) {
          return;
        }
        if (this.typeSelect.querySelector(`option[value="${value}"]`)) {
          return;
        }
        const [asset, style] = value.split('|');
        const label = [asset, style].filter(Boolean).join(' - ');
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label || value;
        option.dataset.dynamic = 'true';
        this.typeSelect.appendChild(option);
      }

      closeEditModal() {
        if (this.editModal) {
          this.editModal.style.display = 'none';
        }
        this.state.editing = null;
      }

      async toggleStatus(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          const action = strategy.is_active ? 'deactivate' : 'activate';
          await fetchJson(`/api/strategies/${strategy.id}/${action}`, { method: 'POST' });
          strategy.is_active = !strategy.is_active;
          this.renderStrategies();
          window.alert(`Strategy ${strategy.is_active ? 'activated' : 'deactivated'}.`);
        } catch (error) {
          this.showError(error.message || 'Failed to update strategy status.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async cloneStrategy(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          await fetchJson(`/api/strategies/${strategy.id}/clone`, { method: 'POST' });
          window.alert('Strategy cloned successfully.');
          await this.reload();
        } catch (error) {
          this.showError(error.message || 'Failed to clone strategy.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async deleteStrategy(strategy, button) {
        const title = strategy.name || 'this strategy';
        if (!window.confirm(`Are you sure you want to delete ${title}?`)) {
          return;
        }
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          await fetchJson(`/api/strategies/${strategy.id}`, { method: 'DELETE' });
          this.state.strategies = this.state.strategies.filter(item => item.id !== strategy.id);
          try {
            window.localStorage.removeItem(this.getPayloadStorageKey(strategy.id));
          } catch (error) {
            console.warn('Failed to remove stored payload', error);
          }
          this.renderStrategies();
          window.alert('Strategy deleted.');
        } catch (error) {
          this.showError(error.message || 'Failed to delete strategy.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async refreshWebhookSecret(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          const data = await fetchJson(`/api/strategies/${strategy.id}/regenerate-secret`, { method: 'POST' });
          if (data?.webhook_secret) {
            strategy.webhook_secret = data.webhook_secret;
            try {
              window.localStorage.removeItem(this.getPayloadStorageKey(strategy.id));
            } catch (error) {
              console.warn('Failed to reset stored payload after secret regen', error);
            }
            this.renderStrategies();
            window.alert('Generated a new webhook secret.');
          }
        } catch (error) {
          this.showError(error.message || 'Failed to regenerate webhook secret.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async testWebhook(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          const result = await fetchJson(`/api/strategies/${strategy.id}/test-webhook`, { method: 'POST' });
          const status = result?.status;
          let responseText = result?.response;
          if (responseText && typeof responseText === 'object') {
            responseText = JSON.stringify(responseText, null, 2);
          }
          window.alert(`Test webhook responded with status ${status}.
${responseText || ''}`);
        } catch (error) {
          this.showError(error.message || 'Failed to trigger test webhook.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      handleContainerClick(event) {
        const button = event.target.closest('[data-action]');
        if (!button || !this.container || !this.container.contains(button)) {
          return;
        }
        const id = button.getAttribute('data-id');
        const strategy = this.state.strategies.find(item => String(item.id) === String(id));
        if (!strategy) {
          return;
        }
        const action = button.dataset.action;
        if (action === 'toggle-status') {
          this.toggleStatus(strategy, button);
        } else if (action === 'clone') {
          this.cloneStrategy(strategy, button);
        } else if (action === 'delete') {
          this.deleteStrategy(strategy, button);
        } else if (action === 'show-payload') {
          this.openPayloadModal(strategy);
        } else if (action === 'edit') {
          this.openEditModal(strategy);
        } else if (action === 'refresh-webhook') {
          this.refreshWebhookSecret(strategy, button);
        } else if (action === 'test-webhook') {
          this.testWebhook(strategy, button);
        } else if (action === 'copy-webhook') {
          const url = this.buildWebhookUrl(strategy);
          copyToClipboard(url || '');
        } else if (action === 'view-logs') {
          this.openLogsModal(strategy);
        }
      }
    }

      function initializeDematStrategiesPage() {
        const root = document.querySelector('.strategies-page-root');
        if (!root) {
          return;
        }
        const existing = window.__dematStrategiesController;
        if (existing) {
          existing.attach(root);
          existing.resume();
          return;
        }
        window.__dematStrategiesController = new DematStrategiesPage(root);
      }
    
    window.pageScripts = window.pageScripts || {};
    window.pageScripts['demat-strategies'] = initializeDematStrategiesPage;

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeDematStrategiesPage);
    } else {
      initializeDematStrategiesPage();
    }
  })();
</script>
<style>
  .strategies-page-root {
    padding: 28px 0 28px !important;
  }
  .strategies-page {
    max-width: 1180px !important;
    padding: 0 20px 28px !important;
  }
  .strategy-cards-grid {
    gap: 16px !important;
  }
  .strategy-card {
    padding: 14px 14px 12px !important;
    border-radius: 14px !important;
  }
  .strategy-card-header {
    gap: 10px !important;
    margin-bottom: 10px !important;
  }
  .strategy-avatar {
    width: 44px !important;
    height: 44px !important;
    border-radius: 14px !important;
    font-size: 16px !important;
  }
  .strategy-card-title {
    font-size: 15px !important;
    white-space: normal !important;
    line-height: 1.25 !important;
  }
  .strategy-webhook-section {
    margin-bottom: 10px !important;
  }
  .strategy-webhook-box {
    padding: 5px 8px !important;
  }
  .strategy-webhook-url {
    font-size: 11.5px !important;
  }
  .strategy-btn-row {
    gap: 6px !important;
  }
  .strategy-btn {
    padding: 7px 6px !important;
    font-size: 12.5px !important;
    border-radius: 8px !important;
  }
</style>

{% endblock %}
