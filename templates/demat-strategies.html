{% extends "demat-trading.html" %}
{% block title %}Strategies - DhanBot{% endblock %}
{% block content %}
<div class="content-section">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h2>Strategies</h2>
            </div>
        </div>
    </div>

<div id="no-strategies-state" class="empty-state">
    <div class="empty-state-icon">
        <i class="fas fa-chart-bar"></i>
    </div>
    <h3>No Strategies</h3>
    <p>Create your first trading strategy to get started.</p>
    <button id="create-strategy-btn" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Create Strategy
    </button>
</div>

<div id="strategies-card" class="card shadow-lg border-0 rounded-3 my-5" style="display:none;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="card-title mb-0">Current Strategies</h5>
            <button id="create-strategy-btn-alt" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Create Strategy
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="strategiesTable">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Asset Class</th>
                        <th>Style</th>
                        <th>Active</th>
                        <th>Last Run</th>
                        <th></th>    
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="text-center text-muted py-4">Loading strategies...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    <div id="strategy-creation-form" style="display: none;">
        <div class="page-header">
            <h2>New Strategy</h2>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-cog"></i> STRATEGY DETAILS</h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="strategy-name">Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="strategy-name" placeholder="My new strategy">
                    <small class="form-text text-muted">Give your strategy a name. It can be anything and will only be seen by you and your strategy subscribers. (e.g., Reversal Scalp)</small>
                </div>
                <div class="form-group">
                    <label for="strategy-description">Description</label>
                    <textarea class="form-control" id="strategy-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="asset-class">Asset class <span class="text-danger">*</span></label>
                    <select class="form-control" id="asset-class">
                        <option>Stocks</option>
                        </select>
                    <small class="form-text text-muted">Select the asset class that this strategy will use. This will determine the tickers that can be used with this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-group">
                    <label for="strategy-style">Style <span class="text-danger">*</span></label>
                    <select class="form-control" id="strategy-style">
                        <option>Systematic</option>
                        </select>
                    <small class="form-text text-muted">Indicate whether your strategy is systematic or discretionary. This helps us understand your usage and may influence future platform features. <a href="#">More Info</a></small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="allow-auto-submit" checked>
                    <label class="form-check-label" for="allow-auto-submit">Allow auto submit</label>
                    <small class="form-text text-muted">If enabled, strategy subscribers will be allowed to enable auto submit when subscribing to this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="allow-live-trading" checked>
                    <label class="form-check-label" for="allow-live-trading">Allow live trading</label>
                    <small class="form-text text-muted">If enabled, strategy subscribers will be allowed to connect live broker accounts to this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="allow-any-ticker" checked>
                    <label class="form-check-label" for="allow-any-ticker">Allow any ticker</label>
                    <small class="form-text text-muted">Allow any ticker on this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-group mt-3">
                    <label for="allowed-tickers">Allowed tickers</label>
                    <textarea class="form-control" id="allowed-tickers" rows="3" placeholder="Enter multiple tickers separated by commas to restrict this strategy to only these tickers. Checking &quot;Allow any ticker&quot; will override this setting."></textarea>
                    <small class="form-text text-muted">Enter multiple tickers separated by commas to restrict this strategy to only these tickers. Checking "Allow any ticker" will override this setting. <a href="#">More Info</a></small>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-bell"></i> NOTIFICATIONS <span class="badge badge-secondary ml-2">Disabled</span></h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="notification-emails">Emails to notify</label>
                    <textarea class="form-control" id="notification-emails" rows="3"></textarea>
                    <small class="form-text text-muted">Comma-separated list of email addresses that will be notified of successful or failed signals sent to this webhook. <a href="#">More Info</a></small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="notify-failures-only">
                    <label class="form-check-label" for="notify-failures-only">Notify failures only</label>
                    <small class="form-text text-muted">Check this if you only want to be notified of failed strategy webhook requests. <a href="#">More Info</a></small>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-lock"></i> SECURITY <span class="badge badge-secondary ml-2">No Security</span></h4>
            </div>
            <div class="card-body">
                <p class="text-muted">Security settings will go here.</p>
                </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-info-circle"></i> OPTIONAL DETAILS</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">Optional details will go here.</p>
                </div>
        </div>

        <div class="form-group text-center">
            <button type="submit" class="btn btn-success">Save</button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
if (!window.pageScripts) window.pageScripts = {};
window.pageScripts["demat-strategies"] = function() {
    const createStrategyBtn = document.getElementById('create-strategy-btn');
    const createStrategyBtnAlt = document.getElementById('create-strategy-btn-alt');
    const noStrategiesState = document.getElementById('no-strategies-state');
    const strategyCreationForm = document.getElementById('strategy-creation-form');
    const strategiesCard = document.getElementById('strategies-card');
    const strategiesTableBody = document.querySelector('#strategiesTable tbody');

    function fetchJson(url, options = {}) {
        return fetch(url, options).then(resp => {
            if (!resp.ok) {
                return resp.json().then(err => { throw new Error(err.error || 'Request failed'); });
            }
            return resp.json();
        });
    }

    function showToast(message, type='success') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        alert(message);
    }
    
    if (createStrategyBtn) {
        createStrategyBtn.addEventListener('click', () => {
            noStrategiesState.style.display = 'none';
            strategyCreationForm.style.display = 'block';
        });
    }
    if (createStrategyBtnAlt) {
        createStrategyBtnAlt.addEventListener('click', () => {
            strategyCreationForm.style.display = 'block';
        });
    }

    function loadStrategies() {
        fetchJson('/api/strategies')
            .then(list => {
                strategiesTableBody.innerHTML = '';
                if (!list || list.length === 0) {
                    strategiesCard.style.display = 'none';
                    noStrategiesState.style.display = 'block';
                    return;
                }
                strategiesCard.style.display = 'block';
                noStrategiesState.style.display = 'none';
                list.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${s.name}</td><td>${s.asset_class}</td><td>${s.style}</td>`;
                    const tdActive = document.createElement('td');
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'btn btn-sm ' + (s.is_active ? 'btn-warning' : 'btn-success');
                    toggleBtn.textContent = s.is_active ? 'Deactivate' : 'Activate';
                    toggleBtn.addEventListener('click', () => {
                        const action = s.is_active ? 'deactivate' : 'activate';
                        fetchJson(`/api/strategies/${s.id}/${action}`, { method: 'POST' })
                            .then(() => loadStrategies())
                            .catch(err => showToast('Update failed: ' + err.message, 'error'));
                    });
                    tdActive.appendChild(toggleBtn);
                    tr.appendChild(tdActive);

                    const tdLast = document.createElement('td');
                    tdLast.textContent = s.last_run_at ? new Date(s.last_run_at).toLocaleString() : '-';
                    tr.appendChild(tdLast);

                    const tdAction = document.createElement('td');
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-sm btn-danger';
                    delBtn.textContent = 'Delete';
                    delBtn.addEventListener('click', () => {
                        if (!confirm('Delete this strategy?')) return;
                        fetchJson(`/api/strategies/${s.id}`, { method: 'DELETE' })
                            .then(() => {
                                showToast('Strategy deleted');
                                loadStrategies();
                            })
                            .catch(err => showToast('Delete failed: ' + err.message, 'error'));
                    });
                    tdAction.appendChild(delBtn);
                    tr.appendChild(tdAction);
                    strategiesTableBody.appendChild(tr);
                });
            })
            .catch(err => showToast('Failed to load strategies: ' + err.message, 'error'));
    }
    const saveButton = strategyCreationForm.querySelector('button[type="submit"]');
    if (saveButton) {
        saveButton.addEventListener('click', function(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('strategy-name').value.trim(),
                description: document.getElementById('strategy-description').value.trim(),
                asset_class: document.getElementById('asset-class').value,
                style: document.getElementById('strategy-style').value,
                allow_auto_submit: document.getElementById('allow-auto-submit').checked,
                allow_live_trading: document.getElementById('allow-live-trading').checked,
                allow_any_ticker: document.getElementById('allow-any-ticker').checked,
                allowed_tickers: document.getElementById('allowed-tickers').value.trim(),
                notification_emails: document.getElementById('notification-emails').value.trim(),
                notify_failures_only: document.getElementById('notify-failures-only').checked
            };

            fetchJson('/api/strategies', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(() => {
                showToast('Strategy created successfully!');
                strategyCreationForm.querySelectorAll('input, textarea').forEach(el => {
                    if (el.type === 'checkbox') {
                        el.checked = false;
                    } else {
                        el.value = '';
                    }
                });
                strategyCreationForm.style.display = 'none';
                loadStrategies();
            })
            .catch(err => showToast('Failed to create strategy: ' + err.message, 'error'));
        });
    }

    loadStrategies();
};
</script>
{% endblock %}
