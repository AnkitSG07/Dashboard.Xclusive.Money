{% extends "demat-trading.html" %}
{% block title %}Strategies - DhanBot{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
{% endblock %}

{% block content %}
<body class="h-full">
    <div class="min-h-screen bg-gray-100 p-6 lg:p-12">
        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row items-center justify-between pb-6 border-b border-gray-200 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Strategies</h1>
            <button id="create-strategy-btn-alt" class="bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2">
                <i class="fas fa-plus text-sm"></i>
                <span>Create Strategy</span>
            </button>
        </div>

        <!-- No Strategies State (Initial state) -->
        <div id="no-strategies-state" class="text-center p-16 bg-white rounded-2xl shadow-lg border-2 border-dashed border-gray-300" style="display: none;">
            <div class="text-6xl text-gray-400 mb-4">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="text-2xl font-semibold text-gray-800">No Strategies Yet</h3>
            <p class="mt-2 text-gray-600">Create your first trading strategy to get started with automated trading.</p>
            <button id="create-strategy-btn" class="mt-6 bg-blue-600 text-white px-8 py-3 rounded-xl shadow-lg hover:bg-blue-700 transition-colors duration-200">
                <i class="fas fa-plus mr-2"></i>
                Create Strategy
            </button>
        </div>

        <!-- Strategies Grid (Hidden by default) -->
        <div id="strategies-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display:none;">
            <!-- Strategy Cards will be dynamically inserted here -->
        </div>

        <!-- Strategy Modal -->
        <div id="strategyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-10 mx-auto p-8 border w-11/12 md:w-3/4 lg:w-2/3 shadow-xl rounded-2xl bg-white">
                <form id="strategyForm">
                    <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Create Strategy</h3>
                        <button type="button" class="text-gray-400 hover:text-gray-600 close-modal">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <!-- Strategy Name -->
                        <div class="flex flex-col">
                            <label for="strategy-name" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                Strategy Name <span class="text-red-500 ml-1">*</span>
                                <div class="tooltip-container ml-2">
                                    <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                    <span class="tooltip-text">A unique and descriptive name for your strategy.</span>
                                </div>
                            </label>
                            <input type="text" id="strategy-name" name="strategyName" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>

                        <!-- Master Accounts -->
                        <div class="flex flex-col">
                            <label class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                Master Accounts
                                <div class="tooltip-container ml-2">
                                    <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                    <span class="tooltip-text">Select the master accounts this strategy will trade with.</span>
                                </div>
                            </label>
                            <div id="strategy-accounts" class="flex flex-col space-y-2 bg-gray-50 p-4 rounded-lg">
                                <!-- Accounts will be dynamically inserted here -->
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Exchange -->
                            <div>
                                <label for="exchange" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Exchange <span class="text-red-500 ml-1">*</span>
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">The stock exchange for this strategy.</span>
                                    </div>
                                </label>
                                <select id="exchange" name="exchange" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="NSE">NSE</option>
                                    <option value="BSE">BSE</option>
                                </select>
                            </div>
                            <!-- Symbol Token -->
                            <div>
                                <label for="symbol-token" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Symbol Token
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">An optional field. Usually auto-populated based on the selected symbol.</span>
                                    </div>
                                </label>
                                <input type="text" id="symbol-token" name="symbolToken" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Auto-populated" readonly>
                            </div>

                            <!-- Transaction Type -->
                            <div>
                                <label for="transaction-type" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Type of Transaction <span class="text-red-500 ml-1">*</span>
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">Whether the strategy will execute a BUY or SELL order.</span>
                                    </div>
                                </label>
                                <select id="transaction-type" name="transactionType" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>

                            <!-- Order Type -->
                            <div>
                                <label for="order-type" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Order Type <span class="text-red-500 ml-1">*</span>
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">Market order executes at the current price, while a limit order is for a specific price.</span>
                                    </div>
                                </label>
                                <select id="order-type" name="orderType" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="limit">Limit</option>
                                    <option value="market">Market</option>
                                </select>
                            </div>

                            <!-- Order Validity -->
                            <div>
                                <label for="order-validity" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Order Validity
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">"Day" means the order is valid until the end of the trading day. "IOC" means it's valid until the order is immediately filled or canceled.</span>
                                    </div>
                                </label>
                                <select id="order-validity" name="orderValidity" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="day" selected>Day</option>
                                    <option value="IOC">IOC (Immediate or Cancel)</option>
                                </select>
                            </div>
                            
                            <!-- Product Type -->
                            <div>
                                <label for="product-type" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Type of Product <span class="text-red-500 ml-1">*</span>
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">"Intraday" is for same-day trading. "CNC" is for holding a position overnight.</span>
                                    </div>
                                </label>
                                <select id="product-type" name="productType" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="intraday">Intraday</option>
                                    <option value="cnc">CNC</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Trading Symbols -->
                        <div>
                            <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                Trading Symbols <span class="text-red-500 ml-1">*</span>
                                <div class="tooltip-container ml-2">
                                    <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                    <span class="tooltip-text">The stock symbols this strategy will monitor. In watchlist mode, this is handled by TradingView.</span>
                                </div>
                            </label>
                            <div class="flex items-center space-x-4 mb-2">
                                <div class="flex items-center">
                                    <input type="radio" name="symbolInputMode" id="singleSymbolMode" value="single" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <label for="singleSymbolMode" class="ml-2 text-sm text-gray-700">Single Symbol</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" name="symbolInputMode" id="watchlistMode" value="watchlist" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <label for="watchlistMode" class="ml-2 text-sm text-gray-700">Watchlist (TradingView Alert)</label>
                                </div>
                            </div>
                            <textarea id="trading-symbols" name="tradingSymbols" rows="1" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter single symbol (e.g., RELIANCE)" required></textarea>
                            <p id="symbol-input-help" class="mt-2 text-sm text-gray-500">Enter the trading symbol.</p>
                            <div id="tokens-list" class="mt-2 text-sm text-gray-400"></div>
                        </div>
                        
                        <!-- Order Quantity/Value -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="order-qty" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Order Quantity
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">The number of shares to buy or sell. Leave empty if you want to use Order Value instead.</span>
                                    </div>
                                </label>
                                <input type="number" id="order-qty" name="orderQty" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 10">
                            </div>
                            <div>
                                <label for="order-value" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                    Order Value
                                    <div class="tooltip-container ml-2">
                                        <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                        <span class="tooltip-text">The total monetary value of the order. Quantity will be calculated automatically based on the live price.</span>
                                    </div>
                                </label>
                                <input type="number" id="order-value" name="orderValue" min="1" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 5000">
                            </div>
                        </div>

                        <!-- Webhook Payload Preview -->
                        <div>
                            <label for="webhook-preview" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                                Webhook Payload Preview
                                <div class="tooltip-container ml-2">
                                    <i class="fas fa-circle-info text-gray-400 text-xs"></i>
                                    <span class="tooltip-text">The JSON payload that will be sent to your webhook URL.</span>
                                </div>
                            </label>
                            <textarea id="webhook-preview" rows="5" class="w-full bg-gray-100 p-3 border border-gray-300 rounded-lg focus:outline-none" readonly>
</textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-8 space-x-4">
                        <button type="button" class="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-100 transition-colors duration-200 close-modal">Cancel</button>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-blue-700 transition-colors duration-200">Save Strategy</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Payload Modal (Redesigned) -->
        <div id="payloadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-10 mx-auto p-8 border w-11/12 md:w-1/2 shadow-xl rounded-2xl bg-white">
                <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Strategy Payload</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600 close-modal">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                        <div class="relative flex items-center">
                            <input id="payload-webhook" type="text" class="w-full text-sm bg-gray-100 p-3 pr-12 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                            <button class="absolute right-2 text-gray-500 hover:text-blue-600 transition-colors" id="copy-webhook-btn" title="Copy Webhook">
                                <i class="fas fa-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">JSON Payload</label>
                        <div class="relative flex items-center">
                            <textarea id="payload-json" rows="5" class="w-full bg-gray-100 p-3 pr-12 border border-gray-300 rounded-lg focus:outline-none" readonly></textarea>
                            <button class="absolute top-2 right-2 text-gray-500 hover:text-blue-600 transition-colors" id="copy-payload-btn" title="Copy Payload">
                                <i class="fas fa-clipboard"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}

{% block scripts %}
<script>
    if (!window.pageScripts) window.pageScripts = {};
    window.pageScripts["demat-strategies"] = function() {
        const createStrategyBtn = document.getElementById('create-strategy-btn');
        const createStrategyBtnAlt = document.getElementById('create-strategy-btn-alt');
        const strategiesGrid = document.getElementById('strategies-grid');
        const noStrategiesState = document.getElementById('no-strategies-state');
        const modalEl = document.getElementById('strategyModal');
        const form = document.getElementById('strategyForm');
        const tokensList = document.getElementById('tokens-list');
        const payloadModalEl = document.getElementById('payloadModal');
        const payloadWebhook = document.getElementById('payload-webhook');
        const payloadJson = document.getElementById('payload-json');
        const userToken = '{{ logged_in_user.webhook_token }}';
        let symbolMap = {};
        let editingId = null;
        const BROKER_KEYS = ['dhan','aliceblue','angelone','iifl','kotak','upstox'];

        // Helper functions for showing/hiding modals
        function showModal(modal) { modal.classList.remove('hidden'); }
        function hideModal(modal) { modal.classList.add('hidden'); }

        // Event listeners for modal control
        createStrategyBtn && createStrategyBtn.addEventListener('click', () => { resetForm(); showModal(modalEl); });
        createStrategyBtnAlt && createStrategyBtnAlt.addEventListener('click', () => { resetForm(); showModal(modalEl); });
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                hideModal(modalEl);
                hideModal(payloadModalEl);
            });
        });
        
        modalEl.addEventListener('click', (e) => {
            if (e.target === modalEl) {
                hideModal(modalEl);
            }
        });
        
        payloadModalEl.addEventListener('click', (e) => {
            if (e.target === payloadModalEl) {
                hideModal(payloadModalEl);
            }
        });

        document.getElementById('copy-webhook-btn').addEventListener('click', () => {
            const tempInput = document.createElement('textarea');
            tempInput.value = payloadWebhook.value;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        });

        document.getElementById('copy-payload-btn').addEventListener('click', () => {
            const tempInput = document.createElement('textarea');
            tempInput.value = payloadJson.value;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        });


        function fetchJson(url, opts = {}) {
            return fetch(url, opts).then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.error || 'Request failed'); });
                return r.json();
            });
        }

        function loadSymbols() {
            fetchJson('/api/symbols').then(list => {
                list.forEach(item => {
                    symbolMap[item.symbol.toUpperCase()] = item;
                });
            }).catch(() => {});
        }

        function loadMasterAccounts(selected) {
            const container = document.getElementById('strategy-accounts');
            return fetchJson('/api/accounts?cache_only=1').then(data => {
                const masters = Array.isArray(data.masters) ? data.masters : [];
                container.innerHTML = masters.map(m => {
                    const id = `acc-${m.id}`;
                    return `
                        <div class="flex items-center">
                            <input class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" type="checkbox" name="masterAccounts" value="${m.id}" id="${id}">
                            <label class="ml-2 text-sm text-gray-900" for="${id}">${m.broker || ''} - ${m.client_id}</label>
                        </div>`;
                }).join('');
                if (selected) {
                    const vals = Array.isArray(selected) ? selected : String(selected).split(',');
                    vals.forEach(v => {
                        const cb = container.querySelector(`input[value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                }
            }).catch(() => {});
        }

        function getSelectedAccounts() {
            const container = document.getElementById('strategy-accounts');
            return Array.from(container.querySelectorAll('input[name="masterAccounts"]:checked')).map(cb => cb.value);
        }

        function getSymbols() {
            if (singleSymbolModeRadio.checked) {
                return [tradingSymbolsTextarea.value.trim()].filter(Boolean);
            } else {
                return ["{% raw %}{{ticker}}{% endraw %}"];
            }
        }


        function updateTokens() {
            const syms = getSymbols();
            const tokenText = syms.map(s => {
                if (s === "{% raw %}{{ticker}}{% endraw %}") {
                    return "Dynamic (TradingView {% raw %}{{ticker}}{% endraw %})";
                }
                const info = symbolMap[s.toUpperCase()];
                if (!info) return s;
                const parts = BROKER_KEYS.map(k => info[k] ? `${k}:${info[k]}` : null).filter(Boolean);
                return parts.length ? `${s} (${parts.join(', ')})` : s;
            }).join(', ');
            tokensList.textContent = tokenText;

            if (singleSymbolModeRadio.checked && syms.length === 1) {
                const info = symbolMap[syms[0].toUpperCase()];
                if (info) {
                    for (const k of BROKER_KEYS) {
                        if (info[k]) {
                            form.symbolToken.value = info[k];
                            break;
                        }
                    }
                } else {
                    form.symbolToken.value = '';
                }
            } else {
                form.symbolToken.value = '';
            }
            updateQtyFromValue();
        }
        form.tradingSymbols.addEventListener('input', updateTokens);

        const singleSymbolModeRadio = document.getElementById('singleSymbolMode');
        const watchlistModeRadio = document.getElementById('watchlistMode');
        const tradingSymbolsTextarea = document.getElementById('trading-symbols');
        const symbolInputHelp = document.getElementById('symbol-input-help');

        function updateSymbolInputMode() {
            if (singleSymbolModeRadio.checked) {
                tradingSymbolsTextarea.placeholder = "Enter single symbol (e.g., RELIANCE)";
                tradingSymbolsTextarea.disabled = false;
                tradingSymbolsTextarea.required = true;
                symbolInputHelp.textContent = "Enter the trading symbol.";
                if (tradingSymbolsTextarea.value === "{% raw %}{{ticker}}{% endraw %}") {
                    tradingSymbolsTextarea.value = "";
                }
            } else {
                tradingSymbolsTextarea.value = "";
                tradingSymbolsTextarea.placeholder = "Symbols are dynamically provided by TradingView";
                tradingSymbolsTextarea.disabled = true;
                tradingSymbolsTextarea.required = false;
                symbolInputHelp.textContent = "For TradingView Watchlist alerts, symbols will be passed dynamically. No input needed here.";
            }
            updateTokens();
            updateWebhookPreview();
        }

        singleSymbolModeRadio.addEventListener('change', updateSymbolInputMode);
        watchlistModeRadio.addEventListener('change', updateSymbolInputMode);

        function updateWebhookPreview() {
            const name = form.strategyName.value.trim();
            const selectedAccounts = getSelectedAccounts();

            const previewPayload = {
                strategyName: name,
                exchange: form.exchange.value,
                transactionType: form.transactionType.value,
                orderType: form.orderType.value,
                orderValidity: form.orderValidity.value,
                productType: form.productType.value,
                masterAccounts: selectedAccounts,
            };
            if (form.orderQty.value) {
                previewPayload.orderQty = parseFloat(form.orderQty.value);
            } else if (form.orderValue.value) {
                previewPayload.orderValue = parseFloat(form.orderValue.value);
            }

            if (singleSymbolModeRadio.checked) {
                const currentSymbol = tradingSymbolsTextarea.value.trim();
                previewPayload.tradingSymbols = currentSymbol ? [currentSymbol] : [];
            } else {
                previewPayload.tradingSymbols = ["{% raw %}{{ticker}}{% endraw %}"];
            }

            document.getElementById('webhook-preview').value = JSON.stringify(previewPayload, null, 2);
        }

        form.strategyName.addEventListener('input', updateWebhookPreview);
        form.exchange.addEventListener('change', updateWebhookPreview);
        form.transactionType.addEventListener('change', updateWebhookPreview);
        form.orderType.addEventListener('change', updateWebhookPreview);
        form.orderValidity.addEventListener('change', updateWebhookPreview);
        form.productType.addEventListener('change', updateWebhookPreview);
        form.orderQty.addEventListener('input', updateWebhookPreview);
        form.orderValue.addEventListener('input', updateWebhookPreview);


        updateSymbolInputMode();


        function resetForm() {
            editingId = null;
            form.reset();
            tokensList.textContent = '';
            form.orderValue.disabled = false;
            form.orderQty.disabled = false;
            singleSymbolModeRadio.checked = true;
            updateSymbolInputMode();
            updateTokens();
            loadMasterAccounts();
            modalEl.querySelector('h3').textContent = 'Create Strategy';
            updateWebhookPreview();
        }
        form.orderQty.addEventListener('input', () => { form.orderValue.disabled = !!form.orderQty.value; });
        form.orderValue.addEventListener('input', () => { form.orderQty.disabled = !!form.orderValue.value; });

        async function updateQtyFromValue() {
            if (!form.orderValue.value || (singleSymbolModeRadio.checked && getSymbols().length !== 1)) return;

            if (!singleSymbolModeRadio.checked) {
                form.orderQty.value = '';
                return;
            }

            try {
                const sym = getSymbols()[0];
                const data = await fetchJson(`/api/quote/${encodeURIComponent(sym)}`);
                const price = parseFloat(data.price);
                if (price > 0) {
                    const qty = parseFloat(form.orderValue.value) / price;
                    form.orderQty.value = qty.toFixed(2);
                }
            } catch (e) { /* ignore */ }
        }

        form.orderValue.addEventListener('change', updateQtyFromValue);

        function loadStrategies() {
            Promise.all([
                fetchJson('/api/strategies'),
                fetchJson('/api/accounts?cache_only=1')
            ]).then(([list, accData]) => {
                const accMap = {};
                (accData.accounts || []).forEach(a => {
                    const name = a.username || a.client_id;
                    accMap[a.id] = `${name} (${a.broker})`;
                });
                strategiesGrid.innerHTML = '';
                if (!list || list.length === 0) {
                    strategiesGrid.style.display = 'none';
                    noStrategiesState.style.display = 'block';
                    return;
                }
                strategiesGrid.style.display = 'grid';
                noStrategiesState.style.display = 'none';
                list.forEach(s => {
                    const accText = s.master_accounts ? s.master_accounts.split(',').map(id => accMap[id.trim()] || id.trim()).join(', ') : 'All';
                    const webhookUrl = `${window.location.origin}/webhook/${userToken}?secret=${encodeURIComponent(s.webhook_secret || '')}`;
                    const cardHtml = `
                    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col transition-transform hover:scale-[1.02]">
                        <div class="flex items-center justify-between mb-4">
                            <h5 class="text-xl font-bold text-gray-800">${s.name}</h5>
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${s.is_active ? 'bg-green-100 text-green-800':'bg-gray-200 text-gray-800'}">
                                ${s.is_active ? 'Active':'Inactive'}
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${s.description || 'No description provided.'}</p>
                        <div class="text-xs text-gray-500 mb-4">
                            <p><strong>Accounts:</strong> ${accText}</p>
                        </div>
                        <div class="flex flex-col space-y-2 mb-4">
                            <label class="text-xs font-medium text-gray-500">Webhook URL</label>
                            <div class="relative flex items-center">
                                <input type="text" class="w-full text-sm bg-gray-100 p-2 pr-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="${webhookUrl}" readonly>
                                <button class="absolute right-2 text-gray-500 hover:text-blue-600 transition-colors copy-btn" data-clipboard-text="${webhookUrl}" title="Copy URL">
                                    <i class="fa-solid fa-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-auto flex flex-wrap gap-2 justify-end">
                            <button class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors activate-toggle-btn ${s.is_active ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-green-500 text-white hover:bg-green-600'}" data-strategy-id="${s.id}">
                                <i class="fa-solid ${s.is_active ? 'fa-pause-circle':'fa-play-circle'} mr-1"></i> ${s.is_active ? 'Deactivate':'Activate'}
                            </button>
                            <a href="/strategy-performance/${s.id}" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-gray-300 transition-colors">
                                <i class="fa-solid fa-chart-line mr-1"></i> Logs
                            </a>
                            <button class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors edit-btn" data-strategy-id="${s.id}">
                                <i class="fa-solid fa-pencil mr-1"></i> Edit
                            </button>
                            <button class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-red-700 transition-colors delete-btn" data-strategy-id="${s.id}">
                                <i class="fa-solid fa-trash-can mr-1"></i> Delete
                            </button>
                        </div>
                    </div>`;
                    strategiesGrid.insertAdjacentHTML('beforeend', cardHtml);
                });

                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = btn.dataset.clipboardText;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                    });
                });
                document.querySelectorAll('.activate-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.textContent.includes('Deactivate') ? 'deactivate' : 'activate';
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}/${action}`, {
                            method: 'POST'
                        }).then(loadStrategies);
                    });
                });
                document.querySelectorAll('.clone-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}/clone`, {
                            method: 'POST'
                        }).then(loadStrategies);
                    });
                });
                document.querySelectorAll('.payload-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const sid = btn.dataset.strategyId;
                        const webhookUrl = btn.closest('.bg-white').querySelector('input').value;
                        const payload = localStorage.getItem('strategyPayload_' + sid) || '';
                        payloadWebhook.value = webhookUrl;
                        payloadJson.value = payload;
                        showModal(payloadModalEl);
                    });
                });
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}`).then(data => {
                            editingId = data.id;
                            modalEl.querySelector('h3').textContent = 'Edit Strategy';
                            form.strategyName.value = data.name;
                            loadMasterAccounts(data.master_accounts ? data.master_accounts.split(',') : []);

                            const storedAllowedTickers = data.allowed_tickers || '';
                            if (storedAllowedTickers === '__WATCHLIST_DYNAMIC__') {
                                watchlistModeRadio.checked = true;
                            } else {
                                singleSymbolModeRadio.checked = true;
                                tradingSymbolsTextarea.value = storedAllowedTickers;
                            }
                            updateSymbolInputMode();
                            updateWebhookPreview();
                            showModal(modalEl);
                        });
                    });
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!confirm('Are you sure you want to delete this strategy? This action cannot be undone.')) return;
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}`, {
                            method: 'DELETE'
                        }).then(() => {
                            localStorage.removeItem('strategyPayload_' + btn.dataset.strategyId);
                            loadStrategies();
                        });
                    });
                });
            });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = form.strategyName.value.trim();
            const selectedAccounts = getSelectedAccounts();

            if (!name) {
                alert('Strategy Name is required');
                return;
            }

            const isSingleSymbolMode = singleSymbolModeRadio.checked;
            let symbolsToProcessForPreview = [];
            let strategyNameForDB = name;
            let tradingSymbolsForDb = '';

            if (isSingleSymbolMode) {
                const singleSymbol = tradingSymbolsTextarea.value.trim();
                if (!singleSymbol) {
                    alert('Enter a trading symbol for single symbol mode');
                    return;
                }
                symbolsToProcessForPreview = [singleSymbol];
                tradingSymbolsForDb = singleSymbol;
                strategyNameForDB = `${name}-${singleSymbol}`;
            } else {
                symbolsToProcessForPreview = ["{% raw %}{{ticker}}{% endraw %}"];
                tradingSymbolsForDb = "__WATCHLIST_DYNAMIC__";
                strategyNameForDB = name;
            }

            if (editingId) {
                const payload = {
                    name: strategyNameForDB,
                    master_accounts: selectedAccounts,
                    allowed_tickers: tradingSymbolsForDb
                };
                fetchJson(`/api/strategies/${editingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                }).then(() => {
                    const stored = localStorage.getItem('strategyPayload_' + editingId);
                    if (stored) {
                        try {
                            const obj = JSON.parse(stored);
                            obj.strategyName = strategyNameForDB;
                            obj.masterAccounts = selectedAccounts;
                            obj.tradingSymbols = symbolsToProcessForPreview;
                            localStorage.setItem('strategyPayload_' + editingId, JSON.stringify(obj));
                        } catch (e) { /* ignore */ }
                    }
                    hideModal(modalEl);
                    loadStrategies();
                });
            } else {
                const payload = {
                    name: strategyNameForDB,
                    asset_class: 'Stocks',
                    style: 'Systematic',
                    master_accounts: selectedAccounts,
                    allowed_tickers: tradingSymbolsForDb
                };

                fetchJson('/api/strategies', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(res => {
                        const cp = {
                            strategyName: strategyNameForDB,
                            exchange: form.exchange.value,
                            transactionType: form.transactionType.value,
                            orderType: form.orderType.value,
                            orderValidity: form.orderValidity.value,
                            productType: form.productType.value,
                            masterAccounts: selectedAccounts,
                            tradingSymbols: symbolsToProcessForPreview
                        };
                        if (form.orderQty.value) {
                            cp.orderQty = parseFloat(form.orderQty.value);
                        } else if (form.orderValue.value) {
                            cp.orderValue = parseFloat(form.orderValue.value);
                        }
                        localStorage.setItem('strategyPayload_' + res.id, JSON.stringify(cp));
                        hideModal(modalEl);
                        loadStrategies();
                    })
                    .catch(error => {
                        alert('Error creating strategy: ' + error.message);
                        console.error('Error creating strategy:', error);
                    });
            }

            updateWebhookPreview();
        });

        loadSymbols();
        loadMasterAccounts();
        loadStrategies();
    };
</script>
{% endblock %}
