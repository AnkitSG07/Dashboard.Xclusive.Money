{% extends "layout.html" %}

{% block title %}Alert to Trade - DhanBot{% endblock %}

{% block styles %}
<style>
  .strategies-page-root {
    background: #f5f5f5;
    margin: -1.5rem -1.5rem 0;
    padding: 40px 0;
  }

  .strategies-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 40px 40px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .strategies-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
  }

  .strategies-header h1 {
    font-size: 36px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 8px;
  }

  .strategies-header p {
    color: #6b7280;
    font-size: 16px;
  }

  .strategy-btn-new {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    padding: 12px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
  }

  .strategy-filters {
    display: flex;
    gap: 16px;
    margin-bottom: 32px;
  }

  .strategy-search-box {
    position: relative;
    flex: 1;
  }

  .strategy-search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
  }

  .strategy-search-box input,
  .strategy-filters select {
    width: 100%;
    padding: 12px 12px 12px 44px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 15px;
    background: #fff;
  }

  .strategy-filters select {
    padding: 12px 36px 12px 16px;
    background: #fff url('data:image/svg+xml;charset=UTF-8,%3csvg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg"%3e%3cpath d="M1 1l6 6 6-6" stroke="%239CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/%3e%3c/svg%3e') no-repeat right 12px center;
    cursor: pointer;
    appearance: none;
  }

  .strategy-cards-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .strategy-messages {
    margin-bottom: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .strategy-message {
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    background: #fff;
    color: #1f2937;
    font-size: 14px;
  }

  .strategy-message[hidden] {
    display: none;
  }

  .strategy-message.strategy-loading {
    color: #4b5563;
    font-style: italic;
    background: #f9fafb;
  }

  .strategy-message.strategy-error {
    border-color: #fca5a5;
    background: #fef2f2;
    color: #b91c1c;
  }

  .strategy-message.strategy-empty {
    border-style: dashed;
    color: #6b7280;
    background: #f9fafb;
  }

  .strategy-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 24px;
  }

  .strategy-card-header {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }

  .strategy-avatar {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 20px;
    font-weight: 700;
    color: #6b7280;
  }

  .strategy-card-info {
    flex: 1;
    min-width: 0;
  }

  .strategy-card-title-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 4px;
  }

  .strategy-card-title {
    font-size: 17px;
    font-weight: 600;
    color: #1a1a1a;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .strategy-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    color: #fff;
  }

  .strategy-badge.is-active {
    background: #10b981;
  }

  .strategy-badge.is-inactive {
    background: #6b7280;
  }

  .strategy-card-type {
    color: #6b7280;
    font-size: 14px;
  }

  .strategy-card-desc {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 16px;
  }

  .strategy-card-section {
    margin-bottom: 12px;
  }

  .strategy-card-label {
    color: #9ca3af;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 4px;
    text-transform: uppercase;
  }

  .strategy-card-value {
    color: #1a1a1a;
    font-size: 14px;
    font-weight: 500;
  }

  .strategy-webhook-section {
    margin-bottom: 20px;
  }

  .strategy-webhook-box {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #f9fafb;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }

  .strategy-webhook-url {
    flex: 1;
    font-size: 12px;
    color: #6b7280;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: monospace;
  }

  .strategy-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px;
    display: flex;
    align-items: center;
  }

  .strategy-btn-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 8px;
  }

  .strategy-btn {
    border: none;
    padding: 10px 8px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .strategy-btn-status[data-status="active"] {
    background: #f97316;
    color: #fff;
  }

  .strategy-btn-status[data-status="inactive"] {
    background: #10b981;
    color: #fff;
  }

  .strategy-btn-clone {
    background: #f3f4f6;
    color: #1a1a1a;
  }

  .strategy-btn-payload {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
  }

  .strategy-btn-logs,
  .strategy-btn-edit {
    background: #fff;
    color: #1a1a1a;
    border: 1px solid #e5e7eb;
  }

  .strategy-btn-delete {
    background: #ef4444;
    color: #fff;
    border: none;
  }

  .strategy-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    padding: 40px;
    overflow-y: auto;
  }

  .strategy-modal {
    max-width: 600px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    padding: 32px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .strategy-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .strategy-modal-title {
    font-size: 24px;
    font-weight: 700;
    color: #1a1a1a;
  }

  .strategy-close-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 28px;
    color: #6b7280;
    line-height: 1;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .strategy-form-group {
    margin-bottom: 20px;
  }

  .strategy-form-label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
  }

  .strategy-form-input,
  .strategy-form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
  }

  .strategy-form-select {
    cursor: pointer;
  }

  .strategy-form-actions {
    display: flex;
    gap: 10px;
    padding-top: 12px;
  }

  .strategy-btn-save {
    flex: 1;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    padding: 11px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .strategy-btn-cancel {
    flex: 1;
    background: #fff;
    color: #1a1a1a;
    border: 1px solid #e5e7eb;
    padding: 11px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .strategy-payload-subtitle {
    margin: 4px 0 12px;
    color: #4b5563;
    font-size: 14px;
  }

  .strategy-payload-section {
    margin-bottom: 32px;
  }

  .strategy-payload-section:last-child {
    margin-bottom: 0;
  }

  .strategy-payload-label {
    font-size: 14px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 12px;
  }

  .strategy-payload-box {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    position: relative;
  }

  .strategy-payload-code {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #1a1a1a;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.6;
  }

  .strategy-copy-icon-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .strategy-copy-icon-btn:hover {
    background: #f3f4f6;
  }

  @media (max-width: 1024px) {
    .strategy-cards-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .strategies-page-root {
      margin: -1.5rem -1rem 0;
      padding: 24px 0;
    }

    .strategies-page {
      padding: 0 20px 20px;
    }

    .strategies-header {
      flex-direction: column;
      gap: 16px;
    }

    .strategies-header h1 {
      font-size: 28px;
    }

    .strategy-btn-new {
      width: 100%;
    }

    .strategy-filters {
      flex-direction: column;
    }

    .strategy-filters select {
      width: 100%;
    }

    .strategy-search-box input,
    .strategy-filters select {
      padding-left: 44px;
    }

    .strategy-cards-grid {
      grid-template-columns: 1fr;
    }

    .strategy-btn-row {
      grid-template-columns: repeat(2, 1fr);
    }

    .strategy-btn-row:last-of-type {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="strategies-page-root" data-webhook-base="{{ webhook_base }}" data-webhook-token="{{ logged_in_user.webhook_token or '' }}">
  <div class="strategies-page">
    <div class="strategies-header">
      <div>
        <h1>Alert to Trade</h1>
        <p>Manage your trading strategies and alerts</p>
      </div>
      <button type="button" class="strategy-btn-new" id="createStrategyBtn">New Strategy</button>
    </div>

    <div class="strategy-filters">
      <div class="strategy-search-box">
        <svg class="strategy-search-icon" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" placeholder="Search strategies by name..." aria-label="Search strategies" data-strategy-search>
      </div>
      <select aria-label="Filter strategies by status" data-strategy-filter="status">
        <option value="all">All Statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select aria-label="Filter strategies by account" style="min-width: 200px;" data-strategy-filter="account">
        <option value="">All Accounts</option>
      </select>
    </div>

    <div class="strategy-messages">
      <div class="strategy-message strategy-loading" data-strategy-loading>Loading strategies...</div>
      <div class="strategy-message strategy-error" data-strategy-error hidden></div>
      <div class="strategy-message strategy-empty" data-strategy-empty hidden>No strategies match your filters.</div>
    </div>

    <div class="strategy-cards-grid" id="strategiesContainer" aria-live="polite"></div>
  </div>
</div>

<div id="editForm" class="strategy-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
  <div class="strategy-modal">
    <div class="strategy-modal-header">
      <h2 id="editTitle" class="strategy-modal-title">Edit Strategy</h2>
      <button type="button" class="strategy-close-btn" aria-label="Close edit form" data-close="edit">&times;</button>
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="editStrategyName">Strategy Name</label>
      <input type="text" id="editStrategyName" class="strategy-form-input" placeholder="Enter strategy name">
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="strategyTypeSelect">Type</label>
      <select id="strategyTypeSelect" class="strategy-form-select">
        <option value="Stocks|Systematic">Stocks - Systematic</option>
        <option value="Stocks|Discretionary">Stocks - Discretionary</option>
        <option value="Options|Systematic">Options - Systematic</option>
        <option value="Options|Discretionary">Options - Discretionary</option>
        <option value="Futures|Systematic">Futures - Systematic</option>
      </select>
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="strategyDescription">Description</label>
      <input type="text" id="strategyDescription" class="strategy-form-input" placeholder="Enter description">
    </div>
    <div class="strategy-form-group">
      <label class="strategy-form-label" for="strategyAccountSelect">Accounts</label>
      <select id="strategyAccountSelect" class="strategy-form-select">
        <option value="">Select account</option>
      </select>
    </div>
    <div class="strategy-form-actions">
      <button type="button" class="strategy-btn-save" id="saveStrategyChanges">Save Changes</button>
      <button type="button" class="strategy-btn-cancel" data-close="edit">Cancel</button>
    </div>
  </div>
</div>

<div id="payloadModal" class="strategy-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="payloadModalTitle">
  <div class="strategy-modal">
    <div class="strategy-modal-header">
      <h2 class="strategy-modal-title" id="payloadModalTitle">Strategy Webhook Details</h2>
      <button type="button" class="strategy-close-btn" aria-label="Close payload details" data-close="payload">&times;</button>
    </div>
    <p class="strategy-payload-subtitle" id="payloadStrategyName"></p>

    <div class="strategy-payload-section">
      <div class="strategy-payload-label">Webhook URL</div>
      <div class="strategy-payload-box">
        <div class="strategy-payload-code" id="webhookUrl">--</div>
        <button type="button" class="strategy-copy-icon-btn" data-copy-target="webhook" aria-label="Copy webhook URL">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a1a1a" stroke-width="2" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="strategy-payload-section">
      <div class="strategy-payload-label">JSON Payload</div>
      <div class="strategy-payload-box">
        <div class="strategy-payload-code" id="payloadCode">--</div>
        <button type="button" class="strategy-copy-icon-btn" data-copy-target="payload" aria-label="Copy JSON payload">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a1a1a" stroke-width="2" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    function escapeHtml(value) {
      if (value === null || value === undefined) {
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function truncate(text, limit) {
      if (!text) return '';
      const value = String(text);
      if (value.length <= limit) return value;
      return value.slice(0, limit - 1) + 'â€¦';
    }

    function normalizeListField(value) {
      if (value === null || value === undefined) {
        return [];
      }
      if (Array.isArray(value)) {
        return value;
      }
      if (typeof value === 'number') {
        return [value];
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) {
          return [];
        }
        if ((trimmed.startsWith('[') && trimmed.endsWith(']'))) {
          try {
            const parsed = JSON.parse(trimmed);
            if (Array.isArray(parsed)) {
              return parsed;
            }
          } catch (error) {
            // ignore
          }
        }
        return trimmed
          .split(',')
          .map(part => part.trim())
          .filter(Boolean);
      }
      try {
        const parsed = JSON.parse(value);
        if (Array.isArray(parsed)) {
          return parsed;
        }
      } catch (error) {
        // ignore
      }
      return [];
    }

    function copyFallback(text) {
      const tempInput = document.createElement('textarea');
      tempInput.value = text;
      tempInput.style.position = 'fixed';
      tempInput.style.opacity = '0';
      document.body.appendChild(tempInput);
      tempInput.focus();
      tempInput.select();
      try {
        document.execCommand('copy');
        window.alert('Copied to clipboard');
      } catch (error) {
        window.alert('Unable to copy to clipboard');
      }
      document.body.removeChild(tempInput);
    }

    function copyToClipboard(text) {
      if (!text) {
        window.alert('Nothing to copy');
        return;
      }
      if (!navigator.clipboard) {
        copyFallback(text);
        return;
      }
      navigator.clipboard.writeText(text).then(function () {
        window.alert('Copied to clipboard');
      }).catch(function () {
        copyFallback(text);
      });
    }

    async function fetchJson(url, options = {}) {
      const response = await fetch(url, options);
      const contentType = response.headers.get('Content-Type') || '';
      let data = null;
      if (contentType.includes('application/json')) {
        data = await response.json();
      } else {
        const text = await response.text();
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (error) {
            data = { message: text };
          }
        }
      }
      if (!response.ok) {
        const message = data && (data.error || data.message);
        throw new Error(message || 'Request failed');
      }
      return data;
    }

    class DematStrategiesPage {
      constructor(root) {
        this.root = root;
        this.container = root.querySelector('#strategiesContainer');
        this.searchInput = root.querySelector('[data-strategy-search]');
        this.statusFilter = root.querySelector('[data-strategy-filter="status"]');
        this.accountFilter = root.querySelector('[data-strategy-filter="account"]');
        this.createButton = root.querySelector('#createStrategyBtn');
        this.loadingMessage = root.querySelector('[data-strategy-loading]');
        this.errorMessage = root.querySelector('[data-strategy-error]');
        this.emptyMessage = root.querySelector('[data-strategy-empty]');
        this.editModal = document.getElementById('editForm');
        this.payloadModal = document.getElementById('payloadModal');
        this.editTitle = document.getElementById('editTitle');
        this.nameInput = document.getElementById('editStrategyName');
        this.typeSelect = document.getElementById('strategyTypeSelect');
        this.descriptionInput = document.getElementById('strategyDescription');
        this.accountSelect = document.getElementById('strategyAccountSelect');
        this.saveButton = document.getElementById('saveStrategyChanges');
        this.payloadWebhook = document.getElementById('webhookUrl');
        this.payloadCode = document.getElementById('payloadCode');
        this.payloadName = document.getElementById('payloadStrategyName');
        this.state = {
          strategies: [],
          accounts: [],
          filters: {
            search: '',
            searchRaw: '',
            status: 'all',
            account: ''
          },
          editing: null
        };
        this.accountIdMap = new Map();
        this.accountClientMap = new Map();
        this.accountVersion = 0;
        this.isSaving = false;
        this.webhookBase = root.dataset.webhookBase || '';
        this.webhookToken = root.dataset.webhookToken || '';
        if (!this.webhookBase && this.webhookToken) {
          const origin = window.location.origin.replace(/\/$/, '');
          this.webhookBase = origin + '/webhook/' + this.webhookToken;
        }
        this.bindEvents();
        this.reload();
      }

      bindEvents() {
        if (this.searchInput) {
          this.searchInput.value = this.state.filters.searchRaw;
          this.searchInput.addEventListener('input', () => {
            const value = this.searchInput.value || '';
            this.state.filters.searchRaw = value;
            this.state.filters.search = value.trim().toLowerCase();
            this.renderStrategies();
          });
        }

        if (this.statusFilter) {
          this.statusFilter.value = this.state.filters.status;
          this.statusFilter.addEventListener('change', () => {
            this.state.filters.status = this.statusFilter.value || 'all';
            this.renderStrategies();
          });
        }

        if (this.accountFilter) {
          this.accountFilter.addEventListener('change', () => {
            this.state.filters.account = this.accountFilter.value || '';
            this.renderStrategies();
          });
        }

        if (this.createButton) {
          this.createButton.addEventListener('click', () => this.openEditModal(null));
        }

        if (this.container) {
          this.container.addEventListener('click', (event) => this.handleContainerClick(event));
        }

        if (this.saveButton) {
          this.saveButton.addEventListener('click', () => this.handleSave());
        }

        document.querySelectorAll('[data-close="edit"]').forEach(btn => {
          btn.addEventListener('click', () => this.closeEditModal());
        });

        document.querySelectorAll('[data-close="payload"]').forEach(btn => {
          btn.addEventListener('click', () => this.closePayloadModal());
        });

        if (this.editModal) {
          this.editModal.addEventListener('click', (event) => {
            if (event.target === this.editModal) {
              this.closeEditModal();
            }
          });
        }

        if (this.payloadModal) {
          this.payloadModal.addEventListener('click', (event) => {
            if (event.target === this.payloadModal) {
              this.closePayloadModal();
              return;
            }
            const copyBtn = event.target.closest('.strategy-copy-icon-btn');
            if (!copyBtn) {
              return;
            }
            const target = copyBtn.dataset.copyTarget;
            if (target === 'webhook') {
              copyToClipboard(this.payloadWebhook?.textContent?.trim() || '');
            } else if (target === 'payload') {
              copyToClipboard(this.payloadCode?.textContent?.trim() || '');
            }
          });
        }
      }

      async reload() {
        this.setLoading(true);
        this.showError();
        try {
          const [accountsPayload, strategiesPayload] = await Promise.all([
            fetchJson('/api/accounts?cache_only=1'),
            fetchJson('/api/strategies')
          ]);
          const accounts = Array.isArray(accountsPayload?.accounts) ? accountsPayload.accounts : [];
          this.state.accounts = accounts;
          this.accountIdMap = new Map(accounts.map(acc => [String(acc.id), acc]));
          this.accountClientMap = new Map(accounts.map(acc => [String(acc.client_id), acc]));
          this.accountVersion += 1;
          this.populateAccountFilters();
          const strategies = Array.isArray(strategiesPayload) ? strategiesPayload : [];
          this.state.strategies = strategies;
          this.renderStrategies();
        } catch (error) {
          console.error('Failed to load strategies', error);
          this.showError(error.message || 'Failed to load strategies.');
          if (this.container) {
            this.container.innerHTML = '';
          }
        } finally {
          this.setLoading(false);
        }
      }

      populateAccountFilters() {
        if (this.accountFilter) {
          const current = this.state.filters.account;
          this.accountFilter.innerHTML = '<option value="">All Accounts</option>';
          this.state.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = String(acc.id);
            option.textContent = this.formatAccountLabel(acc);
            this.accountFilter.appendChild(option);
          });
          if (current && this.accountFilter.querySelector(`option[value="${current}"]`)) {
            this.accountFilter.value = current;
          }
        }

        if (this.accountSelect) {
          const current = this.accountSelect.value;
          this.accountSelect.innerHTML = '<option value="">Select account</option>';
          this.state.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = String(acc.id);
            option.textContent = this.formatAccountLabel(acc);
            this.accountSelect.appendChild(option);
          });
          if (current && this.accountSelect.querySelector(`option[value="${current}"]`)) {
            this.accountSelect.value = current;
          }
        }
      }

      formatAccountLabel(account) {
        if (!account) {
          return 'Account';
        }
        const username = account.username || '';
        const clientId = account.client_id || '';
        const broker = account.broker || '';
        const primary = username || clientId || 'Account';
        const extras = [];
        if (clientId && primary !== clientId) {
          extras.push(clientId);
        }
        if (broker) {
          extras.push(broker);
        }
        return extras.length ? `${primary} (${extras.join(') (')})` : primary;
      }

      setLoading(isLoading) {
        if (this.loadingMessage) {
          this.loadingMessage.hidden = !isLoading;
        }
        if (isLoading) {
          this.setEmptyVisible(false);
        }
      }

      showError(message) {
        if (!this.errorMessage) {
          if (message) {
            window.alert(message);
          }
          return;
        }
        if (message) {
          this.errorMessage.textContent = message;
          this.errorMessage.hidden = false;
        } else {
          this.errorMessage.textContent = '';
          this.errorMessage.hidden = true;
        }
      }

      setEmptyVisible(show) {
        if (this.emptyMessage) {
          this.emptyMessage.hidden = !show;
        }
      }

      getFilteredStrategies() {
        const filters = this.state.filters;
        return this.state.strategies.filter(strategy => {
          if (filters.search && !(String(strategy.name || '').toLowerCase().includes(filters.search))) {
            return false;
          }
          if (filters.status === 'active' && !strategy.is_active) {
            return false;
          }
          if (filters.status === 'inactive' && strategy.is_active) {
            return false;
          }
          if (filters.account) {
            const linked = this.getResolvedAccounts(strategy);
            if (!linked.some(item => item.account && String(item.account.id) === filters.account)) {
              return false;
            }
          }
          return true;
        });
      }

      renderStrategies() {
        if (!this.container) {
          return;
        }
        const strategies = this.getFilteredStrategies();
        this.setLoading(false);
        if (!strategies.length) {
          this.container.innerHTML = '';
          this.setEmptyVisible(true);
          return;
        }
        this.setEmptyVisible(false);
        const html = strategies.map(strategy => this.renderStrategyCard(strategy)).join('');
        this.container.innerHTML = html;
      }

      renderStrategyCard(strategy) {
        const name = strategy.name || 'Untitled Strategy';
        const isActive = Boolean(strategy.is_active);
        const badgeClass = isActive ? 'is-active' : 'is-inactive';
        const badgeLabel = isActive ? 'Active' : 'Inactive';
        const toggleLabel = isActive ? 'Deactivate' : 'Activate';
        const accounts = this.getResolvedAccounts(strategy);
        const accountsText = accounts.length ? accounts.map(item => escapeHtml(item.label)).join(', ') : 'No linked accounts';
        const typeLabel = escapeHtml(this.formatStrategyType(strategy));
        const description = strategy.description ? escapeHtml(strategy.description) : 'No description provided for this strategy.';
        const webhookUrl = this.buildWebhookUrl(strategy);
        const webhookDisplay = webhookUrl ? escapeHtml(truncate(webhookUrl, 72)) : 'Webhook URL unavailable';
        const webhookTitle = webhookUrl ? escapeHtml(webhookUrl) : 'Webhook URL unavailable';
        const avatar = escapeHtml((name.trim() || '?').charAt(0).toUpperCase());
        return `
      <article class="strategy-card" data-strategy-id="${strategy.id}">
        <header class="strategy-card-header">
          <div class="strategy-avatar" aria-hidden="true">${avatar || '?'}</div>
          <div class="strategy-card-info">
            <div class="strategy-card-title-row">
              <h3 class="strategy-card-title" title="${escapeHtml(name)}">${escapeHtml(name)}</h3>
              <span class="strategy-badge ${badgeClass}">${badgeLabel}</span>
            </div>
            <p class="strategy-card-type">${typeLabel}</p>
          </div>
        </header>
        <p class="strategy-card-desc">${description}</p>
        <div class="strategy-card-section">
          <p class="strategy-card-label">Accounts</p>
          <p class="strategy-card-value">${accountsText}</p>
        </div>
        <section class="strategy-webhook-section">
          <p class="strategy-card-label">Webhook URL</p>
          <div class="strategy-webhook-box">
            <code class="strategy-webhook-url" title="${webhookTitle}">${webhookDisplay}</code>
            <button type="button" class="strategy-icon-btn" data-action="copy-webhook" data-id="${strategy.id}" aria-label="Copy webhook URL">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" aria-hidden="true">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
            <button type="button" class="strategy-icon-btn" data-action="refresh-webhook" data-id="${strategy.id}" aria-label="Refresh webhook secret">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" aria-hidden="true">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>
            <button type="button" class="strategy-icon-btn" data-action="test-webhook" data-id="${strategy.id}" aria-label="Test webhook">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="#ef4444" aria-hidden="true">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
          </div>
        </section>
        <div class="strategy-btn-row">
          <button type="button" class="strategy-btn strategy-btn-status" data-action="toggle-status" data-id="${strategy.id}">${toggleLabel}</button>
          <button type="button" class="strategy-btn strategy-btn-clone" data-action="clone" data-id="${strategy.id}">Clone</button>
          <button type="button" class="strategy-btn strategy-btn-payload" data-action="show-payload" data-id="${strategy.id}">Payload</button>
        </div>
        <div class="strategy-btn-row">
          <button type="button" class="strategy-btn strategy-btn-logs" data-action="view-logs" data-id="${strategy.id}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Logs
          </button>
          <button type="button" class="strategy-btn strategy-btn-edit" data-action="edit" data-id="${strategy.id}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit
          </button>
          <button type="button" class="strategy-btn strategy-btn-delete" data-action="delete" data-id="${strategy.id}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
          </button>
        </div>
      </article>`;
      }

      formatStrategyType(strategy) {
        const asset = strategy.asset_class || 'Unknown';
        const style = strategy.style || '';
        return style ? `${asset} - ${style}` : asset;
      }

      getResolvedAccounts(strategy) {
        const cacheKey = '__resolvedAccounts';
        const versionKey = '__accountsVersion';
        if (strategy[versionKey] === this.accountVersion && Array.isArray(strategy[cacheKey])) {
          return strategy[cacheKey];
        }
        const results = [];
        const seen = new Set();
        const addAccount = (label, account) => {
          const key = account ? `acc-${account.id}` : `label-${label}`;
          if (seen.has(key)) {
            return;
          }
          seen.add(key);
          results.push({ label, account });
        };
        if (strategy.account_id) {
          const account = this.accountIdMap.get(String(strategy.account_id));
          const label = account ? this.formatAccountLabel(account) : `Account #${strategy.account_id}`;
          addAccount(label, account);
        }
        normalizeListField(strategy.master_accounts).forEach(raw => {
          const key = String(raw);
          const account = this.accountIdMap.get(key) || this.accountClientMap.get(key);
          if (account) {
            addAccount(this.formatAccountLabel(account), account);
          } else if (key) {
            addAccount(key, null);
          }
        });
        strategy[cacheKey] = results;
        strategy[versionKey] = this.accountVersion;
        return results;
      }

      buildWebhookUrl(strategy) {
        if (!this.webhookBase) {
          return '';
        }
        try {
          const url = new URL(this.webhookBase, window.location.origin);
          url.searchParams.set('strategy_id', strategy.id);
          if (strategy.webhook_secret) {
            url.searchParams.set('secret', strategy.webhook_secret);
          }
          return url.toString();
        } catch (error) {
          return this.webhookBase;
        }
      }

      buildPayload(strategy) {
        const payload = {
          symbol: 'RELIANCE',
          exchange: 'NSE',
          transactionType: 'BUY',
          orderType: 'MARKET',
          orderValidity: 'DAY',
          productType: 'INTRADAY',
          quantity: 1,
          strategyId: strategy.id
        };
        if (strategy.webhook_secret) {
          payload.secret = strategy.webhook_secret;
        }
        const accounts = this.getResolvedAccounts(strategy).map(item => item.label);
        if (accounts.length) {
          payload.masterAccounts = accounts;
        }
        return payload;
      }

      openPayloadModal(strategy) {
        if (!this.payloadModal) {
          return;
        }
        if (this.payloadName) {
          this.payloadName.textContent = strategy.name || `Strategy #${strategy.id}`;
        }
        if (this.payloadWebhook) {
          const webhook = this.buildWebhookUrl(strategy);
          this.payloadWebhook.textContent = webhook || 'Webhook URL unavailable';
        }
        if (this.payloadCode) {
          const payload = this.buildPayload(strategy);
          this.payloadCode.textContent = JSON.stringify(payload, null, 2);
        }
        this.payloadModal.style.display = 'block';
      }

      closePayloadModal() {
        if (this.payloadModal) {
          this.payloadModal.style.display = 'none';
        }
      }

      openEditModal(strategy) {
        this.state.editing = strategy;
        if (this.editTitle) {
          this.editTitle.textContent = strategy ? `Edit Strategy: ${strategy.name || 'Strategy'}` : 'Create Strategy';
        }
        if (this.nameInput) {
          this.nameInput.value = strategy ? (strategy.name || '') : '';
        }
        if (this.descriptionInput) {
          this.descriptionInput.value = strategy ? (strategy.description || '') : '';
        }
        if (this.typeSelect) {
          const asset = strategy?.asset_class || 'Stocks';
          const style = strategy?.style || 'Systematic';
          const value = `${asset}|${style}`;
          this.ensureTypeOption(value);
          this.typeSelect.value = value;
        }
        if (this.accountSelect) {
          const accountId = strategy?.account_id ? String(strategy.account_id) : '';
          if (accountId && !this.accountSelect.querySelector(`option[value="${accountId}"]`)) {
            const option = document.createElement('option');
            option.value = accountId;
            option.textContent = accountId;
            option.dataset.missing = 'true';
            this.accountSelect.appendChild(option);
          }
          this.accountSelect.value = accountId;
        }
        if (this.editModal) {
          this.editModal.style.display = 'block';
        }
      }

      ensureTypeOption(value) {
        if (!this.typeSelect || !value) {
          return;
        }
        if (this.typeSelect.querySelector(`option[value="${value}"]`)) {
          return;
        }
        const [asset, style] = value.split('|');
        const label = [asset, style].filter(Boolean).join(' - ');
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label || value;
        option.dataset.dynamic = 'true';
        this.typeSelect.appendChild(option);
      }

      closeEditModal() {
        if (this.editModal) {
          this.editModal.style.display = 'none';
        }
        this.state.editing = null;
      }

      async handleSave() {
        if (this.isSaving) {
          return;
        }
        if (!this.nameInput) {
          return;
        }
        const name = this.nameInput.value.trim();
        if (!name) {
          this.showError('Strategy name is required.');
          return;
        }
        const typeValue = this.typeSelect ? this.typeSelect.value : 'Stocks|Systematic';
        const [assetClass, style] = (typeValue || 'Stocks|Systematic').split('|');
        const accountId = this.accountSelect ? this.accountSelect.value : '';
        const payload = {
          name,
          description: this.descriptionInput ? this.descriptionInput.value.trim() : '',
          asset_class: assetClass || 'Stocks',
          style: style || 'Systematic',
          account_id: accountId ? parseInt(accountId, 10) : null
        };
        const isEdit = Boolean(this.state.editing);
        const url = isEdit ? `/api/strategies/${this.state.editing.id}` : '/api/strategies';
        const method = isEdit ? 'PUT' : 'POST';
        this.isSaving = true;
        if (this.saveButton) {
          this.saveButton.disabled = true;
        }
        this.showError();
        try {
          await fetchJson(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          this.closeEditModal();
          await this.reload();
          window.alert('Strategy saved successfully.');
        } catch (error) {
          this.showError(error.message || 'Failed to save strategy.');
        } finally {
          this.isSaving = false;
          if (this.saveButton) {
            this.saveButton.disabled = false;
          }
        }
      }

      async toggleStatus(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          const action = strategy.is_active ? 'deactivate' : 'activate';
          await fetchJson(`/api/strategies/${strategy.id}/${action}`, { method: 'POST' });
          strategy.is_active = !strategy.is_active;
          this.renderStrategies();
          window.alert(`Strategy ${strategy.is_active ? 'activated' : 'deactivated'}.`);
        } catch (error) {
          this.showError(error.message || 'Failed to update strategy status.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async cloneStrategy(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          await fetchJson(`/api/strategies/${strategy.id}/clone`, { method: 'POST' });
          window.alert('Strategy cloned successfully.');
          await this.reload();
        } catch (error) {
          this.showError(error.message || 'Failed to clone strategy.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async deleteStrategy(strategy, button) {
        const title = strategy.name || 'this strategy';
        if (!window.confirm(`Are you sure you want to delete ${title}?`)) {
          return;
        }
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          await fetchJson(`/api/strategies/${strategy.id}`, { method: 'DELETE' });
          this.state.strategies = this.state.strategies.filter(item => item.id !== strategy.id);
          this.renderStrategies();
          window.alert('Strategy deleted.');
        } catch (error) {
          this.showError(error.message || 'Failed to delete strategy.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async refreshWebhookSecret(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          const data = await fetchJson(`/api/strategies/${strategy.id}/regenerate-secret`, { method: 'POST' });
          if (data?.webhook_secret) {
            strategy.webhook_secret = data.webhook_secret;
            this.renderStrategies();
            window.alert('Generated a new webhook secret.');
          }
        } catch (error) {
          this.showError(error.message || 'Failed to regenerate webhook secret.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      async testWebhook(strategy, button) {
        if (button) {
          button.disabled = true;
        }
        this.showError();
        try {
          const result = await fetchJson(`/api/strategies/${strategy.id}/test-webhook`, { method: 'POST' });
          const status = result?.status;
          let responseText = result?.response;
          if (responseText && typeof responseText === 'object') {
            responseText = JSON.stringify(responseText, null, 2);
          }
          window.alert(`Test webhook responded with status ${status}.
${responseText || ''}`);
        } catch (error) {
          this.showError(error.message || 'Failed to trigger test webhook.');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      viewLogs(strategy) {
        window.location.href = `/strategy-performance/${strategy.id}`;
      }

      handleContainerClick(event) {
        const button = event.target.closest('[data-action]');
        if (!button || !this.container.contains(button)) {
          return;
        }
        const id = button.getAttribute('data-id');
        const strategy = this.state.strategies.find(item => String(item.id) === String(id));
        if (!strategy) {
          return;
        }
        const action = button.dataset.action;
        if (action === 'toggle-status') {
          this.toggleStatus(strategy, button);
        } else if (action === 'clone') {
          this.cloneStrategy(strategy, button);
        } else if (action === 'delete') {
          this.deleteStrategy(strategy, button);
        } else if (action === 'show-payload') {
          this.openPayloadModal(strategy);
        } else if (action === 'edit') {
          this.openEditModal(strategy);
        } else if (action === 'refresh-webhook') {
          this.refreshWebhookSecret(strategy, button);
        } else if (action === 'test-webhook') {
          this.testWebhook(strategy, button);
        } else if (action === 'copy-webhook') {
          const url = this.buildWebhookUrl(strategy);
          copyToClipboard(url || '');
        } else if (action === 'view-logs') {
          this.viewLogs(strategy);
        }
      }
    }

    function initializeDematStrategiesPage() {
      const root = document.querySelector('.strategies-page-root');
      if (!root) {
        return;
      }
      if (root.__dematStrategiesController) {
        root.__dematStrategiesController.reload();
        return;
      }
      root.__dematStrategiesController = new DematStrategiesPage(root);
    }

    window.pageScripts = window.pageScripts || {};
    window.pageScripts['demat-strategies'] = initializeDematStrategiesPage;

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeDematStrategiesPage);
    } else {
      initializeDematStrategiesPage();
    }
  })();
</script>
{% endblock %}
