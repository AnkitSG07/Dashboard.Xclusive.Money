{% extends "demat-trading-redesign.html" %}

{% block title %}Strategies - TradersPost{% endblock %}

{% block page_id %}demat-strategies{% endblock %}

{% block content %}
<div class="content-section">
    <div class="flex items-center justify-between mb-6 pb-3 border-b border-gray-300">
        <h2 class="text-3xl font-bold text-gray-900">Strategies</h2>
        <button id="create-strategy-btn-alt" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
            <i class="fas fa-plus mr-2"></i> Create Strategy
        </button>
    </div>

    <!-- Empty State -->
    <div id="no-strategies-state" class="text-center p-12 rounded-xl mt-8 text-gray-500 hidden">
        <div class="text-6xl text-gray-400 mb-4">
            <i class="fas fa-chart-bar"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">No Strategies</h3>
        <p class="text-lg">Create your first trading strategy to get started.</p>
        <button id="create-strategy-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg mt-6 transition-colors duration-200">
            <i class="fas fa-plus mr-2"></i>
            Create Strategy
        </button>
    </div>

    <!-- Strategies Grid -->
    <div id="strategies-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 my-8">
        <!-- Strategy cards will be injected here by JS -->
    </div>
</div>

<!-- Create/Edit Strategy Modal -->
<div id="strategyModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 overflow-y-auto flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh]">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h5 class="text-2xl font-semibold text-gray-900" id="strategyModalTitle">Create Strategy</h5>
            <button type="button" class="text-gray-400 hover:text-gray-600 modal-close-btn">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="strategyForm" class="overflow-y-auto p-6 max-h-[70vh]">
            <!-- Form content starts here -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-1">
                    <label for="strategy-name" class="block text-sm font-medium text-gray-700 mb-1">
                        Strategy Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors" id="strategy-name" name="strategyName" required>
                </div>
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Master Accounts
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">Select the master accounts this strategy will be applied to.</span>
                        </span>
                    </label>
                    <div id="strategy-accounts" class="flex flex-col gap-2 p-3 border border-gray-300 rounded-lg">
                        <div class="text-gray-500">Loading accounts...</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Select connected master accounts for this strategy.</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div>
                    <label for="exchange" class="block text-sm font-medium text-gray-700 mb-1">
                        Exchange <span class="text-red-500">*</span>
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">The stock exchange where the trade will be executed.</span>
                        </span>
                    </label>
                    <select class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="exchange" name="exchange">
                        <option value="NSE">NSE</option>
                        <option value="BSE">BSE</option>
                    </select>
                </div>
                <div>
                    <label for="symbol-token" class="block text-sm font-medium text-gray-700 mb-1">
                        Symbol Token
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">A unique identifier for the trading symbol on the selected exchange.</span>
                        </span>
                    </label>
                    <input type="text" class="form-input w-full p-3 border border-gray-300 rounded-lg bg-gray-100" id="symbol-token" name="symbolToken" placeholder="Auto" readonly>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Trading Symbols <span class="text-red-500">*</span>
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">The specific stock symbols for this strategy.</span>
                        </span>
                    </label>
                    <div class="flex items-center gap-4 mb-2">
                        <div class="flex items-center">
                            <input class="form-radio h-4 w-4 text-blue-600 transition duration-150 ease-in-out" type="radio" name="symbolInputMode" id="singleSymbolMode" value="single" checked>
                            <label class="ml-2 block text-sm leading-5 text-gray-900" for="singleSymbolMode">Single Symbol</label>
                        </div>
                        <div class="flex items-center">
                            <input class="form-radio h-4 w-4 text-blue-600 transition duration-150 ease-in-out" type="radio" name="symbolInputMode" id="watchlistMode" value="watchlist">
                            <label class="ml-2 block text-sm leading-5 text-gray-900" for="watchlistMode">Watchlist (TradingView Alert)</label>
                        </div>
                    </div>
                    <textarea class="form-textarea w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="trading-symbols" name="tradingSymbols" rows="1" placeholder="Enter single symbol (e.g., RELIANCE)" required></textarea>
                    <div class="text-xs text-gray-500 mt-1" id="symbol-input-help">Enter the trading symbol.</div>
                    <div id="tokens-list" class="text-xs text-gray-400 mt-2"></div>
                </div>
                <div>
                    <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1">
                        Transaction Type <span class="text-red-500">*</span>
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">Whether the strategy will execute a BUY or SELL transaction.</span>
                        </span>
                    </label>
                    <select class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="transaction-type" name="transactionType">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div>
                    <label for="order-type" class="block text-sm font-medium text-gray-700 mb-1">
                        Order Type <span class="text-red-500">*</span>
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">Choose 'market' for an immediate trade or 'limit' to set a specific price.</span>
                        </span>
                    </label>
                    <select class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="order-type" name="orderType">
                        <option value="limit">limit</option>
                        <option value="market">market</option>
                    </select>
                </div>
                <div>
                    <label for="order-validity" class="block text-sm font-medium text-gray-700 mb-1">
                        Order Validity
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">'Day' orders are valid until the market closes. 'IOC' (Immediate or Cancel) fills partially/fully and cancels the rest immediately.</span>
                        </span>
                    </label>
                    <select class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="order-validity" name="orderValidity">
                        <option value="day" selected>day</option>
                        <option value="IOC">IOC</option>
                    </select>
                </div>
                <div>
                    <label for="product-type" class="block text-sm font-medium text-gray-700 mb-1">
                        Product Type <span class="text-red-500">*</span>
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">
                                'intraday' (MIS) for same-day trading. 'cnc' (longterm) for holding positions.
                            </span>
                        </span>
                    </label>
                    <select class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="product-type" name="productType">
                        <option value="intraday">intraday</option>
                        <option value="cnc">cnc</option>
                    </select>
                    <div class="text-xs text-gray-500 mt-1">intraday/MIS are equivalent, as are CNC/longterm.</div>
                </div>
                <div>
                    <label for="order-qty" class="block text-sm font-medium text-gray-700 mb-1">
                        Order Quantity
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">Enter a specific number of shares to trade. Leave empty if specifying Order Value.</span>
                        </span>
                    </label>
                    <input type="number" class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="order-qty" name="orderQty" min="1">
                    <div class="text-xs text-gray-500 mt-1">Leave empty if specifying Order Value.</div>
                </div>
                <div>
                    <label for="order-value" class="block text-sm font-medium text-gray-700 mb-1">
                        Order Value
                        <span class="tooltip-container ml-1">
                            <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                            <span class="tooltip-text text-xs">Enter the total amount of money to be invested. The quantity will be auto-calculated.</span>
                        </span>
                    </label>
                    <input type="number" class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" id="order-value" name="orderValue" min="1" step="0.01">
                    <div class="text-xs text-gray-500 mt-1">Auto-calculates quantity from live price.</div>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="webhook-preview" class="block text-sm font-medium text-gray-700 mb-1">Webhook Payload</label>
                    <textarea class="form-textarea w-full p-3 border border-gray-300 rounded-lg bg-gray-50" id="webhook-preview" rows="3" readonly></textarea>
                </div>
            </div>
            <!-- Form content ends here -->
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200">Save Strategy</button>
                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg transition-colors duration-200 modal-close-btn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Strategy Payload Modal -->
<div id="payloadModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 overflow-y-auto flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h5 class="text-2xl font-semibold text-gray-900">Strategy Payload</h5>
            <button type="button" class="text-gray-400 hover:text-gray-600 payload-modal-close-btn">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                <div class="relative flex rounded-lg shadow-sm">
                    <input id="payload-webhook" type="text" class="form-input flex-1 p-3 rounded-l-lg border border-gray-300 bg-gray-100" readonly>
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-r-lg transition-colors duration-200" id="copy-webhook-btn" title="Copy Webhook">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">JSON Payload</label>
                <div class="relative flex rounded-lg shadow-sm">
                    <textarea id="payload-json" class="form-textarea flex-1 p-3 rounded-l-lg border border-gray-300 bg-gray-100" rows="5" readonly></textarea>
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-r-lg transition-colors duration-200" id="copy-payload-btn" title="Copy Payload">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<style>
    /* Tooltip styling */
    .tooltip-container {
        position: relative;
        display: inline-block;
    }
    .tooltip-text {
        visibility: hidden;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }

    .strategy-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .strategy-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Use vanilla JS for modal functionality
    const setupModals = () => {
        const modal = document.getElementById('strategyModal');
        const payloadModal = document.getElementById('payloadModal');
        const modalCloseBtns = document.querySelectorAll('.modal-close-btn');
        const payloadModalCloseBtns = document.querySelectorAll('.payload-modal-close-btn');

        modalCloseBtns.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
        payloadModalCloseBtns.forEach(btn => btn.addEventListener('click', () => payloadModal.classList.add('hidden')));

        window.showModal = (id) => {
            const targetModal = document.getElementById(id);
            if (targetModal) {
                targetModal.classList.remove('hidden');
            }
        };
    };
    
    if (!window.pageScripts) window.pageScripts = {};
    window.pageScripts["demat-strategies"] = function() {
        const createStrategyBtn = document.getElementById('create-strategy-btn');
        const createStrategyBtnAlt = document.getElementById('create-strategy-btn-alt');
        const strategiesGrid = document.getElementById('strategies-grid');
        const noStrategiesState = document.getElementById('no-strategies-state');
        const form = document.getElementById('strategyForm');
        const modalTitle = document.getElementById('strategyModalTitle');
        const tokensList = document.getElementById('tokens-list');
        const payloadWebhook = document.getElementById('payload-webhook');
        const payloadJson = document.getElementById('payload-json');
        const userToken = '{{ logged_in_user.webhook_token }}';
        let symbolMap = {};
        let editingId = null;
        const BROKER_KEYS = ['dhan','aliceblue','angelone','iifl','kotak','upstox'];

        // Tooltip handler
        document.querySelectorAll('.tooltip-container').forEach(container => {
            const tooltip = container.querySelector('.tooltip-text');
            let timeout;
            container.addEventListener('mouseenter', () => {
                timeout = setTimeout(() => {
                    tooltip.style.visibility = 'visible';
                    tooltip.style.opacity = '1';
                }, 500); // 500ms delay
            });
            container.addEventListener('mouseleave', () => {
                clearTimeout(timeout);
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            });
        });

        document.getElementById('copy-webhook-btn').addEventListener('click',()=>document.execCommand('copy'));
        document.getElementById('copy-payload-btn').addEventListener('click',()=>document.execCommand('copy'));

        function fetchJson(url, opts={}) {
            return fetch(url, opts).then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.error || 'Request failed'); });
                return r.json();
            });
        }

        function loadSymbols(){
            fetchJson('/api/symbols').then(list => {
                list.forEach(item => {
                    symbolMap[item.symbol.toUpperCase()] = item;
                });
            }).catch(() => {});
        }

        function loadMasterAccounts(selected){
            const container = document.getElementById('strategy-accounts');
            return fetchJson('/api/accounts?cache_only=1').then(data=>{
                const masters = Array.isArray(data.masters) ? data.masters : [];
                container.innerHTML = masters.map(m => {
                    const id = `acc-${m.id}`;
                    return `<div class="flex items-center">
                                <input class="form-checkbox h-4 w-4 text-blue-600 rounded" type="checkbox" name="masterAccounts" value="${m.id}" id="${id}">
                                <label class="ml-2 block text-sm text-gray-700" for="${id}">${m.broker || ''} - ${m.client_id}</label>
                            </div>`;
                }).join('');
                if(selected){
                    const vals = Array.isArray(selected) ? selected : String(selected).split(',');
                    vals.forEach(v => {
                        const cb = container.querySelector(`input[value="${v}"]`);
                        if(cb) cb.checked = true;
                    });
                }
            }).catch(()=>{});
        }

        function getSelectedAccounts(){
            const container = document.getElementById('strategy-accounts');
            return Array.from(container.querySelectorAll('input[name="masterAccounts"]:checked')).map(cb => cb.value);
        }

        function getSymbols(){
            const singleSymbolModeRadio = document.getElementById('singleSymbolMode');
            const tradingSymbolsTextarea = document.getElementById('trading-symbols');

            if (singleSymbolModeRadio.checked) {
                return [tradingSymbolsTextarea.value.trim()].filter(Boolean);
            } else {
                return ["{% raw %}{{ticker}}{% endraw %}"];
            }
        }

        function updateTokens(){
            const syms = getSymbols();
            const tokenText = syms.map(s => {
                if (s === "{% raw %}{{ticker}}{% endraw %}") {
                    return "Dynamic (TradingView {% raw %}{{ticker}}{% endraw %})";
                }
                const info = symbolMap[s.toUpperCase()];
                if(!info) return s;
                const parts = BROKER_KEYS.map(k => info[k] ? `${k}:${info[k]}` : null).filter(Boolean);
                return parts.length ? `${s} (${parts.join(', ')})` : s;
            }).join(', ');
            tokensList.textContent = tokenText;

            const singleSymbolModeRadio = document.getElementById('singleSymbolMode');
            if(singleSymbolModeRadio.checked && syms.length === 1){
                const info = symbolMap[syms[0].toUpperCase()];
                if(info){
                    for(const k of BROKER_KEYS){
                        if(info[k]){ form.symbolToken.value = info[k]; break; }
                    }
                } else {
                    form.symbolToken.value = '';
                }
            } else {
                form.symbolToken.value = '';
            }
            updateQtyFromValue();
        }

        const singleSymbolModeRadio = document.getElementById('singleSymbolMode');
        const watchlistModeRadio = document.getElementById('watchlistMode');
        const tradingSymbolsTextarea = document.getElementById('trading-symbols');
        const symbolInputHelp = document.getElementById('symbol-input-help');

        function updateSymbolInputMode() {
            if (singleSymbolModeRadio.checked) {
                tradingSymbolsTextarea.rows = 1;
                tradingSymbolsTextarea.placeholder = "Enter single symbol (e.g., RELIANCE)";
                tradingSymbolsTextarea.disabled = false;
                tradingSymbolsTextarea.name = "tradingSymbols";
                symbolInputHelp.textContent = "Enter the trading symbol.";
                if (tradingSymbolsTextarea.value === "{% raw %}{{ticker}}{% endraw %}") {
                    tradingSymbolsTextarea.value = "";
                }
            } else {
                tradingSymbolsTextarea.rows = 1;
                tradingSymbolsTextarea.placeholder = "Symbols will be dynamically provided by TradingView ({% raw %}{{ticker}}{% endraw %})";
                tradingSymbolsTextarea.value = "";
                tradingSymbolsTextarea.disabled = true;
                tradingSymbolsTextarea.name = "disabledTradingSymbols";
                symbolInputHelp.textContent = "For TradingView Watchlist alerts, symbols will be passed dynamically. No input needed here.";
            }
            updateTokens();
            updateWebhookPreview();
        }

        singleSymbolModeRadio.addEventListener('change', updateSymbolInputMode);
        watchlistModeRadio.addEventListener('change', updateSymbolInputMode);
        form.tradingSymbols.addEventListener('input', updateTokens);


        function updateWebhookPreview() {
            const name = form.strategyName.value.trim();
            const selectedAccounts = getSelectedAccounts();

            const previewPayload = {
                strategyName: name,
                exchange: form.exchange.value,
                transactionType: form.transactionType.value,
                orderType: form.orderType.value,
                orderValidity: form.orderValidity.value,
                productType: form.productType.value,
                masterAccounts: selectedAccounts,
            };
            if(form.orderQty.value){
                previewPayload.orderQty = parseFloat(form.orderQty.value);
            } else if(form.orderValue.value){
                previewPayload.orderValue = parseFloat(form.orderValue.value);
            }

            if (singleSymbolModeRadio.checked) {
                const currentSymbol = tradingSymbolsTextarea.value.trim();
                previewPayload.tradingSymbols = currentSymbol ? [currentSymbol] : [];
            } else {
                previewPayload.tradingSymbols = ["{% raw %}{{ticker}}{% endraw %}"];
            }

            document.getElementById('webhook-preview').value = JSON.stringify(previewPayload, null, 2);
        }

        form.strategyName.addEventListener('input', updateWebhookPreview);
        form.exchange.addEventListener('change', updateWebhookPreview);
        form.transactionType.addEventListener('change', updateWebhookPreview);
        form.orderType.addEventListener('change', updateWebhookPreview);
        form.orderValidity.addEventListener('change', updateWebhookPreview);
        form.productType.addEventListener('change', updateWebhookPreview);
        form.orderQty.addEventListener('input', updateWebhookPreview);
        form.orderValue.addEventListener('input', updateWebhookPreview);

        updateSymbolInputMode();

        function resetForm(){
            editingId = null;
            form.reset();
            tokensList.textContent = '';
            form.orderValue.disabled = false;
            form.orderQty.disabled = false;
            singleSymbolModeRadio.checked = true;
            updateSymbolInputMode();
            updateTokens();
            loadMasterAccounts();
            modalTitle.textContent = 'Create Strategy';
            updateWebhookPreview();
        }

        form.orderQty.addEventListener('input', ()=>{ form.orderValue.disabled = !!form.orderQty.value; });
        form.orderValue.addEventListener('input', ()=>{ form.orderQty.disabled = !!form.orderValue.value; });

        async function updateQtyFromValue(){
            if(!form.orderValue.value || (singleSymbolModeRadio.checked && getSymbols().length !== 1)) return;
            if (!singleSymbolModeRadio.checked) {
                form.orderQty.value = '';
                return;
            }

            try{
                const sym = getSymbols()[0];
                const data = await fetchJson(`/api/quote/${encodeURIComponent(sym)}`);
                const price = parseFloat(data.price);
                if(price>0){
                    const qty = parseFloat(form.orderValue.value) / price;
                    form.orderQty.value = qty.toFixed(2);
                }
            }catch(e){/* ignore */}
        }

        form.orderValue.addEventListener('change', updateQtyFromValue);

        function loadStrategies(){
            Promise.all([
                fetchJson('/api/strategies'),
                fetchJson('/api/accounts?cache_only=1')
            ]).then(([list, accData]) => {
                const accMap = {};
                (accData.accounts || []).forEach(a => {
                    const name = a.username || a.client_id;
                    accMap[a.id] = `${name} (${a.broker})`;
                });
                strategiesGrid.innerHTML='';
                if(!list || list.length===0){
                    strategiesGrid.classList.add('hidden');
                    noStrategiesState.classList.remove('hidden');
                    return;
                }
                strategiesGrid.classList.remove('hidden');
                noStrategiesState.classList.add('hidden');
                list.forEach(s => {
                    const accText = s.master_accounts ? s.master_accounts.split(',').map(id=>accMap[id.trim()]||id.trim()).join(', ') : 'All';
                    const webhookUrl = `${window.location.origin}/webhook/${userToken}?secret=${encodeURIComponent(s.webhook_secret || '')}`;
                    const cardHtml = `
                    <div class="col">
                        <div class="strategy-card bg-white rounded-xl shadow-md overflow-hidden h-full flex flex-col">
                        <div class="p-6 flex-grow flex flex-col">
                            <div class="flex items-center mb-4">
                            ${s.icon ? `<img src="${s.icon}" class="rounded-full mr-4" style="width:48px;height:48px;object-fit:contain;" alt="${s.name} icon">` : '<div class="mr-4 w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full"><i class="fas fa-chart-line text-gray-400 text-xl"></i></div>'}
                            <div class="flex-grow">
                                <h5 class="text-xl font-semibold text-gray-900 mb-0">${s.name}</h5>
                            </div>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${s.is_active ? 'bg-green-100 text-green-800':'bg-gray-200 text-gray-600'}">${s.is_active ? 'Active':'Inactive'}</span>
                            </div>
                            <p class="text-gray-500 text-sm mb-4 flex-grow">${s.description || 'No description provided.'}</p>
                            <div class="text-xs text-gray-500 mb-4">Accounts: <span class="font-medium">${accText}</span></div>
                            
                            <div class="mb-4">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Webhook URL</label>
                            <div class="relative flex rounded-lg shadow-sm">
                                <input type="text" class="form-input flex-1 p-2 rounded-l-lg text-sm border border-gray-300 bg-gray-100" value="${webhookUrl}" readonly>
                                <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-2 rounded-r-lg transition-colors duration-200 copy-btn" data-clipboard-text="${webhookUrl}" title="Copy Webhook URL"><i class="bi bi-clipboard"></i></button>
                                <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-2 rounded-lg ml-1 transition-colors duration-200 regen-btn" data-strategy-id="${s.id}" title="Regenerate Secret"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                            </div>
                            
                            <div class="mt-auto flex flex-wrap justify-end gap-2">
                            <button class="flex-1 btn-sm font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 ${s.is_active?'bg-yellow-500 hover:bg-yellow-600 text-white':'bg-green-500 hover:bg-green-600 text-white'} activate-toggle-btn" data-strategy-id="${s.id}">
                                <i class="bi ${s.is_active ? 'bi-pause-circle':'bi-play-circle'} mr-1"></i> ${s.is_active ? 'Deactivate':'Activate'}
                            </button>
                            <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 btn-sm font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 clone-btn" data-strategy-id="${s.id}">
                                <i class="bi bi-copy mr-1"></i> Clone
                            </button>
                            <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 btn-sm font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 payload-btn" data-strategy-id="${s.id}">
                                <i class="bi bi-file-earmark-text mr-1"></i> Payload
                            </button>    
                            <a href="/strategy-performance/${s.id}" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 btn-sm font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200">
                                <i class="bi bi-graph-up mr-1"></i> Logs
                            </a>
                            <button class="flex-1 bg-blue-600 hover:bg-blue-700 text-white btn-sm font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 edit-btn" data-strategy-id="${s.id}">
                                <i class="bi bi-pencil mr-1"></i> Edit
                            </button>
                            <button class="flex-1 bg-red-600 hover:bg-red-700 text-white btn-sm font-semibold py-1 px-3 rounded-lg text-sm transition-colors duration-200 delete-btn" data-strategy-id="${s.id}">
                                <i class="bi bi-trash mr-1"></i> Delete
                            </button>
                            </div>
                        </div>
                        </div>
                    </div>`;
                    strategiesGrid.insertAdjacentHTML('beforeend', cardHtml);
                });

                document.querySelectorAll('.copy-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>document.execCommand('copy'));
                });
                document.querySelectorAll('.regen-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        if(!confirm('Regenerate secret for this strategy?')) return;
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}/regenerate-secret`,{method:'POST'}).then(loadStrategies);
                    });
                });
                document.querySelectorAll('.activate-toggle-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        const action=btn.textContent.includes('Deactivate')?'deactivate':'activate';
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}/${action}`,{method:'POST'}).then(loadStrategies);
                    });
                });
                document.querySelectorAll('.clone-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}/clone`,{method:'POST'}).then(loadStrategies);
                    });
                });
                document.querySelectorAll('.payload-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        const sid = btn.dataset.strategyId;
                        const webhookUrl = btn.closest('.strategy-card').querySelector('input').value;
                        const payload = localStorage.getItem('strategyPayload_'+sid) || '';
                        payloadWebhook.value = webhookUrl;
                        payloadJson.value = payload;
                        window.showModal('payloadModal');
                    });
                });
                document.querySelectorAll('.edit-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}`).then(data=>{
                            editingId = data.id;
                            modalTitle.textContent = 'Edit Strategy';
                            form.strategyName.value = data.name;
                            loadMasterAccounts(data.master_accounts ? data.master_accounts.split(',') : []);
                            
                            const storedAllowedTickers = data.allowed_tickers || '';
                            if (storedAllowedTickers === '__WATCHLIST_DYNAMIC__') {
                                watchlistModeRadio.checked = true;
                            } else {
                                singleSymbolModeRadio.checked = true;
                                tradingSymbolsTextarea.value = storedAllowedTickers;
                            }
                            updateSymbolInputMode();
                            updateWebhookPreview();
                            window.showModal('strategyModal');
                        });
                    });
                });
                document.querySelectorAll('.delete-btn').forEach(btn=>{
                    btn.addEventListener('click',()=>{
                        if(!confirm('Are you sure you want to delete this strategy? This action cannot be undone.')) return;
                        fetchJson(`/api/strategies/${btn.dataset.strategyId}`,{method:'DELETE'}).then(()=>{
                            localStorage.removeItem('strategyPayload_'+btn.dataset.strategyId);
                            loadStrategies();
                        });
                    });
                });
            });
        }

        createStrategyBtn && createStrategyBtn.addEventListener('click', ()=>{ resetForm(); window.showModal('strategyModal'); });
        createStrategyBtnAlt && createStrategyBtnAlt.addEventListener('click', ()=>{ resetForm(); window.showModal('strategyModal'); });
        document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => { document.getElementById('strategyModal').classList.add('hidden'); }));

        form.addEventListener('submit', function(e){
            e.preventDefault();
            const name = form.strategyName.value.trim();
            const selectedAccounts = getSelectedAccounts();

            if(!name){ alert('Strategy Name is required'); return; }

            const isSingleSymbolMode = singleSymbolModeRadio.checked;
            let symbolsToProcessForPreview = [];
            let strategyNameForDB = name;
            let tradingSymbolsForDb = '';

            if (isSingleSymbolMode) {
                const singleSymbol = tradingSymbolsTextarea.value.trim();
                if (!singleSymbol) {
                    alert('Enter a trading symbol for single symbol mode');
                    return;
                }
                symbolsToProcessForPreview = [singleSymbol];
                tradingSymbolsForDb = singleSymbol;
                strategyNameForDB = `${name}-${singleSymbol}`;
            } else {
                symbolsToProcessForPreview = ["{% raw %}{{ticker}}{% endraw %}"];
                tradingSymbolsForDb = "__WATCHLIST_DYNAMIC__";
                strategyNameForDB = name;
            }

            if(editingId){
                const payload = {
                    name: strategyNameForDB,
                    master_accounts: selectedAccounts,
                    allowed_tickers: tradingSymbolsForDb
                };
                fetchJson(`/api/strategies/${editingId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(()=>{
                    const stored = localStorage.getItem('strategyPayload_'+editingId);
                    if(stored){
                        try{
                            const obj = JSON.parse(stored);
                            obj.strategyName = strategyNameForDB;
                            obj.masterAccounts = selectedAccounts;
                            obj.tradingSymbols = symbolsToProcessForPreview;
                            localStorage.setItem('strategyPayload_'+editingId, JSON.stringify(obj));
                        }catch(e){/* ignore */}
                    }
                    document.getElementById('strategyModal').classList.add('hidden');
                    loadStrategies();
                });
            } else {
                const payload = {
                    name: strategyNameForDB,
                    asset_class:'Stocks',
                    style:'Systematic',
                    master_accounts: selectedAccounts,
                    allowed_tickers: tradingSymbolsForDb
                };

                fetchJson('/api/strategies',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
                .then(res=>{
                    const cp = {
                        strategyName: strategyNameForDB,
                        exchange: form.exchange.value,
                        transactionType: form.transactionType.value,
                        orderType: form.orderType.value,
                        orderValidity: form.orderValidity.value,
                        productType: form.productType.value,
                        masterAccounts: selectedAccounts,
                        tradingSymbols: symbolsToProcessForPreview
                    };
                    if(form.orderQty.value){
                        cp.orderQty = parseFloat(form.orderQty.value);
                    } else if(form.orderValue.value){
                        cp.orderValue = parseFloat(form.orderValue.value);
                    }
                    localStorage.setItem('strategyPayload_'+res.id, JSON.stringify(cp));
                    document.getElementById('strategyModal').classList.add('hidden');
                    loadStrategies();
                })
                .catch(error => {
                    console.error('Error creating strategy:', error);
                });
            }
            updateWebhookPreview();
        });

        loadSymbols();
        loadMasterAccounts();
        loadStrategies();
        setupModals();
    };

    window.addEventListener('DOMContentLoaded', () => {
        reinitializePageScripts();
    });
</script>
{% endblock %}
