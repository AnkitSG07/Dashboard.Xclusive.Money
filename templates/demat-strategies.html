{% extends "demat-trading.html" %}

{% block title %}Strategies - DhanBot{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold text-primary">Your Trading Strategies</h1>
            <p class="lead text-muted">Manage and create automated trading strategies for your connected accounts.</p>
        </div>
        <div class="col-md-4 text-end">
            <button id="create-strategy-btn-alt" class="btn btn-primary btn-lg shadow-sm">
                <i class="fas fa-plus me-2"></i> Create New Strategy
            </button>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control border-start-0" id="strategy-search" placeholder="Search strategies by name...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="strategy-filter-status">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="strategy-filter-account">
                <option value="">All Accounts</option>
                <!-- Options populated dynamically by JS -->
            </select>
        </div>
    </div>

    <div id="no-strategies-state" class="empty-state card shadow-sm p-5 text-center" style="display:none;">
        <div class="empty-state-icon mb-4">
            <i class="fas fa-robot fa-4x text-muted"></i>
        </div>
        <h3 class="fw-bold text-dark">No Strategies Yet!</h3>
        <p class="text-muted mb-4">It looks like you haven't created any trading strategies. Let's get started!</p>
        <button id="create-strategy-btn" class="btn btn-primary btn-lg">
            <i class="fas fa-plus me-2"></i> Create Your First Strategy
        </button>
    </div>

    <div id="strategies-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 my-4" style="display:none;">
        <!-- Strategy cards will be injected here by JavaScript -->
    </div>

    <!-- Strategy Creation/Edit Modal -->
    <div class="modal fade" id="strategyModal" tabindex="-1" aria-labelledby="strategyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-3 shadow-lg">
                <form id="strategyForm">
                    <div class="modal-header bg-primary text-white rounded-top-3">
                        <h5 class="modal-title fw-bold" id="strategyModalLabel">Create New Strategy</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label for="strategy-name" class="form-label fw-semibold">Strategy Name <span class="text-danger">*</span>
                                <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="A unique and descriptive name for your trading strategy."></i>
                            </label>
                            <input type="text" class="form-control" id="strategy-name" name="strategyName" required placeholder="e.g., Daily Momentum Scalper">
                        </div>

                        <div class="mb-4 border-top pt-3">
                            <label class="form-label fw-semibold">Master Accounts
                                <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Select the master trading accounts this strategy will operate on."></i>
                            </label>
                            <div id="strategy-accounts" class="d-flex flex-column gap-2 p-3 border rounded bg-light-subtle">
                                <!-- Master accounts checkboxes will be loaded here -->
                            </div>
                            <div class="form-text mt-2">Select connected master accounts for this strategy.</div>
                        </div>

                        <div class="row g-3 mb-4 border-top pt-3">
                            <div class="col-md-6">
                                <label for="exchange" class="form-label fw-semibold">Exchange <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="The stock exchange where the trading symbol is listed."></i>
                                </label>
                                <select class="form-select" id="exchange" name="exchange">
                                    <option value="NSE">NSE</option>
                                    <option value="BSE">BSE</option>
                                    <option value="BOTH">Both (NSE &amp; BSE)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="symbol-token" class="form-label fw-semibold">Symbol Token
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Broker-specific token for the trading symbol. Auto-filled for single symbol mode."></i>
                                </label>
                                <input type="text" class="form-control" id="symbol-token" name="symbolToken" placeholder="Auto" readonly>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Trading Symbols <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Define how trading symbols are provided for this strategy."></i>
                                </label>
                                <div class="mb-2">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="symbolInputMode" id="singleSymbolMode" value="single" checked>
                                        <label class="form-check-label" for="singleSymbolMode">Single Symbol</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="symbolInputMode" id="watchlistMode" value="watchlist">
                                        <label class="form-check-label" for="watchlistMode">Watchlist (TradingView Alert)</label>
                                    </div>
                                </div>
                                <textarea class="form-control" id="trading-symbols" name="tradingSymbols" rows="1" placeholder="Enter single symbol (e.g., RELIANCE)" required></textarea>
                                <div class="form-text" id="symbol-input-help">Enter the trading symbol.</div>
                                <div id="tokens-list" class="small text-muted mt-1"></div>
                            </div>
                        </div>

                        <div class="row g-3 mb-4 border-top pt-3">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Alert Type</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="alertType" id="alertTypeStrategy" value="strategy" checked>
                                        <label class="form-check-label" for="alertTypeStrategy">Strategy alert</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="alertType" id="alertTypeManual" value="manual">
                                        <label class="form-check-label" for="alertTypeManual">Manual alert</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6" id="strategyActionGroup">
                                <label for="action-placeholder" class="form-label fw-semibold">Action</label>
                                <input type="text" class="form-control" id="action-placeholder" value="{% raw %}{{strategy.order.action}}{% endraw %}" readonly>
                                <div class="form-text">TradingView will replace this with BUY or SELL.</div>
                            </div>
                            <div class="col-md-6" id="manualTypeGroup" style="display:none;">
                                <label for="transaction-type" class="form-label fw-semibold">Type of Transaction <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Whether the strategy will BUY or SELL the specified symbols."></i>
                                </label>
                                <select class="form-select" id="transaction-type" name="transactionType">
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                   <option value="BOTH">Both (BUY &amp; SELL)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="order-type" class="form-label fw-semibold">Order Type <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="The type of order to place (Limit for specific price, Market for current market price)."></i>
                                </label>
                                <select class="form-select" id="order-type" name="orderType">
                                    <option value="limit">Limit</option>
                                    <option value="market">Market</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="order-validity" class="form-label fw-semibold">Order Validity
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="How long the order remains active (Day for end of day, IOC for immediate or cancel)."></i>
                                </label>
                                <select class="form-select" id="order-validity" name="orderValidity">
                                    <option value="day" selected>Day</option>
                                    <option value="IOC">IOC (Immediate or Cancel)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="product-type" class="form-label fw-semibold">Type of Product <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="The product type for the trade (Intraday/MIS for same-day square-off, CNC/Longterm for delivery)."></i>
                                </label>
                                <select class="form-select" id="product-type" name="productType">
                                    <option value="intraday">Intraday / MIS</option>
                                    <option value="cnc">CNC / Longterm</option>
                                    <option value="mtf">MTF</option>    
                                </select>
                                <div class="form-text">Intraday/MIS are equivalent, as are CNC/longterm.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="order-qty" class="form-label fw-semibold">Order Quantity
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="The number of shares/units to trade. Leave empty if specifying Order Value."></i>
                                </label>
                                <input type="number" class="form-control" id="order-qty" name="orderQty" min="1" placeholder="e.g., 100">
                                <div class="form-text">Leave empty if specifying Order Value.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="order-value" class="form-label fw-semibold">Order Value
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="The total monetary value of the order. Quantity will be auto-calculated from live price."></i>
                                </label>
                                <input type="number" class="form-control" id="order-value" name="orderValue" min="1" step="0.01" placeholder="e.g., 10000.00">
                                <div class="form-text">Auto-calculates quantity from live price.</div>
                            </div>
                            <div class="col-md-12">
                                <label for="webhook-preview" class="form-label fw-semibold">Webhook Payload Preview
                                    <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="This JSON payload will be sent to the webhook URL when triggered."></i>
                                </label>
                                <div class="input-group">
                                    <textarea class="form-control bg-light font-monospace" id="webhook-preview" rows="5" readonly></textarea>
                                    <button type="button" class="btn btn-outline-secondary" id="copy-preview-btn" title="Copy Payload"><i class="bi bi-clipboard"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i> Save Strategy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Strategy Payload Modal -->
    <div class="modal fade" id="payloadModal" tabindex="-1" aria-labelledby="payloadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-3 shadow-lg">
                <div class="modal-header bg-info text-white rounded-top-3">
                    <h5 class="modal-title fw-bold" id="payloadModalLabel">Strategy Webhook Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Webhook URL
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Use this URL in your TradingView alert or other external systems to trigger the strategy."></i>
                        </label>
                        <div class="input-group">
                            <input id="payload-webhook" type="text" class="form-control bg-light font-monospace" readonly>
                            <button type="button" class="btn btn-outline-secondary" id="copy-webhook-btn" title="Copy Webhook URL"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">JSON Payload
                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="This is the default JSON payload for your strategy. You can customize it in TradingView alerts."></i>
                        </label>
                        <div class="input-group">
                            <textarea id="payload-json" class="form-control bg-light font-monospace" rows="7" readonly></textarea>
                            <button type="button" class="btn btn-outline-secondary" id="copy-payload-btn" title="Copy Payload"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
if (!window.pageScripts) window.pageScripts = {};
window.pageScripts["demat-strategies"] = function() {
    const createStrategyBtn = document.getElementById('create-strategy-btn');
    const createStrategyBtnAlt = document.getElementById('create-strategy-btn-alt');
    const strategiesGrid = document.getElementById('strategies-grid');
    const noStrategiesState = document.getElementById('no-strategies-state');
    const modalEl = document.getElementById('strategyModal');
    const form = document.getElementById('strategyForm');
    const tokensList = document.getElementById('tokens-list');
    const modal = new bootstrap.Modal(modalEl);
    const payloadModal = new bootstrap.Modal(document.getElementById('payloadModal'));
    const payloadWebhook = document.getElementById('payload-webhook');
    const payloadJson = document.getElementById('payload-json');
    const webhookPreview = document.getElementById('webhook-preview');
    const alertTypeStrategy = document.getElementById('alertTypeStrategy');
    const alertTypeManual = document.getElementById('alertTypeManual');
    const strategyActionGroup = document.getElementById('strategyActionGroup');
    const manualTypeGroup = document.getElementById('manualTypeGroup');
    const userToken = '{{ logged_in_user.webhook_token }}';
    const bothOption = document.getElementById('transaction-type').querySelector('option[value="BOTH"]');
    let symbolMap = {};
    let editingId = null;
    const BROKER_KEYS = ['dhan','aliceblue','angelone','iifl','kotak','upstox'];

    // Tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    document.getElementById('copy-webhook-btn').addEventListener('click',e=>{e.preventDefault();e.stopPropagation();navigator.clipboard.writeText(payloadWebhook.value);});
    document.getElementById('copy-payload-btn').addEventListener('click',e=>{e.preventDefault();e.stopPropagation();navigator.clipboard.writeText(payloadJson.value);});
    document.getElementById('copy-preview-btn').addEventListener('click',e=>{e.preventDefault();e.stopPropagation();navigator.clipboard.writeText(webhookPreview.value);});
    
    function fetchJson(url, opts={}) {
        return fetch(url, opts).then(r => {
            if (!r.ok) return r.json().then(e => { throw new Error(e.error || 'Request failed'); });
            return r.json();
        });
    }

    function loadSymbols(){
        fetchJson('/api/symbols').then(list => {
            list.forEach(item => {
                symbolMap[item.symbol.toUpperCase()] = item;
            });
        }).catch(() => {});
    }

    function loadMasterAccounts(selected){
        const container = document.getElementById('strategy-accounts');
        const filterAccountSelect = document.getElementById('strategy-filter-account');
        // Clear previous options in filter
        filterAccountSelect.innerHTML = '<option value="">All Accounts</option>';

        return fetchJson('/api/accounts?cache_only=1').then(data=>{
            const masters = Array.isArray(data.masters) ? data.masters : [];
            container.innerHTML = masters.map(m => {
                const id = `acc-${m.id}`;
                const name = m.username ? `${m.username} (${m.client_id})` : m.client_id;
                // Add to filter options
                filterAccountSelect.insertAdjacentHTML('beforeend', `<option value="${m.id}">${m.broker || ''} - ${name}</option>`);
                return `<div class="form-check">
                            <input class="form-check-input" type="checkbox" name="masterAccounts" value="${m.id}" id="${id}">
                            <label class="form-check-label" for="${id}">${m.broker || ''} - ${name}</label>
                        </div>`;
            }).join('');
            if(selected){
                const vals = Array.isArray(selected) ? selected : String(selected).split(',');
                vals.forEach(v => {
                    const cb = container.querySelector(`input[value="${v}"]`);
                    if(cb) cb.checked = true;
                });
            }
        }).catch(()=>{});
    }

    function getSelectedAccounts(){
        const container = document.getElementById('strategy-accounts');
        return Array.from(container.querySelectorAll('input[name="masterAccounts"]:checked')).map(cb => cb.value);
    }
    
    function expandBoth(value, bothValues){
        if (Array.isArray(value)) return value;
        return String(value).toUpperCase() === 'BOTH' ? bothValues : value;
    }

    function getSymbols(){
        if (singleSymbolModeRadio.checked) {
            return [tradingSymbolsTextarea.value.trim()].filter(Boolean);
        } else { // watchlistModeRadio.checked
           return ["{% raw %}{{ticker}}{% endraw %}"]; // For display/preview purposes in the UI
        }
    }

    function updateTokens(){
        const syms = getSymbols();
        const tokenText = syms.map(s => {
            if (s === "{% raw %}{{ticker}}{% endraw %}") {
                return "Dynamic (TradingView {% raw %}{{ticker}}{% endraw %})";
            }
            const info = symbolMap[s.toUpperCase()];
            if(!info) return s;
            const parts = BROKER_KEYS.map(k => info[k] ? `${k}:${info[k]}` : null).filter(Boolean);
            return parts.length ? `${s} (${parts.join(', ')})` : s;
        }).join(', ');
        tokensList.textContent = tokenText;

        if(singleSymbolModeRadio.checked && syms.length === 1){
            const info = symbolMap[syms[0].toUpperCase()];
            if(info){
                for(const k of BROKER_KEYS){
                    if(info[k]){ form.symbolToken.value = info[k]; break; }
                }
            } else {
                form.symbolToken.value = '';
            }
        } else {
            form.symbolToken.value = '';
        }
        updateQtyFromValue();
    }
    form.tradingSymbols.addEventListener('input', updateTokens);

    const singleSymbolModeRadio = document.getElementById('singleSymbolMode');
    const watchlistModeRadio = document.getElementById('watchlistMode');
    const tradingSymbolsTextarea = document.getElementById('trading-symbols');
    const symbolInputHelp = document.getElementById('symbol-input-help');

    function updateSymbolInputMode() {
        if (singleSymbolModeRadio.checked) {
            tradingSymbolsTextarea.rows = 1;
            tradingSymbolsTextarea.placeholder = "Enter single symbol (e.g., RELIANCE)";
            tradingSymbolsTextarea.disabled = false;
            tradingSymbolsTextarea.name = "tradingSymbols"; // Ensure name is correct for single mode
            symbolInputHelp.textContent = "Enter the trading symbol.";
            // If switching from watchlist mode, clear dynamic placeholder value
            if (tradingSymbolsTextarea.value === "{% raw %}{{ticker}}{% endraw %}") {
                tradingSymbolsTextarea.value = "";
            }
        } else { // watchlistModeRadio.checked
            tradingSymbolsTextarea.rows = 1;
            tradingSymbolsTextarea.placeholder = "Symbols will be dynamically provided by TradingView ({% raw %}{{ticker}}{% endraw %})";
            tradingSymbolsTextarea.value = ""; // Explicitly clear any content
            tradingSymbolsTextarea.disabled = true; // Disable the input
            tradingSymbolsTextarea.name = "disabledTradingSymbols"; // Change name to prevent accidental submission
            symbolInputHelp.textContent = "For TradingView Watchlist alerts, symbols will be passed dynamically. No input needed here.";
        }
        updateTokens();
        updateWebhookPreview();
    }

    singleSymbolModeRadio.addEventListener('change', updateSymbolInputMode);
    watchlistModeRadio.addEventListener('change', updateSymbolInputMode);
    function updateAlertMode() {
        if (alertTypeStrategy.checked) {
            strategyActionGroup.style.display = '';
            manualTypeGroup.style.display = 'none';
            if (bothOption) {
                bothOption.hidden = false;
                form.transactionType.value = 'BOTH';
            }
        } else {
            strategyActionGroup.style.display = 'none';
            manualTypeGroup.style.display = '';
            if (bothOption) {
                bothOption.hidden = true;
                if (form.transactionType.value === 'BOTH') {
                    form.transactionType.value = 'BUY';
                }
            }
        }
        updateWebhookPreview();
    }
    alertTypeStrategy.addEventListener('change', updateAlertMode);
    alertTypeManual.addEventListener('change', updateAlertMode);
    
    function updateWebhookPreview() {
        const selectedAccounts = getSelectedAccounts();

        const exch = expandBoth(form.exchange.value, ['NSE','BSE']);
        const previewPayload = {
            exchange: exch,
            orderType: form.orderType.value,
            orderValidity: form.orderValidity.value,
            productType: form.productType.value,
            masterAccounts: selectedAccounts,
        };
        if (alertTypeStrategy.checked) {
            previewPayload.action = "{% raw %}{{strategy.order.action}}{% endraw %}";
        } else {
            previewPayload.transactionType = form.transactionType.value;
        }
        if(form.orderQty.value){
            previewPayload.orderQty = parseFloat(form.orderQty.value);
        } else if(form.orderValue.value){
            previewPayload.orderValue = parseFloat(form.orderValue.value);
        }

        if (singleSymbolModeRadio.checked) {
            const currentSymbol = tradingSymbolsTextarea.value.trim();
            previewPayload.tradingSymbols = currentSymbol ? [currentSymbol] : [];
        } else { // Watchlist mode
            previewPayload.tradingSymbols = ["{% raw %}{{ticker}}{% endraw %}"];
        }

        document.getElementById('webhook-preview').value = JSON.stringify(previewPayload, null, 2);
    }

    form.strategyName.addEventListener('input', updateWebhookPreview);
    form.exchange.addEventListener('change', updateWebhookPreview);
    form.transactionType.addEventListener('change', updateWebhookPreview);
    form.orderType.addEventListener('change', updateWebhookPreview);
    form.orderValidity.addEventListener('change', updateWebhookPreview);
    form.productType.addEventListener('change', updateWebhookPreview);
    form.orderQty.addEventListener('input', updateWebhookPreview);
    form.orderValue.addEventListener('input', updateWebhookPreview);


    updateSymbolInputMode();
    updateAlertMode();
    
    function resetForm(){
        editingId = null;
        form.reset();
        tokensList.textContent = '';
        form.orderValue.disabled = false;
        form.orderQty.disabled = false;
        singleSymbolModeRadio.checked = true;
        alertTypeStrategy.checked = true;
        updateSymbolInputMode();
        updateAlertMode();
        updateTokens();
        loadMasterAccounts(); // Reload accounts to ensure all are unchecked
        modalEl.querySelector('.modal-title').textContent = 'Create New Strategy';
        updateWebhookPreview();
    }
    form.orderQty.addEventListener('input', ()=>{ form.orderValue.disabled = !!form.orderQty.value; });
    form.orderValue.addEventListener('input', ()=>{ form.orderQty.disabled = !!form.orderValue.value; });

    async function updateQtyFromValue(){
        if(!form.orderValue.value || (singleSymbolModeRadio.checked && getSymbols().length !== 1)) {
            form.orderQty.value = ''; // Clear quantity if value is empty or not single symbol
            return;
        }

        if (!singleSymbolModeRadio.checked) {
            form.orderQty.value = ''; // Quantity cannot be calculated for dynamic symbols
            return;
        }

        try{
            const sym = getSymbols()[0];
            const data = await fetchJson(`/api/quote/${encodeURIComponent(sym)}`);
            const price = parseFloat(data.price);
            if(price>0){
                const qty = parseFloat(form.orderValue.value) / price;
                form.orderQty.value = qty.toFixed(2);
            } else {
                form.orderQty.value = ''; // Clear if price is not valid
            }
        }catch(e){
            form.orderQty.value = ''; // Clear on error
        }
    }

    form.orderValue.addEventListener('change', updateQtyFromValue);

    let allStrategies = []; // Store all strategies for filtering

    function renderStrategies(strategiesToRender) {
        const accMap = {};
        // Re-fetch accounts to ensure accMap is up-to-date for rendering
        fetchJson('/api/accounts?cache_only=1').then(accData => {
            (accData.accounts || []).forEach(a => {
                const name = a.username ? `${a.username} (${a.client_id})` : a.client_id;
                accMap[a.id] = `${name} (${a.broker})`;
            });

            strategiesGrid.innerHTML = '';
            if (!strategiesToRender || strategiesToRender.length === 0) {
                strategiesGrid.style.display = 'none';
                noStrategiesState.style.display = 'block';
                return;
            }
            strategiesGrid.style.display = 'flex';
            noStrategiesState.style.display = 'none';

            strategiesToRender.forEach(s => {
                const accText = s.master_accounts ? s.master_accounts.split(',').map(id => accMap[id.trim()] || id.trim()).join(', ') : 'All Connected Accounts';
                const webhookUrl = `${window.location.origin}/webhook/${userToken}?secret=${encodeURIComponent(s.webhook_secret || '')}`;
                const cardHtml = `
                <div class="col strategy-card-item" data-strategy-name="${s.name.toLowerCase()}" data-strategy-status="${s.is_active ? 'active' : 'inactive'}" data-strategy-accounts="${s.master_accounts || ''}">
                  <div class="card h-100 shadow-sm border-0 rounded-3">
                    <div class="card-body d-flex flex-column p-4">
                      <div class="d-flex align-items-center mb-3">
                        ${s.icon ? `<img src="${s.icon}" class="rounded-circle me-3" style="width:56px;height:56px;object-fit:contain; border: 2px solid var(--bs-primary);" alt="${s.name} icon">` : '<div class="me-3 d-flex align-items-center justify-content-center bg-light-subtle rounded-circle" style="width:56px;height:56px; border: 2px solid var(--bs-gray-300);"><i class="fas fa-chart-line fa-2x text-primary"></i></div>'}
                        <div class="flex-grow-1">
                          <h5 class="card-title mb-1 fw-bold text-dark">${s.name}</h5>
                          <p class="card-subtitle text-muted small">${s.asset_class || 'Stocks'} - ${s.style || 'Systematic'}</p>
                        </div>
                        <span class="badge ${s.is_active ? 'bg-success-subtle text-success':'bg-secondary-subtle text-secondary'} fw-semibold py-2 px-3 rounded-pill">${s.is_active ? 'Active':'Inactive'}</span>
                      </div>
                      <p class="card-text text-muted mb-3">${s.description || 'No description provided for this strategy.'}</p>
                      <p class="small text-muted mb-3"><i class="fas fa-users me-2"></i> Accounts: ${accText}</p>
                      
                      <div class="mb-3">
                        <label class="form-label small text-muted mb-1">Webhook URL</label>
                        <div class="input-group input-group-sm">
                          <input type="text" class="form-control bg-light font-monospace" value="${webhookUrl}" readonly>
                          <button class="btn btn-outline-secondary copy-btn" data-clipboard-text="${webhookUrl}" title="Copy Webhook URL"><i class="bi bi-clipboard"></i></button>
                          <button class="btn btn-outline-secondary regen-btn" data-strategy-id="${s.id}" title="Regenerate Secret"><i class="bi bi-arrow-clockwise"></i></button>
                          <button class="btn btn-outline-secondary test-btn" data-strategy-id="${s.id}" title="Test Webhook"><i class="bi bi-play-circle"></i></button>
                        </div>
                      </div>
                      
                      <div class="mt-auto d-flex flex-wrap justify-content-end gap-2 pt-3 border-top">
                        <button class="btn btn-sm ${s.is_active?'btn-warning':'btn-success'} activate-toggle-btn" data-strategy-id="${s.id}">
                          <i class="bi ${s.is_active ? 'bi-pause-circle':'bi-play-circle'} me-1"></i> ${s.is_active ? 'Deactivate':'Activate'}
                        </button>
                        <button class="btn btn-sm btn-info clone-btn" data-strategy-id="${s.id}">
                          <i class="bi bi-copy me-1"></i> Clone
                        </button>
                        <button class="btn btn-sm btn-secondary payload-btn" data-strategy-id="${s.id}">
                          <i class="bi bi-file-earmark-text me-1"></i> Payload
                        </button>    
                        <a href="/strategy-performance/${s.id}" class="btn btn-sm btn-outline-secondary">
                          <i class="bi bi-graph-up me-1"></i> Logs
                        </a>
                        <button class="btn btn-sm btn-primary edit-btn" data-strategy-id="${s.id}">
                          <i class="bi bi-pencil me-1"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-strategy-id="${s.id}">
                          <i class="bi bi-trash me-1"></i> Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>`;
                strategiesGrid.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Re-attach event listeners after rendering
            attachStrategyEventListeners();
        }).catch(error => {
            console.error("Error loading accounts for rendering:", error);
            // Fallback to showing no strategies if accounts fail to load
            strategiesGrid.style.display = 'none';
            noStrategiesState.style.display = 'block';
        });
    }

    function attachStrategyEventListeners() {
        document.querySelectorAll('.copy-btn').forEach(btn=>{
            btn.addEventListener('click',()=>navigator.clipboard.writeText(btn.dataset.clipboardText));
        });
        document.querySelectorAll('.regen-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                if(!confirm('Are you sure you want to regenerate the secret for this strategy? This will invalidate any existing webhook URLs using the old secret.')) return;
                fetchJson(`/api/strategies/${btn.dataset.strategyId}/regenerate-secret`,{method:'POST'}).then(loadStrategies);
            });
        });
        document.querySelectorAll('.test-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                fetchJson(`/api/strategies/${btn.dataset.strategyId}/test-webhook`,{method:'POST'}).then(o=>alert('Webhook test status: ' + (o.status || 'Unknown')));
            });
        });
        document.querySelectorAll('.activate-toggle-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                const action=btn.textContent.includes('Deactivate')?'deactivate':'activate';
                fetchJson(`/api/strategies/${btn.dataset.strategyId}/${action}`,{method:'POST'}).then(loadStrategies);
            });
        });
        document.querySelectorAll('.clone-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                fetchJson(`/api/strategies/${btn.dataset.strategyId}/clone`,{method:'POST'}).then(loadStrategies);
            });
        });
        document.querySelectorAll('.payload-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                const sid = btn.dataset.strategyId;
                const webhookUrl = btn.closest('.card').querySelector('input.form-control').value;

                let payloadObj = {};
                try {
                    payloadObj = JSON.parse(localStorage.getItem('strategyPayload_'+sid) || '{}');
                } catch(e) {}

                payloadObj.exchange = expandBoth(payloadObj.exchange, ['NSE','BSE']);
                payloadObj.transactionType = expandBoth(payloadObj.transactionType, ['BUY','SELL']);
                localStorage.setItem('strategyPayload_'+sid, JSON.stringify(payloadObj));

                payloadWebhook.value = webhookUrl;
                payloadJson.value = JSON.stringify(payloadObj, null, 2);
                payloadModal.show();
            });
        });
        document.querySelectorAll('.edit-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                fetchJson(`/api/strategies/${btn.dataset.strategyId}`).then(data=>{
                    editingId = data.id;
                    modalEl.querySelector('.modal-title').textContent = 'Edit Strategy';
                    
                    const storedAllowedTickers = data.allowed_tickers || '';
                    let baseName = data.name || '';
                    if (storedAllowedTickers && storedAllowedTickers !== '__WATCHLIST_DYNAMIC__') {
                        const suffix = ` (${storedAllowedTickers})`;
                        if (baseName.endsWith(suffix)) {
                            baseName = baseName.slice(0, -suffix.length);
                        }
                    }
                    form.strategyName.value = baseName;
                    loadMasterAccounts(data.master_accounts ? data.master_accounts.split(',') : []);
                    
                    if (storedAllowedTickers === '__WATCHLIST_DYNAMIC__') {
                        watchlistModeRadio.checked = true;
                    } else {
                        singleSymbolModeRadio.checked = true;
                        tradingSymbolsTextarea.value = storedAllowedTickers;
                    }
                    // Set other form fields
                    const exchField = data.exchange;
                    if (Array.isArray(exchField)) {
                        form.exchange.value = exchField.length === 2 ? 'BOTH' : exchField[0];
                    } else {
                        const val = String(exchField || 'NSE').toUpperCase();
                        form.exchange.value = val === 'BOTH' ? 'BOTH' : (exchField || 'NSE');
                    }
                    const tTypeField = data.transaction_type;
                    if (Array.isArray(tTypeField)) {
                        form.transactionType.value = tTypeField.length === 2 ? 'BOTH' : tTypeField[0];
                    } else {
                        const val = String(tTypeField || 'BUY').toUpperCase();
                        form.transactionType.value = val === 'BOTH' ? 'BOTH' : (tTypeField || 'BUY');
                    }

                    const isManualMode = !Array.isArray(tTypeField) && String(tTypeField || '').toUpperCase() !== 'BOTH';
                    alertTypeManual.checked = isManualMode;
                    alertTypeStrategy.checked = !isManualMode;

                    form.orderType.value = data.order_type || 'limit';
                    form.orderValidity.value = data.order_validity || 'day';
                    form.productType.value = data.product_type || 'intraday';
                    form.orderQty.value = data.order_qty || '';
                    form.orderValue.value = data.order_value || '';

                    // Disable/enable quantity/value fields based on which one has a value
                    form.orderQty.disabled = !!form.orderValue.value;
                    form.orderValue.disabled = !!form.orderQty.value;

                    updateSymbolInputMode(); // This also calls updateTokens and updateWebhookPreview
                    updateAlertMode();

                    // Reapply quantity/value after updates to avoid recalculation
                    form.orderQty.value = data.order_qty || '';
                    form.orderValue.value = data.order_value || '';
                    form.orderQty.disabled = !!form.orderValue.value;
                    form.orderValue.disabled = !!form.orderQty.value;

                    updateWebhookPreview();
                    modal.show();
                });
            });
        });
        document.querySelectorAll('.delete-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                if(!confirm('Are you sure you want to delete this strategy? This action cannot be undone.')) return;
                fetchJson(`/api/strategies/${btn.dataset.strategyId}`,{method:'DELETE'}).then(()=>{
                    localStorage.removeItem('strategyPayload_'+btn.dataset.strategyId);
                    loadStrategies();
                });
            });
        });
    }

    function loadStrategies(){
        Promise.all([
            fetchJson('/api/strategies'),
            fetchJson('/api/accounts?cache_only=1') // Ensure accounts are loaded for filter dropdown
        ]).then(([list, accData]) => {
            allStrategies = list; // Store all strategies
            renderStrategies(allStrategies); // Render initially
            // Populate account filter dropdown
            const filterAccountSelect = document.getElementById('strategy-filter-account');
            filterAccountSelect.innerHTML = '<option value="">All Accounts</option>'; // Reset
            const uniqueAccounts = new Set();
            (accData.accounts || []).forEach(a => {
                const name = a.username ? `${a.username} (${a.client_id})` : a.client_id;
                uniqueAccounts.add(JSON.stringify({id: a.id, name: `${a.broker || ''} - ${name}`}));
            });
            Array.from(uniqueAccounts).map(JSON.parse).sort((a,b) => a.name.localeCompare(b.name)).forEach(acc => {
                filterAccountSelect.insertAdjacentHTML('beforeend', `<option value="${acc.id}">${acc.name}</option>`);
            });
        }).catch(error => {
            console.error("Error loading strategies:", error);
            strategiesGrid.style.display = 'none';
            noStrategiesState.style.display = 'block';
        });
    }

    // Filtering logic
    const strategySearchInput = document.getElementById('strategy-search');
    const strategyFilterStatus = document.getElementById('strategy-filter-status');
    const strategyFilterAccount = document.getElementById('strategy-filter-account');

    function applyFilters() {
        const searchTerm = strategySearchInput.value.toLowerCase();
        const filterStatus = strategyFilterStatus.value;
        const filterAccount = strategyFilterAccount.value;

        const filteredStrategies = allStrategies.filter(s => {
            const matchesSearch = s.name.toLowerCase().includes(searchTerm);
            const matchesStatus = filterStatus === '' || (s.is_active ? 'active' : 'inactive') === filterStatus;
            const matchesAccount = filterAccount === '' || (s.master_accounts && s.master_accounts.split(',').includes(filterAccount));
            
            return matchesSearch && matchesStatus && matchesAccount;
        });
        renderStrategies(filteredStrategies);
    }

    strategySearchInput.addEventListener('input', applyFilters);
    strategyFilterStatus.addEventListener('change', applyFilters);
    strategyFilterAccount.addEventListener('change', applyFilters);


    createStrategyBtn && createStrategyBtn.addEventListener('click', ()=>{ resetForm(); modal.show(); });
    createStrategyBtnAlt && createStrategyBtnAlt.addEventListener('click', ()=>{ resetForm(); modal.show(); });

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const name = form.strategyName.value.trim();
        const selectedAccounts = getSelectedAccounts();

        if(!name){ alert('Strategy Name is required'); return; }

        const isSingleSymbolMode = singleSymbolModeRadio.checked;
        let symbolsToProcessForPreview = [];
        let strategyNameForDB = name;
        let tradingSymbolsForDb = '';

        if (isSingleSymbolMode) {
            const singleSymbol = tradingSymbolsTextarea.value.trim();
            if (!singleSymbol) {
                alert('Enter a trading symbol for single symbol mode');
                return;
            }
            symbolsToProcessForPreview = [singleSymbol];
            tradingSymbolsForDb = singleSymbol;
            // For single symbol mode, append symbol to strategy name for clarity in DB
            strategyNameForDB = `${name} (${singleSymbol})`; 
        } else {
            symbolsToProcessForPreview = ["{% raw %}{{ticker}}{% endraw %}"];
            tradingSymbolsForDb = "__WATCHLIST_DYNAMIC__";
            strategyNameForDB = name; // Keep original name for dynamic watchlist
        }

        const exchVal = expandBoth(form.exchange.value, ['NSE','BSE']);
        const ttypeVal = expandBoth(form.transactionType.value, ['BUY','SELL']);
        const commonPayload = {
            name: strategyNameForDB,
            master_accounts: selectedAccounts.join(','), // Store as comma-separated string
            allowed_tickers: tradingSymbolsForDb,
            exchange: exchVal,
            transaction_type: ttypeVal,
            order_type: form.orderType.value,
            order_validity: form.orderValidity.value,
            product_type: form.productType.value,
            order_qty: form.orderQty.value ? parseFloat(form.orderQty.value) : null,
            order_value: form.orderValue.value ? parseFloat(form.orderValue.value) : null,
            asset_class:'Stocks', // Default for now, could be a form field later
            style:'Systematic' // Default for now, could be a form field later
        };

        let apiCall;
        if(editingId){
            apiCall = fetchJson(`/api/strategies/${editingId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(commonPayload)});
        } else {
            apiCall = fetchJson('/api/strategies',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(commonPayload)});
        }

        apiCall.then(res=>{
            const strategyId = editingId || res.id; // Get ID for local storage
            const cp = {
                strategyName: strategyNameForDB,
                exchange: exchVal,
                transactionType: ttypeVal,
                orderType: form.orderType.value,
                orderValidity: form.orderValidity.value,
                productType: form.productType.value,
                masterAccounts: selectedAccounts,
                tradingSymbols: symbolsToProcessForPreview
            };
            if(form.orderQty.value){
                cp.orderQty = parseFloat(form.orderQty.value);
            } else if(form.orderValue.value){
                cp.orderValue = parseFloat(form.orderValue.value);
            }
            localStorage.setItem('strategyPayload_'+strategyId, JSON.stringify(cp));
            modal.hide();
            loadStrategies();
        })
        .catch(error => {
            alert('Error saving strategy: ' + error.message);
            console.error('Error saving strategy:', error);
        });

        updateWebhookPreview();
    });

    loadSymbols();
    loadMasterAccounts(); // This also populates the filter dropdown
    loadStrategies();
};
</script>
{% endblock %}

{% block style %}
<style>
/* General Styling */
body {
    font-family: 'Inter', sans-serif; /* Modern sans-serif font */
    background-color: #f8f9fa; /* Light background */
    color: #343a40; /* Darker text for readability */
}

.container-fluid {
    max-width: 1400px; /* Max width for content */
}

/* Headings */
h1, h2, h3, h4, h5, h6 {
    font-family: 'Poppins', sans-serif; /* A more distinct font for headings */
    font-weight: 600;
    color: #212529;
}

.display-5 {
    font-size: 2.5rem;
}

.text-primary {
    color: #007bff !important; /* Bootstrap primary blue */
}

.text-muted {
    color: #6c757d !important;
}

/* Buttons */
.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    transition: all 0.2s ease-in-out;
}
.btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
    transform: translateY(-1px);
}
.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
    border-radius: 0.5rem;
}
.btn-sm {
    padding: 0.3rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.3rem;
}

/* Cards */
.card {
    border-radius: 0.75rem;
    border: none; /* Remove default border */
    transition: all 0.2s ease-in-out;
}
.card.shadow-sm {
    box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075) !important;
}
.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 .25rem .5rem rgba(0, 0, 0, .1) !important;
}

/* Empty State */
.empty-state {
    background-color: #ffffff;
    border: 2px dashed #e9ecef;
    border-radius: 1rem;
    color: #6c757d;
}
.empty-state-icon {
    color: #adb5bd;
}

/* Search and Filter Bar */
.input-group .form-control,
.input-group .input-group-text,
.form-select {
    border-radius: 0.5rem;
    border-color: #ced4da;
}
.input-group-text {
    background-color: #f8f9fa;
}
.form-select {
    background-color: #ffffff;
}

/* Strategy Card Specifics */
.strategy-card-item .card-body {
    display: flex;
    flex-direction: column;
}
.strategy-card-item .card-title {
    font-size: 1.35rem;
    margin-bottom: 0.25rem;
}
.strategy-card-item .card-subtitle {
    font-size: 0.9rem;
}
.strategy-card-item .badge {
    font-size: 0.85em;
    padding: 0.5em 0.8em;
    border-radius: 1rem;
}
.bg-success-subtle {
    background-color: #d4edda !important;
}
.text-success {
    color: #28a745 !important;
}
.bg-secondary-subtle {
    background-color: #e2e3e5 !important;
}
.text-secondary {
    color: #6c757d !important;
}

.strategy-card-item .input-group-sm .form-control,
.strategy-card-item .input-group-sm .btn {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    border-radius: 0.3rem;
}
.strategy-card-item .input-group-sm .btn {
    border-color: #ced4da;
}

.strategy-card-item .mt-auto {
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}
.strategy-card-item .btn {
    white-space: nowrap; /* Prevent buttons from wrapping text */
}

/* Modal Styling */
.modal-content {
    border-radius: 1rem;
    border: none;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}
.modal-header {
    border-bottom: none;
    padding: 1.5rem;
}
.modal-title {
    font-size: 1.5rem;
}
.modal-body {
    padding: 2rem;
}
.modal-footer {
    border-top: none;
    padding: 1.5rem;
}
.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%); /* Makes close button white */
}

/* Form Elements in Modal */
.form-label {
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
}
.form-control, .form-select {
    border-radius: 0.4rem;
    border: 1px solid #ced4da;
    padding: 0.75rem 1rem;
    font-size: 1rem;
}
.form-control:focus, .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
}
.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}
.bg-light-subtle {
    background-color: #f0f2f5 !important;
}
.font-monospace {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;
}

/* Tooltip Icon */
.form-label .fa-info-circle {
    cursor: help;
    font-size: 0.9em;
    color: #adb5bd;
    transition: color 0.2s ease-in-out;
}
.form-label .fa-info-circle:hover {
    color: #6c757d;
}

/* Custom styles for specific elements */
#strategy-accounts {
    max-height: 150px;
    overflow-y: auto;
}
</style>
{% endblock %}
