{% extends "demat-trading.html" %}
{% block title %}Strategies - DhanBot{% endblock %}
{% block content %}
<div class="content-section">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h2>Strategies</h2>
            </div>
        </div>
    </div>

<div id="no-strategies-state" class="empty-state">
    <div class="empty-state-icon">
        <i class="fas fa-chart-bar"></i>
    </div>
    <h3>No Strategies</h3>
    <p>Create your first trading strategy to get started.</p>
    <button id="create-strategy-btn" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Create Strategy
    </button>
</div>

<div id="strategies-card" class="card shadow-lg border-0 rounded-3 my-5" style="display:none;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="card-title mb-0">Current Strategies</h5>
            <button id="create-strategy-btn-alt" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Create Strategy
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="strategiesTable">
                <thead class="table-light">
                    <tr>
                        <th>Icon</th>
                        <th>Name</th>
                        <th>Asset Class</th>
                        <th>Style</th>
                        <th>Public</th>
                        <th>Webhook</th>
                        <th>Active</th>
                        <th>Last Run</th>
                        <th></th>  
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" class="text-center text-muted py-4">Loading strategies...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    <div id="strategy-creation-form" style="display: none;">
        <div class="page-header">
            <h2>New Strategy</h2>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-cog"></i> STRATEGY DETAILS</h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="strategy-name">Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="strategy-name" placeholder="My new strategy">
                    <small class="form-text text-muted">Give your strategy a name. It can be anything and will only be seen by you and your strategy subscribers. (e.g., Reversal Scalp)</small>
                </div>
                <div class="form-group">
                    <label for="strategy-description">Description</label>
                    <textarea class="form-control" id="strategy-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="asset-class">Asset class <span class="text-danger">*</span></label>
                    <select class="form-control" id="asset-class">
                        <option>Stocks</option>
                        </select>
                    <small class="form-text text-muted">Select the asset class that this strategy will use. This will determine the tickers that can be used with this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-group">
                    <label for="strategy-style">Style <span class="text-danger">*</span></label>
                    <select class="form-control" id="strategy-style">
                        <option>Systematic</option>
                        </select>
                    <small class="form-text text-muted">Indicate whether your strategy is systematic or discretionary. This helps us understand your usage and may influence future platform features. <a href="https://docs.example.com/strategy-style" target="_blank">More Info</a></small>
                </div>
                <div class="form-group mt-2">
                    <label for="strategy-icon">Icon</label>
                    <input type="file" class="form-control" id="strategy-icon" accept="image/*">
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="allow-auto-submit" checked>
                    <label class="form-check-label" for="allow-auto-submit">Allow auto submit</label>
                    <small class="form-text text-muted">If enabled, strategy subscribers will be allowed to enable auto submit when subscribing to this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="allow-live-trading" checked>
                    <label class="form-check-label" for="allow-live-trading">Allow live trading</label>
                    <small class="form-text text-muted">If enabled, strategy subscribers will be allowed to connect live broker accounts to this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="allow-any-ticker" checked>
                    <label class="form-check-label" for="allow-any-ticker">Allow any ticker</label>
                    <small class="form-text text-muted">Allow any ticker on this strategy. <a href="#">More Info</a></small>
                </div>
                <div class="form-group mt-3">
                    <label for="allowed-tickers">Allowed tickers</label>
                    <textarea class="form-control" id="allowed-tickers" rows="3" placeholder="Enter multiple tickers separated by commas to restrict this strategy to only these tickers. Checking &quot;Allow any ticker&quot; will override this setting."></textarea>
                    <small class="form-text text-muted">Enter multiple tickers separated by commas to restrict this strategy to only these tickers. Checking "Allow any ticker" will override this setting. <a href="https://docs.example.com/allowed-tickers" target="_blank">More Info</a></small>
                </div>
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" id="is-public">
                    <label class="form-check-label" for="is-public">Public</label>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-bell"></i> NOTIFICATIONS <span class="badge badge-secondary ml-2">Disabled</span></h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="notification-emails">Emails to notify</label>
                    <textarea class="form-control" id="notification-emails" rows="3"></textarea>
                    <small class="form-text text-muted">Comma-separated list of email addresses that will be notified of successful or failed signals sent to this webhook. <a href="#">More Info</a></small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="notify-failures-only">
                    <label class="form-check-label" for="notify-failures-only">Notify failures only</label>
                    <small class="form-text text-muted">Check this if you only want to be notified of failed strategy webhook requests. <a href="#">More Info</a></small>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-lock"></i> SECURITY <span class="badge badge-secondary ml-2">No Security</span></h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="webhook-secret">Webhook Secret</label>
                    <input type="text" class="form-control" id="webhook-secret" placeholder="Enter secret for webhook validation">
                    <small class="form-text text-muted">Incoming webhooks must include this secret token.</small>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-info-circle"></i> OPTIONAL DETAILS</h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="signal-source">Signal Source</label>
                    <input type="text" class="form-control" id="signal-source" placeholder="TradingView, TrendSpider, etc">
                </div>
                <div class="form-group mt-2">
                    <label for="schedule">Schedule</label>
                    <input type="text" class="form-control" id="schedule" placeholder="e.g. cron expression">
                </div>
                <div class="form-group mt-2">
                    <label for="risk-max-positions">Max Positions</label>
                    <input type="number" class="form-control" id="risk-max-positions" min="0">
                </div>
                <div class="form-group mt-2">
                    <label for="risk-max-allocation">Max Allocation (%)</label>
                    <input type="number" class="form-control" id="risk-max-allocation" min="0" max="100" step="0.01">
                </div>
                <div class="form-check mt-3">
                    <input type="checkbox" class="form-check-input" id="track-performance">
                    <label class="form-check-label" for="track-performance">Track performance</label>
                </div>
                <div class="form-group mt-2">
                    <label for="log-retention-days">Log retention days</label>
                    <input type="number" class="form-control" id="log-retention-days" value="30" min="1">
                </div>
            </div>
        </div>

        <div class="form-group text-center">
            <button type="submit" class="btn btn-success">Save</button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
if (!window.pageScripts) window.pageScripts = {};
window.pageScripts["demat-strategies"] = function() {
    const createStrategyBtn = document.getElementById('create-strategy-btn');
    const createStrategyBtnAlt = document.getElementById('create-strategy-btn-alt');
    const noStrategiesState = document.getElementById('no-strategies-state');
    const strategyCreationForm = document.getElementById('strategy-creation-form');
    const strategiesCard = document.getElementById('strategies-card');
    const strategiesTableBody = document.querySelector('#strategiesTable tbody');
    const userToken = '{{ logged_in_user.webhook_token }}';
    let editingId = null;
    const iconInput = document.getElementById('strategy-icon');
    
    const cardBodies = strategyCreationForm.querySelectorAll('.card.mb-4 .card-body');
    const optionalDetailsBody = cardBodies[3];
    let accountSelect;

    function loadAccounts() {
        accountSelect = document.createElement('select');
        accountSelect.id = 'strategy-account';
        accountSelect.className = 'form-control';
        const wrapper = document.createElement('div');
        wrapper.className = 'form-group';
        const label = document.createElement('label');
        label.textContent = 'Broker Account';
        wrapper.appendChild(label);
        wrapper.appendChild(accountSelect);
        if (optionalDetailsBody) optionalDetailsBody.prepend(wrapper);

        fetchJson('/api/accounts?cache_only=1')
            .then(data => {
                const accounts = data.accounts || [];
                accountSelect.innerHTML = '<option value="">Select Account</option>' +
                    accounts.map(a => `<option value="${a.id}">${a.client_id} (${a.broker})</option>`).join('');
            })
            .catch(err => console.error('Account load failed', err));
    }


    function fetchJson(url, options = {}) {
        return fetch(url, options).then(resp => {
            if (!resp.ok) {
                return resp.json().then(err => { throw new Error(err.error || 'Request failed'); });
            }
            return resp.json();
        });
    }

    function showToast(message, type='success') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        alert(message);
    }
    
    if (createStrategyBtn) {
        createStrategyBtn.addEventListener('click', () => {
            noStrategiesState.style.display = 'none';
            strategyCreationForm.style.display = 'block';
        });
    }
    if (createStrategyBtnAlt) {
        createStrategyBtnAlt.addEventListener('click', () => {
            strategyCreationForm.style.display = 'block';
        });
    }

    function loadStrategies() {
        fetchJson('/api/strategies')
            .then(list => {
                strategiesTableBody.innerHTML = '';
                if (!list || list.length === 0) {
                    strategiesCard.style.display = 'none';
                    noStrategiesState.style.display = 'block';
                    return;
                }
                strategiesCard.style.display = 'block';
                noStrategiesState.style.display = 'none';
                list.forEach(s => {
                    const tr = document.createElement('tr');
                    const iconCell = `<td>${s.icon ? `<img src="${s.icon}" width="24">` : ''}</td>`;
                    tr.innerHTML = `${iconCell}<td>${s.name}</td><td>${s.asset_class}</td><td>${s.style}</td><td>${s.is_public ? 'Yes' : 'No'}</td>`;

                    const tdWebhook = document.createElement('td');
                    const webhookUrl = `${location.origin}/webhook/${userToken}${s.webhook_secret ? `?secret=${encodeURIComponent(s.webhook_secret)}` : ''}`;
                    tdWebhook.innerHTML = `<div class="input-group input-group-sm"><input type="text" class="form-control form-control-sm" value="${webhookUrl}" readonly><button class="btn btn-outline-secondary copy-btn">Copy</button><button class="btn btn-outline-secondary regen-btn">Regen</button><button class="btn btn-outline-secondary test-btn">Test</button></div>`;
                    tr.appendChild(tdWebhook);

                    const tdActive = document.createElement('td');
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'btn btn-sm ' + (s.is_active ? 'btn-warning' : 'btn-success');
                    toggleBtn.textContent = s.is_active ? 'Deactivate' : 'Activate';
                    toggleBtn.addEventListener('click', () => {
                        const action = s.is_active ? 'deactivate' : 'activate';
                        fetchJson(`/api/strategies/${s.id}/${action}`, { method: 'POST' })
                            .then(() => loadStrategies())
                            .catch(err => showToast('Update failed: ' + err.message, 'error'));
                    });
                    tdActive.appendChild(toggleBtn);
                    tr.appendChild(tdActive);

                    const tdLast = document.createElement('td');
                    tdLast.textContent = s.last_run_at ? new Date(s.last_run_at).toLocaleString() : '-';
                    tr.appendChild(tdLast);

                    const tdAction = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-secondary me-1';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', () => {
                        editingId = s.id;
                        strategyCreationForm.style.display = 'block';
                        noStrategiesState.style.display = 'none';
                        document.getElementById('strategy-name').value = s.name || '';
                        document.getElementById('strategy-description').value = s.description || '';
                        document.getElementById('asset-class').value = s.asset_class || '';
                        document.getElementById('strategy-style').value = s.style || '';
                        document.getElementById('allow-auto-submit').checked = !!s.allow_auto_submit;
                        document.getElementById('allow-live-trading').checked = !!s.allow_live_trading;
                        document.getElementById('allow-any-ticker').checked = !!s.allow_any_ticker;
                        document.getElementById('allowed-tickers').value = s.allowed_tickers || '';
                        document.getElementById('notification-emails').value = s.notification_emails || '';
                        document.getElementById('notify-failures-only').checked = !!s.notify_failures_only;
                        document.getElementById('webhook-secret').value = s.webhook_secret || '';
                        document.getElementById('signal-source').value = s.signal_source || '';
                        document.getElementById('schedule').value = s.schedule || '';
                        document.getElementById('risk-max-positions').value = s.risk_max_positions || '';
                        document.getElementById('risk-max-allocation').value = s.risk_max_allocation || '';
                        document.getElementById('track-performance').checked = !!s.track_performance;
                        document.getElementById('log-retention-days').value = s.log_retention_days || '';

                        document.getElementById('is-public').checked = !!s.is_public;
                        if (iconInput) iconInput.value = '';
                        if (accountSelect) accountSelect.value = s.account_id || '';
                    });
                    tdAction.appendChild(editBtn);
                    
                    const cloneBtn = document.createElement('button');
                    cloneBtn.className = 'btn btn-sm btn-info me-1';
                    cloneBtn.textContent = 'Clone';
                    cloneBtn.addEventListener('click', () => {
                        fetchJson(`/api/strategies/${s.id}/clone`, {method:'POST'})
                            .then(() => { showToast('Cloned'); loadStrategies(); });
                    });
                    tdAction.appendChild(cloneBtn);

                    const logsBtn = document.createElement('a');
                    logsBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                    logsBtn.textContent = 'View Logs';
                    logsBtn.href = `/strategy-performance/${s.id}`;
                    tdAction.appendChild(logsBtn);


                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-sm btn-danger';
                    delBtn.textContent = 'Delete';
                    delBtn.addEventListener('click', () => {
                        if (!confirm('Delete this strategy?')) return;
                        fetchJson(`/api/strategies/${s.id}`, { method: 'DELETE' })
                            .then(() => {
                                showToast('Strategy deleted');
                                loadStrategies();
                            })
                            .catch(err => showToast('Delete failed: ' + err.message, 'error'));
                    });
                    tdAction.appendChild(delBtn);
                    tr.appendChild(tdAction);

                    const copyBtn = tdWebhook.querySelector('.copy-btn');
                    const regenBtn = tdWebhook.querySelector('.regen-btn');
                    const testBtn = tdWebhook.querySelector('.test-btn');
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(webhookUrl).then(() => showToast('Copied')); 
                    });
                    regenBtn.addEventListener('click', () => {
                        if (!confirm('Regenerate secret?')) return;
                        fetchJson(`/api/strategies/${s.id}/regenerate-secret`, {method: 'POST'})
                            .then(out => { s.webhook_secret = out.webhook_secret; loadStrategies(); })
                            .catch(err => showToast('Failed: ' + err.message, 'error'));
                    });
                    testBtn.addEventListener('click', () => {
                        fetchJson(`/api/strategies/${s.id}/test-webhook`, {method: 'POST'})
                            .then(out => showToast('Status: ' + out.status))
                            .catch(err => showToast('Test failed: ' + err.message, 'error'));
                    });

                    strategiesTableBody.appendChild(tr);
                });
            })
            .catch(err => showToast('Failed to load strategies: ' + err.message, 'error'));
    }
    const saveButton = strategyCreationForm.querySelector('button[type="submit"]');
    if (saveButton) {
        saveButton.addEventListener('click', function(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('strategy-name').value.trim(),
                description: document.getElementById('strategy-description').value.trim(),
                asset_class: document.getElementById('asset-class').value,
                style: document.getElementById('strategy-style').value,
                allow_auto_submit: document.getElementById('allow-auto-submit').checked,
                allow_live_trading: document.getElementById('allow-live-trading').checked,
                allow_any_ticker: document.getElementById('allow-any-ticker').checked,
                allowed_tickers: document.getElementById('allowed-tickers').value.trim(),
                notification_emails: document.getElementById('notification-emails').value.trim(),
                notify_failures_only: document.getElementById('notify-failures-only').checked,
                webhook_secret: document.getElementById('webhook-secret').value.trim(),
                signal_source: document.getElementById('signal-source').value.trim(),
                schedule: document.getElementById('schedule').value.trim(),
                risk_max_positions: parseInt(document.getElementById('risk-max-positions').value) || null,
                risk_max_allocation: parseFloat(document.getElementById('risk-max-allocation').value) || null,
                track_performance: document.getElementById('track-performance').checked,
                log_retention_days: parseInt(document.getElementById('log-retention-days').value) || null,
                account_id: accountSelect && accountSelect.value ? parseInt(accountSelect.value) : null,
                is_public: document.getElementById('is-public').checked
            };

            const url = editingId ? `/api/strategies/${editingId}` : '/api/strategies';
            const method = editingId ? 'PUT' : 'POST';
            function submit(iconData) {
                if (iconData) data.icon = iconData;
                fetchJson(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                })
                .then(() => {
                    showToast(editingId ? 'Strategy updated successfully!' : 'Strategy created successfully!');
                    strategyCreationForm.querySelectorAll('input, textarea').forEach(el => {
                        if (el.type === 'checkbox') {
                            el.checked = false;
                        } else {
                            el.value = '';
                        }
                    });
                    if (iconInput) iconInput.value = '';
                    document.getElementById('is-public').checked = false;
                    strategyCreationForm.style.display = 'none';
                    editingId = null;
                    loadStrategies();
                })
                .catch(err => showToast('Failed to create strategy: ' + err.message, 'error'));
            }
            if (iconInput && iconInput.files[0]) {
                const reader = new FileReader();
                reader.onload = e => submit(e.target.result);
                reader.readAsDataURL(iconInput.files[0]);
            } else {
                submit(null);
            }
        });
    }

    loadAccounts();
    loadStrategies();
};
</script>
{% endblock %}
