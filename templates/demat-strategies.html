{% extends "demat-trading.html" %}
{% block title %}Strategies - DhanBot{% endblock %}
{% block content %}
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Page Header -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between pb-6 border-b border-gray-200">
            <div class="mb-4 sm:mb-0">
                <h1 class="text-3xl font-bold text-gray-900">Trading Strategies</h1>
                <p class="mt-1 text-base text-gray-500">Manage and monitor your automated trading strategies.</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-500">
                    <span class="font-semibold text-gray-700">User ID:</span> <span id="user-id"></span>
                </div>
                <button id="create-strategy-btn-alt" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i> Create Strategy
                </button>
            </div>
        </header>

        <!-- Strategy Grid Container -->
        <main class="mt-8">
            <!-- Loading State -->
            <div id="loading-state" class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-gray-900"></div>
            </div>

            <!-- Empty State -->
            <div id="no-strategies-state" class="hidden text-center p-12 bg-white rounded-xl shadow-sm border border-gray-200">
                <i class="fas fa-chart-bar text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-2xl font-semibold text-gray-900">No Strategies Found</h3>
                <p class="mt-2 text-gray-500">Create your first trading strategy to get started.</p>
                <button id="create-strategy-btn" class="mt-6 inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i> Create Strategy
                </button>
            </div>

            <!-- Strategies Grid -->
            <div id="strategies-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Strategy cards will be dynamically inserted here -->
            </div>
        </main>

        <!-- Modals -->

        <!-- Create/Edit Strategy Modal -->
        <div id="strategyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg rounded-xl bg-white transition-transform duration-300 transform scale-95">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-indigo-600 rounded-t-xl">
                    <h3 id="modal-title" class="text-2xl font-bold text-white">Create Strategy</h3>
                    <button id="modal-close-btn" class="text-indigo-200 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="strategyForm" class="p-6">
                    <!-- Section: Strategy Details -->
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="strategy-name" class="block text-sm font-medium text-gray-700 flex items-center">
                                    Strategy Name <span class="text-red-500 ml-1">*</span>
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">A unique name for your strategy.</span>
                                    </span>
                                </label>
                                <input type="text" id="strategy-name" name="strategyName" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., My Trend-Following Strategy">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 flex items-center">
                                    Trading Symbols <span class="text-red-500 ml-1">*</span>
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">The symbols you want to trade. For TradingView alerts, use dynamic mode.</span>
                                    </span>
                                </label>
                                <div class="mt-1 flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <input type="radio" id="singleSymbolMode" name="symbolInputMode" value="single" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                        <label for="singleSymbolMode" class="ml-2 block text-sm font-medium text-gray-700">Single Symbol</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="watchlistMode" name="symbolInputMode" value="watchlist" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                        <label for="watchlistMode" class="ml-2 block text-sm font-medium text-gray-700">Watchlist (TradingView)</label>
                                    </div>
                                </div>
                                <textarea id="trading-symbols" name="tradingSymbols" rows="1" required
                                    class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Enter single symbol, e.g., RELIANCE"></textarea>
                                <p id="symbol-input-help" class="mt-2 text-sm text-gray-500">Enter the trading symbol.</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 mt-6 pt-6 space-y-6">
                        <h4 class="text-xl font-semibold text-gray-800">Order Parameters</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="transaction-type" class="block text-sm font-medium text-gray-700 flex items-center">
                                    Transaction Type <span class="text-red-500 ml-1">*</span>
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">Whether to place a BUY or SELL order.</span>
                                    </span>
                                </label>
                                <select id="transaction-type" name="transactionType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>
                            <div>
                                <label for="order-type" class="block text-sm font-medium text-gray-700 flex items-center">
                                    Order Type <span class="text-red-500 ml-1">*</span>
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">MARKET orders execute at the best available price. LIMIT orders execute at a specified price or better.</span>
                                    </span>
                                </label>
                                <select id="order-type" name="orderType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="market">MARKET</option>
                                    <option value="limit">LIMIT</option>
                                </select>
                            </div>
                            <div>
                                <label for="product-type" class="block text-sm font-medium text-gray-700 flex items-center">
                                    Product Type <span class="text-red-500 ml-1">*</span>
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">INTRADAY orders must be squared off on the same day. CNC/long-term orders are for holding.</span>
                                    </span>
                                </label>
                                <select id="product-type" name="productType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="intraday">INTRADAY</option>
                                    <option value="cnc">CNC</option>
                                </select>
                            </div>
                            <div>
                                <label for="order-qty" class="block text-sm font-medium text-gray-700 flex items-center">
                                    Order Quantity
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">The number of shares or lots to trade. Leave empty if specifying Order Value.</span>
                                    </span>
                                </label>
                                <input type="number" id="order-qty" name="orderQty" min="1"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 10">
                            </div>
                            <div>
                                <label for="order-value" class="block text-sm font-medium text-gray-700 flex items-center">
                                    Order Value
                                    <span class="tooltip-container">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-box">The total monetary value of the order. Quantity will be auto-calculated.</span>
                                    </span>
                                </label>
                                <input type="number" id="order-value" name="orderValue" min="1" step="0.01"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 5000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 mt-6 pt-6">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Webhook Payload Preview</h4>
                        <div>
                            <label for="webhook-preview" class="block text-sm font-medium text-gray-700 flex items-center">
                                Generated JSON Payload
                                <span class="tooltip-container">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-box">The JSON payload that will be sent with your webhook.</span>
                                </span>
                            </label>
                            <textarea id="webhook-preview" rows="5" readonly
                                class="mt-1 block w-full rounded-md bg-gray-100 border-gray-300 shadow-sm resize-none"></textarea>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="form-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                            Cancel
                        </button>
                        <button type="submit" id="form-submit-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                            Save Strategy
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Payload Modal -->
        <div id="payloadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-xl bg-white transition-transform duration-300 transform scale-95">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-indigo-600 rounded-t-xl">
                    <h3 class="text-2xl font-bold text-white">Strategy Webhook</h3>
                    <button id="payload-modal-close-btn" class="text-indigo-200 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 mt-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Webhook URL</label>
                        <div class="flex">
                            <input id="payload-webhook" type="text" readonly class="flex-1 rounded-l-lg border-gray-300 bg-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <button id="copy-webhook-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-r-lg hover:bg-gray-300 transition-colors duration-200" title="Copy URL">
                                <i class="fas fa-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">JSON Payload</label>
                        <div class="flex">
                            <textarea id="payload-json" rows="5" readonly class="flex-1 rounded-l-lg border-gray-300 bg-gray-100 shadow-sm resize-none"></textarea>
                            <button id="copy-payload-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-r-lg hover:bg-gray-300 transition-colors duration-200" title="Copy Payload">
                                <i class="fas fa-clipboard"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Alert/Confirmation Modal -->
        <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-[100]">
            <div class="bg-white p-6 rounded-lg shadow-xl w-80">
                <h4 id="customAlertTitle" class="text-lg font-bold"></h4>
                <p id="customAlertMessage" class="mt-2 text-sm text-gray-700"></p>
                <div class="mt-4 text-right">
                    <button id="customAlertConfirmBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors duration-200 hidden">Confirm</button>
                    <button id="customAlertCancelBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-200 ml-2">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration and Initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        // UI Elements
        const createStrategyBtn = document.getElementById('create-strategy-btn');
        const createStrategyBtnAlt = document.getElementById('create-strategy-btn-alt');
        const strategiesGrid = document.getElementById('strategies-grid');
        const noStrategiesState = document.getElementById('no-strategies-state');
        const loadingState = document.getElementById('loading-state');
        const userIdDisplay = document.getElementById('user-id');

        // Modals
        const strategyModal = document.getElementById('strategyModal');
        const payloadModal = document.getElementById('payloadModal');
        const modalTitle = document.getElementById('modal-title');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const payloadModalCloseBtn = document.getElementById('payload-modal-close-btn');
        
        // Forms
        const strategyForm = document.getElementById('strategyForm');
        const formCancelBtn = document.getElementById('form-cancel-btn');
        const formSubmitBtn = document.getElementById('form-submit-btn');
        const payloadWebhook = document.getElementById('payload-webhook');
        const payloadJson = document.getElementById('payload-json');
        const copyWebhookBtn = document.getElementById('copy-webhook-btn');
        const copyPayloadBtn = document.getElementById('copy-payload-btn');

        // Form Fields with Tooltips
        const strategyNameInput = document.getElementById('strategy-name');
        const singleSymbolModeRadio = document.getElementById('singleSymbolMode');
        const watchlistModeRadio = document.getElementById('watchlistMode');
        const tradingSymbolsTextarea = document.getElementById('trading-symbols');
        const symbolInputHelp = document.getElementById('symbol-input-help');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const orderTypeSelect = document.getElementById('order-type');
        const productTypeSelect = document.getElementById('product-type');
        const orderQtyInput = document.getElementById('order-qty');
        const orderValueInput = document.getElementById('order-value');
        const webhookPreviewTextarea = document.getElementById('webhook-preview');

        // Custom Alert UI
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertConfirmBtn = document.getElementById('customAlertConfirmBtn');
        const customAlertCancelBtn = document.getElementById('customAlertCancelBtn');

        let editingId = null;

        // Custom alert and confirmation box
        function showCustomAlert(title, message, isConfirm = false) {
            return new Promise((resolve) => {
                customAlertTitle.textContent = title;
                customAlertMessage.textContent = message;
                customAlertConfirmBtn.style.display = isConfirm ? 'inline-block' : 'none';
                customAlertModal.classList.remove('hidden');

                const onConfirm = () => {
                    customAlertModal.classList.add('hidden');
                    customAlertConfirmBtn.removeEventListener('click', onConfirm);
                    customAlertCancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };
                const onCancel = () => {
                    customAlertModal.classList.add('hidden');
                    customAlertConfirmBtn.removeEventListener('click', onConfirm);
                    customAlertCancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                customAlertConfirmBtn.addEventListener('click', onConfirm);
                customAlertCancelBtn.addEventListener('click', onCancel);
            });
        }

        // Helper for copying text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCustomAlert('Success', 'Copied to clipboard!');
            } catch (err) {
                showCustomAlert('Error', 'Failed to copy text.');
            }
            document.body.removeChild(textarea);
        }

        // Functions to show/hide modals
        const showModal = (modal) => modal.classList.remove('hidden');
        const hideModal = (modal) => modal.classList.add('hidden');

        // Event Listeners for modals
        modalCloseBtn.addEventListener('click', () => hideModal(strategyModal));
        formCancelBtn.addEventListener('click', () => hideModal(strategyModal));
        payloadModalCloseBtn.addEventListener('click', () => hideModal(payloadModal));

        // Event listener for opening create strategy modal
        createStrategyBtn && createStrategyBtn.addEventListener('click', () => { resetForm(); showModal(strategyModal); });
        createStrategyBtnAlt && createStrategyBtnAlt.addEventListener('click', () => { resetForm(); showModal(strategyModal); });

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    userId = user.uid;
                } else {
                    await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
                    userId = auth.currentUser.uid;
                }
                isAuthReady = true;
                userIdDisplay.textContent = userId;
                // Set up real-time listener for strategies
                setupStrategiesListener();
            } catch (error) {
                console.error("Authentication Error:", error);
                loadingState.classList.add('hidden');
                noStrategiesState.classList.remove('hidden');
                noStrategiesState.innerHTML = `<h3 class="text-2xl font-semibold text-red-500">Authentication Error</h3><p class="mt-2 text-gray-500">Could not authenticate. Please try again.</p>`;
            }
        });

        // Real-time listener for strategies
        function setupStrategiesListener() {
            if (!isAuthReady || !userId) return;
            
            const strategiesColRef = collection(db, `artifacts/${appId}/users/${userId}/strategies`);
            
            onSnapshot(strategiesColRef, (snapshot) => {
                loadingState.classList.add('hidden');
                const strategies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStrategies(strategies);
            }, (error) => {
                console.error("Error fetching strategies: ", error);
                loadingState.classList.add('hidden');
                strategiesGrid.classList.add('hidden');
                noStrategiesState.classList.remove('hidden');
                noStrategiesState.innerHTML = `<h3 class="text-2xl font-semibold text-red-500">Error</h3><p class="mt-2 text-gray-500">Failed to load strategies.</p>`;
            });
        }
        
        // Render strategy cards
        function renderStrategies(strategies) {
            strategiesGrid.innerHTML = '';
            if (strategies.length === 0) {
                strategiesGrid.classList.add('hidden');
                noStrategiesState.classList.remove('hidden');
            } else {
                noStrategiesState.classList.add('hidden');
                strategiesGrid.classList.remove('hidden');
                strategies.forEach(s => {
                    const status = s.isActive ? 'Active' : 'Inactive';
                    const statusColor = s.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                    const toggleIcon = s.isActive ? 'fas fa-pause-circle' : 'fas fa-play-circle';
                    const toggleText = s.isActive ? 'Deactivate' : 'Activate';
                    
                    const cardHtml = `
                        <div class="bg-white p-6 rounded-xl shadow-md flex flex-col transition-transform hover:scale-[1.02] duration-200">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h4 class="text-xl font-bold text-gray-900">${s.name}</h4>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">${status}</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="text-gray-500 hover:text-indigo-600 transition-colors" onclick="handleEdit('${s.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-red-500 hover:text-red-700 transition-colors" onclick="handleDelete('${s.id}')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-auto flex flex-col sm:flex-row sm:items-center justify-between space-y-3 sm:space-y-0 sm:space-x-3 mt-6">
                                <button class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors" onclick="handleWebhookPayload('${s.id}', '${s.webhookSecret}')">
                                    <i class="fas fa-link mr-2"></i> Webhook
                                </button>
                                <button class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" onclick="handleToggleStatus('${s.id}', ${s.isActive})">
                                    <i class="${toggleIcon} mr-2"></i> ${toggleText}
                                </button>
                            </div>
                        </div>
                    `;
                    strategiesGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
        }

        // Form logic
        function updateSymbolInputMode() {
            if (singleSymbolModeRadio.checked) {
                tradingSymbolsTextarea.placeholder = "Enter single symbol, e.g., RELIANCE";
                tradingSymbolsTextarea.disabled = false;
                symbolInputHelp.textContent = "Enter the trading symbol.";
                // Clear any dynamic placeholder text if switching from watchlist mode
                if (tradingSymbolsTextarea.value.includes('{{ticker}}')) {
                    tradingSymbolsTextarea.value = '';
                }
            } else {
                tradingSymbolsTextarea.placeholder = "Symbols will be dynamically provided by TradingView ({{ticker}})";
                tradingSymbolsTextarea.value = '{{ticker}}'; // Set placeholder text as value for preview
                tradingSymbolsTextarea.disabled = true;
                symbolInputHelp.textContent = "For TradingView alerts, symbols will be passed dynamically.";
            }
            updateWebhookPreview();
        }
        
        singleSymbolModeRadio.addEventListener('change', updateSymbolInputMode);
        watchlistModeRadio.addEventListener('change', updateSymbolInputMode);
        
        function updateWebhookPreview() {
            const previewPayload = {
                strategyName: strategyNameInput.value,
                transactionType: transactionTypeSelect.value,
                orderType: orderTypeSelect.value,
                productType: productTypeSelect.value,
                tradingSymbols: singleSymbolModeRadio.checked ? (tradingSymbolsTextarea.value ? [tradingSymbolsTextarea.value] : []) : ['{{ticker}}']
            };
            if (orderQtyInput.value) {
                previewPayload.orderQty = parseFloat(orderQtyInput.value);
            }
            if (orderValueInput.value) {
                previewPayload.orderValue = parseFloat(orderValueInput.value);
            }
            webhookPreviewTextarea.value = JSON.stringify(previewPayload, null, 2);
        }

        // Add event listeners to form inputs to update preview
        strategyForm.addEventListener('input', updateWebhookPreview);

        function resetForm() {
            editingId = null;
            strategyForm.reset();
            updateSymbolInputMode();
            modalTitle.textContent = 'Create Strategy';
            formSubmitBtn.textContent = 'Save Strategy';
            orderQtyInput.disabled = false;
            orderValueInput.disabled = false;
            updateWebhookPreview();
        }

        // Handle quantity/value input interdependence
        orderQtyInput.addEventListener('input', () => {
            orderValueInput.disabled = !!orderQtyInput.value;
        });
        orderValueInput.addEventListener('input', () => {
            orderQtyInput.disabled = !!orderValueInput.value;
        });

        // Form submission handler
        strategyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = strategyNameInput.value.trim();
            const webhookSecret = editingId ? null : crypto.randomUUID(); // Generate new secret only for new strategies

            const strategyData = {
                name: name,
                transactionType: transactionTypeSelect.value,
                orderType: orderTypeSelect.value,
                productType: productTypeSelect.value,
                isActive: editingId ? false : true, // New strategies are active by default
                tradingSymbols: singleSymbolModeRadio.checked ? tradingSymbolsTextarea.value : '__WATCHLIST_DYNAMIC__',
                webhookSecret: webhookSecret,
                webhookPayload: JSON.parse(webhookPreviewTextarea.value) // Store the generated payload
            };
            if (orderQtyInput.value) {
                strategyData.orderQty = parseFloat(orderQtyInput.value);
            }
            if (orderValueInput.value) {
                strategyData.orderValue = parseFloat(orderValueInput.value);
            }

            try {
                if (editingId) {
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/strategies`, editingId), strategyData);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/strategies`), strategyData);
                }
                hideModal(strategyModal);
                resetForm();
            } catch (error) {
                console.error("Error saving strategy:", error);
                showCustomAlert('Error', 'Failed to save strategy. Please try again.');
            }
        });
        
        // Global functions for card actions
        window.handleEdit = async (id) => {
            if (!isAuthReady || !userId) {
                showCustomAlert('Error', 'Authentication not ready. Please wait.');
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/strategies`, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editingId = id;
                    modalTitle.textContent = 'Edit Strategy';
                    formSubmitBtn.textContent = 'Update Strategy';
                    strategyNameInput.value = data.name;
                    transactionTypeSelect.value = data.transactionType;
                    orderTypeSelect.value = data.orderType;
                    productTypeSelect.value = data.productType;

                    if (data.tradingSymbols === '__WATCHLIST_DYNAMIC__') {
                        watchlistModeRadio.checked = true;
                    } else {
                        singleSymbolModeRadio.checked = true;
                        tradingSymbolsTextarea.value = data.tradingSymbols || '';
                    }
                    updateSymbolInputMode();

                    orderQtyInput.value = data.orderQty || '';
                    orderValueInput.value = data.orderValue || '';
                    orderQtyInput.disabled = !!data.orderValue;
                    orderValueInput.disabled = !!data.orderQty;

                    updateWebhookPreview();
                    showModal(strategyModal);
                } else {
                    showCustomAlert('Error', 'Strategy not found.');
                }
            } catch (error) {
                console.error("Error fetching strategy for edit:", error);
                showCustomAlert('Error', 'Failed to load strategy details.');
            }
        };

        window.handleDelete = async (id) => {
            const confirmed = await showCustomAlert('Confirm Deletion', 'Are you sure you want to delete this strategy? This action cannot be undone.', true);
            if (confirmed && isAuthReady && userId) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/strategies`, id));
                } catch (error) {
                    console.error("Error deleting strategy:", error);
                    showCustomAlert('Error', 'Failed to delete strategy.');
                }
            }
        };

        window.handleToggleStatus = async (id, currentStatus) => {
            if (!isAuthReady || !userId) return;
            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/strategies`, id), {
                    isActive: !currentStatus
                });
            } catch (error) {
                console.error("Error toggling strategy status:", error);
                showCustomAlert('Error', 'Failed to change strategy status.');
            }
        };

        window.handleWebhookPayload = async (id, secret) => {
            if (!isAuthReady || !userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/strategies`, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const webhookUrl = `${window.location.origin}/webhook/${userId}/${id}?secret=${encodeURIComponent(secret)}`;
                payloadWebhook.value = webhookUrl;
                payloadJson.value = JSON.stringify(data.webhookPayload, null, 2);
                showModal(payloadModal);
            }
        };

        // Clipboard copy functionality
        copyWebhookBtn.addEventListener('click', () => copyToClipboard(payloadWebhook.value));
        copyPayloadBtn.addEventListener('click', () => copyToClipboard(payloadJson.value));

        // Initial setup for form
        updateSymbolInputMode();
    </script>
{% endblock %}
