{% extends "layout.html" %}
{% block title %}Dashboard Summary - DhanBot{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .summary-dashboard {
    --summary-bg: #f5f7fb;
    --summary-card: #ffffff;
    --summary-border: #e6e9f2;
    --summary-text: #111827;
    --summary-muted: #6b7280;
    --summary-primary: #4f46e5;
    --summary-green: #059669;
    --summary-red: #dc2626;
    --summary-purple: #7c3aed;
    --summary-blue: #2563eb;
    color: var(--summary-text);
    background: var(--summary-bg);
    border-radius: 24px;
    box-shadow: inset 0 0 0 1px rgba(230, 233, 242, 0.45);
    padding: clamp(32px, 4vw, 48px) clamp(20px, 4vw, 32px);
  }

  .summary-dashboard .summary-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: clamp(24px, 4vw, 32px);
  }

  .summary-grid {
    display: grid;
    gap: 24px;
  }

  .summary-grid-4 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }

  .summary-grid-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .summary-grid-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  @media (max-width: 1280px) {
    .summary-grid-4 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (max-width: 768px) {
    .summary-dashboard {
      border-radius: 20px;
      padding: 28px 20px;
    }

    .summary-grid-3,
    .summary-grid-2,
    .summary-grid-4 {
      grid-template-columns: 1fr;
    }
  }

  .summary-card,
  .summary-card--muted {
    background: var(--summary-card);
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: clamp(20px, 3vw, 24px);
    box-shadow: 0 2px 10px rgba(28, 31, 43, 0.03);
  }

  .summary-card--muted {
    background: #f3f4f7;
    border: none;
    box-shadow: none;
    text-align: center;
  }

  .summary-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--summary-border);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    cursor: pointer;
    background: #ffffff;
    color: var(--summary-muted);
    user-select: none;
  }

  .summary-chip.is-active {
    background: rgba(79, 70, 229, 0.08);
    border-color: #dfe2f7;
    color: var(--summary-primary);
  }

  .summary-progress {
    height: 8px;
    border-radius: 999px;
    background: #eef2ff;
    position: relative;
    overflow: hidden;
  }

  .summary-progress > span {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    border-radius: inherit;
  }

  .summary-table {
    width: 100%;
    border-collapse: collapse;
  }

  .summary-table th,
  .summary-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #f1f3f8;
  }

  .summary-table thead th {
    font-weight: 600;
    color: var(--summary-muted);
    text-align: left;
  }

  .summary-table tbody tr:last-child td {
    border-bottom: none;
  }

  .summary-header {
    background: var(--summary-card);
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: clamp(24px, 4vw, 28px) clamp(20px, 4vw, 32px);
    box-shadow: 0 2px 10px rgba(28, 31, 43, 0.03);
  }

  .summary-header h1 {
    font-size: clamp(26px, 3vw, 32px);
    font-weight: 800;
    letter-spacing: -0.3px;
    margin: 0;
  }

  .summary-header p {
    margin: 8px 0 0 0;
    color: var(--summary-muted);
    font-size: clamp(14px, 2.4vw, 16px);
  }

  .summary-section-title {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  .summary-section-title h2 {
    font-size: 20px;
    font-weight: 800;
    margin: 0;
  }

  .summary-section-title a {
    text-decoration: none;
    color: var(--summary-primary);
    font-weight: 600;
    font-size: 14px;
  }

  .summary-card-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .summary-card-label {
    margin: 0;
    color: var(--summary-muted);
    font-size: 14px;
  }

  .summary-stat-value {
    margin: 0;
    font-size: clamp(26px, 3vw, 32px);
    font-weight: 800;
    letter-spacing: -0.4px;
  }

  .summary-stat-positive {
    color: var(--summary-green);
  }

  .summary-stat-negative {
    color: var(--summary-red);
  }

  .summary-transaction {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .summary-transaction + .summary-transaction {
    margin-top: 14px;
  }

  .summary-transaction .info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0;
  }

  .summary-pill {
    border: 1px solid var(--summary-border);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
    background: #f1f4f8;
    font-weight: 600;
    text-transform: uppercase;
  }

  .summary-pill.summary-pill--sell {
    border-color: #fad1d1;
    color: var(--summary-red);
    background: #fff5f5;
  }

  .summary-pill.summary-pill--dividend {
    background: #ffffff;
  }

  .summary-value {
    margin: 0;
    font-weight: 700;
    white-space: nowrap;
  }

  .summary-stat-footnote {
    margin: 6px 0 0 0;
    font-size: 12px;
    color: var(--summary-muted);
  }
</style>
{% endblock %}

{% block content %}
<div class="summary-dashboard">
  <div class="summary-inner">
    <section class="summary-header">
      <div style="display:flex; align-items:flex-start; justify-content:space-between;">
        <div>
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
            <div style="width:28px; height:28px; border-radius:8px; background:#eef2ff; display:flex; align-items:center; justify-content:center;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--summary-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="14" width="7" height="7" rx="2"></rect>
                <rect x="3" y="14" width="7" height="7" rx="2"></rect>
              </svg>
            </div>
            <h1>Dashboard Summary</h1>
          </div>
          <p>Overview of your trading activities and account performance.</p>
        </div>
      </div>
    </section>

    <section class="summary-grid summary-grid-4">
      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Portfolio Value</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 7H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h15a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"></path>
              <path d="M16 3H7a2 2 0 0 0-2 2v2"></path>
              <path d="M20 11h-6a2 2 0 0 0 0 4h6"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_portfolio_value) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Investment</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(124,58,237,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M6 3h12"></path>
              <path d="M6 8h12"></path>
              <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_investment) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set gain_positive = overview.total_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if gain_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.total_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.total_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.total_gain_loss_percent) }}
        </p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Today's Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set today_positive = overview.today_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if today_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.today_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.today_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.today_gain_loss_percent) }}
        </p>
      </div>
    </section>

    <section>
      <div class="summary-section-title">
        <h2>Account Summary</h2>
        <a href="/account-config">Manage Accounts</a>
      </div>
      <div class="summary-grid summary-grid-3">
        {% set account_palette = [
          {'bg': 'rgba(234,88,12,0.10)', 'stroke': '#EA580C'},
          {'bg': 'rgba(37,99,235,0.10)', 'stroke': 'var(--summary-blue)'},
          {'bg': 'rgba(124,58,237,0.10)', 'stroke': 'var(--summary-purple)'}
        ] %}
        {% if account_summaries %}
          {% for account in account_summaries %}
            {% set palette = account_palette[loop.index0 % (account_palette|length)] %}
            <div class="summary-card">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:40px; height:40px; border-radius:10px; background:{{ palette.bg }}; display:flex; align-items:center; justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="{{ palette.stroke }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                  </div>
                  <div>
                    <p style="margin:0; font-weight:700;">{{ account.broker or 'Account' }}</p>
                    <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ account.client_id }}</p>
                  </div>
                </div>
                <span style="background:rgba(5,150,105,0.10); color:{{ account.status_color }}; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600;">{{ account.status_label }}</span>
              </div>
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; justify-content:space-between; font-size:14px;">
                  <span style="color:var(--summary-muted)">Portfolio Value</span>
                  <span style="font-weight:700;">{{ format_currency(account.portfolio_value) }}</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:14px;">
                  <span style="color:var(--summary-muted)">Gain/Loss</span>
                  {% set account_positive = account.gain_loss >= 0 %}
                  <span style="font-weight:700; color:{{ 'var(--summary-green)' if account_positive else 'var(--summary-red)' }};">
                    {{ format_currency(account.gain_loss) }}
                    <span style="font-size:11px; margin-left:4px;">{{ format_percentage(account.gain_loss_percent) }}</span>
                  </span>
                </div>
                {% if account.error %}
                  <p class="summary-stat-footnote" style="color:var(--summary-red);">{{ account.error }}</p>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="summary-card summary-card--muted" style="grid-column:1/-1;">
            <p style="margin:0; font-weight:600;">No connected accounts</p>
            <p class="summary-stat-footnote" style="margin-top:6px;">Connect a broker account to view portfolio insights.</p>
          </div>
        {% endif %}
      </div>
    </section>

    <section class="summary-card">
      <div style="display:flex; flex-direction:column; gap:16px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:20px; font-weight:800;">Portfolio Performance</h2>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          <span class="summary-chip is-active">1D</span>
          <span class="summary-chip">1W</span>
          <span class="summary-chip">1M</span>
          <span class="summary-chip">3M</span>
          <span class="summary-chip">6M</span>
          <span class="summary-chip">1Y</span>
          <span class="summary-chip">All</span>
        </div>
      </div>

      <div style="margin:8px 0 16px 0;">
        <div style="display:flex; align-items:baseline; gap:8px; margin-bottom:2px;">
          <p style="margin:0; font-size:28px; font-weight:800;">{{ format_percentage(performance_summary.today_return_percent) }}</p>
          {% set benchmark_delta = performance_summary.today_return_percent - performance_summary.benchmark_return_percent %}
          {% set delta_positive = benchmark_delta >= 0 %}
          <span style="display:inline-flex; align-items:center; gap:6px; color:{{ 'var(--summary-green)' if delta_positive else 'var(--summary-red)' }}; font-size:13px;">
            {% if delta_positive %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
              </svg>
            {% else %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="1 6 10.5 15.5 15.5 10.5 23 18"></polyline>
                <polyline points="7 18 1 18 1 12"></polyline>
              </svg>
            {% endif %}
            {{ format_percentage(benchmark_delta) }} vs benchmark
          </span>
        </div>
        <p style="margin:0; color:var(--summary-muted); font-size:12px;">Portfolio return for 1D (benchmark {{ format_percentage(performance_summary.benchmark_return_percent) }})</p>
      </div>

      <div style="height:240px; border:1px dashed var(--summary-border); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--summary-muted); margin:0 0 18px 0;">
        Inline chart placeholder (use your existing Recharts block here)
      </div>

      <div class="summary-grid summary-grid-3" style="gap:12px;">
        {% for period in performance_summary.periods %}
          {% set period_color = period.color if period.value >= 0 else 'var(--summary-red)' %}
          <div class="summary-card--muted">
            <p style="margin:0; font-size:22px; font-weight:800; color:{{ period_color }};">{{ format_percentage(period.value) }}</p>
            <p style="margin:4px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ period.label }}</p>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="summary-grid summary-grid-2">
      <div class="summary-card">
        <div class="summary-section-title" style="margin-bottom:12px;">
          <h2>Top Holdings</h2>
          <a href="#">View All</a>
        </div>
        <div style="overflow-x:auto;">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Stock</th>
                <th style="text-align:right">Qty</th>
                <th style="text-align:right">Value</th>
                <th style="text-align:right">P&amp;L</th>
              </tr>
            </thead>
            <tbody>
              {% if top_holdings %}
                {% for holding in top_holdings %}
                  {% set pnl_positive = holding.pnl >= 0 %}
                  <tr>
                    <td>
                      <div>
                        <p style="margin:0; font-weight:700;">{{ holding.symbol }}</p>
                        <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ holding.sector or '—' }}</p>
                      </div>
                    </td>
                    <td style="text-align:right">{{ format_quantity(holding.quantity) }}</td>
                    <td style="text-align:right; font-weight:700;">{{ format_currency(holding.market_value) }}</td>
                    <td style="text-align:right;">
                      <span style="color:{{ 'var(--summary-green)' if pnl_positive else 'var(--summary-red)' }}; font-weight:700;">{{ format_currency(holding.pnl) }}</span>
                      <p style="margin:2px 0 0 0; color:{{ 'var(--summary-green)' if pnl_positive else 'var(--summary-red)' }}; font-size:12px;">{{ format_percentage(holding.pnl_percent) }}</p>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4" style="text-align:center; padding:24px 8px; color:var(--summary-muted);">
                    No holdings available. Connect an account or refresh your positions.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-section-title" style="margin-bottom:12px;">
          <h2>Sector Allocation</h2>
          <a href="#">View Details</a>
        </div>

        {% if sector_allocation %}
          {% for sector in sector_allocation %}
            <div style="margin-bottom:14px;">
              <div style="display:flex; align-items:center; justify-content:space-between; font-size:14px; margin-bottom:6px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="width:12px; height:12px; border-radius:999px; background:{{ sector.color }}; display:inline-block"></span>
                  <span>{{ sector.label }}</span>
                </div>
                <span style="font-weight:700;">{{ format_percentage(sector.percent) }}</span>
              </div>
              <div class="summary-progress"><span style="width:{{ sector.percent }}%; background:{{ sector.color }};"></span></div>
              <p class="summary-stat-footnote" style="margin:6px 0 0 0;">{{ format_currency(sector.amount) }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="summary-stat-footnote" style="margin:0;">No sector allocation data available.</p>
        {% endif %}
      </div>
    </section>

    <section class="summary-card">
      <div class="summary-section-title" style="margin-bottom:12px;">
        <h2>Recent Transactions</h2>
        <a href="#">View All</a>
      </div>

      <div>
        {% if recent_transactions %}
          {% for txn in recent_transactions %}
            {% set action = txn.action or '' %}
            {% set is_buy = action == 'BUY' %}
            {% set is_sell = action == 'SELL' %}
            {% set is_dividend = not is_buy and not is_sell %}
            {% set icon_bg = 'rgba(5,150,105,0.10)' if is_buy else ('rgba(220,38,38,0.10)' if is_sell else 'rgba(37,99,235,0.10)') %}
            {% set icon_color = 'var(--summary-green)' if is_buy else ('var(--summary-red)' if is_sell else 'var(--summary-blue)') %}
            <div class="summary-transaction">
              <div class="info">
                <div style="width:40px; height:40px; border-radius:999px; background:{{ icon_bg }}; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                  {% if is_sell %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="17" x2="17" y2="7"></line>
                      <polyline points="7 7 17 7 17 17"></polyline>
                    </svg>
                  {% elif is_buy %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="7" x2="17" y2="17"></line>
                      <polyline points="17 7 17 17 7 17"></polyline>
                    </svg>
                  {% else %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M6 3h12"></path>
                      <path d="M6 8h12"></path>
                      <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
                    </svg>
                  {% endif %}
                </div>
                <div style="min-width:0;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <p style="margin:0; font-weight:700;">{{ txn.symbol or '—' }}</p>
                    {% set pill_class = 'summary-pill summary-pill--sell' if is_sell else ('summary-pill summary-pill--dividend' if is_dividend else 'summary-pill') %}
                    <span class="{{ pill_class }}">{{ action.title() if action else 'Trade' }}</span>
                  </div>
                  <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ format_quantity(txn.quantity) }} shares @ {{ format_currency(txn.price) }} • {{ txn.broker or '—' }}
                  </p>
                </div>
              </div>
              <p class="summary-value">{{ format_currency(txn.value) }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="summary-stat-footnote" style="margin:0;">No recent transactions found.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>
{% endblock %}
