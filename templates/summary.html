
{% extends "layout.html" %}
{% block title %}Dashboard Summary - DhanBot{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .summary-dashboard {
    --summary-bg: #f5f7fb;
    --summary-card: #ffffff;
    --summary-border: #e6e9f2;
    --summary-text: #111827;
    --summary-muted: #6b7280;
    --summary-primary: #4f46e5;
    --summary-green: #059669;
    --summary-red: #dc2626;
    --summary-purple: #7c3aed;
    --summary-blue: #2563eb;
  
    color: var(--summary-text);
    background: var(--summary-bg);
    border-radius: 24px;
    box-shadow: inset 0 0 0 1px rgba(230, 233, 242, 0.45);
    padding: clamp(32px, 4vw, 48px) clamp(20px, 4vw, 32px);
  }
  
  .summary-dashboard .summary-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: clamp(24px, 4vw, 32px);
  }
  
  /* base grid helper */
  .summary-grid {
    display: grid;
    gap: 24px;
  }
  
  /* === TOP METRIC CARDS ROW (4 cards, like screenshot) === */
  .summary-grid-4 {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 24px;
  }
  
  /* each top stat card */
  .summary-grid-4 .summary-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(17,24,39,0.04);
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
  
  /* top row in each card:
     "Total Portfolio Value" on left
     icon badge on right */
  .summary-grid-4 .summary-card-title {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin-bottom: 16px;
    gap: 12px;
   
  }
  
  /* label text in card header */
  .summary-grid-4 .summary-card-label {
    margin: 0;
    font-size: 13px;
    line-height: 1.4;
    font-weight: 500;
    color: #4b5563; /* grey-600 like screenshot */
    flex: 1;  
  }
  
  /* icon badge on right of header */
  .summary-grid-4 .summary-card-title > div {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    /* background color for each card is still inline in HTML */
  }
  .summary-grid-4 .summary-card-title svg {
    width: 20px;
    height: 20px;
    stroke-width: 2;
  }
  
  /* big rupee amount */
  .summary-grid-4 .summary-stat-value {
    margin: 0;
    font-size: 28px;
    line-height: 1.2;
    font-weight: 800;
    letter-spacing: -0.03em;
    color: #111827;
  }
  
  /* green/red amount override for gain/loss cards */
  .summary-grid-4 .summary-stat-value.summary-stat-positive {
    color: #059669; /* green-600 */
  }
  .summary-grid-4 .summary-stat-value.summary-stat-negative {
    color: #dc2626; /* red-600 */
  }
  
  /* footnote under number (like "+16.23%") */
  .summary-grid-4 .summary-stat-footnote {
    margin-top: 8px;
    font-size: 14px;
    line-height: 1.3;
    font-weight: 500;
    color: #059669;
  }
  .summary-grid-4 .summary-stat-footnote.summary-stat-negative {
    color: #dc2626;
  }
  
  /* other grid groups below summary cards */
  .summary-grid-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  .summary-grid-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  .summary-period-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    align-items: stretch;
  }
  .summary-period-grid .summary-card--muted {
    text-align: center;
}
  .top-holdings-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .top-holdings-controls #top-holdings-toggle {
    margin-left: auto;
    font-size: 12px;
    font-weight: 600;
    color: var(--summary-blue);
    text-decoration: none;
  }

  .top-holdings-controls #top-holdings-toggle:hover {
    text-decoration: underline;
  }

  .top-holdings-filter {
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  .top-holdings-filter__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    color: var(--summary-muted);
  }

  .top-holdings-filter__icon svg {
    width: 16px;
    height: 16px;
  }

  .top-holdings-filter__label {
    font-size: 12px;
    font-weight: 600;
    color: var(--summary-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .top-holdings-filter__control {
    position: relative;
    display: inline-flex;
    align-items: center;
  }

  .top-holdings-filter__select {
    appearance: none;
    border: 1px solid #e5e7eb;
    border-radius: 999px;
    background-color: #f9fafb;
    color: #111827;
    font-size: 13px;
    font-weight: 600;
    line-height: 1.2;
    padding: 8px 40px 8px 16px;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
  }

  .top-holdings-filter__control::after {
    content: "";
    position: absolute;
    right: 16px;
    width: 10px;
    height: 6px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='none' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' d='M1 1l4 4 4-4'/%3E%3C/svg%3E")
      no-repeat center center / contain;
    pointer-events: none;
  }

  .top-holdings-filter__select:hover {
    border-color: #d1d5db;
    background-color: #ffffff;
  }

  .top-holdings-filter__select:focus {
    outline: none;
    border-color: var(--summary-blue);
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
  }

  @media (max-width: 640px) {
    .top-holdings-controls {
      flex-direction: column;
      align-items: flex-start;
    }

    .top-holdings-controls #top-holdings-toggle {
      margin-left: 0;
    }
  }

  /* === TOP HOLDINGS TABLE & CARD VIEW === */
  .top-holdings-surface {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  .top-holdings-table-container {
    display: block;
    overflow-x: auto;
  }

  .top-holdings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    line-height: 1.4;
    color: #1f2937;
  }

  .top-holdings-table thead th {
    padding: 10px 12px;
    font-weight: 500;
    color: #6b7280;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
  }

  .top-holdings-table thead th:nth-child(n + 4) {
    text-align: right;
  }

  .top-holdings-table thead th:nth-child(2),
  .top-holdings-table thead th:nth-child(3),
  .top-holdings-table tbody td:nth-child(2),
  .top-holdings-table tbody td:nth-child(3),
  .top-holdings-table tbody td:last-child {
    text-align: center;
  }

  .top-holdings-table thead th:last-child {
    text-align: center;
  }

  .top-holdings-table tbody td:nth-child(4),
  .top-holdings-table tbody td:nth-child(5),
  .top-holdings-table tbody td:nth-child(6),
  .top-holdings-table tbody td:nth-child(7) {
    text-align: right;
  }

  .top-holdings-table tbody td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    color: #111827;
    vertical-align: middle;
  }

  .top-holdings-table tbody tr:last-child td {
    border-bottom: none;
  }

  .top-holdings-card-list {
    display: none;
    padding: 16px;
    background: linear-gradient(180deg, rgba(243,244,246,0.45), rgba(243,244,246,0));
  }

  .top-holdings-card {
    background: #ffffff;
    border: 1px solid rgba(17, 24, 39, 0.08);
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .top-holdings-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .top-holdings-card__identity {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .top-holdings-card__avatar {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: #f3f4f6;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #111827;
  }

  .top-holdings-card__symbol {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #111827;
  }

  .top-holdings-card__subtitle {
    margin: 4px 0 0 0;
    font-size: 12px;
    color: #6b7280;
  }

  .top-holdings-card__value {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    font-size: 16px;
    font-weight: 700;
    color: #111827;
  }

  .top-holdings-card__value-delta {
    font-size: 12px;
    font-weight: 600;
  }

  .top-holdings-card__value-delta.is-positive {
    color: #16a34a;
  }

  .top-holdings-card__value-delta.is-negative {
    color: #dc2626;
  }

  .top-holdings-card__chips {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .top-holdings-card__chips .top-holdings-card__broker {
    margin-left: auto;
  }

  .top-holdings-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px;
    font-size: 11px;
    font-weight: 600;
    border-radius: 999px;
    background: #f3f4f6;
    color: #374151;
    line-height: 1;
  }

  .top-holdings-chip--product {
    background: #ecfdf5;
    color: #047857;
    border: 1px solid rgba(5, 150, 105, 0.2);
  }

  .top-holdings-card__broker {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: transparent;
  }

  .top-holdings-card__broker img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .top-holdings-card__meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: #4b5563;
  }

  .top-holdings-card__qty {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 6px;
  }

  .top-holdings-card__qty strong {
    color: #111827;
    font-weight: 700;
  }

  .top-holdings-card__ltp {
    font-weight: 600;
    color: #111827;
  }

  @media (max-width: 768px) {
    .top-holdings-surface {
      padding: 0;
      border: none;
      background: transparent;
    }

    .top-holdings-table-container {
      display: none;
    }

    .top-holdings-card-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0;
      background: transparent;
    }
  }

  
  /* responsive:
     tablet/phone -> scroll horizontally for the 4 stat cards,
     but other grids (3-col, 2-col) collapse to single-column */
  @media (max-width: 1024px) {
    .summary-grid-4 {
      grid-auto-flow: column;
      grid-auto-columns: minmax(250px, 1fr);
      grid-template-columns: unset;
      overflow-x: auto;
      padding-bottom: 8px;
    }
  
    .summary-grid-4 .summary-card {
      min-width: 250px;
    }
  
    .summary-grid-4::-webkit-scrollbar {
      height: 6px;
    }
  
    .summary-grid-4::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.15);
      border-radius: 999px;
    }
  
    .summary-grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
  
    .summary-grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
  }
  
  /* dashboard container tweaks on very small screens */
  @media (max-width: 768px) {
    .summary-grid-4 {
      grid-auto-flow: row;
      grid-auto-columns: unset;
      grid-template-columns: 1fr;
      overflow-x: visible;
      padding-bottom: 0;
    }

    .summary-grid-4 .summary-card {
      min-width: 0;
    }

    .summary-dashboard {
      border-radius: 20px;
      padding: 28px 20px;
    }
  }

  @media (max-width: 768px) {
    .summary-period-grid {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
  }
    
  /* === GENERIC CARD STYLES (used in lower sections etc.) === */
  .summary-card,
  .summary-card--muted {
    background: var(--summary-card);
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: clamp(10px, 1vw, 14px);
    box-shadow: 0 2px 10px rgba(28, 31, 43, 0.03);
  }
  
  /* muted card (empty states / small KPI boxes in performance section) */
  .summary-card--muted {
    background: #f3f4f7;
    border: none;
    box-shadow: none;
    text-align: center;
  }
  
  /* === ACCOUNT STATUS BADGES === */
  .summary-account-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: 8px 8px;
    font-size: 10px;
    font-weight: 500;
    color: var(--status-color, var(--summary-muted));
    background: var(--status-background-color, #f8f9fc);
    border-color: var(--status-border-color, var(--summary-border));
  }
  .summary-account-status::before {
    content: "";
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: var(--status-color, currentColor);
  }
  .summary-account-status.summary-account-status--error {
    color: var(--summary-red);
    border-color: rgba(220, 38, 38, 0.24);
    background: rgba(220, 38, 38, 0.08);
  }
  
  /* === LITTLE FILTER CHIPS (1D / 1W / etc.) === */
  .summary-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--summary-border);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    cursor: pointer;
    background: #ffffff;
    color: var(--summary-muted);
    user-select: none;
  }
  .summary-chip.is-active {
    background: rgba(79, 70, 229, 0.08);
    border-color: #dfe2f7;
    color: var(--summary-primary);
  }
  
  /* === PERFORMANCE CHART BOX === */
  .summary-chart-container {
    position: relative;
    height: 240px;
    border: 1px dashed var(--summary-border);
    border-radius: 12px;
    margin: 0 0 18px 0;
    background: var(--summary-card);
    overflow: hidden;
  }
  .summary-chart-skeleton {
    position: absolute;
    inset: 12px;
    border-radius: 10px;
    background: linear-gradient(90deg, #f5f7fb 0%, #eef2ff 50%, #f5f7fb 100%);
    background-size: 200% 100%;
    animation: summary-shimmer 1.4s ease-in-out infinite;
  }
  .summary-chart-skeleton[hidden] {
    display: none;
  }
  @keyframes summary-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  .summary-chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }
  .summary-chart-empty {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--summary-muted);
    font-size: 14px;
    padding: 0 16px;
    background: var(--summary-card);
  }
  .summary-chart-empty[hidden] {
    display: none;
  }
  
  /* === PROGRESS BAR (sector allocation rows) === */
  .summary-progress {
    height: 8px;
    border-radius: 999px;
    background: #eef2ff;
    position: relative;
    overflow: hidden;
  }
  .summary-progress > span {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    border-radius: inherit;
  }
  
  /* === TABLES (Top Holdings) === */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
  }
  .summary-table th,
  .summary-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #f1f3f8;
  }
  .summary-table thead th {
    font-weight: 600;
    color: var(--summary-muted);
    text-align: left;
  }
  .summary-table tbody tr:last-child td {
    border-bottom: none;
  }
  
  /* === HEADER CARD ("Dashboard Summary" block at top) === */
  .summary-header {
    background: var(--summary-card);
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: clamp(24px, 4vw, 28px) clamp(20px, 4vw, 32px);
    box-shadow: 0 2px 10px rgba(28, 31, 43, 0.03);
  }
  .summary-header h1 {
    font-size: clamp(26px, 3vw, 32px);
    font-weight: 800;
    letter-spacing: -0.3px;
    margin: 0;
  }
  .summary-header p {
    margin: 8px 0 0 0;
    color: var(--summary-muted);
    font-size: clamp(14px, 2.4vw, 16px);
  }
  
  /* === SECTION HEADERS ("Account Summary", etc.) === */
  .summary-section-title {
    margin-top: 1px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }
  .summary-section-title h2 {
  
    font-size: 20px;
    font-weight: 800;
    margin: 0;
  }
  .summary-section-title a {
    text-decoration: none;
    color: var(--summary-primary);
    font-weight: 600;
    font-size: 14px;
  }
  
  /* === GENERIC CARD HEADER (used in other cards, e.g. "Top Holdings", etc.) === */
  .summary-card-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .summary-card-label {
    margin: 0;
    color: var(--summary-muted);
    font-size: 14px;
  }
  
  /* === NUMERIC STAT / GENERIC (outside top tiles) === */
  .summary-stat-value {
    margin: 0;
    font-size: clamp(26px, 3vw, 32px);
    font-weight: 800;
    letter-spacing: -0.4px;
  }
  .summary-stat-positive {
    color: var(--summary-green);
  }
  .summary-stat-negative {
    color: var(--summary-red);
  }
  
  /* === RECENT TRANSACTIONS LIST === */
  .summary-transaction {
    margin-top: 20px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(120px, max-content) auto;
    align-items: center;
    gap: 16px;
  }
  .summary-transaction + .summary-transaction {
    margin-top: 14px;
  }
  .summary-transaction .info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0;
  }
  
  .summary-transaction .timestamp {
    font-size: 12px;
    color: var(--summary-muted);
    white-space: nowrap;
    text-align: center;
    justify-self: center;
    min-width: 120px;
  }
  .summary-transaction .timestamp time {
    display: block;
  }
  .summary-pill {
    border: 1px solid var(--summary-border);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
    background: #f1f4f8;
    font-weight: 600;
    text-transform: uppercase;
  }
  .summary-pill.summary-pill--sell {
    border-color: #fad1d1;
    color: var(--summary-red);
    background: #fff5f5;
  }
  .summary-pill.summary-pill--dividend {
    background: #ffffff;
  }
  .summary-value {
    margin: 0;
    font-weight: 700;
    white-space: nowrap;
    justify-self: end;
  }

  @media (max-width: 640px) {
    .summary-transaction {
      grid-template-columns: minmax(0, 1fr);
      row-gap: 8px;
    }
    .summary-transaction .timestamp,
    .summary-value {
      justify-self: flex-start;
      text-align: left;
    }
  }
  
  /* default footnote style (used outside the top 4 cards) */
  .summary-stat-footnote {
    margin: 6px 0 0 0;
    font-size: 12px;
    color: var(--summary-muted);
  }
/* === Account Summary mobile layout === */
@media (max-width: 768px) {
  /* Turn the account summary grid into a vertical list on mobile */
  .summary-section-title + .summary-grid.summary-grid-3 {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
  }

  /* Style each broker card as a full-width tile */
  .summary-section-title + .summary-grid.summary-grid-3 .summary-card {
    width: 100% !important;
    min-width: 0 !important;

    border-radius: 16px !important;
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04) !important;
    padding: 16px 20px !important;
  }

  /* Tweak the small "Connected" pill for mobile look */
  .summary-section-title + .summary-grid.summary-grid-3 .summary-account-status {
    background: rgba(5, 150, 105, 0.1) !important;
    color: #047857 !important;
    border: 1px solid rgba(5, 150, 105, 0.25) !important;
    border-radius: 8px !important;
    padding: 4px 10px !important;
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    line-height: 1.2;
  }
}
  /* Alternative: hard 3 columns, no scroll */
  @media (max-width: 768px) {
    .summary-period-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 12px;
    }
  
    .summary-period-grid .summary-card,
    .summary-period-grid .summary-card--muted {
      min-width: 0; /* allow them to shrink */
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="summary-dashboard">
  <div class="summary-inner">
    <section class="summary-header">
      <div style="display:flex; align-items:flex-start; justify-content:space-between;">
        <div>
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
            <div style="width:28px; height:28px; border-radius:8px; background:#eef2ff; display:flex; align-items:center; justify-content:center;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--summary-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="14" width="7" height="7" rx="2"></rect>
                <rect x="3" y="14" width="7" height="7" rx="2"></rect>
              </svg>
            </div>
            <h1>Dashboard Summary</h1>
          </div>
          <p>Overview of your trading activities and account performance.</p>
        </div>
      </div>
    </section>

    <section class="summary-grid summary-grid-4">
      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Portfolio Value</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 7H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h15a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"></path>
              <path d="M16 3H7a2 2 0 0 0-2 2v2"></path>
              <path d="M20 11h-6a2 2 0 0 0 0 4h6"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_portfolio_value) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Investment</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(124,58,237,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M6 3h12"></path>
              <path d="M6 8h12"></path>
              <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_investment) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set gain_positive = overview.total_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if gain_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.total_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.total_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.total_gain_loss_percent) }}
        </p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Today's Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set today_positive = overview.today_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if today_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.today_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.today_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.today_gain_loss_percent) }}
        </p>
      </div>
    </section>

    <section>
      <div class="summary-section-title">
        <h2>Account Summary</h2>
        <a href="{{ url_for('AddAccount') }}">Manage Accounts</a>
      </div>
      <div class="summary-grid summary-grid-3">
        {% set account_palette = [
          {'bg': 'rgba(234,88,12,0.10)', 'stroke': '#EA580C'},
          {'bg': 'rgba(37,99,235,0.10)', 'stroke': 'var(--summary-blue)'},
          {'bg': 'rgba(124,58,237,0.10)', 'stroke': 'var(--summary-purple)'}
        ] %}
        {% if account_summaries %}
          {% for account in account_summaries %}
            {% set palette = account_palette[loop.index0 % (account_palette|length)] %}
            {% set has_error = account.error %}
            <div class="summary-card">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:16px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:40px; height:40px; border-radius:10px; background:{{ palette.bg }}; display:flex; align-items:center; justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="{{ palette.stroke }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                  </div>
                  <div>
                    <p style="margin:0; font-weight:700;">{{ account.broker or 'Account' }}</p>
                    <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ account.client_id }}</p>
                  </div>
                </div>
                <div
                  class="summary-account-status {{ 'summary-account-status--error' if has_error else 'summary-account-status--ok' }}"
                  style="--status-color: {{ account.status_color }}; --status-background-color: {{ account.status_background_color }}; --status-border-color: {{ account.status_border_color }};"
                >
                  {{ account.status_label }}
                </div>
              </div>
            {% if has_error %}
              <p class="summary-stat-footnote" style="color:var(--summary-red); margin:0;">{{ account.error }}</p>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div class="summary-card summary-card--muted" style="grid-column:1/-1;">
            <p style="margin:0; font-weight:600;">No connected accounts</p>
            <p class="summary-stat-footnote" style="margin-top:6px;">Connect a broker account to view portfolio insights.</p>
          </div>
        {% endif %}
      </div>
    </section>

    <section class="summary-card">
      <div style="display:flex; flex-direction:column; gap:16px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:20px; font-weight:800;">Portfolio Performance</h2>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          <span class="summary-chip is-active" data-period="1D" role="button" tabindex="0">1D</span>
          <span class="summary-chip" data-period="1W" role="button" tabindex="0">1W</span>
          <span class="summary-chip" data-period="1M" role="button" tabindex="0">1M</span>
          <span class="summary-chip" data-period="3M" role="button" tabindex="0">3M</span>
          <span class="summary-chip" data-period="6M" role="button" tabindex="0">6M</span>
          <span class="summary-chip" data-period="1Y" role="button" tabindex="0">1Y</span>
          <span class="summary-chip" data-period="All" role="button" tabindex="0">All</span>
        </div>
      </div>

      {% set primary_period_label = performance_summary.periods[0].label if performance_summary.periods else '1D' %}  
      <div style="margin:8px 0 16px 0;">
        <div style="display:flex; align-items:baseline; gap:8px; margin-bottom:2px;">
          <p style="margin:0; font-size:28px; font-weight:800;">{{ format_percentage(performance_summary.today_return_percent) }}</p>
          {% set benchmark_delta = performance_summary.today_return_percent - performance_summary.benchmark_return_percent %}
          {% set delta_positive = benchmark_delta >= 0 %}
          <span style="display:inline-flex; align-items:center; gap:6px; color:{{ 'var(--summary-green)' if delta_positive else 'var(--summary-red)' }}; font-size:13px;">
            {% if delta_positive %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
              </svg>
            {% else %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="1 6 10.5 15.5 15.5 10.5 23 18"></polyline>
                <polyline points="7 18 1 18 1 12"></polyline>
              </svg>
            {% endif %}
            {{ format_percentage(benchmark_delta) }} vs benchmark
          </span>
        </div>
        <p style="margin:0; color:var(--summary-muted); font-size:12px;">Portfolio return for {{ primary_period_label }} (benchmark {{ format_percentage(performance_summary.benchmark_return_percent) }})</p>
      </div>

      <div class="summary-chart-container">
        <div
          id="portfolio-performance-loading"
          class="summary-chart-skeleton"
          role="status"
          aria-live="polite"
          aria-label="Loading portfolio performance"
          hidden
        ></div>
        <canvas id="portfolio-performance-chart" aria-label="Portfolio performance trend" role="img"></canvas>
        <div id="portfolio-performance-empty" class="summary-chart-empty" hidden>
          No performance data available yet.
        </div>
      </div>

      <div class="summary-grid summary-grid-3 summary-period-grid" style="gap:12px;">
        {% for period in performance_summary.periods %}
          {% set period_color = period.color if period.value >= 0 else 'var(--summary-red)' %}
          <div class="summary-card--muted">
            <p style="margin:0; font-size:22px; font-weight:800; color:{{ period_color }};">{{ format_percentage(period.value) }}</p>
            <p style="margin:4px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ period.label }}</p>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="summary-grid summary-grid-2">
      <div class="summary-card" style="grid-column:1/-1;">
        <div class="summary-section-title" style="margin-bottom:12px;">
          <h2>Top Holdings</h2>
          <div class="top-holdings-controls">
            <div class="top-holdings-filter">
              <span class="top-holdings-filter__icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h18M6 9.75h12M10 15h4" />
                </svg>
              </span>
              <span class="top-holdings-filter__label">Filters:</span>
              <div class="top-holdings-filter__control">
                <label class="summary-sr-only" for="top-holdings-broker-filter">Filter top holdings by broker</label>
                <select id="top-holdings-broker-filter" class="top-holdings-filter__select">
                  {% for broker in broker_names %}
                    <option value="{{ broker }}">{{ broker }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <a href="#" id="top-holdings-toggle" hidden>View All</a>
          </div>
        </div>
        <div class="top-holdings-surface">
          {% if top_holdings %}
            <div class="top-holdings-table-container">
              <table class="top-holdings-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Buy Avg Price</th>
                    <th>Sell Avg Price</th>
                    <th>LTP</th>
                    <th>P&amp;L</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for holding in top_holdings %}
                    {% set pnl_positive = holding.pnl >= 0 %}
                    {% set symbol_display = holding.symbol or '—' %}
                    {% set avatar_text = symbol_display[:2].upper() %}
                    {% set exchange_badge = holding.exchange and holding.exchange.upper() %}
                    {% set product_label = (holding.product or 'Normal') %}
                    {% set buy_avg = holding.buy_avg_price if holding.buy_avg_price is not none else (holding.cost / holding.quantity if holding.quantity > 0 else None) %}
                    {% set sell_avg = holding.sell_avg_price if holding.sell_avg_price is not none else ((holding.cost / (-holding.quantity)) if holding.quantity < 0 else None) %}
                    {% set broker_label = holding.primary_broker or (holding.brokers|first if holding.brokers else '') %}
                    {% set broker_label = broker_label|trim %}
                    {% set broker_key = broker_label|lower|replace(' ', '') if broker_label else '' %}
                    {% set broker_key = broker_key|replace('-', '') %}
                    {% set broker_key = broker_key|replace('_', '') %}
                    {% set broker_key = broker_key|replace('&', 'and') %}
                    {% set broker_key = broker_key|replace('.', '') %}
                    {% set broker_icon = broker_icons.get(broker_key) if broker_key else None %}
                    {% set broker_icon = broker_icon or url_for('static', filename='images/logo.png') %}
                    {% set broker_alt_text = (broker_label if broker_label else 'Broker') ~ ' logo' %}
                    <tr data-brokers='{{ holding.brokers | tojson | safe }}'>
                      <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div style="height: 28px; width: 28px; border-radius: 6px; background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color:#111827;">
                            {{ avatar_text }}
                          </div>
                          <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                            <span style="font-weight: 500; color:#111827;">{{ symbol_display }}</span>
                            {% if exchange_badge %}
                              <span style="border: 1px solid rgba(107,114,128,0.3); font-size: 9px; line-height: 1; padding: 2px 4px; height: 16px; border-radius: 4px; color:#374151; background-color:#ffffff;">
                                {{ exchange_badge }}
                              </span>
                            {% endif %}
                            {% if holding.sector %}
                              <span style="border: 1px solid #fde68a; background-color:#fffbeb; color:#92400e; font-size: 9px; line-height:1; padding:2px 4px; height:16px; border-radius:4px; font-weight:500;">
                                {{ holding.sector[:1].upper() }}
                              </span>
                            {% endif %}
                          </div>
                        </div>
                      </td>
                      <td>
                        <span style="border:1px solid #10b981; background-color:#ecfdf5; color:#047857; font-size:10px; line-height:1; padding:2px 6px; border-radius:4px; font-weight:500; display:inline-block;">
                          {{ product_label }}
                        </span>
                      </td>
                      <td>{{ format_quantity(holding.quantity) }}</td>
                      <td>{{ buy_avg is not none and format_currency(buy_avg) or '—' }}</td>
                      <td>{{ sell_avg is not none and format_currency(sell_avg) or '—' }}</td>
                      <td>{{ format_currency(holding.ltp) }}</td>
                      <td>
                        <span style="color:{{ '#16a34a' if pnl_positive else '#dc2626' }}; font-weight:600;">{{ format_currency(holding.pnl) }}</span>
                      </td>
                      <td>
                        <img src="{{ broker_icon }}" alt="{{ broker_alt_text }}" title="{{ holding.brokers|join(', ') }}" style="height: 28px; width: 28px; display: block; object-fit: contain; margin-left: auto; margin-right: auto; border-radius: 6px; background: transparent;" />
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="top-holdings-card-list">
              {% for holding in top_holdings %}
                {% set pnl_positive = holding.pnl >= 0 %}
                {% set symbol_display = holding.symbol or '—' %}
                {% set avatar_text = symbol_display[:2].upper() %}
                {% set product_label = (holding.product or 'Normal') %}
                {% set exchange_badge = holding.exchange and holding.exchange.upper() %}
                {% set buy_avg = holding.buy_avg_price if holding.buy_avg_price is not none else (holding.cost / holding.quantity if holding.quantity > 0 else None) %}
                {% set sell_avg = holding.sell_avg_price if holding.sell_avg_price is not none else ((holding.cost / (-holding.quantity)) if holding.quantity < 0 else None) %}
                {% set broker_label = holding.primary_broker or (holding.brokers|first if holding.brokers else '') %}
                {% set broker_label = broker_label|trim %}
                {% set broker_key = broker_label|lower|replace(' ', '') if broker_label else '' %}
                {% set broker_key = broker_key|replace('-', '') %}
                {% set broker_key = broker_key|replace('_', '') %}
                {% set broker_key = broker_key|replace('&', 'and') %}
                {% set broker_key = broker_key|replace('.', '') %}
                {% set broker_icon = broker_icons.get(broker_key) if broker_key else None %}
                {% set broker_icon = broker_icon or url_for('static', filename='images/logo.png') %}
                {% set broker_alt_text = (broker_label if broker_label and broker_label != '—' else 'Broker') ~ ' logo' %}
                {% set market_value = holding.market_value if holding.market_value is not none else (holding.cost + holding.pnl) %}
                {% set pnl_percent = holding.pnl_percent if holding.pnl_percent is not none else ((holding.pnl / holding.cost * 100.0) if holding.cost else 0.0) %}
                <div class="top-holdings-card" data-brokers='{{ holding.brokers | tojson | safe }}'>
                  <div class="top-holdings-card__header">
                    <div class="top-holdings-card__identity">
                      <div class="top-holdings-card__avatar">{{ avatar_text }}</div>
                      <div>
                        <p class="top-holdings-card__symbol">{{ symbol_display }}</p>
                        <p class="top-holdings-card__subtitle">{{ holding.sector or 'Uncategorized' }}</p>
                      </div>
                    </div>
                    <div class="top-holdings-card__value">
                      {{ format_currency(market_value) }}
                      <span class="top-holdings-card__value-delta {{ 'is-positive' if pnl_positive else 'is-negative' }}">
                        {{ format_currency(holding.pnl) }} ({{ format_percentage(pnl_percent) }})
                      </span>
                    </div>
                  </div>
                  <div class="top-holdings-card__chips">
                    <span class="top-holdings-chip top-holdings-chip--product">{{ product_label }}</span>
                    {% if exchange_badge %}
                      <span class="top-holdings-chip">{{ exchange_badge }}</span>
                    {% endif %}
                    <span class="top-holdings-card__broker">
                      <img src="{{ broker_icon }}" alt="{{ broker_alt_text }}" title="{{ holding.brokers|join(', ') }}">
                    </span>
                  </div>
                  <div class="top-holdings-card__meta">
                    <div class="top-holdings-card__qty">
                      <span>Qty.</span>
                      <strong>{{ format_quantity(holding.quantity) }}</strong>
                      {% if buy_avg is not none %}
                        <span>&times; {{ format_currency(buy_avg) }}</span>
                      {% endif %}
                      {% if sell_avg is not none %}
                        <span>(Sell {{ format_currency(sell_avg) }})</span>
                      {% endif %}
                    </div>
                    <div class="top-holdings-card__ltp">LTP {{ format_currency(holding.ltp) }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
            <div id="top-holdings-empty-state" class="top-holdings-empty" hidden>
              No holdings match the selected broker.
            </div>
          {% else %}
            <div style="padding: 24px 16px; text-align: center; color: #6b7280; font-size: 12px;">
              No holdings available. Connect an account or refresh your positions.
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="summary-card">
      <div class="summary-section-title" style="margin-bottom:12px;">
        <h2>Recent Transactions</h2>
        <a href="#" id="recent-transactions-toggle" hidden>View All</a>
      </div>

      <div>
        {% if recent_transactions %}
          {% for txn in recent_transactions %}
            {% set action = txn.action or '' %}
            {% set is_buy = action == 'BUY' %}
            {% set is_sell = action == 'SELL' %}
            {% set is_dividend = not is_buy and not is_sell %}
            {% set icon_bg = 'rgba(5,150,105,0.10)' if is_buy else ('rgba(220,38,38,0.10)' if is_sell else 'rgba(37,99,235,0.10)') %}
            {% set icon_color = 'var(--summary-green)' if is_buy else ('var(--summary-red)' if is_sell else 'var(--summary-blue)') %}
            <div class="summary-transaction">
              <div class="info">
                <div style="width:40px; height:40px; border-radius:999px; background:{{ icon_bg }}; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                  {% if is_sell %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="17" x2="17" y2="7"></line>
                      <polyline points="7 7 17 7 17 17"></polyline>
                    </svg>
                  {% elif is_buy %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="7" x2="17" y2="17"></line>
                      <polyline points="17 7 17 17 7 17"></polyline>
                    </svg>
                  {% else %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M6 3h12"></path>
                      <path d="M6 8h12"></path>
                      <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
                    </svg>
                  {% endif %}
                </div>
                <div style="min-width:0;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <p style="margin:0; font-weight:700;">{{ txn.symbol or '—' }}</p>
                    {% set pill_class = 'summary-pill summary-pill--sell' if is_sell else ('summary-pill summary-pill--dividend' if is_dividend else 'summary-pill') %}
                    <span class="{{ pill_class }}">{{ action.title() if action else 'Trade' }}</span>
                  </div>
                  {% set has_price = txn.price and txn.price > 0 %}  
                  <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ format_quantity(txn.quantity) }} shares{% if has_price %} @ {{ format_currency(txn.price) }}{% endif %} • {{ txn.broker or '—' }}
                  </p>
                </div>
              </div>
              <div class="timestamp">
                <time datetime="{{ txn.timestamp_iso }}">{{ format_datetime(txn.timestamp) }}</time>
              </div>
              {% set has_value = txn.value and txn.value > 0 %}
              <p class="summary-value">{{ format_currency(txn.value) if has_value else '—' }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="summary-stat-footnote" style="margin:0;">No recent transactions found.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
if (!window.pageScripts) window.pageScripts = {};
window.pageScripts["Summary"] = function () {
  const canvas = document.getElementById("portfolio-performance-chart");
  const emptyState = document.getElementById("portfolio-performance-empty");
  const loadingState = document.getElementById("portfolio-performance-loading");
  const chips = Array.from(document.querySelectorAll(".summary-chip[data-period]"));
  const chartGlobal = window.Chart;
  const brokerFilter = document.getElementById("top-holdings-broker-filter");
  const holdingsTableContainer = document.querySelector(".top-holdings-table-container");
  const holdingsTableRows = holdingsTableContainer
    ? Array.from(holdingsTableContainer.querySelectorAll("tbody tr"))
    : [];
  const holdingsCardList = document.querySelector(".top-holdings-card-list");
  const holdingsCardItems = holdingsCardList
    ? Array.from(holdingsCardList.querySelectorAll(".top-holdings-card"))
    : [];
  const holdingsEmptyState = document.getElementById("top-holdings-empty-state");
  const holdingsToggle = document.getElementById("top-holdings-toggle");
  const transactionsToggle = document.getElementById("recent-transactions-toggle");
  const transactionItems = Array.from(document.querySelectorAll(".summary-transaction"));

  const HOLDINGS_LIMIT = 5;
  const TRANSACTIONS_LIMIT = 5;
  let holdingsShowAll = false;
  let transactionsShowAll = false;
  
  const brokerCache = new WeakMap();

  function normalizeBrokerName(value) {
    if (!value) {
      return "";
    }
    return String(value).toLowerCase().trim();
  }

  function extractBrokers(element) {
    if (!element) {
      return [];
    }
    if (brokerCache.has(element)) {
      return brokerCache.get(element);
    }
    const rawValue = element.dataset?.brokers;
    let brokerList = [];
    if (rawValue) {
      try {
        const parsed = JSON.parse(rawValue);
        if (Array.isArray(parsed)) {
          brokerList = parsed.map((item) => String(item));
        }
      } catch (error) {
        brokerList = String(rawValue)
          .split(/\s*,\s*/)
          .map((item) => item.trim())
          .filter(Boolean);
      }
    }
    brokerCache.set(element, brokerList);
    return brokerList;
  }

  function matchesBroker(element, normalizedSelection, showAllSelection) {
    if (!element) {
      return false;
    }
    if (showAllSelection) {
      return true;
    }
    const brokers = extractBrokers(element)
      .map((name) => normalizeBrokerName(name))
      .filter(Boolean);
    if (!brokers.length) {
      return false;
    }
    return brokers.includes(normalizedSelection);
  }

  function updateTransactionsVisibility() {
    if (!transactionItems.length) {
      if (transactionsToggle) {
        transactionsToggle.hidden = true;
      }
      return;
    }

    const shouldCollapse = transactionItems.length > TRANSACTIONS_LIMIT;
    if (!shouldCollapse && transactionsShowAll) {
      transactionsShowAll = false;
    }

    transactionItems.forEach((item, index) => {
      const shouldShow = transactionsShowAll || index < TRANSACTIONS_LIMIT;
      item.style.display = shouldShow ? "" : "none";
    });

    if (transactionsToggle) {
      transactionsToggle.hidden = !shouldCollapse;
      if (shouldCollapse) {
        transactionsToggle.textContent = transactionsShowAll ? "View Less" : "View All";
      }
    }
  }

  function applyBrokerFilter(selectedBroker) {
    const normalizedSelection = normalizeBrokerName(
      typeof selectedBroker === "string" ? selectedBroker : ""
    );
    const showAllSelection =
      !normalizedSelection || normalizedSelection === "all";

    let visibleRows = 0;
    let visibleCards = 0;
    let tableMatchCount = 0;
    let cardMatchCount = 0;

    holdingsTableRows.forEach((row) => {
      const isMatch = matchesBroker(row, normalizedSelection, showAllSelection);
      if (isMatch) {
        const shouldShow = holdingsShowAll || tableMatchCount < HOLDINGS_LIMIT;
        row.style.display = shouldShow ? "" : "none";
        tableMatchCount += 1;
        if (shouldShow) {
          visibleRows += 1;
        }
      } else {
        row.style.display = "none";
      }
    });

    holdingsCardItems.forEach((card) => {
      const isMatch = matchesBroker(card, normalizedSelection, showAllSelection);
      if (isMatch) {
        const shouldShow = holdingsShowAll || cardMatchCount < HOLDINGS_LIMIT;
        card.style.display = shouldShow ? "" : "none";
        cardMatchCount += 1;
        if (shouldShow) {
          visibleCards += 1;
        }
      } else {
        card.style.display = "none";
      }
    });

    if (holdingsTableContainer) {
      holdingsTableContainer.hidden =
        holdingsTableRows.length > 0 && visibleRows === 0;
    }
    if (holdingsCardList) {
      holdingsCardList.hidden =
        holdingsCardItems.length > 0 && visibleCards === 0;
    }

    if (holdingsEmptyState) {
      const hasVisible = visibleRows + visibleCards > 0;
      holdingsEmptyState.hidden = hasVisible;
    }

    const totalMatches = Math.max(tableMatchCount, cardMatchCount);
    if (totalMatches <= HOLDINGS_LIMIT && holdingsShowAll) {
      holdingsShowAll = false;
    }

    if (holdingsToggle) {
      holdingsToggle.hidden = totalMatches <= HOLDINGS_LIMIT;
      if (!holdingsToggle.hidden) {
        holdingsToggle.textContent = holdingsShowAll ? "View Less" : "View All";
      }
    }
  }

  updateTransactionsVisibility();

  if (transactionsToggle) {
    transactionsToggle.addEventListener("click", (event) => {
      event.preventDefault();
      if (transactionItems.length <= TRANSACTIONS_LIMIT) {
        return;
      }
      transactionsShowAll = !transactionsShowAll;
      updateTransactionsVisibility();
    });
  }

  if (brokerFilter) {
    applyBrokerFilter(brokerFilter.value);
    brokerFilter.addEventListener("change", () => {
      applyBrokerFilter(brokerFilter.value);
    });
  } else {
    applyBrokerFilter("");
  }

  if (holdingsToggle) {
    holdingsToggle.addEventListener("click", (event) => {
      event.preventDefault();
      const totalHoldings = Math.max(
        holdingsTableRows.length,
        holdingsCardItems.length
      );
      if (totalHoldings <= HOLDINGS_LIMIT) {
        return;
      }
      holdingsShowAll = !holdingsShowAll;
      applyBrokerFilter(brokerFilter ? brokerFilter.value : "");
    });
  }

  if (!canvas) {
    return;
  }

  const hasChart = typeof chartGlobal === "function";
  if (!hasChart) {
    canvas.setAttribute("hidden", "");
    if (emptyState) {
      emptyState.hidden = false;
    }
    return;
  }

  const initialSeries = {{ performance_summary.series | default([]) | tojson | safe }};
  const PERIOD_LIMITS = {
    "1D": 1,
    "1W": 7,
    "1M": 30,
    "3M": 90,
    "6M": 180,
    "1Y": 365,
    "All": null,
  };

  let cachedSeries = [];
  let isLoadingSeries = false;
  let chartInstance = null;
  const hasTimeScale = !!(
    chartGlobal?.registry?.getScale?.('time') &&
    chartGlobal?._adapters?.date
  );
  const xScaleType = hasTimeScale ? 'time' : 'linear';

  function normalizeSeries(series) {
    if (!Array.isArray(series)) {
      return [];
    }
    return series
      .map((point) => {
        if (!point) return null;
        const date = new Date(point.timestamp);
        if (Number.isNaN(date.getTime())) return null;
        const value = Number(point.value);
        if (!Number.isFinite(value)) return null;
        return { timestamp: date.toISOString(), value };
      })
      .filter(Boolean)
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  }

  function mapToDataset(series) {
    return series.map((point) => {
      const date = new Date(point.timestamp);
      const xValue = hasTimeScale ? date : date.getTime();
      return { x: xValue, y: Number(point.value) };
    });
  }

  function ensureChart() {
    if (chartInstance) {
      return chartInstance;
    }
    const context = canvas.getContext("2d");
    chartInstance = new chartGlobal(context, {
      type: "line",
      data: {
        datasets: [
          {
            label: "Portfolio Performance",
            data: [],
            borderColor: "rgba(79, 70, 229, 0.9)",
            backgroundColor: "rgba(79, 70, 229, 0.12)",
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        parsing: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: {
            type: xScaleType,
            time: hasTimeScale ? { tooltipFormat: "MMM d, yyyy HH:mm" } : undefined,
            grid: { color: "rgba(107, 114, 128, 0.15)" },
            ticks: {
              color: "#6b7280",
              maxTicksLimit: 8,
              callback(value) {
                if (hasTimeScale) {
                  return this.getLabelForValue(value);
                }
                const date = new Date(Number(value));
                if (Number.isNaN(date.getTime())) return "";
                return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
              },
            },
          },
          y: {
            grid: { color: "rgba(107, 114, 128, 0.15)" },
            ticks: {
              color: "#6b7280",
              callback(value) {
                return `₹${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
              },
            },
          },
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: "index",
            intersect: false,
            callbacks: {
              label(context) {
                const value = context.parsed.y;
                return `₹${Number(value).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
              },
            },
          },
        },
      },
    });
    return chartInstance;
  }

  function setLoadingState(isLoading) {
    isLoadingSeries = Boolean(isLoading);
    if (loadingState) {
      loadingState.hidden = !isLoadingSeries;
    }
  }

  function toggleState(hasData) {
    if (hasData) {
      canvas.removeAttribute("hidden");
      if (emptyState) emptyState.hidden = true;
      setLoadingState(false);
      return;
    }

    canvas.setAttribute("hidden", "");

    if (isLoadingSeries) {
      if (emptyState) emptyState.hidden = true;
      setLoadingState(true);
      return;
    }

    if (emptyState) emptyState.hidden = false;
    setLoadingState(false);
  }

  function updateChart(series) {
    const chart = ensureChart();
    const hasData = Array.isArray(series) && series.length > 0;
    toggleState(hasData);
    if (!hasData) {
      chart.data.datasets[0].data = [];
      chart.update("none");
      return;
    }
    chart.data.datasets[0].data = mapToDataset(series);
    chart.update("none");
  }

  function filterSeries(periodKey) {
    if (!cachedSeries.length) {
      return [];
    }
    const limitDays = PERIOD_LIMITS[periodKey] ?? null;
    if (!limitDays) {
      return cachedSeries.slice();
    }
    const now = Date.now();
    const threshold = now - limitDays * 24 * 60 * 60 * 1000;
    return cachedSeries.filter((point) => {
      const time = Date.parse(point.timestamp);
      return Number.isFinite(time) && time >= threshold;
    });
  }

  function setActiveChip(period) {
    chips.forEach((chip) => {
      chip.classList.toggle("is-active", chip.dataset.period === period);
    });
  }
  
  const periodOrder = chips
    .map((chip) => chip.dataset.period)
    .filter((period, index, arr) => period && arr.indexOf(period) === index);

  let activePeriod = chips.find((chip) => chip.classList.contains("is-active"))?.dataset.period || "1D";
  if (!activePeriod || !(activePeriod in PERIOD_LIMITS)) {
    activePeriod = periodOrder[0] || "All";
  }

  function findFallbackSeries(excludePeriod) {
    if (!cachedSeries.length) {
      return { period: excludePeriod, series: [] };
    }

    const candidateOrder = periodOrder.length
      ? periodOrder
      : Object.keys(PERIOD_LIMITS);

    for (const candidate of candidateOrder) {
      if (!candidate || candidate === excludePeriod) {
        continue;
      }
      const candidateSeries = filterSeries(candidate);
      if (candidateSeries.length) {
        return { period: candidate, series: candidateSeries };
      }
    }

    return { period: excludePeriod, series: cachedSeries.slice() };
  }

  function applyPeriod(period) {
    if (!period || !(period in PERIOD_LIMITS)) {
      period = activePeriod;
    }
    let resolvedPeriod = period;
    let series = filterSeries(period);

    if (!series.length && cachedSeries.length) {
      const fallback = findFallbackSeries(period);
      resolvedPeriod = fallback.period;
      series = fallback.series;
    }

    activePeriod = resolvedPeriod;
    setActiveChip(resolvedPeriod);
    updateChart(series);
  }

  function refreshSeries() {
    setLoadingState(!cachedSeries.length);
    fetch("/api/summary")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to load summary data");
        }
        return response.json();
      })
      .then((data) => {
        const incoming = data?.performance_summary?.series;
        if (!Array.isArray(incoming)) {
          setLoadingState(false);
          if (!cachedSeries.length) {
            toggleState(false);
          }
          return;
        }
        cachedSeries = normalizeSeries(incoming);
        setLoadingState(false);
        applyPeriod(activePeriod);
      })
      .catch(() => {
        setLoadingState(false);
        if (!cachedSeries.length) {
          toggleState(false);
        }
      });
  }

  cachedSeries = normalizeSeries(initialSeries);
  if (cachedSeries.length) {
    applyPeriod(activePeriod);
  } else {
    setLoadingState(true);
    toggleState(false);
  }
  refreshSeries();

  const REFRESH_EVENT_KEY = "__summaryRefreshHandler";
  if (window[REFRESH_EVENT_KEY]) {
    document.removeEventListener("summary:refresh", window[REFRESH_EVENT_KEY]);
  }
  window[REFRESH_EVENT_KEY] = refreshSeries;
  document.addEventListener("summary:refresh", refreshSeries);

  chips.forEach((chip) => {
    if (chip.dataset.bound === "true") {
      return;
    }
    chip.dataset.bound = "true";
    const handleActivate = () => applyPeriod(chip.dataset.period);
    chip.addEventListener("click", handleActivate);
    chip.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        handleActivate();
      }
    });
  });
};
</script>
