{% extends "layout.html" %}
{% block title %}Dashboard Summary - DhanBot{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .summary-dashboard {
    --summary-bg: #f5f7fb;
    --summary-card: #ffffff;
    --summary-border: #e6e9f2;
    --summary-text: #111827;
    --summary-muted: #6b7280;
    --summary-primary: #4f46e5;
    --summary-green: #059669;
    --summary-red: #dc2626;
    --summary-purple: #7c3aed;
    --summary-blue: #2563eb;
  
    color: var(--summary-text);
    background: var(--summary-bg);
    border-radius: 24px;
    box-shadow: inset 0 0 0 1px rgba(230, 233, 242, 0.45);
    padding: clamp(32px, 4vw, 48px) clamp(20px, 4vw, 32px);
  }
  
  .summary-dashboard .summary-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: clamp(24px, 4vw, 32px);
  }
  
  /* base grid helper */
  .summary-grid {
    display: grid;
    gap: 24px;
  }
  
  /* === TOP METRIC CARDS ROW (4 cards, like screenshot) === */
  .summary-grid-4 {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 24px;
  }
  
  /* each top stat card */
  .summary-grid-4 .summary-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(17,24,39,0.04);
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
  
  /* top row in each card:
     "Total Portfolio Value" on left
     icon badge on right */
  .summary-grid-4 .summary-card-title {
    display: flex;
    align-items: ;
    justify-content: left;
    margin-bottom: 16px;
    gap: 12px;
   
  }
  
  /* label text in card header */
  .summary-grid-4 .summary-card-label {
    margin: 0;
    font-size: 13px;
    line-height: 1.4;
    font-weight: 500;
    color: #4b5563; /* grey-600 like screenshot */
  }
  
  /* icon badge on right of header */
  .summary-grid-4 .summary-card-title > div {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 35px;
    /* background color for each card is still inline in HTML */
  }
  .summary-grid-4 .summary-card-title svg {
    width: 20px;
    height: 20px;
    stroke-width: 2;
  }
  
  /* big rupee amount */
  .summary-grid-4 .summary-stat-value {
    margin: 0;
    font-size: 28px;
    line-height: 1.2;
    font-weight: 800;
    letter-spacing: -0.03em;
    color: #111827;
  }
  
  /* green/red amount override for gain/loss cards */
  .summary-grid-4 .summary-stat-value.summary-stat-positive {
    color: #059669; /* green-600 */
  }
  .summary-grid-4 .summary-stat-value.summary-stat-negative {
    color: #dc2626; /* red-600 */
  }
  
  /* footnote under number (like "+16.23%") */
  .summary-grid-4 .summary-stat-footnote {
    margin-top: 8px;
    font-size: 14px;
    line-height: 1.3;
    font-weight: 500;
    color: #059669;
  }
  .summary-grid-4 .summary-stat-footnote.summary-stat-negative {
    color: #dc2626;
  }
  
  /* other grid groups below summary cards */
  .summary-grid-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  .summary-grid-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
    /* === TOP HOLDINGS TABLE & CARD VIEW === */
  .top-holdings-surface {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  .top-holdings-table-container {
    display: block;
    overflow-x: auto;
  }

  .top-holdings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    line-height: 1.4;
    color: #1f2937;
  }

  .top-holdings-table thead th {
    padding: 10px 12px;
    font-weight: 500;
    color: #6b7280;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
  }

  .top-holdings-table thead th:nth-child(n + 4) {
    text-align: right;
  }

  .top-holdings-table thead th:nth-child(2),
  .top-holdings-table thead th:nth-child(3),
  .top-holdings-table tbody td:nth-child(2),
  .top-holdings-table tbody td:nth-child(3),
  .top-holdings-table tbody td:last-child {
    text-align: center;
  }

  .top-holdings-table thead th:last-child {
    text-align: center;
  }

  .top-holdings-table tbody td:nth-child(4),
  .top-holdings-table tbody td:nth-child(5),
  .top-holdings-table tbody td:nth-child(6),
  .top-holdings-table tbody td:nth-child(7) {
    text-align: right;
  }

  .top-holdings-table tbody td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    color: #111827;
    vertical-align: middle;
  }

  .top-holdings-table tbody tr:last-child td {
    border-bottom: none;
  }

  .top-holdings-card-list {
    display: none;
    padding: 16px;
    background: linear-gradient(180deg, rgba(243,244,246,0.45), rgba(243,244,246,0));
  }

  .top-holdings-card {
    background: #ffffff;
    border: 1px solid rgba(17, 24, 39, 0.08);
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .top-holdings-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .top-holdings-card__identity {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .top-holdings-card__avatar {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: #f3f4f6;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #111827;
  }

  .top-holdings-card__symbol {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #111827;
  }

  .top-holdings-card__subtitle {
    margin: 4px 0 0 0;
    font-size: 12px;
    color: #6b7280;
  }

  .top-holdings-card__value {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    font-size: 16px;
    font-weight: 700;
    color: #111827;
  }

  .top-holdings-card__value-delta {
    font-size: 12px;
    font-weight: 600;
  }

  .top-holdings-card__value-delta.is-positive {
    color: #16a34a;
  }

  .top-holdings-card__value-delta.is-negative {
    color: #dc2626;
  }

  .top-holdings-card__chips {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .top-holdings-card__chips .top-holdings-card__broker {
    margin-left: auto;
  }

  .top-holdings-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px;
    font-size: 11px;
    font-weight: 600;
    border-radius: 999px;
    background: #f3f4f6;
    color: #374151;
    line-height: 1;
  }

  .top-holdings-chip--product {
    background: #ecfdf5;
    color: #047857;
    border: 1px solid rgba(5, 150, 105, 0.2);
  }

  .top-holdings-card__broker {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
  }

  .top-holdings-card__meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: #4b5563;
  }

  .top-holdings-card__qty {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 6px;
  }

  .top-holdings-card__qty strong {
    color: #111827;
    font-weight: 700;
  }

  .top-holdings-card__ltp {
    font-weight: 600;
    color: #111827;
  }

  @media (max-width: 768px) {
    .top-holdings-surface {
      padding: 0;
      border: none;
      background: transparent;
    }

    .top-holdings-table-container {
      display: none;
    }

    .top-holdings-card-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0;
      background: transparent;
    }
  }

  
  /* responsive:
     tablet/phone -> scroll horizontally for the 4 stat cards,
     but other grids (3-col, 2-col) collapse to single-column */
  @media (max-width: 1024px) {
    .summary-grid-4 {
      grid-auto-flow: column;
      grid-auto-columns: minmax(250px, 1fr);
      grid-template-columns: unset;
      overflow-x: auto;
      padding-bottom: 8px;
    }
  
    .summary-grid-4 .summary-card {
      min-width: 250px;
    }
  
    .summary-grid-4::-webkit-scrollbar {
      height: 6px;
    }
  
    .summary-grid-4::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.15);
      border-radius: 999px;
    }
  
    .summary-grid-3 {
      grid-template-columns: 1fr;
    }
  
    .summary-grid-2 {
      grid-template-columns: 1fr;
    }
  }
  
  /* dashboard container tweaks on very small screens */
  @media (max-width: 768px) {
    .summary-dashboard {
      border-radius: 20px;
      padding: 28px 20px;
    }
  }
  
  /* === GENERIC CARD STYLES (used in lower sections etc.) === */
  .summary-card,
  .summary-card--muted {
    background: var(--summary-card);
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: clamp(10px, 1vw, 14px);
    box-shadow: 0 2px 10px rgba(28, 31, 43, 0.03);
  }
  
  /* muted card (empty states / small KPI boxes in performance section) */
  .summary-card--muted {
    background: #f3f4f7;
    border: none;
    box-shadow: none;
    text-align: center;
  }
  
  /* === ACCOUNT STATUS BADGES === */
  .summary-account-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: 8px 8px;
    font-size: 10px;
    font-weight: 500;
    color: var(--summary-muted);
    background: #f8f9fc;
  }
  .summary-account-status::before {
    content: "";
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: currentColor;
  }
  .summary-account-status.summary-account-status--ok {
    color: var(--summary-green);
    border-color: rgba(5, 150, 105, 0.24);
    background: rgba(5, 150, 105, 0.08);
  }
  .summary-account-status.summary-account-status--error {
    color: var(--summary-red);
    border-color: rgba(220, 38, 38, 0.24);
    background: rgba(220, 38, 38, 0.08);
  }
  
  /* === LITTLE FILTER CHIPS (1D / 1W / etc.) === */
  .summary-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--summary-border);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    cursor: pointer;
    background: #ffffff;
    color: var(--summary-muted);
    user-select: none;
  }
  .summary-chip.is-active {
    background: rgba(79, 70, 229, 0.08);
    border-color: #dfe2f7;
    color: var(--summary-primary);
  }
  
  /* === STALE DATA PILL ("Refreshing…") === */
  .summary-stale-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--summary-muted);
    background: rgba(37, 99, 235, 0.08);
    border-radius: 999px;
    padding: 4px 10px;
    font-weight: 500;
  }
  .summary-stale-indicator::before {
    content: "";
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--summary-blue);
    animation: summary-pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes summary-pulse {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
  }
  
  /* === PERFORMANCE CHART BOX === */
  .summary-chart-container {
    position: relative;
    height: 240px;
    border: 1px dashed var(--summary-border);
    border-radius: 12px;
    margin: 0 0 18px 0;
    background: var(--summary-card);
    overflow: hidden;
  }
  .summary-chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }
  .summary-chart-empty {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--summary-muted);
    font-size: 14px;
    padding: 0 16px;
    background: var(--summary-card);
  }
  .summary-chart-empty[hidden] {
    display: none;
  }
  
  /* === PROGRESS BAR (sector allocation rows) === */
  .summary-progress {
    height: 8px;
    border-radius: 999px;
    background: #eef2ff;
    position: relative;
    overflow: hidden;
  }
  .summary-progress > span {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    border-radius: inherit;
  }
  
  /* === TABLES (Top Holdings) === */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
  }
  .summary-table th,
  .summary-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #f1f3f8;
  }
  .summary-table thead th {
    font-weight: 600;
    color: var(--summary-muted);
    text-align: left;
  }
  .summary-table tbody tr:last-child td {
    border-bottom: none;
  }
  
  /* === HEADER CARD ("Dashboard Summary" block at top) === */
  .summary-header {
    background: var(--summary-card);
    border: 1px solid var(--summary-border);
    border-radius: 12px;
    padding: clamp(24px, 4vw, 28px) clamp(20px, 4vw, 32px);
    box-shadow: 0 2px 10px rgba(28, 31, 43, 0.03);
  }
  .summary-header h1 {
    font-size: clamp(26px, 3vw, 32px);
    font-weight: 800;
    letter-spacing: -0.3px;
    margin: 0;
  }
  .summary-header p {
    margin: 8px 0 0 0;
    color: var(--summary-muted);
    font-size: clamp(14px, 2.4vw, 16px);
  }
  
  /* === SECTION HEADERS ("Account Summary", etc.) === */
  .summary-section-title {
    margin-top: 1px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }
  .summary-section-title h2 {
  
    font-size: 20px;
    font-weight: 800;
    margin: 0;
  }
  .summary-section-title a {
    text-decoration: none;
    color: var(--summary-primary);
    font-weight: 600;
    font-size: 14px;
  }
  
  /* === GENERIC CARD HEADER (used in other cards, e.g. "Top Holdings", etc.) === */
  .summary-card-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .summary-card-label {
    margin: 0;
    color: var(--summary-muted);
    font-size: 14px;
  }
  
  /* === NUMERIC STAT / GENERIC (outside top tiles) === */
  .summary-stat-value {
    margin: 0;
    font-size: clamp(26px, 3vw, 32px);
    font-weight: 800;
    letter-spacing: -0.4px;
  }
  .summary-stat-positive {
    color: var(--summary-green);
  }
  .summary-stat-negative {
    color: var(--summary-red);
  }
  
  /* === RECENT TRANSACTIONS LIST === */
  .summary-transaction {
    margin-top: 20px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(120px, max-content) auto;
    align-items: center;
    gap: 16px;
  }
  .summary-transaction + .summary-transaction {
    margin-top: 14px;
  }
  .summary-transaction .info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0;
  }
  
  .summary-transaction .timestamp {
    font-size: 12px;
    color: var(--summary-muted);
    white-space: nowrap;
    text-align: center;
    justify-self: center;
    min-width: 120px;
  }
  .summary-transaction .timestamp time {
    display: block;
  }
  .summary-pill {
    border: 1px solid var(--summary-border);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
    background: #f1f4f8;
    font-weight: 600;
    text-transform: uppercase;
  }
  .summary-pill.summary-pill--sell {
    border-color: #fad1d1;
    color: var(--summary-red);
    background: #fff5f5;
  }
  .summary-pill.summary-pill--dividend {
    background: #ffffff;
  }
  .summary-value {
    margin: 0;
    font-weight: 700;
    white-space: nowrap;
    justify-self: end;
  }

  @media (max-width: 640px) {
    .summary-transaction {
      grid-template-columns: minmax(0, 1fr);
      row-gap: 8px;
    }
    .summary-transaction .timestamp,
    .summary-value {
      justify-self: flex-start;
      text-align: left;
    }
  }
  
  /* default footnote style (used outside the top 4 cards) */
  .summary-stat-footnote {
    margin: 6px 0 0 0;
    font-size: 12px;
    color: var(--summary-muted);
  }
</style>
{% endblock %}

{% block content %}
<div class="summary-dashboard">
  <div class="summary-inner">
    <section class="summary-header">
      <div style="display:flex; align-items:flex-start; justify-content:space-between;">
        <div>
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
            <div style="width:28px; height:28px; border-radius:8px; background:#eef2ff; display:flex; align-items:center; justify-content:center;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--summary-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="14" width="7" height="7" rx="2"></rect>
                <rect x="3" y="14" width="7" height="7" rx="2"></rect>
              </svg>
            </div>
            <h1>Dashboard Summary</h1>
          </div>
          <p>Overview of your trading activities and account performance.</p>
        </div>
      </div>
    </section>

    <section class="summary-grid summary-grid-4">
      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Portfolio Value</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 7H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h15a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"></path>
              <path d="M16 3H7a2 2 0 0 0-2 2v2"></path>
              <path d="M20 11h-6a2 2 0 0 0 0 4h6"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_portfolio_value) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Investment</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(124,58,237,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M6 3h12"></path>
              <path d="M6 8h12"></path>
              <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_investment) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set gain_positive = overview.total_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if gain_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.total_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.total_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.total_gain_loss_percent) }}
        </p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Today's Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set today_positive = overview.today_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if today_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.today_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.today_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.today_gain_loss_percent) }}
        </p>
      </div>
    </section>

    <section>
      <div class="summary-section-title">
        <h2>Account Summary</h2>
        <a href="/account-config">Manage Accounts</a>
      </div>
      <div class="summary-grid summary-grid-3">
        {% set account_palette = [
          {'bg': 'rgba(234,88,12,0.10)', 'stroke': '#EA580C'},
          {'bg': 'rgba(37,99,235,0.10)', 'stroke': 'var(--summary-blue)'},
          {'bg': 'rgba(124,58,237,0.10)', 'stroke': 'var(--summary-purple)'}
        ] %}
        {% if account_summaries %}
          {% for account in account_summaries %}
            {% set palette = account_palette[loop.index0 % (account_palette|length)] %}
            {% set has_error = account.error %}  
            <div class="summary-card">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:16px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:40px; height:40px; border-radius:10px; background:{{ palette.bg }}; display:flex; align-items:center; justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="{{ palette.stroke }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                  </div>
                  <div>
                    <p style="margin:0; font-weight:700;">{{ account.broker or 'Account' }}</p>
                    <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ account.client_id }}</p>
                  </div>
                </div>
                <div class="summary-account-status {{ 'summary-account-status--error' if has_error else 'summary-account-status--ok' }}">
                  {{ 'Failed' if has_error else 'Connected' }}
                </div>
              </div>
              {% if has_error %}
                <p class="summary-stat-footnote" style="color:var(--summary-red); margin:0;">{{ account.error }}</p>
              {% endif %}  
            </div>
          {% endfor %}
        {% else %}
          <div class="summary-card summary-card--muted" style="grid-column:1/-1;">
            <p style="margin:0; font-weight:600;">No connected accounts</p>
            <p class="summary-stat-footnote" style="margin-top:6px;">Connect a broker account to view portfolio insights.</p>
          </div>
        {% endif %}
      </div>
    </section>

    <section class="summary-card">
      <div style="display:flex; flex-direction:column; gap:16px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:20px; font-weight:800;">Portfolio Performance</h2>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          <span class="summary-chip is-active" data-period="1D" role="button" tabindex="0">1D</span>
          <span class="summary-chip" data-period="1W" role="button" tabindex="0">1W</span>
          <span class="summary-chip" data-period="1M" role="button" tabindex="0">1M</span>
          <span class="summary-chip" data-period="3M" role="button" tabindex="0">3M</span>
          <span class="summary-chip" data-period="6M" role="button" tabindex="0">6M</span>
          <span class="summary-chip" data-period="1Y" role="button" tabindex="0">1Y</span>
          <span class="summary-chip" data-period="All" role="button" tabindex="0">All</span>
        </div>
      </div>

      <div style="margin:8px 0 16px 0;">
        <div style="display:flex; align-items:baseline; gap:8px; margin-bottom:2px;">
          <p style="margin:0; font-size:28px; font-weight:800;">{{ format_percentage(performance_summary.today_return_percent) }}</p>
          {% set benchmark_delta = performance_summary.today_return_percent - performance_summary.benchmark_return_percent %}
          {% set delta_positive = benchmark_delta >= 0 %}
          <span style="display:inline-flex; align-items:center; gap:6px; color:{{ 'var(--summary-green)' if delta_positive else 'var(--summary-red)' }}; font-size:13px;">
            {% if delta_positive %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
              </svg>
            {% else %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="1 6 10.5 15.5 15.5 10.5 23 18"></polyline>
                <polyline points="7 18 1 18 1 12"></polyline>
              </svg>
            {% endif %}
            {{ format_percentage(benchmark_delta) }} vs benchmark
          </span>
        </div>
        <p style="margin:0; color:var(--summary-muted); font-size:12px;">Portfolio return for 1D (benchmark {{ format_percentage(performance_summary.benchmark_return_percent) }})</p>
      </div>

      <div class="summary-chart-container">
        <canvas id="portfolio-performance-chart" aria-label="Portfolio performance trend" role="img"></canvas>
        <div id="portfolio-performance-empty" class="summary-chart-empty" hidden>
          No performance data available yet.
        </div>
      </div>

      <div class="summary-grid summary-grid-3" style="gap:12px;">
        {% for period in performance_summary.periods %}
          {% set period_color = period.color if period.value >= 0 else 'var(--summary-red)' %}
          <div class="summary-card--muted">
            <p style="margin:0; font-size:22px; font-weight:800; color:{{ period_color }};">{{ format_percentage(period.value) }}</p>
            <p style="margin:4px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ period.label }}</p>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="summary-grid summary-grid-2">
      <div class="summary-card" style="grid-column:1/-1;">
        <div class="summary-section-title" style="margin-bottom:12px;">
          <h2>Top Holdings</h2>
          <a href="#">View All</a>
        </div>
        <div class="top-holdings-surface">
          {% if top_holdings %}
            {% set broker_palette = [
              {'bg': '#dbeafe', 'color': '#1e40af'},
              {'bg': '#ffedd5', 'color': '#9a3412'},
              {'bg': '#d1fae5', 'color': '#065f46'}
            ] %}
            <div class="top-holdings-table-container">
              <table class="top-holdings-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Buy Avg Price</th>
                    <th>Sell Avg Price</th>
                    <th>LTP</th>
                    <th>P&amp;L</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for holding in top_holdings %}
                    {% set pnl_positive = holding.pnl >= 0 %}
                    {% set symbol_display = holding.symbol or '—' %}
                    {% set avatar_text = symbol_display[:2].upper() %}
                    {% set exchange_badge = holding.exchange and holding.exchange.upper() %}
                    {% set product_label = (holding.product or 'Normal') %}
                    {% set buy_avg = holding.buy_avg_price if holding.buy_avg_price is not none else (holding.cost / holding.quantity if holding.quantity > 0 else None) %}
                    {% set sell_avg = holding.sell_avg_price if holding.sell_avg_price is not none else ((holding.cost / (-holding.quantity)) if holding.quantity < 0 else None) %}
                    {% set broker_style = broker_palette[loop.index0 % (broker_palette|length)] %}
                    {% set broker_name = holding.primary_broker or (holding.brokers and holding.brokers[0]) or '—' %}
                    {% set broker_badge = broker_name[:2].upper() %}
                    <tr>
                      <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div style="height: 28px; width: 28px; border-radius: 6px; background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color:#111827;">
                            {{ avatar_text }}
                          </div>
                          <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                            <span style="font-weight: 500; color:#111827;">{{ symbol_display }}</span>
                            {% if exchange_badge %}
                              <span style="border: 1px solid rgba(107,114,128,0.3); font-size: 9px; line-height: 1; padding: 2px 4px; height: 16px; border-radius: 4px; color:#374151; background-color:#ffffff;">
                                {{ exchange_badge }}
                              </span>
                            {% endif %}
                            {% if holding.sector %}
                              <span style="border: 1px solid #fde68a; background-color:#fffbeb; color:#92400e; font-size: 9px; line-height:1; padding:2px 4px; height:16px; border-radius:4px; font-weight:500;">
                                {{ holding.sector[:1].upper() }}
                              </span>
                            {% endif %}
                          </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                      </td>
                      <td>
                        <span style="border:1px solid #10b981; background-color:#ecfdf5; color:#047857; font-size:10px; line-height:1; padding:2px 6px; border-radius:4px; font-weight:500; display:inline-block;">
                          {{ product_label }}
                        </span>
                      </td>
                      <td>{{ format_quantity(holding.quantity) }}</td>
                      <td>{{ buy_avg is not none and format_currency(buy_avg) or '—' }}</td>
                      <td>{{ sell_avg is not none and format_currency(sell_avg) or '—' }}</td>
                      <td>{{ format_currency(holding.ltp) }}</td>
                      <td>
                        <span style="color:{{ '#16a34a' if pnl_positive else '#dc2626' }}; font-weight:600;">{{ format_currency(holding.pnl) }}</span>
                      </td>
                      <td>
                        <div title="{{ holding.brokers|join(', ') }}" style="height: 28px; width: 28px; border-radius: 6px; background-color:{{ broker_style.bg }}; display:flex; align-items:center; justify-content:center; margin-left:auto; margin-right:auto; font-size:10px; font-weight:600; color:{{ broker_style.color }};">
                          {{ broker_badge }}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="top-holdings-card-list">
              {% for holding in top_holdings %}
                {% set pnl_positive = holding.pnl >= 0 %}
                {% set symbol_display = holding.symbol or '—' %}
                {% set avatar_text = symbol_display[:2].upper() %}
                {% set product_label = (holding.product or 'Normal') %}
                {% set exchange_badge = holding.exchange and holding.exchange.upper() %}
                {% set buy_avg = holding.buy_avg_price if holding.buy_avg_price is not none else (holding.cost / holding.quantity if holding.quantity > 0 else None) %}
                {% set sell_avg = holding.sell_avg_price if holding.sell_avg_price is not none else ((holding.cost / (-holding.quantity)) if holding.quantity < 0 else None) %}
                {% set broker_style = broker_palette[loop.index0 % (broker_palette|length)] %}
                {% set broker_name = holding.primary_broker or (holding.brokers and holding.brokers[0]) or '—' %}
                {% set broker_badge = broker_name[:2].upper() %}
                {% set market_value = holding.market_value if holding.market_value is not none else (holding.cost + holding.pnl) %}
                {% set pnl_percent = holding.pnl_percent if holding.pnl_percent is not none else ((holding.pnl / holding.cost * 100.0) if holding.cost else 0.0) %}
                <div class="top-holdings-card">
                  <div class="top-holdings-card__header">
                    <div class="top-holdings-card__identity">
                      <div class="top-holdings-card__avatar">{{ avatar_text }}</div>
                      <div>
                        <p class="top-holdings-card__symbol">{{ symbol_display }}</p>
                        <p class="top-holdings-card__subtitle">{{ holding.sector or 'Uncategorized' }}</p>
                      </div>
                    </div>
                    <div class="top-holdings-card__value">
                      {{ format_currency(market_value) }}
                      <span class="top-holdings-card__value-delta {{ 'is-positive' if pnl_positive else 'is-negative' }}">
                        {{ format_currency(holding.pnl) }} ({{ format_percentage(pnl_percent) }})
                      </span>
                    </div>
                  </div>
                  <div class="top-holdings-card__chips">
                    <span class="top-holdings-chip top-holdings-chip--product">{{ product_label }}</span>
                    {% if exchange_badge %}
                      <span class="top-holdings-chip">{{ exchange_badge }}</span>
                    {% endif %}
                    <span class="top-holdings-card__broker" style="background-color:{{ broker_style.bg }}; color:{{ broker_style.color }};">
                      {{ broker_badge }}
                    </span>
                  </div>
                  <div class="top-holdings-card__meta">
                    <div class="top-holdings-card__qty">
                      <span>Qty.</span>
                      <strong>{{ format_quantity(holding.quantity) }}</strong>
                      {% if buy_avg is not none %}
                        <span>&times; {{ format_currency(buy_avg) }}</span>
                      {% endif %}
                      {% if sell_avg is not none %}
                        <span>(Sell {{ format_currency(sell_avg) }})</span>
                      {% endif %}
                    </div>
                    <div class="top-holdings-card__ltp">LTP {{ format_currency(holding.ltp) }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div style="padding: 24px 16px; text-align: center; color: #6b7280; font-size: 12px;">
              No holdings available. Connect an account or refresh your positions.
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="summary-card">
      <div class="summary-section-title" style="margin-bottom:12px;">
        <h2>Recent Transactions</h2>
        <a href="#">View All</a>
      </div>

      <div>
        {% if recent_transactions %}
          {% for txn in recent_transactions %}
            {% set action = txn.action or '' %}
            {% set is_buy = action == 'BUY' %}
            {% set is_sell = action == 'SELL' %}
            {% set is_dividend = not is_buy and not is_sell %}
            {% set icon_bg = 'rgba(5,150,105,0.10)' if is_buy else ('rgba(220,38,38,0.10)' if is_sell else 'rgba(37,99,235,0.10)') %}
            {% set icon_color = 'var(--summary-green)' if is_buy else ('var(--summary-red)' if is_sell else 'var(--summary-blue)') %}
            <div class="summary-transaction">
              <div class="info">
                <div style="width:40px; height:40px; border-radius:999px; background:{{ icon_bg }}; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                  {% if is_sell %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="17" x2="17" y2="7"></line>
                      <polyline points="7 7 17 7 17 17"></polyline>
                    </svg>
                  {% elif is_buy %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="7" x2="17" y2="17"></line>
                      <polyline points="17 7 17 17 7 17"></polyline>
                    </svg>
                  {% else %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M6 3h12"></path>
                      <path d="M6 8h12"></path>
                      <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
                    </svg>
                  {% endif %}
                </div>
                <div style="min-width:0;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <p style="margin:0; font-weight:700;">{{ txn.symbol or '—' }}</p>
                    {% set pill_class = 'summary-pill summary-pill--sell' if is_sell else ('summary-pill summary-pill--dividend' if is_dividend else 'summary-pill') %}
                    <span class="{{ pill_class }}">{{ action.title() if action else 'Trade' }}</span>
                  </div>
                  {% set has_price = txn.price and txn.price > 0 %}  
                  <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ format_quantity(txn.quantity) }} shares{% if has_price %} @ {{ format_currency(txn.price) }}{% endif %} • {{ txn.broker or '—' }}
                  </p>
                </div>
              </div>
              <div class="timestamp">
                <time datetime="{{ txn.timestamp_iso }}">{{ format_datetime(txn.timestamp) }}</time>
              </div>
              {% set has_value = txn.value and txn.value > 0 %}
              <p class="summary-value">{{ format_currency(txn.value) if has_value else '—' }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="summary-stat-footnote" style="margin:0;">No recent transactions found.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
if (!window.pageScripts) window.pageScripts = {};
window.pageScripts["Summary"] = function () {
  const canvas = document.getElementById("portfolio-performance-chart");
  const emptyState = document.getElementById("portfolio-performance-empty");
  const chips = Array.from(document.querySelectorAll(".summary-chip[data-period]"));
  const chartGlobal = window.Chart;

  if (!canvas) {
    return;
  }

  const hasChart = typeof chartGlobal === "function";
  if (!hasChart) {
    canvas.setAttribute("hidden", "");
    if (emptyState) {
      emptyState.hidden = false;
    }
    return;
  }

  const initialSeries = {{ performance_summary.series | default([]) | tojson | safe }};
  const PERIOD_LIMITS = {
    "1D": 1,
    "1W": 7,
    "1M": 30,
    "3M": 90,
    "6M": 180,
    "1Y": 365,
    "All": null,
  };

  let cachedSeries = [];
  let chartInstance = null;
  const hasTimeScale = !!(
    chartGlobal?.registry?.getScale?.('time') &&
    chartGlobal?._adapters?.date
  );
  const xScaleType = hasTimeScale ? 'time' : 'linear';

  function normalizeSeries(series) {
    if (!Array.isArray(series)) {
      return [];
    }
    return series
      .map((point) => {
        if (!point) return null;
        const date = new Date(point.timestamp);
        if (Number.isNaN(date.getTime())) return null;
        const value = Number(point.value);
        if (!Number.isFinite(value)) return null;
        return { timestamp: date.toISOString(), value };
      })
      .filter(Boolean)
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  }

  function mapToDataset(series) {
    return series.map((point) => {
      const date = new Date(point.timestamp);
      const xValue = hasTimeScale ? date : date.getTime();
      return { x: xValue, y: Number(point.value) };
    });
  }

  function ensureChart() {
    if (chartInstance) {
      return chartInstance;
    }
    const context = canvas.getContext("2d");
    chartInstance = new chartGlobal(context, {
      type: "line",
      data: {
        datasets: [
          {
            label: "Portfolio Performance",
            data: [],
            borderColor: "rgba(79, 70, 229, 0.9)",
            backgroundColor: "rgba(79, 70, 229, 0.12)",
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        parsing: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: {
            type: xScaleType,
            time: hasTimeScale ? { tooltipFormat: "MMM d, yyyy HH:mm" } : undefined,
            grid: { color: "rgba(107, 114, 128, 0.15)" },
            ticks: {
              color: "#6b7280",
              maxTicksLimit: 8,
              callback(value) {
                if (hasTimeScale) {
                  return this.getLabelForValue(value);
                }
                const date = new Date(Number(value));
                if (Number.isNaN(date.getTime())) return "";
                return date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
              },
            },
          },
          y: {
            grid: { color: "rgba(107, 114, 128, 0.15)" },
            ticks: {
              color: "#6b7280",
              callback(value) {
                return `₹${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
              },
            },
          },
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: "index",
            intersect: false,
            callbacks: {
              label(context) {
                const value = context.parsed.y;
                return `₹${Number(value).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
              },
            },
          },
        },
      },
    });
    return chartInstance;
  }

  function toggleState(hasData) {
    if (hasData) {
      canvas.removeAttribute("hidden");
      if (emptyState) emptyState.hidden = true;
    } else {
      canvas.setAttribute("hidden", "");
      if (emptyState) emptyState.hidden = false;
    }
  }

  function updateChart(series) {
    const chart = ensureChart();
    const hasData = Array.isArray(series) && series.length > 0;
    toggleState(hasData);
    if (!hasData) {
      chart.data.datasets[0].data = [];
      chart.update("none");
      return;
    }
    chart.data.datasets[0].data = mapToDataset(series);
    chart.update("none");
  }

  function filterSeries(periodKey) {
    if (!cachedSeries.length) {
      return [];
    }
    const limitDays = PERIOD_LIMITS[periodKey] ?? null;
    if (!limitDays) {
      return cachedSeries.slice();
    }
    const now = Date.now();
    const threshold = now - limitDays * 24 * 60 * 60 * 1000;
    return cachedSeries.filter((point) => {
      const time = Date.parse(point.timestamp);
      return Number.isFinite(time) && time >= threshold;
    });
  }

  function setActiveChip(period) {
    chips.forEach((chip) => {
      chip.classList.toggle("is-active", chip.dataset.period === period);
    });
  }

  let activePeriod = chips.find((chip) => chip.classList.contains("is-active"))?.dataset.period || "1D";
  if (!activePeriod || !(activePeriod in PERIOD_LIMITS)) {
    activePeriod = "All";
  }

  function applyPeriod(period) {
    if (!period || !(period in PERIOD_LIMITS)) {
      period = activePeriod;
    }
    activePeriod = period;
    setActiveChip(period);
    const series = filterSeries(period);
    updateChart(series);
  }

  function refreshSeries() {
    fetch("/api/summary")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to load summary data");
        }
        return response.json();
      })
      .then((data) => {
        const incoming = data?.performance_summary?.series;
        if (!Array.isArray(incoming)) {
          return;
        }
        cachedSeries = normalizeSeries(incoming);
        applyPeriod(activePeriod);
      })
      .catch(() => {
        if (!cachedSeries.length) {
          toggleState(false);
        }
      });
  }

  cachedSeries = normalizeSeries(initialSeries);
  applyPeriod(activePeriod);
  refreshSeries();

  const REFRESH_EVENT_KEY = "__summaryRefreshHandler";
  if (window[REFRESH_EVENT_KEY]) {
    document.removeEventListener("summary:refresh", window[REFRESH_EVENT_KEY]);
  }
  window[REFRESH_EVENT_KEY] = refreshSeries;
  document.addEventListener("summary:refresh", refreshSeries);

  chips.forEach((chip) => {
    if (chip.dataset.bound === "true") {
      return;
    }
    chip.dataset.bound = "true";
    const handleActivate = () => applyPeriod(chip.dataset.period);
    chip.addEventListener("click", handleActivate);
    chip.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        handleActivate();
      }
    });
  });
};
</script>
{% endblock %}
