{% extends "layout.html" %}
{% block title %}Dashboard Summary - DhanBot{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/summary.css') }}">
{% endblock %}

{% block content %}
<div class="summary-dashboard">
  <div class="summary-inner">
    <section class="summary-header">
      <div style="display:flex; align-items:flex-start; justify-content:space-between;">
        <div>
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
            <div style="width:28px; height:28px; border-radius:8px; background:#eef2ff; display:flex; align-items:center; justify-content:center;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--summary-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="3" width="7" height="7" rx="2"></rect>
                <rect x="14" y="14" width="7" height="7" rx="2"></rect>
                <rect x="3" y="14" width="7" height="7" rx="2"></rect>
              </svg>
            </div>
            <h1>Dashboard Summary</h1>
          </div>
          <p>Overview of your trading activities and account performance.</p>
        </div>
      </div>
    </section>

    <section class="summary-grid summary-grid-4">
      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Portfolio Value</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 7H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h15a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"></path>
              <path d="M16 3H7a2 2 0 0 0-2 2v2"></path>
              <path d="M20 11h-6a2 2 0 0 0 0 4h6"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_portfolio_value) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Investment</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(124,58,237,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M6 3h12"></path>
              <path d="M6 8h12"></path>
              <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
            </svg>
          </div>
        </div>
        <p class="summary-stat-value">{{ format_currency(overview.total_investment) }}</p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Total Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set gain_positive = overview.total_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if gain_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.total_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.total_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.total_gain_loss_percent) }}
        </p>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">
          <p class="summary-card-label">Today's Gain/Loss</p>
          <div style="width:40px; height:40px; border-radius:10px; background:rgba(5,150,105,0.10); display:flex; align-items:center; justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="7" y1="17" x2="17" y2="7"></line>
              <polyline points="7 7 17 7 17 17"></polyline>
            </svg>
          </div>
        </div>
        {% set today_positive = overview.today_gain_loss >= 0 %}
        <p class="summary-stat-value {{ 'summary-stat-positive' if today_positive else 'summary-stat-negative' }}">
          {{ format_currency(overview.today_gain_loss) }}
        </p>
        <p class="summary-stat-footnote {{ 'summary-stat-positive' if overview.today_gain_loss_percent >= 0 else 'summary-stat-negative' }}">
          {{ format_percentage(overview.today_gain_loss_percent) }}
        </p>
      </div>
    </section>

    <section>
      <div class="summary-section-title">
        <h2>Account Summary</h2>
        <a href="{{ url_for('AddAccount') }}">Manage Accounts</a>
      </div>
      <div class="summary-grid summary-grid-3">
        {% set account_palette = [
          {'bg': 'rgba(234,88,12,0.10)', 'stroke': '#EA580C'},
          {'bg': 'rgba(37,99,235,0.10)', 'stroke': 'var(--summary-blue)'},
          {'bg': 'rgba(124,58,237,0.10)', 'stroke': 'var(--summary-purple)'}
        ] %}
        {% if account_summaries %}
          {% for account in account_summaries %}
            {% set palette = account_palette[loop.index0 % (account_palette|length)] %}
            {% set has_error = account.error %}
            <div class="summary-card">
              {% set broker_label = account.broker or 'Account' %}
              {% set broker_key = broker_label|lower|replace(' ', '') %}
              {% set broker_key = broker_key|replace('-', '') %}
              {% set broker_key = broker_key|replace('_', '') %}
              {% set broker_key = broker_key|replace('&', 'and') %}
              {% set broker_key = broker_key|replace('.', '') %}
              {% set broker_icon = broker_icons.get(broker_key) if broker_key else None %}
              {% set broker_icon = broker_icon or url_for('static', filename='images/logo.png') %}  
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:16px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:40px; height:40px; border-radius:10px; background:{{ palette.bg }}; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                    <img
                      src="{{ broker_icon }}"
                      alt="{{ broker_label }} logo"
                      style="width:100%; height:100%; object-fit:contain;"
                    >
                  </div>
                  <div>
                    <p style="margin:0; font-weight:700;">{{ broker_label }}</p>
                    <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ account.client_id }}</p>
                  </div>
                </div>
                <div
                  class="summary-account-status {{ 'summary-account-status--error' if has_error else 'summary-account-status--ok' }}"
                  style="--status-color: {{ account.status_color }}; --status-background-color: {{ account.status_background_color }}; --status-border-color: {{ account.status_border_color }};"
                >
                  {{ account.status_label }}
                </div>
              </div>
            {% if account.cached_at %}
              {# Footnote removed: no stale or last updated message #}
            {% elif account.stale and not has_error %}
              {# Footnote removed for stale accounts without cached data #}
            {% endif %}
            {% if has_error %}
              <p class="summary-stat-footnote" style="color:var(--summary-red); margin:0;">{{ account.error }}</p>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div class="summary-card summary-card--muted" style="grid-column:1/-1;">
            <p style="margin:0; font-weight:600;">No connected accounts</p>
            <p class="summary-stat-footnote" style="margin-top:6px;">Connect a broker account to view portfolio insights.</p>
          </div>
        {% endif %}
      </div>
    </section>

    <section class="summary-card">
      <div style="display:flex; flex-direction:column; gap:16px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:20px; font-weight:800;">Portfolio Performance</h2>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          <span class="summary-chip is-active" data-period="1D" role="button" tabindex="0">1D</span>
          <span class="summary-chip" data-period="1W" role="button" tabindex="0">1W</span>
          <span class="summary-chip" data-period="1M" role="button" tabindex="0">1M</span>
          <span class="summary-chip" data-period="3M" role="button" tabindex="0">3M</span>
          <span class="summary-chip" data-period="6M" role="button" tabindex="0">6M</span>
          <span class="summary-chip" data-period="1Y" role="button" tabindex="0">1Y</span>
          <span class="summary-chip" data-period="All" role="button" tabindex="0">All</span>
        </div>
      </div>

      {% set primary_period_label = performance_summary.periods[0].label if performance_summary.periods else '1D' %}  
      <div style="margin:8px 0 16px 0;">
        <div style="display:flex; align-items:baseline; gap:8px; margin-bottom:2px;">
          <p style="margin:0; font-size:28px; font-weight:800;">{{ format_percentage(performance_summary.today_return_percent) }}</p>
          {% set benchmark_delta = performance_summary.today_return_percent - performance_summary.benchmark_return_percent %}
          {% set delta_positive = benchmark_delta >= 0 %}
          <span style="display:inline-flex; align-items:center; gap:6px; color:{{ 'var(--summary-green)' if delta_positive else 'var(--summary-red)' }}; font-size:13px;">
            {% if delta_positive %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
              </svg>
            {% else %}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--summary-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="1 6 10.5 15.5 15.5 10.5 23 18"></polyline>
                <polyline points="7 18 1 18 1 12"></polyline>
              </svg>
            {% endif %}
            {{ format_percentage(benchmark_delta) }} vs benchmark
          </span>
        </div>
        <p style="margin:0; color:var(--summary-muted); font-size:12px;">Portfolio return for {{ primary_period_label }} (benchmark {{ format_percentage(performance_summary.benchmark_return_percent) }})</p>
      </div>

      <div class="summary-chart-container">
        <canvas id="portfolio-performance-chart" aria-label="Portfolio performance trend" role="img"></canvas>
        <div id="portfolio-performance-empty" class="summary-chart-empty" hidden>
          No performance data available yet.
        </div>
      </div>

      <div class="summary-grid summary-grid-3 summary-period-grid" style="gap:12px;">
        {% for period in performance_summary.periods %}
          {% set period_color = period.color if period.value >= 0 else 'var(--summary-red)' %}
          <div class="summary-card--muted">
            <p style="margin:0; font-size:22px; font-weight:800; color:{{ period_color }};">{{ format_percentage(period.value) }}</p>
            <p style="margin:4px 0 0 0; color:var(--summary-muted); font-size:12px;">{{ period.label }}</p>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="summary-grid summary-grid-2">
      <div class="summary-card" style="grid-column:1/-1;">
        <div class="summary-section-title" style="margin-bottom:12px;">
          <h2>Top Holdings</h2>
          <a href="#">View All</a>
        </div>
        <div class="top-holdings-surface">
          <div class="top-holdings-toolbar">
            <label class="summary-sr-only" for="broker-filter">Filter holdings by broker</label>
            <div class="top-holdings-filter">
              <span class="top-holdings-filter__label" aria-hidden="true">Broker</span>
              <select id="broker-filter" class="top-holdings-filter__select">
                {% for broker_name in broker_names %}
                  {% set option_label = 'All brokers' if broker_name == 'All' else broker_name %}
                  <option value="{{ broker_name }}">{{ option_label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          {% if combined_holdings %}
            <div class="top-holdings-table-container">
              <table class="top-holdings-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Buy Avg Price</th>
                    <th>Sell Avg Price</th>
                    <th>LTP</th>
                    <th>P&amp;L</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for holding in combined_holdings %}
                    {% set pnl_positive = holding.pnl >= 0 %}
                    {% set symbol_display = holding.symbol or '—' %}
                    {% set avatar_text = symbol_display[:2].upper() %}
                    {% set exchange_badge = holding.exchange and holding.exchange.upper() %}
                    {% set product_label = (holding.product or 'Normal') %}
                    {% set buy_avg = holding.buy_avg_price if holding.buy_avg_price is not none else (holding.cost / holding.quantity if holding.quantity > 0 else None) %}
                    {% set sell_avg = holding.sell_avg_price if holding.sell_avg_price is not none else ((holding.cost / (-holding.quantity)) if holding.quantity < 0 else None) %}
                    {% set broker_label = holding.primary_broker or (holding.brokers|first if holding.brokers else '') %}
                    {% set broker_label = broker_label|trim %}
                    {% set broker_key = broker_label|lower|replace(' ', '') if broker_label else '' %}
                    {% set broker_key = broker_key|replace('-', '') %}
                    {% set broker_key = broker_key|replace('_', '') %}
                    {% set broker_key = broker_key|replace('&', 'and') %}
                    {% set broker_key = broker_key|replace('.', '') %}
                    {% set broker_icon = broker_icons.get(broker_key) if broker_key else None %}
                    {% set broker_icon = broker_icon or url_for('static', filename='images/logo.png') %}
                    {% set broker_alt_text = (broker_label if broker_label else 'Broker') ~ ' logo' %}
                    {% set pnl_percent = holding.pnl_percent if holding.pnl_percent is not none else ((holding.pnl / holding.cost * 100.0) if holding.cost else 0.0) %}
                    <tr data-brokers='{{ holding.brokers | tojson }}'>
                      <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div style="height: 28px; width: 28px; border-radius: 6px; background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color:#111827;">
                            {{ avatar_text }}
                          </div>
                          <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                            <span style="font-weight: 500; color:#111827;">{{ symbol_display }}</span>
                            {% if exchange_badge %}
                              <span style="border: 1px solid rgba(107,114,128,0.3); font-size: 9px; line-height: 1; padding: 2px 4px; height: 16px; border-radius: 4px; color:#374151; background-color:#ffffff;">
                                {{ exchange_badge }}
                              </span>
                            {% endif %}
                            {% if holding.sector %}
                              <span style="border: 1px solid #fde68a; background-color:#fffbeb; color:#92400e; font-size: 9px; line-height:1; padding:2px 4px; height:16px; border-radius:4px; font-weight:500;">
                                {{ holding.sector[:1].upper() }}
                              </span>
                            {% endif %}
                          </div>
                        </div>
                      </td>
                      <td>
                        <span style="border:1px solid #10b981; background-color:#ecfdf5; color:#047857; font-size:10px; line-height:1; padding:2px 6px; border-radius:4px; font-weight:500; display:inline-block;">
                          {{ product_label }}
                        </span>
                      </td>
                      <td>{{ format_quantity(holding.quantity) }}</td>
                      <td>{{ buy_avg is not none and format_currency(buy_avg) or '—' }}</td>
                      <td>{{ sell_avg is not none and format_currency(sell_avg) or '—' }}</td>
                      <td>{{ format_currency(holding.ltp) }}</td>
                      <td>
                        <span class="top-holdings-table__pnl {{ 'is-positive' if pnl_positive else 'is-negative' }}">
                          {{ format_currency(holding.pnl) }}
                          <small>{{ format_percentage(pnl_percent) }}</small>
                        </span>
                      </td>
                      <td>
                        <img src="{{ broker_icon }}" alt="{{ broker_alt_text }}" title="{{ holding.brokers|join(', ') }}" style="height: 28px; width: 28px; display: block; object-fit: contain; margin-left: auto; margin-right: auto; border-radius: 6px; background: transparent;" loading="lazy" decoding="async" />
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="top-holdings-card-list">
              {% for holding in combined_holdings %}
                {% set pnl_positive = holding.pnl >= 0 %}
                {% set symbol_display = holding.symbol or '—' %}
                {% set avatar_text = symbol_display[:2].upper() %}
                {% set product_label = (holding.product or 'Normal') %}
                {% set exchange_badge = holding.exchange and holding.exchange.upper() %}
                {% set buy_avg = holding.buy_avg_price if holding.buy_avg_price is not none else (holding.cost / holding.quantity if holding.quantity > 0 else None) %}
                {% set sell_avg = holding.sell_avg_price if holding.sell_avg_price is not none else ((holding.cost / (-holding.quantity)) if holding.quantity < 0 else None) %}
                {% set broker_label = holding.primary_broker or (holding.brokers|first if holding.brokers else '') %}
                {% set broker_label = broker_label|trim %}
                {% set broker_key = broker_label|lower|replace(' ', '') if broker_label else '' %}
                {% set broker_key = broker_key|replace('-', '') %}
                {% set broker_key = broker_key|replace('_', '') %}
                {% set broker_key = broker_key|replace('&', 'and') %}
                {% set broker_key = broker_key|replace('.', '') %}
                {% set broker_icon = broker_icons.get(broker_key) if broker_key else None %}
                {% set broker_icon = broker_icon or url_for('static', filename='images/logo.png') %}
                {% set broker_alt_text = (broker_label if broker_label and broker_label != '—' else 'Broker') ~ ' logo' %}
                {% set market_value = holding.market_value if holding.market_value is not none else (holding.cost + holding.pnl) %}
                {% set pnl_percent = holding.pnl_percent if holding.pnl_percent is not none else ((holding.pnl / holding.cost * 100.0) if holding.cost else 0.0) %}
                <div class="top-holdings-card" data-brokers='{{ holding.brokers | tojson }}'>
                  <div class="top-holdings-card__header">
                    <div class="top-holdings-card__identity">
                      <div class="top-holdings-card__avatar">{{ avatar_text }}</div>
                      <div>
                        <p class="top-holdings-card__symbol">{{ symbol_display }}</p>
                        <p class="top-holdings-card__subtitle">{{ holding.sector or 'Uncategorized' }}</p>
                      </div>
                    </div>
                    <div class="top-holdings-card__value">
                      {{ format_currency(market_value) }}
                      <span class="top-holdings-card__value-delta {{ 'is-positive' if pnl_positive else 'is-negative' }}">
                        {{ format_currency(holding.pnl) }} ({{ format_percentage(pnl_percent) }})
                      </span>
                    </div>
                  </div>
                  <div class="top-holdings-card__chips">
                    <span class="top-holdings-chip top-holdings-chip--product">{{ product_label }}</span>
                    {% if exchange_badge %}
                      <span class="top-holdings-chip">{{ exchange_badge }}</span>
                    {% endif %}
                    <span class="top-holdings-card__broker">
                      <img src="{{ broker_icon }}" alt="{{ broker_alt_text }}" title="{{ holding.brokers|join(', ') }}" loading="lazy" decoding="async">
                    </span>
                  </div>
                  <div class="top-holdings-card__meta">
                    <div class="top-holdings-card__qty">
                      <span>Qty.</span>
                      <strong>{{ format_quantity(holding.quantity) }}</strong>
                      {% if buy_avg is not none %}
                        <span>&times; {{ format_currency(buy_avg) }}</span>
                      {% endif %}
                      {% if sell_avg is not none %}
                        <span>(Sell {{ format_currency(sell_avg) }})</span>
                      {% endif %}
                    </div>
                    <div class="top-holdings-card__ltp">LTP {{ format_currency(holding.ltp) }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div style="padding: 24px 16px; text-align: center; color: #6b7280; font-size: 12px;">
              No holdings available. Connect an account or refresh your positions.
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="summary-card">
      <div class="summary-section-title" style="margin-bottom:12px;">
        <h2>Recent Transactions</h2>
        <a href="#">View All</a>
      </div>

      <div>
        {% if recent_transactions %}
          {% for txn in recent_transactions %}
            {% set action = txn.action or '' %}
            {% set is_buy = action == 'BUY' %}
            {% set is_sell = action == 'SELL' %}
            {% set is_dividend = not is_buy and not is_sell %}
            {% set icon_bg = 'rgba(5,150,105,0.10)' if is_buy else ('rgba(220,38,38,0.10)' if is_sell else 'rgba(37,99,235,0.10)') %}
            {% set icon_color = 'var(--summary-green)' if is_buy else ('var(--summary-red)' if is_sell else 'var(--summary-blue)') %}
            <div class="summary-transaction">
              <div class="info">
                <div style="width:40px; height:40px; border-radius:999px; background:{{ icon_bg }}; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                  {% if is_sell %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="17" x2="17" y2="7"></line>
                      <polyline points="7 7 17 7 17 17"></polyline>
                    </svg>
                  {% elif is_buy %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="7" y1="7" x2="17" y2="17"></line>
                      <polyline points="17 7 17 17 7 17"></polyline>
                    </svg>
                  {% else %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{{ icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M6 3h12"></path>
                      <path d="M6 8h12"></path>
                      <path d="M6 13a5 5 0 0 0 5 5h1l-6 3"></path>
                    </svg>
                  {% endif %}
                </div>
                <div style="min-width:0;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <p style="margin:0; font-weight:700;">{{ txn.symbol or '—' }}</p>
                    {% set pill_class = 'summary-pill summary-pill--sell' if is_sell else ('summary-pill summary-pill--dividend' if is_dividend else 'summary-pill') %}
                    <span class="{{ pill_class }}">{{ action.title() if action else 'Trade' }}</span>
                  </div>
                  {% set has_price = txn.price and txn.price > 0 %}  
                  <p style="margin:2px 0 0 0; color:var(--summary-muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ format_quantity(txn.quantity) }} shares{% if has_price %} @ {{ format_currency(txn.price) }}{% endif %} • {{ txn.broker or '—' }}
                  </p>
                </div>
              </div>
              <div class="timestamp">
                <time datetime="{{ txn.timestamp_iso }}">{{ format_datetime(txn.timestamp) }}</time>
              </div>
              {% set has_value = txn.value and txn.value > 0 %}
              <p class="summary-value">{{ format_currency(txn.value) if has_value else '—' }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="summary-stat-footnote" style="margin:0;">No recent transactions found.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const PAGE_NAME = "Summary";
  const templateSeriesRaw = {{ performance_summary.series | default([]) | tojson | safe }};
  const templateSeries = Array.isArray(templateSeriesRaw) ? templateSeriesRaw : [];

  const getPrefetchData = typeof window.getPagePrefetchData === "function"
    ? (page) => window.getPagePrefetchData(page)
    : () => undefined;
  const setPrefetchData = typeof window.setPagePrefetchData === "function"
    ? (page, data, options) => window.setPagePrefetchData(page, data, options)
    : () => undefined;
  const runGlobalPrefetch = typeof window.runPagePrefetch === "function"
    ? (options) => window.runPagePrefetch(PAGE_NAME, options)
    : null;

  let summaryPrefetcher = null;
  if (typeof window.registerPagePrefetcher === "function") {
    summaryPrefetcher = window.registerPagePrefetcher(PAGE_NAME, async ({ cached }) => {
      try {
        const response = await fetch("/api/summary", { credentials: "include" });
        const payload = await response.json().catch(() => null);
        if (!response.ok) {
          const message = payload?.error || `Failed to load summary data (${response.status})`;
          throw new Error(message);
        }
        if (!payload || typeof payload !== "object") {
          return cached ?? null;
        }
        const normalized = { ...payload };
        const summary = normalized.performance_summary && typeof normalized.performance_summary === "object"
          ? { ...normalized.performance_summary }
          : {};
        if (!Array.isArray(summary.series)) {
          summary.series = [];
        }
        normalized.performance_summary = summary;
        return normalized;
      } catch (error) {
        console.error("Failed to prefetch summary data", error);
        return cached ?? null;
      }
    });
  }

  const existingPayload = getPrefetchData(PAGE_NAME);
  if (!existingPayload && templateSeries.length) {
    setPrefetchData(PAGE_NAME, { performance_summary: { series: templateSeries } }, { persist: false });
  }

  if (!window.pageScripts) window.pageScripts = {};
  window.pageScripts[PAGE_NAME] = function () {
    const canvas = document.getElementById("portfolio-performance-chart");
    const emptyState = document.getElementById("portfolio-performance-empty");
    const chips = Array.from(document.querySelectorAll(".summary-chip[data-period]"));
    const chartGlobal = window.Chart;

    if (!canvas) {
      return;
    }

    const hasChart = typeof chartGlobal === "function";
    if (!hasChart) {
      canvas.setAttribute("hidden", "");
      if (emptyState) {
        emptyState.hidden = false;
      }
      return;
    }

    const PERIOD_LIMITS = {
      "1D": 1,
      "1W": 7,
      "1M": 30,
      "3M": 90,
      "6M": 180,
      "1Y": 365,
      "All": null,
    };

    let cachedSeries = [];
    let chartInstance = null;
    const hasTimeScale = !!(
      chartGlobal?.registry?.getScale?.("time") &&
      chartGlobal?._adapters?.date
    );
    const xScaleType = hasTimeScale ? "time" : "linear";

    function normalizeSeries(series) {
      if (!Array.isArray(series)) {
        return [];
      }
      return series
        .map((point) => {
          if (!point) return null;
          const date = new Date(point.timestamp);
          if (Number.isNaN(date.getTime())) return null;
          const value = Number(point.value);
          if (!Number.isFinite(value)) return null;
          return { timestamp: date.toISOString(), value };
        })
        .filter(Boolean)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }

    function mapToDataset(series) {
      return series.map((point) => {
        const date = new Date(point.timestamp);
        const xValue = hasTimeScale ? date : date.getTime();
        return { x: xValue, y: Number(point.value) };
      });
    }

    function ensureChart() {
      if (chartInstance) {
        return chartInstance;
      }
      const context = canvas.getContext("2d");
      chartInstance = new chartGlobal(context, {
        type: "line",
        data: {
          datasets: [
            {
              label: "Portfolio Performance",
              data: [],
              borderColor: "rgba(79, 70, 229, 0.9)",
              backgroundColor: "rgba(79, 70, 229, 0.12)",
              tension: 0.4,
              fill: true,
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              intersect: false,
              mode: "index",
              callbacks: {
                title: (items) => {
                  const item = items?.[0];
                  if (!item) return "";
                  const date = new Date(item.parsed.x);
                  return date.toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "numeric",
                    minute: "numeric",
                  });
                },
                label: (context) => {
                  const value = Number(context.parsed.y || 0);
                  return `Portfolio Value: ${value.toLocaleString(undefined, {
                    style: "currency",
                    currency: "INR",
                    maximumFractionDigits: 2,
                  })}`;
                },
              },
            },
          },
          interaction: {
            intersect: false,
            mode: "index",
          },
          scales: {
            x: {
              type: xScaleType,
              grid: {
                display: false,
              },
              ticks: {
                maxTicksLimit: 8,
                color: "rgba(148, 163, 184, 0.9)",
                autoSkip: true,
              },
            },
            y: {
              beginAtZero: false,
              grid: {
                color: "rgba(226, 232, 240, 0.5)",
              },
              ticks: {
                callback: (value) => `₹${Number(value).toLocaleString()}`,
                color: "rgba(100, 116, 139, 0.9)",
              },
            },
          },
        },
      });
      return chartInstance;
    }

    function toggleState(hasData) {
      const chart = ensureChart();
      if (!chart) return;
      if (hasData) {
        canvas.removeAttribute("hidden");
        if (emptyState) {
          emptyState.hidden = true;
        }
      } else {
        canvas.setAttribute("hidden", "");
        if (emptyState) {
          emptyState.hidden = false;
        }
      }
    }

    function updateChart(series) {
      const chart = ensureChart();
      if (!chart) return;

      const hasData = Array.isArray(series) && series.length > 0;
      toggleState(hasData);
      chart.data.datasets[0].data = mapToDataset(series);
      chart.update();
    }

    function setActiveChip(period) {
      chips.forEach((chip) => {
        if (chip.dataset.period === period) {
          chip.classList.add("active");
          chip.setAttribute("aria-pressed", "true");
        } else {
          chip.classList.remove("active");
          chip.setAttribute("aria-pressed", "false");
        }
      });
    }

    function readInitialSeries() {
      const payload = getPrefetchData(PAGE_NAME);
      const cached = payload?.performance_summary?.series;
      if (Array.isArray(cached) && cached.length) {
        return cached;
      }
      return templateSeries;
    }

    let activePeriod = chips[0]?.dataset.period || "1M";

    function filterSeries(period) {
      if (!period || !(period in PERIOD_LIMITS)) {
        return cachedSeries.slice();
      }
      const limit = PERIOD_LIMITS[period];
      if (!limit) {
        return cachedSeries.slice();
      }
      const now = Date.now();
      const cutoff = now - limit * 24 * 60 * 60 * 1000;
      return cachedSeries.filter(point => new Date(point.timestamp).getTime() >= cutoff);
    }

    function findFallbackSeries(excludePeriod) {
      const periodOrder = Object.keys(PERIOD_LIMITS);
      const candidateOrder = excludePeriod
        ? [excludePeriod, ...periodOrder.filter(period => period !== excludePeriod)]
        : Object.keys(PERIOD_LIMITS);

      for (const candidate of candidateOrder) {
        if (!candidate || candidate === excludePeriod) {
          continue;
        }
        const candidateSeries = filterSeries(candidate);
        if (candidateSeries.length) {
          return { period: candidate, series: candidateSeries };
        }
      }

      return { period: excludePeriod, series: cachedSeries.slice() };
    }

    function applyPeriod(period) {
      if (!period || !(period in PERIOD_LIMITS)) {
        period = activePeriod;
      }
      let resolvedPeriod = period;
      let series = filterSeries(period);

      if (!series.length && cachedSeries.length) {
        const fallback = findFallbackSeries(period);
        resolvedPeriod = fallback.period;
        series = fallback.series;
      }

      activePeriod = resolvedPeriod;
      setActiveChip(resolvedPeriod);
      updateChart(series);
    }

    function syncFromPrefetch() {
      const payload = getPrefetchData(PAGE_NAME);
      const incoming = payload?.performance_summary?.series;
      if (Array.isArray(incoming)) {
        cachedSeries = normalizeSeries(incoming);
        applyPeriod(activePeriod);
      } else if (!cachedSeries.length) {
        toggleState(false);
      }
    }

    function refreshSeries(arg) {
      const isEvent = arg && typeof arg === "object" && typeof arg.type === "string";
      const requestedForce = !isEvent && arg && typeof arg === "object" && "force" in arg
        ? !!arg.force
        : false;
      const shouldForce = requestedForce || !cachedSeries.length;
      const runner = summaryPrefetcher || runGlobalPrefetch;

      if (typeof runner !== "function") {
        syncFromPrefetch();
        return Promise.resolve();
      }

      return Promise.resolve(runner({ force: shouldForce }))
        .then(() => {
          syncFromPrefetch();
        })
        .catch((error) => {
          console.error("Failed to refresh summary data", error);
          if (!cachedSeries.length) {
            toggleState(false);
          }
        });
    }

    function bootstrap() {
      cachedSeries = normalizeSeries(readInitialSeries());
      applyPeriod(activePeriod);
      refreshSeries({ force: !cachedSeries.length });

      const REFRESH_EVENT_KEY = "__summaryRefreshHandler";
      if (window[REFRESH_EVENT_KEY]) {
        document.removeEventListener("summary:refresh", window[REFRESH_EVENT_KEY]);
      }
      window[REFRESH_EVENT_KEY] = refreshSeries;
      document.addEventListener("summary:refresh", refreshSeries);
    }

    const startBootstrap = () => {
      if (startBootstrap._ran) {
        return;
      }
      startBootstrap._ran = true;
      bootstrap();
    };

    chips.forEach((chip) => {
      if (chip.dataset.bound === "true") {
        return;
      }
      chip.dataset.bound = "true";
      const handleActivate = () => {
        startBootstrap();
        applyPeriod(chip.dataset.period);
      };
      chip.addEventListener("click", handleActivate);
      chip.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handleActivate();
        }
      });
    });

    if ("requestIdleCallback" in window) {
      requestIdleCallback(startBootstrap, { timeout: 500 });
    } else {
      setTimeout(startBootstrap, 0);
    }
  };
})();
</script>
{% endblock %}
