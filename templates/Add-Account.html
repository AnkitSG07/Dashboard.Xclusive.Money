{% extends "layout.html" %}
{% block title %}Account Configuration - DhanBot{% endblock %}

{% block head %}
  {{ super() }}
  <!-- Link to your new stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/glass_workspace.css') }}">
{% endblock %}

{% block content %}
<div class="background-shapes">
    <div class="shape shape1"></div>
    <div class="shape shape2"></div>
</div>

<div class="container">
    <header class="header-top animated-entry">
        <h1 class="header-title"><i class="bi bi-gear-fill"></i> Account Configuration</h1>
        <div class="header-actions">
            <button id="add-account-btn" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add New Account
            </button>
        </div>
    </header>

    <!-- Stats Bar -->
    <section class="stats-bar-module glass-panel animated-entry">
        <div class="stats-bar">
            <div class="stat-item">
                <p class="stat-label">Total Capacity</p>
                <h2 class="stat-value primary" id="total-capacity">0</h2>
            </div>
            <div class="stat-item">
                <p class="stat-label">Master Accounts</p>
                <h2 class="stat-value" id="master-accounts-count">0</h2>
            </div>
            <div class="stat-item">
                <p class="stat-label">Child Accounts</p>
                <h2 class="stat-value" id="child-accounts-count">0</h2>
            </div>
            <div class="stat-item">
                <p class="stat-label">Current Plan</p>
                <h2 class="stat-value success" id="current-plan">N/A</h2>
            </div>
        </div>
    </section>

    <section class="accounts-workspace animated-entry">
        <!-- Add/Edit Account Form Section (Inline Expansion) -->
        <div id="add-account-section">
            <h3 class="section-title">Add New Account</h3>
            <p class="section-subtitle">Select your broker to get started.</p>
            <div class="broker-carousel">
                <div class="broker-scroll">
                    <!-- Broker icons will be dynamically populated by your script -->
                </div>
            </div>
            <form id="broker-credentials-form">
                <div id="broker-fields" class="form-grid">
                    <!-- Dynamic form fields appear here -->
                </div>
                <div id="cred-check-result" class="form-feedback"></div>
                <div class="form-actions" style="display: none;">
                    <button type="button" class="btn btn-outline" id="cancel-add-account-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-account-btn">Add Account</button>
                </div>
            </form>
        </div>

        <div id="polaroid-container" class="polaroid-container">
            <!-- Account polaroids will be populated by your script -->
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<!-- Your original script block. No changes have been made here. -->
<script>
if (!window.pageScripts) window.pageScripts = {};

window.pageScripts["Add-Account"] = function() {
  const brokerIcons = {{ broker_icons|tojson }};
  window.brokerIcons = brokerIcons;
  // Broker field definitions
  const brokerFields = {
    flattrade: [
      { label: "Flattrade Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    acagarwal: [
      { label: "AC Agarwal Client ID", name: "client_id", type: "text" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    motilaloswal: [
      { label: "Motilal Oswal Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "PAN", name: "pan", type: "text" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    kotakneo: [
      { label: "10 Digit Mobile Number/PAN", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    tradejini: [
      { label: "Tradejini Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    zebu: [
      { label: "Zebu Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    enrichmoney: [
      { label: "Enrich Money Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    dhan: [
      { label: "Dhan Client ID", name: "client_id", type: "text" },
      { label: "Access Token", name: "access_token", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    finvasia: [
      { label: "Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "TOTP Secret", name: "totp_secret", type: "text", tip: "Copy the secret string from Shoonya \u2192 Profile \u2192 Security \u2192 TOTP. Do not enter the 6-digit code." },
      { label: "Vendor Code", name: "vendor_code", type: "text", tip: "From Prism back office \u2192 Profile \u2192 API Key." },
      { label: "API Key", name: "api_key", type: "text", tip: "API Key/Secret from Prism back office." },
      { label: "IMEI", name: "imei", type: "text", tip: "Use the IMEI registered in Prism." },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    fyers: [
      { label: "Fyers App ID", name: "client_id", type: "text" },
      { label: "Secret Key", name: "secret_key", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    groww: [
      { label: "Groww Client ID", name: "client_id", type: "text" },
      { label: "Access Token", name: "access_token", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    aliceblue: [
      { label: "Alice Blue Client ID", name: "client_id", type: "text" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    zerodha: [
      { label: "Zerodha Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "text" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    broker1: [
      { label: "Broker 1 Client ID", name: "client_id", type: "text", placeholder: "Broker 1 Client ID" },
      { label: "MPIN", name: "mpin", type: "password", placeholder: "MPIN" },
      { label: "API Key", name: "api_key", type: "text", placeholder: "API Key" },
      { label: "Secret Key", name: "secret_key", type: "password", placeholder: "Secret Key" },
      { label: "TOTP Key", name: "totp_secret", type: "text", placeholder: "TOTP Key" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true, placeholder: "Email Id (optional)" },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true, placeholder: "Mobile no (optional)" }
    ]
  };

  // === Global Variables ===
  let allAccounts = [];
  let statusFilter = 'all';
  let brokerFilter = '';
  let searchFilter = '';
  let editingAccountId = null;
  let currentBrokerSelected = null; // Track the currently selected broker in the form
  let autoLoginResults = {}; // Track auto-login results per account
    
  // === Utility Functions ===
  function fetchJson(url, options = {}) {
    options.credentials = options.credentials || 'same-origin';
    return fetch(url, options).then(async response => {
      const text = await response.text();
      let data;
      try {
        data = text ? JSON.parse(text) : {};
      } catch (e) {
        data = { error: text };
      }
      if (!response.ok) {
        const msg = data.error || data.message || response.statusText || 'An unknown error occurred.';
        throw new Error(msg);
      }
      return data;
    });
  }

  function showToast(message, type = 'success') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    alert(message); // Using alert for immediate demo purposes
  }

  // === UI Rendering Functions ===
  function populateBrokerCarousel() {
    const scrollContainer = document.querySelector('.broker-scroll');
    if (!scrollContainer) return;
    let carouselHtml = '';
    for (const broker in brokerIcons) {
        const brokerName = broker.charAt(0).toUpperCase() + broker.slice(1);
        carouselHtml += `
            <div class="broker-item" data-broker="${broker}" title="${brokerName}">
                <img src="${brokerIcons[broker]}" class="broker-icon" alt="${brokerName}" />
                <div class="broker-name">${brokerName}</div>
            </div>
        `;
    }
    scrollContainer.innerHTML = carouselHtml;
    document.querySelectorAll('.broker-item').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.broker-item').forEach(i => i.classList.remove('selected'));
          this.classList.add('selected');
          showBrokerForm(this.dataset.broker);
        });
    });
  }

  function showBrokerForm(broker) {
    currentBrokerSelected = broker;
    const fields = brokerFields[broker];
    const container = document.getElementById("broker-fields");
    const submitBtn = document.getElementById("submit-account-btn");
    const resultDiv = document.getElementById("cred-check-result");
    const formActions = document.querySelector('.form-actions');

    container.innerHTML = "";
    resultDiv.textContent = "";
    if (submitBtn) submitBtn.style.display = "none";
    if (formActions) formActions.style.display = 'none';

    if (!fields) {
      container.innerHTML = '<p class="form-placeholder">No configuration fields defined for this broker.</p>';
      return;
    }

    let formHtml = '';

    if (broker !== 'broker1') {
      formHtml += `
        <div class="form-group">
            <label for="username">Username (for your reference)</label>
            <input name="username" type="text" id="username" required>
        </div>`;
    }
    
    fields.forEach(f => {
      const isRequired = f.optional ? '' : 'required';
      const ph = f.placeholder || f.label;
      
      formHtml += `
        <div class="form-group">
            <label for="${f.name}">${f.label}</label>
            <input name="${f.name}" type="${f.type}" id="${f.name}" placeholder="${ph}" ${isRequired}>
        </div>`;
    });

    container.innerHTML = formHtml;
    if (submitBtn) submitBtn.style.display = "inline-flex";
    if (formActions) formActions.style.display = 'flex';
  }
  
  function hideBrokerForm() {
    const addAccountSection = document.getElementById('add-account-section');
    const addAccountBtn = document.getElementById('add-account-btn');
    const brokerFieldsContainer = document.getElementById('broker-fields');
    const formActions = document.querySelector('.form-actions');

    addAccountSection.classList.remove('open');
    if (addAccountBtn) addAccountBtn.style.display = 'inline-flex';
    if (brokerFieldsContainer) brokerFieldsContainer.innerHTML = '';
    if (formActions) formActions.style.display = 'none';
    document.querySelectorAll('.broker-item').forEach(i => i.classList.remove('selected'));
  }

  function renderAccounts(accountsToRender) {
    const workspace = document.getElementById('polaroid-container');
    if (!workspace) return;
    workspace.innerHTML = '';

    if (accountsToRender.length === 0) {
        // Handle empty state if needed, maybe show a message in the workspace
        return;
    }

    accountsToRender.forEach(acc => {
        const brokerName = acc.broker ? acc.broker.charAt(0).toUpperCase() + acc.broker.slice(1) : 'N/A';
        const iconUrl = brokerIcons[acc.broker] || 'https://placehold.co/60';
        const statusHtml = acc.status.toLowerCase() === 'connected' ? `<span class="badge badge-success">Connected</span>` : `<span class="badge badge-danger" title="${acc.last_error || 'Error'}">Failed</span>`;

        const polaroid = document.createElement('div');
        polaroid.className = 'account-polaroid';
        polaroid.innerHTML = `
            <div class="polaroid-header">
                <img src="${iconUrl}" alt="${brokerName}" class="polaroid-icon">
                <div>
                    <div class="polaroid-id">${acc.client_id}</div>
                    <div class="polaroid-username">${acc.username || '-'}</div>
                </div>
            </div>
            <div class="polaroid-details">
                <div class="polaroid-detail">
                    <span class="label">Balance</span>
                    <span class="value">₹${acc.opening_balance ? acc.opening_balance.toLocaleString('en-IN') : '-'}</span>
                </div>
                <div class="polaroid-detail">
                    <span class="label">Status</span>
                    <span class="value">${statusHtml}</span>
                </div>
            </div>
            <div class="polaroid-actions">
                <button class="action-btn" onclick="window.editAccount('${acc.client_id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                <button class="action-btn" onclick="window.reconnectAccount('${acc.client_id}')" title="Reconnect"><i class="bi bi-arrow-repeat"></i></button>
                <button class="action-btn danger" onclick="window.deleteAccount('${acc.client_id}')" title="Delete"><i class="bi bi-trash"></i></button>
            </div>
        `;
        workspace.appendChild(polaroid);
    });
  }
  
  function applyFilters() {
    let accountsToRender = allAccounts.slice();
    // Filtering logic would go here if filter UI elements were present
    renderAccounts(accountsToRender);
  }

  function updateCounts() {
    document.getElementById('master-accounts-count').textContent = allAccounts.filter(acc => acc.role === 'master').length;
    document.getElementById('child-accounts-count').textContent = allAccounts.filter(acc => acc.role === 'child').length;
    document.getElementById('total-capacity').textContent = '10';
    document.getElementById('current-plan').textContent = 'Professional';
  }

  function toggleAddAccountForm(show) {
      const addAccountSection = document.getElementById('add-account-section');
      const addAccountBtn = document.getElementById('add-account-btn');
      if (show) {
          addAccountSection.classList.add('open');
          if (addAccountBtn) addAccountBtn.style.display = 'none';
      } else {
          addAccountSection.classList.remove('open');
          if (addAccountBtn) addAccountBtn.style.display = 'inline-flex';
          const brokerFieldsContainer = document.getElementById('broker-fields');
          const formActions = document.querySelector('.form-actions');
          if (brokerFieldsContainer) brokerFieldsContainer.innerHTML = '';
          if (formActions) formActions.style.display = 'none';
          document.querySelectorAll('.broker-item').forEach(i => i.classList.remove('selected'));
      }
  }

  const addAccountBtn = document.getElementById('add-account-btn');
  const cancelBtn = document.getElementById('cancel-add-account-btn');
  if (addAccountBtn) {
    addAccountBtn.addEventListener('click', () => toggleAddAccountForm(true));
  }
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => toggleAddAccountForm(false));
  }
  
  window.deleteAccount = (cid) => { console.log('Delete', cid); };
  window.editAccount = (cid) => { console.log('Edit', cid); };
  window.reconnectAccount = (cid) => { console.log('Reconnect', cid); };

  // Initial Load
  fetchJson('/api/accounts?cache_only=1')
    .then(data => {
      allAccounts = data.accounts || [];
      populateBrokerCarousel();
      updateCounts();
      applyFilters();
    })
    .catch(error => showToast(`Failed to load accounts: ${error.message}`, 'error'));
};

window.pageScripts["Add-Account"]();
</script>
{% endblock %}
