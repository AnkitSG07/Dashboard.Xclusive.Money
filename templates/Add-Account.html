{% extends "layout.html" %}
{% block title %}Account Configuration - DhanBot{% endblock %}
{% block head %}
  {{ super() }}
  <style>
    :root {
      --bs-primary: #007bff; /* A standard primary blue */
      --bs-secondary: #6c757d;
      --bs-success: #28a745;
      --bs-info: #17a2b8;
      --bs-warning: #ffc107;
      --bs-danger: #dc3545;
      --bs-light: #f8f9fa;
      --bs-dark: #343a40;

      /* Soft shadows */
      --bs-box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
      --bs-box-shadow-sm: 0 .125rem .25rem rgba(0,0,0,.06);
      --bs-box-shadow-lg: 0 .5rem 1rem rgba(0,0,0,.15);

      /* Rounded corners */
      --bs-border-radius: .5rem;
      --bs-border-radius-lg: .75rem;

      /* Backgrounds */
      --bs-body-bg: #f4f7f6;
      --bs-light-bg: #fdfefe; /* A slightly off-white for internal cards/elements */
    }

    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
      background-color: var(--bs-body-bg);
      color: var(--bs-dark);
    }

    .container-fluid {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }

    .card {
      border: none;
      border-radius: var(--bs-border-radius-lg);
      box-shadow: var(--bs-box-shadow);
      transition: all 0.2s ease-in-out;
      background-color: white; /* Default card background */
    }

    .card:hover {
      box-shadow: var(--bs-box-shadow-lg);
      transform: translateY(-2px);
    }

    .card-header {
      background-color: var(--bs-light); /* Lighter header for general cards */
      border-bottom: none;
      border-top-left-radius: var(--bs-border-radius-lg);
      border-top-right-radius: var(--bs-border-radius-lg);
      font-weight: 600;
      padding: 1.25rem 1.5rem;
    }

    /* Hero section specific styling */
    .hero-section {
        background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%);
        color: white;
        padding: 2.5rem !important;
        border-radius: var(--bs-border-radius-lg) !important;
        box-shadow: var(--bs-box-shadow-lg) !important;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    .hero-section h2, .hero-section p {
        color: white !important;
    }
    .hero-section .btn-light {
        background-color: rgba(255, 255, 255, 0.9);
        color: var(--bs-primary) !important;
        border: none;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
    }
    .hero-section .btn-light:hover {
        background-color: white;
    }

    /* Summary cards styling */
    .summary-card .card-body {
        padding: 1rem;
    }
    .summary-card .card-title {
        font-size: 1.6rem;
    }

    /* Broker carousel styling */
    .broker-icon-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 clamp(0.25rem, 1.2vw, 0.4rem);
      flex-shrink: 0;
      min-width: 0;
      flex-basis: clamp(3.2rem, 12vw, 4.2rem);
    }
    
    .broker-icon {
      width: clamp(2.8rem, 10vw, 3.8rem);
      height: clamp(2.8rem, 10vw, 3.8rem);
      border-radius: 50%;
      background: var(--bg-input); /* Light gray background */
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light); /* Light border */
      object-fit: contain;
      padding: clamp(0.25rem, 1vw, 0.35rem);
      transition: all 0.15s ease;
      cursor: pointer;
      margin-bottom: 0.5rem;
    }
    
    .broker-icon:hover,
    .broker-icon.selected,
    .broker-icon.border-primary {
      border-color: var(--primary); /* Primary blue border */
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
      background: var(--bg-hover); /* Light gray hover */
      transform: translateY(-0.05rem);
    }
    
    .broker-scroll {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 0.6rem;
      scrollbar-width: thin;
      scrollbar-color: var(--text-muted) var(--bg-input);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .broker-scroll::-webkit-scrollbar {
      height: 0.4rem;
    }
    
    .broker-scroll::-webkit-scrollbar-track {
      background: var(--bg-light-gray); /* Light scrollbar track */
      border-radius: 0.2rem;
    }
    
    .broker-scroll::-webkit-scrollbar-thumb {
      background-color: var(--text-muted); /* Muted dark scrollbar thumb */
      border-radius: 0.2rem;
      border: 1px solid var(--bg-light-gray);
    }
    
    .broker-scroll > div {
      flex: 0 0 auto;
    }
      .broker-icon {
        width: 4rem;
        height: 4rem;
        padding: 0.35rem;
      }
      .broker-icon-wrap {
        margin: 0 0.4rem;
      }
    
      .card, .section-box, .profile-card, .main-content {
      word-break: break-word;
      overflow-wrap: break-word;
      min-width: 0;
      max-width: 100%;
    }


    /* Form styling */
    .form-label {
        font-weight: 500;
        color: var(--bs-dark);
    }
    .form-control:read-only {
        background-color: var(--bs-light);
        opacity: 0.7;
    }

    /* Filter/Search bar styling */
    .filter-search-bar .form-select,
    .filter-search-bar .form-control {
        border-radius: var(--bs-border-radius-sm);
    }
    .filter-search-bar .input-group-text {
        border-radius: var(--bs-border-radius-sm) 0 0 var(--bs-border-radius-sm);
    }

    /* Connected Accounts Card (replacing table rows) */
    .account-card {
        background-color: var(--bs-light-bg);
        border: 1px solid var(--bs-gray-200);
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }

    .account-card-body {
        flex-grow: 1; /* Allow content to push actions to bottom */
    }

    .account-card-footer {
        background-color: var(--bs-light);
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--bs-gray-200);
        border-bottom-left-radius: calc(var(--bs-border-radius-lg) - 1px);
        border-bottom-right-radius: calc(var(--bs-border-radius-lg) - 1px);
    }

    .account-card .status-badge {
        font-size: 0.75rem;
        padding: 0.3em 0.6em;
        border-radius: var(--bs-border-radius-sm);
    }

    .account-card .action-buttons .btn-sm {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
    }

    /* Responsiveness */
    @media (max-width: 767.98px) {
        .hero-section {
            padding: 1.5rem !important;
            flex-direction: column;
            align-items: flex-start;
        }
        .hero-section .mb-3.mb-md-0 {
            width: 100%;
        }
        .hero-section .btn-lg {
            width: 100%;
            text-align: center;
        }

        .summary-card {
            margin-bottom: 1rem; /* Add spacing between summary cards on mobile */
        }

        .filter-search-bar .flex-grow-1 {
            max-width: 100% !important; /* Full width for filters on mobile */
            margin-bottom: 0.75rem;
        }
        .filter-search-bar .flex-grow-1:last-child {
            margin-bottom: 0;
        }

        .account-card .card-body {
            padding-bottom: 0.5rem; /* Reduce padding slightly */
        }
        .account-card .action-buttons {
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        .account-card .action-buttons .btn {
            flex-grow: 1;
            max-width: calc(50% - 0.25rem); /* Two buttons per row */
        }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="hero-section mb-5">
        <div class="me-auto me-md-0 mb-3 mb-md-0">
            <h2 class="mb-2"><i class="bi bi-gear-fill me-2"></i> Account Configuration</h2>
            <p class="lead">Manage your trading accounts. Add, edit, or reconnect accounts from multiple brokers.</p>
        </div>
        <button id="add-account-btn" class="btn btn-light btn-lg shadow-sm">
            <i class="bi bi-plus-circle me-2"></i> Add New Account
        </button>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-sm rounded-3 summary-card bg-light">
                <div class="card-body">
                    <p class="card-text text-muted mb-1 small">Total Capacity</p>
                    <h4 class="card-title fw-bold text-primary" id="total-capacity">0</h4>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-sm rounded-3 summary-card bg-light">
                <div class="card-body">
                    <p class="card-text text-muted mb-1 small">Master Accounts</p>
                    <h4 class="card-title fw-bold text-info" id="master-accounts-count">0</h4>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-sm rounded-3 summary-card bg-light">
                <div class="card-body">
                    <p class="card-text text-muted mb-1 small">Child Accounts</p>
                    <h4 class="card-title fw-bold text-secondary" id="child-accounts-count">0</h4>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-sm rounded-3 summary-card bg-light">
                <div class="card-body">
                    <p class="card-text text-muted mb-1 small">Current Plan</p>
                    <h4 class="card-title fw-bold text-success" id="current-plan">N/A</h4>
                </div>
            </div>
        </div>
    </div>

    <div id="add-account-section" class="card shadow-lg border-0 rounded-3 mb-5" style="display:none;">
        <div class="card-body p-4">
            <h5 class="card-title mb-4 text-primary d-flex align-items-center">
                <i class="bi bi-person-add me-2"></i> Add/Edit Account Details
            </h5>

            <p class="text-muted small mb-3">Select your broker to configure account credentials.</p>
            <div class="broker-carousel overflow-auto mb-4 pb-2">
                <div class="broker-scroll d-flex align-items-center gap-4 px-2">
                    <div class="text-center broker-selection-item" data-broker="broker1" title="Broker 1">
                        <img src="/static/images/logo.svg" class="broker-icon" alt="Broker 1" />
                        <div class="small text-muted mt-1">Broker 1</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="zerodha" title="Zerodha">
                        <img src="/static/images/zerodha.png" class="broker-icon" alt="Zerodha" />
                        <div class="small text-muted mt-1">Zerodha</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="aliceblue" title="Alice Blue">
                        <img src="/static/images/aliceblue.jpg" class="broker-icon" alt="Alice Blue" />
                        <div class="small text-muted mt-1">Alice Blue</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="groww" title="Groww">
                        <img src="/static/images/groww.png" class="broker-icon" alt="Groww" />
                        <div class="small text-muted mt-1">Groww</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="fyers" title="Fyers">
                        <img src="/static/images/fyers.png" class="broker-icon" alt="Fyers" />
                        <div class="small text-muted mt-1">Fyers</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="finvasia" title="Finvasia">
                        <img src="/static/images/finvasia.jpg" class="broker-icon" alt="Finvasia" />
                        <div class="small text-muted mt-1">Finvasia</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="dhan" title="Dhan">
                        <img src="/static/images/dhan.jpg" class="broker-icon" alt="Dhan" />
                        <div class="small text-muted mt-1">Dhan</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="flattrade" title="Flattrade">
                        <img src="/static/images/flattrade.jpg" class="broker-icon" alt="Flattrade" />
                        <div class="small text-muted mt-1">Flattrade</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="acagarwal" title="AC Agarwal">
                        <img src="/static/images/acagarwal.jpg" class="broker-icon" alt="AC Agarwal" />
                        <div class="small text-muted mt-1">AC Agarwal</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="motilaloswal" title="Motilal Oswal">
                        <img src="/static/images/motilaloswal.png" class="broker-icon" alt="Motilal Oswal" />
                        <div class="small text-muted mt-1">Motilal Oswal</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="kotakneo" title="Kotak Neo">
                        <img src="/static/images/kotakneo.png" class="broker-icon" alt="Kotak Neo" />
                        <div class="small text-muted mt-1">Kotak Neo</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="tradejini" title="Tradejini">
                        <img src="/static/images/tradejini.png" class="broker-icon" alt="Tradejini" />
                        <div class="small text-muted mt-1">Tradejini</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="zebu" title="Zebu">
                        <img src="/static/images/zebu.jpg" class="broker-icon" alt="Zebu" />
                        <div class="small text-muted mt-1">Zebu</div>
                    </div>
                    <div class="text-center broker-selection-item" data-broker="enrichmoney" title="Enrich Money">
                        <img src="/static/images/enrichmoney.jpg" class="broker-icon" alt="Enrich Money" />
                        <div class="small text-muted mt-1">Enrich Money</div>
                    </div>
                </div>
            </div>

            <form id="broker-credentials-form" class="row g-3">
                <div id="broker-fields" class="col-12">
                    <p class="text-center text-muted py-3">Please select a broker above to view configuration fields.</p>
                </div>
                <div id="cred-check-result" class="col-12 mt-2"></div>
                <div class="col-12 d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="cancel-add-account-btn">Close</button>
                    <button type="submit" class="btn btn-success" style="display:none;" id="submit-account-btn">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-4">
            <h5 class="card-title mb-4 text-dark d-flex align-items-center">
                <i class="bi bi-list-columns-reverse me-2"></i> Your Connected Accounts
            </h5>

            <ul class="nav nav-tabs nav-tabs-alt mb-3" id="status-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-status="all">All
                        <span class="badge rounded-pill bg-secondary ms-1" id="tab-count-all">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-status="success">Connected
                        <span class="badge rounded-pill bg-success ms-1" id="tab-count-success">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-status="failed">Failed
                        <span class="badge rounded-pill bg-danger ms-1" id="tab-count-failed">0</span>
                    </a>
                </li>
            </ul>

            <div class="d-flex flex-wrap gap-3 mb-4 filter-search-bar">
                <div class="flex-grow-1" style="max-width: 200px;">
                    <label for="broker-filter" class="visually-hidden">Filter by Broker</label>
                    <select class="form-select" id="broker-filter" aria-label="Filter by Broker"></select>
                </div>
                <div class="flex-grow-1" style="max-width: 280px;">
                    <label for="account-search" class="visually-hidden">Search Accounts</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="search" class="form-control" id="account-search" placeholder="Search by Client ID or Username" aria-label="Search Accounts">
                    </div>
                </div>
            </div>

            <div id="accounts-card-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                </div>
            <div id="accounts-empty-state" class="text-center p-4 text-muted border rounded mt-3" style="display: none;">
                <i class="bi bi-info-circle-fill fs-3 text-info mb-2"></i>
                <p class="mb-0">No accounts found matching your criteria.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
if (!window.pageScripts) window.pageScripts = {};

window.pageScripts["Add-Account"] = function() {
  const brokerIcons = {{ broker_icons|tojson }};
  window.brokerIcons = brokerIcons;
  // Broker field definitions
  const brokerFields = {
    flattrade: [
      { label: "Flattrade Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    acagarwal: [
      { label: "AC Agarwal Client ID", name: "client_id", type: "text" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    motilaloswal: [
      { label: "Motilal Oswal Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "PAN", name: "pan", type: "text" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    kotakneo: [
      { label: "10 Digit Mobile Number/PAN", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    tradejini: [
      { label: "Tradejini Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    zebu: [
      { label: "Zebu Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    enrichmoney: [
      { label: "Enrich Money Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    dhan: [
      { label: "Dhan Client ID", name: "client_id", type: "text" },
      { label: "Access Token", name: "access_token", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    finvasia: [
      { label: "Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "TOTP Secret", name: "totp_secret", type: "text", tip: "Copy the secret string from Shoonya \u2192 Profile \u2192 Security \u2192 TOTP. Do not enter the 6-digit code." },
      { label: "Vendor Code", name: "vendor_code", type: "text", tip: "From Prism back office \u2192 Profile \u2192 API Key." },
      { label: "API Key", name: "api_key", type: "text", tip: "API Key/Secret from Prism back office." },
      { label: "IMEI", name: "imei", type: "text", tip: "Use the IMEI registered in Prism." },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    fyers: [
      { label: "Fyers App ID", name: "client_id", type: "text" },
      { label: "Secret Key", name: "secret_key", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    groww: [
      { label: "Groww Client ID", name: "client_id", type: "text" },
      { label: "Access Token", name: "access_token", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    aliceblue: [
      { label: "Alice Blue Client ID", name: "client_id", type: "text" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    zerodha: [
      { label: "Zerodha Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "text" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    broker1: [
      { label: "Broker 1 Client ID", name: "client_id", type: "text", placeholder: "Broker 1 Client ID" },
      { label: "MPIN", name: "mpin", type: "password", placeholder: "MPIN" },
      { label: "API Key", name: "api_key", type: "text", placeholder: "API Key" },
      { label: "Secret Key", name: "secret_key", type: "password", placeholder: "Secret Key" },
      { label: "TOTP Key", name: "totp_secret", type: "text", placeholder: "TOTP Key" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true, placeholder: "Email Id (optional)" },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true, placeholder: "Mobile no (optional)" }
    ]
  };

  // === Global Variables ===
  let allAccounts = [];
  let statusFilter = 'all';
  let brokerFilter = '';
  let searchFilter = '';
  let editingAccountId = null;
  let currentBrokerSelected = null; // Track the currently selected broker in the form
  let autoLoginResults = {}; // Track auto-login results per account
    
  // === Utility Functions ===
  function fetchJson(url, options = {}) {
    return fetch(url, options).then(response => {
      if (!response.ok) {
        return response.json().then(errorData => {
          throw new Error(errorData.error || 'An unknown error occurred.');
        });
      }
      return response.json();
    });
  }

  // Placeholder for a toast notification system (e.g., Bootstrap Toasts, SweetAlert2)
  function showToast(message, type = 'success') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    alert(message); // Using alert for immediate demo purposes
  }

  // === UI Rendering Functions ===
  function showBrokerFields(broker) {
    currentBrokerSelected = broker;
    const fields = brokerFields[broker];
    const container = document.getElementById("broker-fields");
    const submitBtn = document.getElementById("submit-account-btn");
    const resultDiv = document.getElementById("cred-check-result");
    const cancelBtn = document.getElementById("cancel-add-account-btn"); // Get the close button

    container.innerHTML = "";
    resultDiv.textContent = ""; // Clear previous validation messages
    submitBtn.style.display = "none"; // Hide submit until fields are rendered
    cancelBtn.textContent = "Close"; // Ensure the button text is "Close"

    if (!fields) {
      container.innerHTML = '<p class="text-center text-muted py-3">No configuration fields defined for this broker.</p>';
      return;
    }

    let formHtml = '';

    // Only add Username field if the broker is NOT 'broker1' as per image requirement
    if (broker !== 'broker1') {
      formHtml += `
        <div class="col-md-6">
            <label for="username" class="form-label">Username (for your reference)</label>
            <input class="form-control" name="username" type="text" id="username" required>
        </div>`;
    }
    
    // Sort fields based on the provided image for 'broker1'
    const broker1FieldOrder = ["client_id", "mpin", "api_key", "secret_key", "totp_secret", "email", "mobile"];
    const sortedFields = broker === 'broker1' ? 
                         [...fields].sort((a, b) => broker1FieldOrder.indexOf(a.name) - broker1FieldOrder.indexOf(b.name)) : 
                         fields;

    sortedFields.forEach(f => {
      const isRequired = f.optional ? '' : 'required'; // Use optional property
      const ph = f.placeholder ? ` placeholder="${f.placeholder}"` : '';
      const val = f.value ? ` value="${f.value}"` : '';
      let inputEl;

      if (f.type === 'password') {
        inputEl = `
          <div class="input-group">
            <input class="form-control" name="${f.name}" type="password" ${ph} ${val} ${isRequired}>
            <button type="button" class="btn btn-outline-secondary toggle-pass" aria-label="Toggle password visibility">
              <i class="bi bi-eye"></i>
            </button>
          </div>`;
      } else {
        inputEl = `<input class="form-control" name="${f.name}" type="${f.type}" ${ph} ${val} ${isRequired}>`;
      }
      
      // Removed <label> element and replaced with placeholder in Broker 1 fields as per image
      // For other brokers, labels remain as they were not specified in the image.
      formHtml += `
        <div class="col-md-6">
            ${broker !== 'broker1' || !f.placeholder ? `<label for="${f.name}" class="form-label">${f.label}</label>` : ''}
            ${inputEl}
            ${f.tip ? `<div class="form-text text-muted">${f.tip}</div>` : ''}
        </div>`;
    });

    container.innerHTML = formHtml;
    submitBtn.style.display = "inline-block"; // Show submit button after fields are loaded
    submitBtn.disabled = false;

    attachPasswordToggles();
    attachValidation();
  }

  // MODIFIED renderTable to render cards instead of table rows
  function renderAccounts(accountsToRender) {
    const cardGrid = document.getElementById('accounts-card-grid');
    const emptyState = document.getElementById('accounts-empty-state');
    cardGrid.innerHTML = ''; // Clear previous cards

    if (accountsToRender.length === 0) {
        emptyState.style.display = 'block';
        return;
    } else {
        emptyState.style.display = 'none';
    }

    accountsToRender.forEach(acc => {
        const brokerName = acc.broker ? acc.broker.charAt(0).toUpperCase() + acc.broker.slice(1) : '';
        const iconUrl = brokerIcons[acc.broker] || '/static/images/logo.png';
        const pictureHTML = `<img src="${iconUrl}" class="rounded-circle me-2" style="width:28px; height:28px; object-fit:contain;" alt="${brokerName} logo">`;
        const statusHtml = renderStatusBadge(acc);

        const cardHtml = `
            <div class="col">
                <div class="card h-100 shadow-sm account-card">
                    <div class="card-body account-card-body">
                        <div class="d-flex align-items-center mb-2">
                            ${pictureHTML}
                            <h6 class="card-title mb-0 flex-grow-1">${brokerName}</h6>
                            <span id="status-${acc.client_id.replace(/[^a-zA-Z0-9_-]/g,'')}" class="status-badge">${statusHtml}</span>
                        </div>
                        <p class="mb-1 text-muted"><strong>Client ID:</strong> <span class="font-monospace">${acc.client_id}</span></p>
                        <p class="mb-1 text-muted"><strong>Username:</strong> ${acc.username || '-'}</p>
                        <p class="mb-0 text-muted"><strong>Balance:</strong> <span class="fw-bold">₹${acc.opening_balance ? acc.opening_balance.toLocaleString('en-IN') : '-'}</span></p>
                    </div>
                    <div class="account-card-footer d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="window.editAccount('${acc.client_id}')" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit Account">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="window.reconnectAccount('${acc.client_id}')" data-bs-toggle="tooltip" data-bs-placement="top" title="Reconnect Account">
                            <i class="bi bi-arrow-repeat"></i> Reconnect
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="window.deleteAccount('${acc.client_id}')" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete Account">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
        cardGrid.insertAdjacentHTML('beforeend', cardHtml);
    });

    // Initialize tooltips after rendering cards
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
  }


  function renderStatusBadge(acc) {
    const auto = autoLoginResults[acc.client_id];
    const lastErr = acc.last_error || (Array.isArray(acc.errors) ? acc.errors[0] : acc.errors);
    const st = (acc.status || '').toLowerCase();
      
    if (auto) {
      if (auto.status === 'error') {
        const msg = auto.error ? auto.error.replace(/"/g, '&quot;') : 'Error';
        return `<span class="badge bg-danger" title="${msg}">Error</span>`;
      }
      if (auto.status === 'checking') {
        return '<span class="badge bg-info">Connecting...</span>';
      }
    }

    if (st && st !== 'connected') {
      if (st === 'pending') return '<span class="badge bg-info">Pending</span>';
      // treat any non-connected status as error when lastErr exists or status is failed
      if (st === 'failed' || lastErr) {
        const msg = lastErr ? String(lastErr).replace(/"/g, '&quot;') : acc.status;
        return `<span class="badge bg-danger" title="${msg}">Error</span>`;
      }
      const label = acc.status ? acc.status : 'Unknown';
      return `<span class="badge bg-warning text-dark">${label}</span>`;
    }

    // ignore non-login errors when status shows connected      
    return '<span class="badge bg-success">Connected</span>';
  }

  // MODIFIED updateStatusCell to target card
  function updateStatusCell(cid) {
    const sanitizedCid = cid.replace(/[^a-zA-Z0-9_-]/g,'');
    const statusSpan = document.getElementById(`status-${sanitizedCid}`);
    if (!statusSpan) return;
    const acc = allAccounts.find(a => a.client_id === cid);
    if (!acc) return;
    statusSpan.innerHTML = renderStatusBadge(acc);
  }

  function attemptAutoLogin() {
    allAccounts.forEach(acc => {
      autoLoginResults[acc.client_id] = {status: 'checking'};
      updateStatusCell(acc.client_id);
      fetchJson('/api/reconnect-account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id: acc.client_id })
      })
      .then(resp => {
        if (resp.message) {
          autoLoginResults[acc.client_id] = {status: 'success'};
        } else {
          autoLoginResults[acc.client_id] = {status: 'error', error: resp.error || 'Error'};
        }
        updateStatusCell(acc.client_id);
        updateCounts(); // Update counts in summary cards
      })
      .catch(err => {
        autoLoginResults[acc.client_id] = {status: 'error', error: err.message};
        updateStatusCell(acc.client_id);
        updateCounts(); // Update counts in summary cards
      });
    });
  }

  function refreshBalances() {
    allAccounts.forEach(acc => {
      fetchJson('/api/account-balance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id: acc.client_id })
      })
      .then(resp => {
        if (typeof resp.balance === 'number') {
          acc.opening_balance = resp.balance;
          applyFilters(); // Re-render to show updated balance
        }
      })
      .catch(err => console.error('Balance refresh failed', err));
    });
  }

  function accountHasError(acc) {
    const st = (acc.status || '').toLowerCase();
    // Consider error if status is explicitly 'failed' or if any non-connected/pending status is present
    if (st === 'failed' || (st && st !== 'connected' && st !== 'pending')) return true;
    // Also consider error if auto-login result is an error
    if (autoLoginResults[acc.client_id] && autoLoginResults[acc.client_id].status === 'error') return true;
    return false;
  }

  function isSuccess(acc) {
    const st = (acc.status || '').toLowerCase();
    // An account is "connected" if its status is 'connected' AND auto-login result is not an error
    return st === 'connected' && (!autoLoginResults[acc.client_id] || autoLoginResults[acc.client_id].status !== 'error');
  }

  function isFailed(acc) {
    const st = (acc.status || '').toLowerCase();
    // An account is "failed" if its status is 'failed' OR if it's a non-connected/pending status OR if auto-login failed
    if (st === 'failed' || (st && st !== 'connected' && st !== 'pending')) return true;
    if (autoLoginResults[acc.client_id] && autoLoginResults[acc.client_id].status === 'error') return true;
    return false;
  }

  // MODIFIED applyFilters to use renderAccounts (card rendering)
  function applyFilters() {
    let accountsToRender = allAccounts.slice(); // Create a shallow copy to filter
    if (statusFilter === 'success') accountsToRender = accountsToRender.filter(isSuccess);
    else if (statusFilter === 'failed') accountsToRender = accountsToRender.filter(isFailed);
    if (brokerFilter) accountsToRender = accountsToRender.filter(a => a.broker === brokerFilter);
    if (searchFilter) {
      const term = searchFilter.toLowerCase();
      accountsToRender = accountsToRender.filter(a =>
        String(a.client_id).toLowerCase().includes(term) ||
        (a.username || '').toLowerCase().includes(term) ||
        (a.last_error || (Array.isArray(a.errors) ? a.errors.join(' ') : a.errors) || a.status || '').toLowerCase().includes(term)
      );
    }
    renderAccounts(accountsToRender); // Use the new card rendering function
  }

  function updateCounts() {
    const total = allAccounts.length;
    const connected = allAccounts.filter(isSuccess).length;
    const failed = allAccounts.filter(isFailed).length;
    
    document.getElementById('tab-count-all').textContent = total;
    document.getElementById('tab-count-success').textContent = connected;
    document.getElementById('tab-count-failed').textContent = failed;

    // Assuming you have elements for master/child accounts and plan, populate them
    // You would need to fetch/determine master/child counts from your API or allAccounts
    const masterAccountsCount = allAccounts.filter(acc => acc.role === 'master').length;
    const childAccountsCount = allAccounts.filter(acc => acc.role === 'child').length;
    
    document.getElementById('master-accounts-count').textContent = masterAccountsCount;
    document.getElementById('child-accounts-count').textContent = childAccountsCount;
    // Assuming 'Total Capacity' and 'Current Plan' come from a different API or fixed values
    document.getElementById('total-capacity').textContent = '10'; // Example static value
    document.getElementById('current-plan').textContent = 'Professional'; // Example static value
  }

  function populateBrokerFilter() {
    const select = document.getElementById('broker-filter');
    if (!select) return;
    const brokers = [...new Set(allAccounts.map(a => a.broker))].sort();
    select.innerHTML = '<option value="">All Brokers</option>' +
      brokers.map(b => `<option value="${b}">${b.charAt(0).toUpperCase() + b.slice(1)}</option>`).join('');
  }

  // === Event Attachments ===
  function attachPasswordToggles() {
    document.querySelectorAll('#broker-fields .toggle-pass').forEach(btn => {
      btn.onclick = function() {
        const inp = btn.parentElement.querySelector('input');
        if (!inp) return;
        const isPass = inp.type === 'password';
        inp.type = isPass ? 'text' : 'password';
        const icon = btn.querySelector('i');
        if (icon) {
          icon.classList.toggle('bi-eye');
          icon.classList.toggle('bi-eye-slash');
        }
      };
    });
  }

  function attachValidation() {
    const form = document.getElementById('broker-credentials-form');
    form.querySelectorAll('input').forEach(inp => {
      // Exclude username validation if it's not present for a broker (like broker1)
      if (currentBrokerSelected === 'broker1' && inp.name === 'username') return; 

      inp.onblur = validateCredentials;
    });
  }

  function validateCredentials() {
    const resultDiv = document.getElementById('cred-check-result');
    const submitBtn = document.getElementById('submit-account-btn');
    const form = document.getElementById('broker-credentials-form');
    
    // Clear previous feedback
    resultDiv.innerHTML = '';
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.is-valid').forEach(el => el.classList.remove('is-valid'));

    if (!currentBrokerSelected) { return; }

    const fields = brokerFields[currentBrokerSelected] || [];
    
    let allRequiredFieldsFilled = true;

    // Check username field if applicable
    const usernameInput = form.querySelector('input[name="username"]');
    // Only check if username field exists and is required (not optional)
    const isUsernameRequired = !fields.some(f => f.name === 'username' && f.optional); // Check if username is explicitly optional in brokerFields
    if (usernameInput && isUsernameRequired && usernameInput.value.trim() === '') {
        allRequiredFieldsFilled = false;
        usernameInput.classList.add('is-invalid');
    }

    fields.forEach(f => {
      // Check if field is required and its input is empty
      if (!f.optional) { // Use the 'optional' property to determine requirement
        const inputElement = form.querySelector(`input[name="${f.name}"]`);
        if (inputElement && inputElement.value.trim() === '') {
          allRequiredFieldsFilled = false;
          inputElement.classList.add('is-invalid'); // Mark missing required fields
        }
      }
    });

    if (!allRequiredFieldsFilled) {
      resultDiv.innerHTML = '<span class="text-warning small"><i class="bi bi-exclamation-triangle me-1"></i> Please fill all required fields.</span>';
      submitBtn.disabled = true; // Disable submit if not all required fields are filled
      return;
    }
      
    if (currentBrokerSelected === 'zerodha') {
      // Skip credential validation for Zerodha as it uses OAuth login
      submitBtn.disabled = false;
      resultDiv.innerHTML = '';
      return;
    }

    // Show spinner while validating
    resultDiv.innerHTML = '<span class="spinner-border spinner-border-sm me-1 text-info" role="status"></span> <span class="text-info small">Checking credentials...</span>';
    submitBtn.disabled = true; // Disable during check

    const data = {};
    new FormData(form).forEach((v, k) => data[k] = v);
    data['broker'] = currentBrokerSelected;

    fetchJson('/api/check-credentials', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    })
    .then(resp => {
      if (resp.valid) {
        resultDiv.innerHTML = '<span class="text-success small"><i class="bi bi-check-circle-fill me-1"></i> Credentials valid!</span>';
        form.querySelectorAll('input').forEach(i => i.classList.add('is-valid')); // Mark all as valid
        form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid')); // Remove any invalid
        submitBtn.disabled = false;
      } else {
        resultDiv.innerHTML = `<span class="text-danger small"><i class="bi bi-x-circle-fill me-1"></i> ${resp.error || 'Invalid credentials'}</span>`;
        form.querySelectorAll('input').forEach(i => i.classList.add('is-invalid')); // Mark all as invalid
        form.querySelectorAll('.is-valid').forEach(el => el.classList.remove('is-valid')); // Remove any valid
        submitBtn.disabled = true; // Keep disabled if validation fails
      }
    })
    .catch(error => {
      resultDiv.innerHTML = `<span class="text-danger small"><i class="bi bi-x-circle-fill me-1"></i> Validation failed: ${error.message}</span>`;
      submitBtn.disabled = true; // Keep disabled on network/server error
    });
  }

  // === Event Listeners ===

  // Add Account button click
  document.getElementById('add-account-btn').addEventListener('click', function() {
    document.getElementById('add-account-section').style.display = 'block';
    document.getElementById('add-account-section').scrollIntoView({ behavior: 'smooth' }); // Scroll into view
    editingAccountId = null;
    document.getElementById('submit-account-btn').textContent = 'Add Account';
    document.getElementById('broker-credentials-form').reset(); // Clear form
    document.getElementById('broker-fields').innerHTML = '<p class="text-center text-muted py-3">Please select a broker above to view configuration fields.</p>'; // Reset dynamic fields
    document.getElementById('cred-check-result').innerHTML = ''; // Clear result
    document.getElementById('submit-account-btn').style.display = 'none'; // Hide submit button initially
    document.querySelectorAll('.broker-selection-item').forEach(i => i.classList.remove('active-broker')); // Remove active broker highlight
    currentBrokerSelected = null;
  });

  // Cancel Add Account button click
  document.getElementById('cancel-add-account-btn').addEventListener('click', function() {
    document.getElementById('add-account-section').style.display = 'none';
  });

  // Broker icon selection
  document.querySelectorAll('.broker-selection-item').forEach(item => {
    item.addEventListener('click', function() {
      document.querySelectorAll('.broker-selection-item').forEach(i => i.classList.remove('active-broker'));
      this.classList.add('active-broker');
      showBrokerFields(this.dataset.broker);
    });
  });

  // Broker credentials form submission
  document.getElementById('broker-credentials-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {};
    for (const [key, value] of formData.entries()) data[key] = value;
    
    if (!currentBrokerSelected) { showToast('Please select a broker.', 'warning'); return; }
    data['broker'] = currentBrokerSelected;

    // Specific login flows for Zerodha/Fyers
    if (data['broker'] === 'zerodha') {
      fetchJson('/api/init-zerodha-login', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
      })
      .then(resp => {
        if (resp.login_url) { window.location.href = resp.login_url; }
        else { showToast(resp.error || 'Failed to get login URL for Zerodha.', 'error'); }
      })
      .catch(error => showToast(`Failed to initiate Zerodha login: ${error.message}`, 'error'));
      return;
    }
            
    if (data['broker'] === 'fyers') {
      fetchJson('/api/init-fyers-login', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
      })
      .then(resp => {
        if (resp.login_url) { window.location.href = resp.login_url; }
        else { showToast(resp.error || 'Failed to get login URL for Fyers.', 'error'); }
      })
      .catch(error => showToast(`Failed to initiate Fyers login: ${error.message}`, 'error'));
      return;
    }

    // Standard Add/Update Account flow
    const endpoint = editingAccountId ? '/api/update-account' : '/api/add-account';
    if (editingAccountId) data['client_id'] = editingAccountId; // Use original client_id for update

    fetchJson(endpoint, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    })
    .then(resp => {
      showToast(resp.message || resp.error || 'Operation completed.');
      if (resp.message) { // Only reload on success
        location.reload();
      }
    })
    .catch(error => showToast(`Failed to save account: ${error.message}`, 'error'));
  });

  // Table Filters & Actions
  document.querySelectorAll('#status-tabs .nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('#status-tabs .nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      statusFilter = link.dataset.status || 'all';
      applyFilters();
    });
  });

  document.getElementById('broker-filter').addEventListener('change', e => {
    brokerFilter = e.target.value;
    applyFilters();
  });

  document.getElementById('account-search').addEventListener('input', e => {
    searchFilter = e.target.value;
    applyFilters();
  });

  // Global functions for table actions (can be called directly from onclick in HTML)
  window.deleteAccount = function(cid) {
    if (!confirm('Are you sure you want to delete account ' + cid + '? This action cannot be undone.')) return;
    fetchJson('/api/delete-account', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ client_id: cid })
    })
    .then(resp => {
      showToast(resp.message || resp.error || 'Unknown error during deletion.');
      if (resp.message) location.reload();
    })
    .catch(error => showToast(`Failed to delete account: ${error.message}`, 'error'));
  };

  window.editAccount = function(cid) {
    const acc = allAccounts.find(a => a.client_id === cid);
    if (!acc) { showToast('Account not found for editing.', 'error'); return; }

    editingAccountId = cid; // Set the account ID being edited
    document.getElementById('add-account-section').style.display = 'block';
    document.getElementById('add-account-section').scrollIntoView({ behavior: 'smooth' });

    // Highlight the correct broker icon
    document.querySelectorAll('.broker-selection-item').forEach(i => i.classList.remove('active-broker'));
    const iconItem = document.querySelector(`.broker-selection-item[data-broker="${acc.broker}"]`);
    if (iconItem) iconItem.classList.add('active-broker');
    
    // Show broker-specific fields and populate them
    showBrokerFields(acc.broker); // This also sets currentBrokerSelected

    // Populate the form fields with existing data
    setTimeout(() => { // Timeout ensures fields are rendered by showBrokerFields first
      const form = document.getElementById('broker-credentials-form');
      if (!form) return;

      // Populate username only if the field exists for this broker
      const usernameInput = form.querySelector('input[name="username"]');
      if (usernameInput) {
          usernameInput.value = acc.username || '';
      }
      
      Object.entries(acc.credentials || {}).forEach(([k, v]) => {
        const inp = form.querySelector(`input[name="${k}"]`);
        if (inp) {
          inp.value = v;
          if (k === 'client_id' || k === 'api_key' || k === 'access_token') { // Prevent editing key identifiers
             inp.readOnly = true;
             inp.classList.add('bg-light'); // Visually indicate read-only
          }
        }
      });
      document.getElementById('submit-account-btn').textContent = 'Update Account';
      document.getElementById('submit-account-btn').disabled = false; // Enable update button
      document.getElementById('cred-check-result').innerHTML = '<span class="text-info small">Modify credentials and click Update.</span>';
    }, 100); // Small delay to ensure DOM updates from showBrokerFields
  };

  window.reconnectAccount = function(cid) {
    if (!confirm('Attempt to reconnect account ' + cid + '?')) return;
    fetchJson('/api/reconnect-account', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ client_id: cid })
    })
    .then(resp => {
      showToast(resp.message || resp.error || 'Unknown error during reconnection.');
      if (resp.message) location.reload(); // Reload to see updated status
    })
    .catch(error => showToast(`Failed to reconnect account: ${error.message}`, 'error'));
  };

  // === Initial Load ===
  fetchJson('/api/accounts?cache_only=1')
    .then(data => {
      allAccounts = data.accounts || [];
      populateBrokerFilter();
      updateCounts();
      applyFilters(); // Call applyFilters to render cards initially
      attemptAutoLogin();
      refreshBalances();
    })
    .catch(error => showToast(`Failed to load accounts: ${error.message}`, 'error'));
};
</script>
{% endblock %}
