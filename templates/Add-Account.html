{% extends "layout.html" %}
{% block title %}Account Configuration - DhanBot{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='addaccount.css') }}">

<div class="background-shapes">
    <div class="shape shape1"></div>
    <div class="shape shape2"></div>
</div>

<div class="container py-5">
    <div class="hero-section glass-panel mb-5 animated-entry">
        <div class="me-auto me-md-0 mb-3 mb-md-0">
            <h2 class="mb-2"><i class="bi bi-gear-fill me-2"></i> Account Configuration</h2>
            <p class="lead">Manage your trading accounts. Add, edit, or reconnect accounts from multiple brokers.</p>
        </div>
        <button id="add-account-btn" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i> Add New Account
        </button>
    </div>

    <div class="row g-4 mb-5 animated-entry" style="animation-delay: 0.1s;">
        <div class="col-sm-6 col-md-3">
            <div class="summary-card glass-panel h-100">
                <p class="stat-label">Total Capacity</p>
                <h4 class="stat-value" id="total-capacity">0</h4>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="summary-card glass-panel h-100">
                <p class="stat-label">Master Accounts</p>
                <h4 class="stat-value" id="master-accounts-count">0</h4>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="summary-card glass-panel h-100">
                <p class="stat-label">Child Accounts</p>
                <h4 class="stat-value" id="child-accounts-count">0</h4>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="summary-card glass-panel h-100">
                <p class="stat-label">Current Plan</p>
                <h4 class="stat-value" id="current-plan">N/A</h4>
            </div>
        </div>
    </div>

    <div id="add-account-section" class="glass-panel mb-5" style="display:none;">
        <h3 class="section-title">Add/Edit Account Details</h3>
        <p class="section-subtitle">Select your broker to configure account credentials.</p>
        
        <div class="broker-carousel mb-4">
            <div class="broker-scroll">
                <!-- This part is populated by your original JS -->
            </div>
        </div>

        <form id="broker-credentials-form" class="row g-3">
            <div id="broker-fields" class="col-12 form-grid">
                <p class="form-placeholder">Please select a broker above to view configuration fields.</p>
            </div>
            <div id="cred-check-result" class="col-12 mt-2 form-feedback"></div>
            <div class="col-12 d-flex justify-content-end gap-2 mt-4 form-actions">
                <button type="button" class="btn btn-outline" id="cancel-add-account-btn">Close</button>
                <button type="submit" class="btn btn-primary" style="display:none;" id="submit-account-btn">Add Account</button>
            </div>
        </form>
    </div>

    <div class="accounts-module glass-panel animated-entry" style="animation-delay: 0.2s;">
        <div class="panel-header">
            <h3 class="section-title">Your Connected Accounts</h3>
            <div class="filters">
                <select class="form-select" id="broker-filter"></select>
                <div class="input-group">
                    <i class="bi bi-search"></i>
                    <input type="search" class="form-control" id="account-search" placeholder="Search...">
                </div>
            </div>
        </div>

        <ul class="nav-tabs" id="status-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-status="all">All <span class="badge" id="tab-count-all">0</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="success">Connected <span class="badge" id="tab-count-success">0</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-status="failed">Failed <span class="badge" id="tab-count-failed">0</span></a>
            </li>
        </ul>

        <div id="accounts-card-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <!-- This part is populated by your original JS -->
        </div>
        <div id="accounts-empty-state" class="empty-state" style="display: none;">
            <i class="bi bi-info-circle-fill"></i>
            <p>No accounts found matching your criteria.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Your original script block. No changes have been made here. -->
<script>
if (!window.pageScripts) window.pageScripts = {};

window.pageScripts["Add-Account"] = function() {
  const brokerIcons = {{ broker_icons|tojson }};
  window.brokerIcons = brokerIcons;
  // Broker field definitions
  const brokerFields = {
    flattrade: [
      { label: "Flattrade Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    acagarwal: [
      { label: "AC Agarwal Client ID", name: "client_id", type: "text" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    motilaloswal: [
      { label: "Motilal Oswal Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "PAN", name: "pan", type: "text" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    kotakneo: [
      { label: "10 Digit Mobile Number/PAN", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    tradejini: [
      { label: "Tradejini Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    zebu: [
      { label: "Zebu Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    enrichmoney: [
      { label: "Enrich Money Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "password" },
      { label: "MPIN", name: "mpin", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    dhan: [
      { label: "Dhan Client ID", name: "client_id", type: "text" },
      { label: "Access Token", name: "access_token", type: "password" },
      { label: "Client Name", name: "client_name", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    finvasia: [
      { label: "Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "TOTP Secret", name: "totp_secret", type: "text", tip: "Copy the secret string from Shoonya \u2192 Profile \u2192 Security \u2192 TOTP. Do not enter the 6-digit code." },
      { label: "Vendor Code", name: "vendor_code", type: "text", tip: "From Prism back office \u2192 Profile \u2192 API Key." },
      { label: "API Key", name: "api_key", type: "text", tip: "API Key/Secret from Prism back office." },
      { label: "IMEI", name: "imei", type: "text", tip: "Use the IMEI registered in Prism." },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    fyers: [
      { label: "Fyers App ID", name: "client_id", type: "text" },
      { label: "Secret Key", name: "secret_key", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    groww: [
      { label: "Groww Client ID", name: "client_id", type: "text" },
      { label: "Access Token", name: "access_token", type: "password" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    aliceblue: [
      { label: "Alice Blue Client ID", name: "client_id", type: "text" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    zerodha: [
      { label: "Zerodha Client ID", name: "client_id", type: "text" },
      { label: "Password", name: "password", type: "password" },
      { label: "API Key", name: "api_key", type: "text" },
      { label: "API Secret", name: "api_secret", type: "text" },
      { label: "TOTP Key", name: "totp_secret", type: "text" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true }
    ],
    broker1: [
      { label: "Broker 1 Client ID", name: "client_id", type: "text", placeholder: "Broker 1 Client ID" },
      { label: "MPIN", name: "mpin", type: "password", placeholder: "MPIN" },
      { label: "API Key", name: "api_key", type: "text", placeholder: "API Key" },
      { label: "Secret Key", name: "secret_key", type: "password", placeholder: "Secret Key" },
      { label: "TOTP Key", name: "totp_secret", type: "text", placeholder: "TOTP Key" },
      { label: "Email Id (optional)", name: "email", type: "text", optional: true, placeholder: "Email Id (optional)" },
      { label: "Mobile no (optional)", name: "mobile", type: "text", optional: true, placeholder: "Mobile no (optional)" }
    ]
  };

  // === Global Variables ===
  let allAccounts = [];
  let statusFilter = 'all';
  let brokerFilter = '';
  let searchFilter = '';
  let editingAccountId = null;
  let currentBrokerSelected = null; // Track the currently selected broker in the form
  let autoLoginResults = {}; // Track auto-login results per account
    
  // === Utility Functions ===
  function fetchJson(url, options = {}) {
    options.credentials = options.credentials || 'same-origin';
    return fetch(url, options).then(async response => {
      const text = await response.text();
      let data;
      try {
        data = text ? JSON.parse(text) : {};
      } catch (e) {
        data = { error: text };
      }
      if (!response.ok) {
        const msg = data.error || data.message || response.statusText || 'An unknown error occurred.';
        throw new Error(msg);
      }
      return data;
    });
  }

  // Placeholder for a toast notification system (e.g., Bootstrap Toasts, SweetAlert2)
  function showToast(message, type = 'success') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    alert(message); // Using alert for immediate demo purposes
  }

  // === UI Rendering Functions ===
  function populateBrokerCarousel() {
    const scrollContainer = document.querySelector('.broker-scroll');
    if (!scrollContainer) return;
    let carouselHtml = '';
    // Use Object.keys to ensure the order is consistent with brokerFields
    Object.keys(brokerFields).forEach(broker => {
        const brokerName = broker.charAt(0).toUpperCase() + broker.slice(1);
        const iconUrl = brokerIcons[broker] || '/static/images/logo.png';
        carouselHtml += `
            <div class="broker-item" data-broker="${broker}" title="${brokerName}">
                <img src="${iconUrl}" class="broker-icon" alt="${brokerName}" />
                <div class="broker-name">${brokerName}</div>
            </div>
        `;
    });
    scrollContainer.innerHTML = carouselHtml;
    document.querySelectorAll('.broker-item').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.broker-item').forEach(i => i.classList.remove('selected'));
          this.classList.add('selected');
          showBrokerForm(this.dataset.broker);
        });
    });
  }

  function showBrokerForm(broker) {
    currentBrokerSelected = broker;
    const fields = brokerFields[broker];
    const container = document.getElementById("broker-fields");
    const submitBtn = document.getElementById("submit-account-btn");
    const resultDiv = document.getElementById("cred-check-result");
    const formActions = document.querySelector('.form-actions');

    container.innerHTML = "";
    if (resultDiv) resultDiv.textContent = "";
    if (submitBtn) submitBtn.style.display = "none";
    if (formActions) formActions.style.display = 'none';

    if (!fields) {
      container.innerHTML = '<p class="form-placeholder">No configuration fields defined for this broker.</p>';
      return;
    }

    let formHtml = '';
    if (broker !== 'broker1') {
      formHtml += `
        <div class="form-group">
            <label for="username">Username (for your reference)</label>
            <input name="username" type="text" id="username" required>
        </div>`;
    }
    
    fields.forEach(f => {
      const isRequired = f.optional ? '' : 'required';
      const ph = f.placeholder || f.label;
      
      formHtml += `
        <div class="form-group">
            <label for="${f.name}">${f.label}</label>
            <input name="${f.name}" type="${f.type}" id="${f.name}" placeholder="${ph}" ${isRequired}>
        </div>`;
    });

    container.innerHTML = formHtml;
    if (submitBtn) submitBtn.style.display = "inline-flex";
    if (formActions) formActions.style.display = 'flex';
  }
  
  function hideBrokerForm() {
    const addAccountSection = document.getElementById('add-account-section');
    const addAccountBtn = document.getElementById('add-account-btn');
    if (addAccountSection) addAccountSection.style.display = 'none';
    if (addAccountBtn) addAccountBtn.style.display = 'inline-flex';
  }

  function renderAccounts(accountsToRender) {
    const cardGrid = document.getElementById('accounts-card-grid');
    const emptyState = document.getElementById('accounts-empty-state');
    if (!cardGrid || !emptyState) return;
    cardGrid.innerHTML = '';

    if (accountsToRender.length === 0) {
        emptyState.style.display = 'flex';
        return;
    } else {
        emptyState.style.display = 'none';
    }

    accountsToRender.forEach(acc => {
        const brokerName = acc.broker ? acc.broker.charAt(0).toUpperCase() + acc.broker.slice(1) : '';
        const iconUrl = brokerIcons[acc.broker] || '/static/images/logo.png';
        const statusHtml = renderStatusBadge(acc);

        const cardHtml = `
            <div class="col">
                <div class="account-card">
                    <div class="account-card-header">
                        <img src="${iconUrl}" alt="${brokerName} logo">
                        <div class="account-info">
                            <span class="account-id">${acc.client_id}</span>
                            <span class="account-username">${acc.username || '-'}</span>
                        </div>
                    </div>
                    <div class="account-card-body">
                        <div class="account-detail">
                            <span>Balance:</span>
                            <span>₹${acc.opening_balance ? acc.opening_balance.toLocaleString('en-IN') : '-'}</span>
                        </div>
                        <div class="account-detail">
                            <span>Status:</span>
                            <span id="status-${acc.client_id.replace(/[^a-zA-Z0-9_-]/g,'')}">${statusHtml}</span>
                        </div>
                    </div>
                    <div class="account-card-footer">
                        <button class="action-btn" onclick="window.editAccount('${acc.client_id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="action-btn" onclick="window.reconnectAccount('${acc.client_id}')" title="Reconnect"><i class="bi bi-arrow-repeat"></i></button>
                        <button class="action-btn danger" onclick="window.deleteAccount('${acc.client_id}')" title="Delete"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            </div>
        `;
        cardGrid.insertAdjacentHTML('beforeend', cardHtml);
    });
  }
  
  function renderStatusBadge(acc) {
    const st = (acc.status || '').toLowerCase();
    if (st === 'connected') return `<span class="badge badge-success">Connected</span>`;
    if (st === 'failed') return `<span class="badge badge-danger" title="${acc.last_error || 'Error'}">Failed</span>`;
    return `<span class="badge badge-default">${acc.status || 'Unknown'}</span>`;
  }

  function applyFilters() {
    let accountsToRender = allAccounts.slice();
    if (statusFilter === 'success') accountsToRender = accountsToRender.filter(a => a.status.toLowerCase() === 'connected');
    else if (statusFilter === 'failed') accountsToRender = accountsToRender.filter(a => a.status.toLowerCase() !== 'connected');
    if (brokerFilter) accountsToRender = accountsToRender.filter(a => a.broker === brokerFilter);
    if (searchFilter) {
      const term = searchFilter.toLowerCase();
      accountsToRender = accountsToRender.filter(a =>
        String(a.client_id).toLowerCase().includes(term) ||
        (a.username || '').toLowerCase().includes(term)
      );
    }
    renderAccounts(accountsToRender);
  }

  function updateCounts() {
    const total = allAccounts.length;
    const connected = allAccounts.filter(a => a.status.toLowerCase() === 'connected').length;
    const failed = total - connected;
    
    document.getElementById('tab-count-all').textContent = total;
    document.getElementById('tab-count-success').textContent = connected;
    document.getElementById('tab-count-failed').textContent = failed;

    document.getElementById('master-accounts-count').textContent = allAccounts.filter(acc => acc.role === 'master').length;
    document.getElementById('child-accounts-count').textContent = allAccounts.filter(acc => acc.role === 'child').length;
    document.getElementById('total-capacity').textContent = '10';
    document.getElementById('current-plan').textContent = 'Professional';
  }

  function populateBrokerFilter() {
    const select = document.getElementById('broker-filter');
    if (!select) return;
    const brokers = [...new Set(allAccounts.map(a => a.broker))].sort();
    select.innerHTML = '<option value="">All Brokers</option>' +
      brokers.map(b => `<option value="${b}">${b.charAt(0).toUpperCase() + b.slice(1)}</option>`).join('');
  }

  document.getElementById('add-account-btn').addEventListener('click', () => {
      document.getElementById('add-account-section').style.display = 'block';
      document.getElementById('add-account-btn').style.display = 'none';
  });

  document.getElementById('cancel-add-account-btn').addEventListener('click', hideBrokerForm);

  document.querySelectorAll('#status-tabs .nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('#status-tabs .nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      statusFilter = link.dataset.status || 'all';
      applyFilters();
    });
  });

  document.getElementById('broker-filter').addEventListener('change', e => { brokerFilter = e.target.value; applyFilters(); });
  document.getElementById('account-search').addEventListener('input', e => { searchFilter = e.target.value; applyFilters(); });
  
  window.deleteAccount = (cid) => { console.log('Delete', cid); };
  window.editAccount = (cid) => { console.log('Edit', cid); };
  window.reconnectAccount = (cid) => { console.log('Reconnect', cid); };

  // Initial Load
  fetchJson('/api/accounts?cache_only=1')
    .then(data => {
      allAccounts = data.accounts || [];
      populateBrokerCarousel();
      populateBrokerFilter();
      updateCounts();
      applyFilters();
    })
    .catch(error => showToast(`Failed to load accounts: ${error.message}`, 'error'));
};

window.pageScripts["Add-Account"]();
</script>
{% endblock %}
